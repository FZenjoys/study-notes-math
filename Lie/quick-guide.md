# 在位姿估计问题中应用李群/流形的发展脉络、动机与直觉
* * *

# 前言

使用多传感器的数据源去估计机体的位姿，这是一个长久的话题。特别是近年来无人机、机器人和智能汽车行业的快速发展，更使得这方面的研究高热不断。但是翻开相关的论文和资料，却是让人头痛不已。里面的数学公式，不但有上标、下标，还有前标，甚至再来几个++/--的修饰，实在让人看得头晕眼花，不明所以。

其实，理清相关问题的发展脉络，理解姿态或位姿估计问题引入李群或流形的动机与直觉之后，这些数学公式的目的相当简单，知道了目的再去看，公式并不难看懂，自己再次推导也不会很难。但是咱们的傻博士们呀，推导公式倒是一把好手，整版整版的公式推导都不带喘气的，似乎一个公式不撑破一张打印纸那都不叫本事，不带一行文字解释那才叫高明。但是鲜有人谈论动机和直觉，更不要说如何带新人入门了。

开拓者在荒野里探索，那是有大本事的人。但是创立和发展一个理论之后，后来者应该能继承和传播最初的动机与直觉，如同黑夜里点亮路灯，能让后来的后来者走得更顺畅一些，能跟上前人的步伐。但是这方面的资料太少太少。这时候就显得 Joan Solà 博士的难能可贵了，他写了两个入门资料，文献[12]和[18]，并做了培训讲座，能让人上两个台阶。

# 乘性卡尔曼滤波器族群

在姿态估计中所使用的卡尔曼滤波器中：
* Error-State Kalman Filter
* Multiplicative Kalman Filter
* Indirect Kalman Filter

这些大多指的是同一个东西。

乘性卡尔曼滤波器(Multiplicative Extended Kalman Filter, MEKF)因其在数学上能对旋转做最优估计而著称。因为旋转是群而不是向量，只对乘法封闭，因此不能用卡尔曼滤波器直接估计，因为协方差运算必须用减法。所以只能将要估计的状态量分为标称状态和误差状态，先用卡尔曼滤波器估计误差状态，再将误差状态注入(inject)标称状态，则标称状态也就成了最优估计，这就解决了旋转不能直接估计的问题，因此这种方法也称间接卡尔曼滤波(Indirect Kalman Filter)。又因为估计的是误差，所以又叫误差状态卡尔曼滤波(Error-State Kalman Filter, ESKF)。

如今对估计旋转的问题又有新进展，引入了李群和流形。因此最新的滤波器又被称为流形卡尔曼滤波(Manifold Extended Kalman Filter, MEKF)。

引入了李群和流形后，就存在全局坐标系和局部坐标系的切换问题，于是又多了一种相对乘性扩展卡尔曼滤波器(Relative multiplicative extended Kalman filter, RMEKF)。

另外，最新的不变扩展卡尔曼滤波(Invariant Extended Kalman Filter, IEKF)，或者又叫不变流形卡尔曼滤波(Invariant manifold Extended Kalman Filter, IEKF)，也是这家族成员。

# 乘性卡尔曼滤波器理论发展

一个很自然的直觉，三维空间的旋转用三维向量表示。常见的有欧拉角表示和轴角表示。但是，不论哪种三维向量表示，都存在有奇点，并且插值不均匀，表示姿态有不连续的跳跃问题，这些问题大多与 tan() 函数相关。数学上已经证明，姿态估计的基本约束条件是姿态矩阵是旋转群或特殊正交群 SO(3) 的成员。这就是说姿态矩阵必须是行列式为 +1 的正交矩阵的群理论方法。对三维空间旋转来说，最少需要 4 个参数的表示方法，也就是四元数表示法，才能无奇点的、连续的、采样均匀地表示三维旋转。

用 4 个以上的参数表示三维旋转，必然要引入约束。比如，四元数是 4 个参数，所以要引入单位范数这个约束，使得单位四元数可以表示三维旋转。而旋转矩阵是 9 个参数，所以要引入 6 个约束，3 个行向量正交，并且 3 个列向量也正交。约束的本质就是降维。这也使得单位四元数和旋转矩阵不是向量而是群，也就是人们常说的旋转群或特殊正交群 SO(3)。

表示三维旋转的单位四元数和旋转矩阵不是向量而是群，在做姿态估计时，这个概念需要牢记在心。因为最常用的姿态估计方法就是卡尔曼滤波器。但是卡尔曼滤波器最核心的概念是协方差矩阵，里面有一个重要的假设就是估计状态是向量，计算协方差采用的是减法'-'。而三维旋转只能用群来表示，这就使得两者产生了冲突。对此，文献[7]在第 3 章中专门讨论了约束的复杂性。文献[3]的题目也点到了问题，对于姿态四元数，我们是把它看成 4 参数向量还是把它看成有约束的群？

最早估计姿态四元数时，就是把姿态四元数当成向量，直接把它丢进卡尔曼滤波器里进行最优估计。这类滤波器被称为加性卡尔曼滤波器(Additive Kalman Filter)。基于上面的原因，有人觉得它在数学上有问题，于是 NASA 里的一群聪明人提出了乘性卡尔曼滤波器。

他们是这样解决问题的。首先，我们根据牛顿定律建模，并根据 IMU 的数据可以外推机体的当前姿态，该姿态被称为标称姿态。虽然标称姿态不能直接用卡尔曼滤波器做最优估计，但是我们可以做间接估计。标称姿态和真实姿态之间有一个误差。只要采样频率够快，这个误差就很小，基本上就在零点附近抖动，并且性质近线性。对于这个小误差，我们可以用三维向量的轴角表示法表示，因为它此时远离奇点。既然误差是用向量表示，所以它可以用卡尔曼滤波器进行最优估计。估计出来的误差向量，可以从轴角表示法变换为误差四元数。最后，误差四元数作用到标称四元数上面，标称四元数因此也间接成了最优估计。误差四元数作用到标称四元数时，采用的是乘法，因为乘法对群成员封闭，因此这类滤波器又被称为乘性滤波器。

加性和乘性滤波器在上世纪 70 年代就已经并行使用。但一直到本世纪初，才有人从数学上讨论两者在数学概念上的差异，其中 F. Landis Markley 这位白胡子老爷爷是主力，参见文献[2-4]。此后乘性卡尔曼滤波器才在姿态估计中占据正统地位。

除了符合数学概念，采用乘性卡尔曼滤波器还有一些优点，在文献[12]中有总结：

1. 方向误差状态最小 (即，其参数数量与自由度相同)，避免了过度参数化 (或冗余) 的相关问题，以及相关协方差矩阵奇异性的风险，这通常是由强制约束引起的。 

2. 误差状态系统总是在接近原点的位置运行，因此远离可能的参数奇异性、万向节锁问题，或类似的问题，从而提供保证在所有时间里线性化有效性始终保持不变。

3. 误差状态总是很小，这意味着所有二阶乘积都可以忽略不计。这使得 Jacobians 矩阵的计算变得非常简单和快速。有些 Jacobians 矩阵数值甚至可能是常数或等于可用状态量。

4. 误差动力学变化很慢，因为所有大信号动力学已集成在标称状态。这意味着我们可以以低于预测的速度应用 KF 修正 (这是观测误差的唯一方法)。

因为上面第 3/4 项优点，从而导致了文献[1]所提到的优点：规避动力学建模。文献[1]描述的是在开发火星车的过程中，在不建立车辆动力学模型的情况下，用陀螺仪模型代替动力学模型，获得了良好的姿态估计。这个例子很能体现 ESKF 的优点。首先，火星表面的真实情况谁也不知道。其次，火星车的方案可能会有改动，如从 4 个轮子变成 6 个轮子，动力学模型会发生变化。最后，因为环境的变化，车辆的动力学模型的参数多变的，例如，在高速公路、戈壁和沙漠上，汽车的动力学模型的参数都不一样。因此基于车辆的动力学模型去估计姿态，会有很大的难度。但是，基于传感器模型去估计姿态误差，则规避了这些问题，因为传感器特性是已知的、可测量的，并且不会有太大的变化。

所谓规避动力学建模，在文献[21]有进一步的讨论。因为外力合力是很难准确测量的，同时质量分布也是很难准确测量的。一个小车，风阻是多变的，车轮摩擦力也是多变的。小车上一个人还是上四个人，上一个胖子，他坐哪里，质心也会有较大变换。这就给动力学方程带来了较大的误差。因此，用动力学模型建模并估计姿态，一个是建模困难，而是估计精度不高。而现在采用运动学建模，并估计误差，则大大简化了模型，只需要最基本的牛顿定律既可，而且估计精度也大大提高。

最后，文献[5]和[12]全面总结了乘性卡尔曼滤波器的理论。

# 乘性卡尔曼滤波器实现案例

早先，在互联网上面没有多少成熟可用的采用 ESKF 算法进行姿态估计的代码。没有前人的成功经验，初学者就很难学习，也更难写出一个可用的 ESKF 代码。如果只看参考文献[1]-[4]，是不能写出一套完整代码的，因为公式都没写全。因为大佬们写论文，只写最有价值的关键突破，而不会啰嗦把所有公式写全，手把手地教初学者怎么样完成一次循环迭代。

这些年来这种状况有所改变，现在这方面的教材越来越多。初学者入门要了解 MEKF 的一些基本概念，可先看文献[19]。

文献[5]是最早一份介绍 MEKF 完整实现的教材。里面不但介绍了高精度积分的方法，还推导了泰勒级数的封闭形式的解，有很高的工程实用性。不过要注意的是，文献[5]是针对航天人员培训用，所以里面使用的四元数方程是 JPL 约定。并且在测量更新这一章介绍的是航天所用的星光传感器，和地面上所用传感器不一样。

文献[8]是很实用的实现教材。在文献[5]中，只推导了姿态估计方程，而在文献[8]中，则推导姿态、速度和位置的方程，测量更新也加入了磁力计和 GPS，更适合地面使用。

文献[12]是近年来最好最详细的介绍 MEKF 完整实现的教材。从理论到实现都说了遍，也关注高精度积分的方法，和推导泰勒级数的封闭形式的解，并且他使用的四元数方程是大家常用的 Hamilton 约定。不过因为这是 Joan Solà 博士的写毕业论文的一个副产品，学术气息更浓一些。事无巨细，有时候不好抓住实现的脉络。

文献[13]和文献[20]是一些参考实现，可以一边看实现一边回看上面的教材，则更容易理解 MEKF。特别是文献[20]是文献[8]的简单实现，更容易对照理解。

如果要考虑现实的复杂问题，则可以参考文献[21]。文献[21]的实现在[[ROScopter](https://github.com/byu-magicc/roscopter)]，是很现实的项目，在代码里还要处理更多的细节。

MEKF 有一个特点，就是在一次循环迭代结束时，有一次 reset 操作。最新的研究进展，为提高数据精度，对 reset 操作还需要全阶处理。对此请看文献[22]。

# 引入李群的动机

## 动机与解释

对于李群的一个简短定义是：李群是一个群，也是一个光滑流形。李群以前又被称为 "连续变换群"。

三维旋转做为一个群，并且又是连续变化的，因此姿态估计问题在 MEKF 成为主流后，引入了李群和流形重新解释 MEKF 就是一个自然而然的事。因为在设计 MEKF 时也留下一些让人疑惑的问题，通过李群的解释，在数学上也有了答案。

例如，为什么三维向量可以用 4 种映射变换为误差四元数，为什么在一次循环迭代结束时，一定要执行 reset 操作。这些问题，通过李群，就有了自然而直观的解释。

文献[12]在推导 MEKF 的过程中，已经引入了一些李群的概念。李群和流形在数学上博大精深，其实在工程应用中只使用了很基础很简单的一个子集。因此 Joan Solà 博士后来针对机器人位姿估计问题，写了一个只有 17 页的李群和流形的教材，就是文献[18]。

群是代数结构概念。流形是几何拓扑概念。李群连接了两者，具有两者的特性。李群做为一个群，同样有“封结幺逆”的特性。很容易验证，单位四元数和旋转矩阵的集合与乘法构成群。和运动相关的变换矩阵的乘法也构成群。这些都是李群的一种：
* 特殊正交群SO(n)：也就是旋转群。
* 特殊欧氏群SE(n)：也就是运动群。其中包含了旋转和平移运动。

在这里我们只关注在二维和三维空间中的旋转群SO(2)/SO(3)和运动群SE(2)/SE(3)。

对于流形，我们只关注单位四元数所表示的嵌入四维空间R4的三维S3球面及其近似流形。它们有两个特性需要关注：
* 局部(local)
* 收回(retraction)

根据参考文献[18]的总结，引入李群的动机主要有这几方面：
* 它是适当的：在旋转和运动的非线性空间上进行严格的微积分(导数和积分)演算。
* 它是强大的：在最小的空间里适当地处理不确定性、优化步骤、增量。
* 它是抽象的：在不同的方案中(2D/3D、四元数与旋转矩阵、IMU预积分与里程表)，实施统一的概念。
* 它是优美的！具有数学上的简洁统一的美感。

实际上最重要动机就是能对群元素能进行加减法运算，从而能复用向量空间中成熟的算法。因为群存在约束，非线性约束以及约束所定义的作用，使得有些算法直接在群元素上进行运算很困难，甚至违反了约束。这时候就引入李代数解决这个问题。

李代数是流形在幺元处的切空间。流形的所有切空间的结构都相同，都是在幺元处的结构。流形局部的切空间的切点是一个很特殊的地方。它既属于流形又属于切空间，在此建立原点的切空间有向量空间性质，并且切空间的元素既可以变换到笛卡尔空间也可以变换到流形空间中。因此在切点处我们会涉及三种空间：
* 笛卡尔空间R3。这是我们最熟悉的三维向量空间。
* 切空间。这也是三维向量空间。笛卡尔空间的三维向量通过 3 个生成元进入这个空间，形成 3x3 的斜对称矩阵结构。
* 流形空间。在切空间的向量使用加减法进行各种最优估计之后，使用指数映射函数 exp() 就进入了流形空间，这就是流形的收回(retraction)操作。

具体到我们的例子，在表示姿态的流形的当前姿态点上我们建立一个局部切空间。附着在机体上的 IMU 测量得到的角速度就是与其同构的局部笛卡尔空间的三维向量，我们然后通过 3 个生成元使其进入局部切空间，形成的 3x3 的斜对称矩阵就是切空间中的角速度。根据模型的运动学方程，在切空间中使用包括加减法的各种计算，得到一个姿态外推的增量向量。增量向量使用指数映射函数 exp() 进入流形空间，再通过乘法作用到当前姿态点上，于是当前姿态就在S3球面上移动到了新的姿态点上，所走的路径就是增量向量缠绕(wrap)到流形上所形成的测地线。这种球面运动就是旋转。

因为各种原因，通过角速度外推的新的姿态和真实姿态有误差。我们可以估计这个误差，使得我们最终的姿态估计值最接近真实值。我们是在局部切空间中计算误差向量，因为切空间是向量空间，可以使用卡尔曼滤波器进行最优估计。经过推导，误差向量的协方差矩阵与角速度有关，于是再次使用切空间中的角速度，3x3 的斜对称矩阵，计算协方差矩阵。时间更新阶段，如有需要，还可用其外推计算积累误差。测量更新阶段，IMU 得到的加速度向量和磁力计得到的磁力向量也用类似的生成元形成 3x3 的斜对称矩阵，进入切空间参与计算。传感器噪声向量用另外的生成元变成对角矩阵也进入切空间参与计算。最后，使用最优估计算法，在局部切空间中计算得到误差向量的最优估计。

最优估计的误差向量通过收回(retraction)并作用到当前姿态点上，于是当前姿态点就沿着误差向量形成的测地线移动到新的姿态上，并且该姿态是最优估计的姿态。

## 对局部切空间的理解

流形上的所有局部切空间都是平等的，理解这点很重要。在知乎上有一个很有趣的讨论，[获得多个旋转矩阵，如何获得平均旋转？](https://www.zhihu.com/question/439497100/answer/1681897931)

我们先从几何上直观理解问题。找来一个篮球，用笔随便找一个地方点一个点，旁边写上“幺元”。转一下篮球，再找另外的地方，最好离幺元远一点的地方，点几个点，这就是我们抽样得到的随机旋转。然后我们估摸着在这几个点的中心区域点一个点，这就是我们猜测的平均旋转。我们手上只有直尺，量不了球面上两点的距离。但我们手上还有一些柔软的琴弦(string)，于是我们用琴弦从猜测点出发，到其中一个随机点的时候用手按住标记，然后拉直了琴弦在直尺上看数据，这就是从猜测点到随机点的距离。把所有的距离相加就是总距离。 

刚才那个猜测点是随便猜的。我们按照某种梯度下降方法继续猜下一个点，直到找到总距离最小的那个点。在这期间，我们用琴弦量弧段，就是量测地线。琴弦拉直了用直尺量，就是 log() 操作，或者说展开(unwrap)操作，将圆球(流形)上的元素映射到了向量空间。在向量空间中，距离相加就得到了总距离。因为局部切空间不同，各个点映射到切空间中的向量也不同，所以总距离就有变化。而平均旋转，就是总距离最小的那个点，但我们没有解析解，因为各处局部切空间无法直接相互比较。所以要求全局最小总距离，就只能靠某种方法试探和逼近。 

所以这就是正确答案里为什么会有不明觉厉的测地线，为什么会有 log() 操作的原因，从这种直观的例子就很容易理解了。

开始接触旋转时的常见错误，就是把多个旋转表示，比如欧拉角或四元数相加求平均。旋转没有我们在向量空间中所理解的“加法”，而只有“组合”，也就是乘法。理解了这一点，后面就容易理解了。为了用“加法”，只能把流形上的元素映射到切点处的向量空间，执行包含“加法/减法”的算法后，再把所得结果，是一个向量，映射回流形空间，相当于切点处的元素移动/旋转到新的位置。前一种映射就是 log()，后一种映射就是 exp()。 

如果理解了旋转没有加法，所以就很容易理解欧拉角/四元数相加再平均的算法是错误的了。在小角度条件下，四元数求和平均的算法有比较好的数值结果，是因为在小角度情况下四元数的相加平均算法约等于旋转的一阶近似。 

另一个“切空间”算法很能迷惑人。它是这样的，在幺元处建立一个局部切空间，然后将流形上各个随机点映射到(log)在该切空间中，然后在该切空间中计算得到的平均向量，再映射回(exp)流形上。乍一看没什么问题，一切操作都符合数学原理。向量相加求平均，就是在向量空间中，求映射到向量空间中的各个点的几何中心，也就是求一个各点围成的多面体的几何中心。然后将这个平均向量映射回圆球(流形)上，就是从幺元出发移动/旋转到平均向量指示的点上，那该点好像就是平均旋转。

回到我们上面的篮球做验证，如果我们的随机点远离幺元，那么在幺元处计算得到的平均向量的点落在随机点围成区域的中心点的可能性很小。所以这种方法的误差最大，甚至只能称之为错误。 

错误在哪里呢？局部切空间都是平等的，为什么在幺元处建立的局部切空间就是特殊的，能一步算出全局的极值呢？它能计算的，只是在局部切空间这个视角下的某个向量或某个值，不具备全局意义。实际上，求这种全局极值，必然存在某个全局坐标系或某种全局性指标，在相同的条件下，这些局部切空间计算出来的值才能相互比较求出一个极值。

不过这种几何直觉的方向是对的。我们用类似的几何直觉重新解释正确答案。随着切点的不同，在以切点为原点建立的切空间中，各个映射点围成的多面体的体积/面积也不相同。我们需要在流形上试探找到一个点，在该点上建立的切空间中，切点/原点正好是多面体的几何中心，也就是平均向量最小，这样从原点出发到各个映射点的总距离最小，这时各个映射点围成的多面体的体积/面积也最小。但是该点没有解析解，只能靠搜索找到。

对于局部切空间的应用，后面还有进一步的讨论。

## 映射方法的选择

在文献[2]提出，在文献[16]总结，在文献[21]中也同样使用的，将切空间中的向量映射到流形上，常见有 4 种映射方法：

1. 正交投影 (Orthographic, O)
2. Rodrigues 参数 (Rodrigues Parameters, RP)
3. 改进型 Rodrigues 参数 (Modified Rodrigues Parameters, MRP) 
4. 旋转向量 (Rotation Vector, RV)

前三种是我们所知道的球极平面投影 (stereographic projection) {这三种投影分别具体称为正交投影 (Orthographic)、日晷投影 (Gnomonic) 和球极平面投影 (Stereographic) }。最后是所谓的等距投影 (Equidistant)。

前三种映射关系是第四种的某种近似，因为这四种映射关系在零点附近的小角度情况下数值很接近，但大角度之后就明显不再是球面，如果球面是完美模型，选择前三种映射关系可能是因为某种原因，例如选择正交投影 (Orthographic) 是因为它可以简单地把单位四元数转换为轴-角向量，选择 Rodrigues 参数(RP)是因为它是单映射，选择改进型 Rodrigues 参数(MRP)是因为它避免了超越函数的运算。还有，因为在工程中 IMU 的取样间隔时间 ∆t 很小，所以一般增量角度 θ = ω ∗ ∆t 都很小，所以都会应用三角函数小角度近似的方法。

此外，需要注意的是，这个收回(retraction)操作，在不同的版本中，有个 1/2 系数的区别，是因为四元数 S3 流形对 SO(3) 是双倍覆盖。于是在旋转矩阵形式的版本中使用的是全角 θ，而在四元数版本中使用的是半角 θ/2。

## 应用流形理论的进展

近些年，对姿态估计问题的研究又有新的发展，或者说有新的灌水田地。前面应用李群，偏向应用群方面的知识，现在开始偏向应用流形方面的知识。参考文献[14]、[16]、[23]是同一个作者写的系列论文，由此可以看到这种方法的要点。

# 位姿的估计

在三维空间中，对于一个质点，我们用位置来描述就够了，只需要 3 个自由度(DOF)，也就可以用通俗的三维坐标来表示。然而对一个刚体，3 个自由度是不够的，因为有了体积的存在，还需要有 3 个角参量来描述姿态，一共是 6 个自由度(DOF)，这时候坐标已经不能够满足了，所以姿态就是为了描述这件事情产生的。也就是三维空间中的刚体，需要用位置(position)以及姿态(Attitude)表示，两个物理量各有 3 个自由度(DOF)，组合起来就是位姿(pose)。姿态的英文词汇有两个，“attitude” 或者 “orientation”。后者的意义更为明显，可以理解为“取向”或“指向”。所谓姿态，就是刚体在三维空间中，固连在刚体上的机体坐标系(body frame)和参考坐标系(reference frame)之间的旋转关系。

位姿估计，是工程问题，是力学和数学理论结合的产物。从李群去理解位姿问题，可以得到简单而一致的概念。SE(3) 就是我们要研究的对象。该对象，或者说元组(tuple)，其实是由两种数学对象组合而成。旋转群 SO(3) 属于李群的一种。平移属于向量空间，但严格地说，向量也可以算是李群的一种，因为它同样也有“封结幺逆”的特性，只是它的收回(retraction)操作是恒等函数。所以旋转和平移可以组合成 SE(3) 群，它可表示为 4x4 齐次矩阵。

文献[6]和文献[11]从李群的角度重新推导了工程力学中的基础方程，是复习工程力学方程的好教材。从中也可以看出，在工程中所使用的数学知识都好古老。工程力学有两百多年的历史，是工业革命时期的产物，李群有一百多年的历史，是电气化革命时期的产物。稍微近一些的是卡尔曼滤波器，将近70年的历史，是信息革命时期的产物。而将这些知识相结合以解决位姿估计问题，也不过十余年的时间。

文献[21]全面推导了位姿估计的方程，其中增加了最新的视觉里程计和激光扫描匹配的内容。该文献中关于全局坐标系与局部坐标系相互变换的内容，对于理解应用李群解决位姿估计问题十分有帮助。这在后面讨论。

# 建模的差异

为估计姿态或位姿，需要建模。惯性是物体的内在秉性，IMU 可以精准地测量机体的角速度和加速度而不受外界干扰。但是如何使用角速度和加速度，却有不同的模型。其实描述物理世界的模型不是一成不变的，有很多工程上面的考虑，反应出人们对系统中误差的理解。

## 为估计姿态建模

为估计姿态建模时，大多将加速度中的重力向量做为观测向量使用。

文献[5]是为航天工程人员准备的教材。在太空微重力环境中，没有使用重力向量做为观测向量，因为在那里重力太弱小。航天器使用的是星光传感器的数据进行测量更新。

文献[13]，还有文献[14]、[16]、[23]，都是传统的方法，将加速度中的重力向量做为观测向量使用。因为在近地表，几乎是恒定的重力向量在 IMU 的加速度测量值中已经可以分离出来，而多变的外力可以认为是噪声的一部分，因此可以校正出局部的水平面，也就是校正出欧拉角中的 Roll & Pitch。

文献[10]提供了一种新的思路，他们将磁倾角做为观测向量，同样可以解决问题。并且这是一套达到工程品质要求的代码，其中为工程应用所做的细节处理，值得学习。

## 为估计位姿建模

姿态变化由角速度驱动，位置变化由速度驱动，所以为估计位姿建模时，从 IMU 得到的加速度数据要用于估计速度，进而估计位移。这时候引入全局测量值是必须的，如 GPS 的测量值，不这样不足以做全局校正，从而消除估计值中的积累误差。

文献[20]是文献[8]的简单实现。其中文献[8]提到的一个技巧，在某个轴上施加定值的噪声，居然也可以校正数据。卡尔曼滤波器真是很神奇的东西。

文献[8]和文献[12]，出于学术上的通用模型考虑，对于全局测量值未做特殊处理。

而在现实的项目里，需要做很多细致考量。例如文献[25]，它虽然不是 ESKF 家族的滤波器，但是有很多细节值得借鉴。在那里，高度数据 z 分量和 x-y 平面数据是分别校正。这是因为GPS在高度数据上误差过大，而我们还拥有其它高精度的高度数据源可以对其进行校正，例如气压计、测距仪、外部视觉等等。

在文献[21]中，还有另外的处理。加速计测量的 z 分量被用于时间更新，在传播模型中计算，而 x 和 y 分量被用作测量更新。所有这些，都是基于系统模型的特点而做处理。

# 协方差与不确定性

协方差矩阵是不确定性的表示。在流形上的协方差矩阵因为非线性的原因很难估计。因此需要在局部切空间中计算，然后再用收回操作映射到流形上。

在文献[16]中证明，流形上的协方差和局部切空间中的协方差是同胚(homeomorphism)，因此局部切空间中的协方差可以通过图表(chart)映射到流形空间上。所谓图表(chart)，就是前面定义的 4 种映射方法，最终将局部切空间中的向量映射到流形上。

在常见的示意图中，在流形上以当前估计值为切点建立的局部切空间一般表示为平面，而将流形表示为球面。实际上此时的局部切空间为三维空间，其中的协方差矩阵，表示的是真实值的概率分布，形状为该矩阵的 3 个特征向量张成的椭球，椭球的中心就是概率中心，就是真实值最有可能存在的地方。在每一个穿过概率中心的直线上取概率密度，得到的就是真实值在各个方向上的高斯分布。而误差向量就是从切点/原点指向概率中心，当前视角下真实值最有可能存在的地方，因此误差向量就是在当前局部切空间中的最优估计。将向量误差从切空间收回到流形上，则当前估计值就旋转/移动到最优估计点上。

文献[24]，《减少不确定性的不确定性》，从李群的角度，全面地探讨了在估计问题中，协方差所表示的不确定性所涉及的知识和方程，其中，李群伴随 (adjoint)，位姿求逆，组合分布，相对变换分布，等等这些知识在 SLAM 或机器人位姿估计中经常用到。在文献[18]中，《微型Lie理论》，伴随也是 Joan Solà 博士特意提到的一个很有用的工具。

文献[17]，《李代数中联合分布位姿不确定性的刻画》，更深一步介绍了位姿估计所用的李群/李代数知识，并讨论了，在位姿图中，一组互相关的位姿，如何计算不确定性，并在互相关、或称为联合分布的情况下，如何计算位姿组合、位姿求逆和相对位姿估计，这些知识在SLAM或机器人位姿估计中经常用到。

# 全局坐标系与局部坐标系

文献[21]，是一个自包含的教材，完整地讨论了在全局坐标系条件下，文中称为惯性相对导航 (Inertial Relative Navigation, iRN)，以及在局部坐标系条件下，文中称为机体固连相对导航 (body-fixed Relative Navigation, bRN)，应用相对乘性扩展 Kalman 滤波器 (relative multiplicative extended Kalman filter, RMEKF)解决位姿估计问题。

全局坐标系与局部坐标系的相互变换，使用的就是文献[18]和文献[24]所讨论的伴随矩阵工具。在现实应用中，必须同时应用全局坐标系与局部坐标系对位姿进行估计。首先，IMU 的测量数据都是局部坐标系的数据，存在积累误差，所以必然要引入全局测量数据，例如室外的 GPS 或室内的物体跟踪数据，从而消除积累误差，使得误差有边界(bounded)。

其次，IMU 的数据具有很高的采样率，可以轻松地超过 100Hz，而 GPS 可能只有 1Hz，在都市里受各种干扰很容易丢失信号，甚至是长时间没有信号，例如车辆驶入地下隧道中，这是需要用关键帧 (keyframe) 技术，确定位姿估计的新的原点，在局部坐标系中递推位姿，直到再次获得全局数据，这时从最开始的关键帧原点推算当前的全局位姿并进行校正，这时可以保证最小的全局位姿跳跃。

形象地理解这些问题，我们可以在一个球面想象如何解决这些问题。在球面上有一个上一时间段的最优估计点，我们可以在此建立一个局部切空间，在当前IMU数据到达后，根据物理模型外推得到当前位姿的估计值。我们推进/切换局部切空间，当前协方差矩阵也需要递推到当前切空间中，使用的是卡尔曼滤波的预测(先验)估计协方差方程。使用其它传感器的测量值，在当前估计的位姿切空间中对位姿误差进行最优估计。当估计出最优误差向量后，将其注入(inject)/作用到当前位姿估计值中，这时当前位姿估计值就成了最优估计，而误差向量归零，并且局部切空间推进/切换到最优估计值的点上。位姿估计问题就这样周而复始地往前推进。

第一次切换局部切空间被称为外推，第二次切换被称为重置。重置既然切换了局部切空间，则相应的协方差也需要往前推进/旋转到新的位置。在测量更新阶段，使用更新(后验)的协方差方程推进协方差矩阵向前变化，表示的是在外推姿态点处的局部切空间看最优点处的协方差，而重置后在最优点处构建的局部切空间的原点处的协方差，虽然两处看到的最优点都是在流形上的同一个位置，但局部切空间变了，视角变了，需要把上一个局部切空间的协方差变换到本地协方差。但是在文献[1-5]中的重置章节没有讨论这个问题，文献[12]讨论了这个问题，但建议可以忽略，文献[16]也讨论了这个问题，在那里被称为图表(chart)更新，作者也认为可以忽略。在文献[22]中全面地讨论了姿态重置时协方差更新的全阶解。看计算结果，在一个时间步长中变化 1 弧度以内产生的误差都很小，只有瞬间变化 10 弧度以上才产生明显的误差，如果从采样率 100Hz 计算，这已经是很剧烈的旋转了，这时最有效的解决方案是提高采样率。因此在大多数情况下，位姿误差重置时，误差很小，两处局部切空间挨得很近，基本上重合，因此协方差矩阵可以不更新，但是算法设计者在概念上要了解有这个步骤，引起的原因是局部切空间发生了切换。

再对比前面的求全局平均旋转例子，误差卡尔曼滤波可以认为是在一个局部切空间中求加权的平均旋转，各种校正用的传感器数据可以认为是对真实值的多次采样，通过求加权的平均旋转而逼近真实值，而平均运算是通过李群和李代数在向量空间中进行加减运算。这是在当前局部切空间中做最优估计，所以可以一次计算到位，而前面的例子求的是全局条件下的平均旋转，所以需要用试探方法对比各个局部切空间中的数值。

再进一步想象，当全局传感器数据迟迟不能到达，这时候只能以最后一次被全局校正的位姿为关键帧设立新的位姿原点，外推位姿，后面虽然还有切换局部切空间和误差归零的操作，但是都基于这个关键帧计算，直到再次获得全局数据，于是可以全局校正位姿，消除积累误差，建立新的关键帧。

对于 SLAM 问题，还会涉及到位姿组合、位姿求逆和相对位姿估计这些问题。用李群求解这些问题，可以有一致的概念和一致的求解方法，包括使用全局坐标系与局部坐标系相互变换的方法，这些在文献[17]和文献[24]讨论。

以前的讨论，大多只考虑到物体中一个点的位姿估计问题，而机器人这样的有多个运动部件的物体，则需要考虑互相关的问题，并且需要从一个部件推算另一个部件的相对位姿，这些在文献[17]中讨论。

用卡尔曼滤波器估计状态，很容易出现状态维度爆炸问题。而约束本质是降维，互相关就是一系列约束，使得状态维度变小，从而容易计算。但是引入约束又使得状态不再是向量。于是引入李群和流形，使得状态的误差或增量的最优估计可以在向量空间中进行，最后将最优估计出来的向量收回到流形上，使得当前状态移动/旋转到最优估计点上。

# 工程问题

位姿估计本质是工程问题，所以需要从工程细节解决问题。

## 异步事件问题

在传统的姿态估计的应用场景中，为简化计算并提高估计精度，有一个并行采样的假设。也就是所有的传感器数据都是同时采样，也就是用 IMU 数据驱动位姿变化，用同一时刻的其它传感器数据对位姿进行校正。

但是在现代的嵌入式系统中，这个假设已经很难保证。因为现在各类传感器都是以不同的采样率进行采样，例如陀螺仪/加速计可以达到 100 ~ 200 Hz 的采样率，而地磁计的采样率可能只有 10Hz，而 GPS 可能只有 1Hz。如果陀螺仪/加速计/地磁计这 3 者都以 100Hz 进行采样，因地磁计来不及锁定数据，可能连续 10 次上报同一个数据，直到寄存器锁定后才上报新的数据。这样的数据组合，既影响了估计精度，也增加了计算量。

并且嵌入式系统的 CPU 已经进入多核时代，因此对于传感器数据处理模块，可能是多种传感器多种频率，异步采样，数据异步到达。

针对这种情况，文献[9]讨论了传感器数据如何在多速率多延迟向量测量条件下进行递推姿态估计，解决思路是用一种组合预测器-观测器的姿态估计方法，用滑动窗口对历史数据进行处理，利用姿态运动学和向量测量模型的对称性，从而在延时输出姿态状态时，可以对其校正。

## 编程问题

文献[15]讨论编程实现李群的代码库，以及应用代码库求解最优估计时需要考虑的编程问题。

## 综合问题

在多核系统中要实现一个位姿估计系统，软件上至少要实现 3 种类型的活动对象。一种是用于传感器采样，一种用于位姿估计器，一种用于使用位姿的应用。最终这是一个多线程/多进程的组合系统。

此外，从时间轴看，一个时间段内的传感器采样，在文献[25]中称为“融合时间范围”('fusion time horizon')，因为误差足够小，可以认为是同时采样，在一次估计的循环迭代中处理完。从多点位姿估计的角度看，使用文献[17]进行互相关的多点位姿估计。从长的时间序列看，使用文献[9]进行多速率多延迟的递推估计。

# 反例

对位姿估计问题的理解，是一步步深入理解和发展的。最早，当卡尔曼滤波器被发明出来后，是直接估计的表示姿态的四元数的，这类卡尔曼滤波器，被称为加性滤波器。很快，NASA 里的聪明人发现不对，旋转是群而不是向量，于是他们发明了乘性滤波器，就是误差状态卡尔曼滤波器，又称间接卡尔曼滤波器。但是长久以来，加性滤波器和乘性滤波器在实际项目中都工作正常。不得不说卡尔曼滤波器真是神奇的东西，够能容纳异类的。

卡尔曼滤波器有极强的适应能力。加性滤波器也应用了很长时间也没有出什么问题，否则大家早就发现问题并把它淘汰了。文献[25]，PX4 项目里的 ECL2 姿态估计器，在实现中考虑了很多工程细节，例如，如何处理测量的异常值，如何处理和切换传感器数据源，如何判断和处理系统的协方差异常情况等等。

位姿估计问题，包括卡尔曼滤波器，本质上是工程问题。工程上的一个小问题，就能轻易地让数学上的努力变得毫无作用。而加性滤波器似乎也没那么不堪。PX4 项目里的 ECL2 姿态估计器，就是对姿态四元数直接用 EKF 做估计，虽然它的 Jacobians 矩阵更加复杂且难以解释，但是它的估计精度不输于其它间接的估计器，也成功地在成千上万个无人机里得到应用。卡尔曼滤波器既神奇又有黑暗的角落，例如 Q & R 矩阵，调参似乎比数学更重要。所以这个世界，始终还是调参侠的天下。

# 文献列表

01. [Circumventing Dynamic Modeling: Evaluation of the Error-State Kalman Filter applied to Mobile Robot Localization - 1999](https://www.academia.edu/13385785/Circumventing_dynamic_modeling_Evaluation_of_the_error-state_kalman_filter_applied_to_mobile_robot_localization)
    + 规避动力学建模：应用于移动机器人定位的误差状态卡尔曼滤波器的评价

02. [Attitude Error Representations for Kalman Filtering - 2002](https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20020060647.pdf)
    + [Attitude Error Representations for Kalman Filtering - 2003](https://www.researchgate.net/publication/245432681_Attitude_Error_Representations_for_Kalman_Filtering)
    + 卡尔曼滤波的姿态误差表示

03. [Attitude estimation or quaternion estimation? - 2003](https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20030093641.pdf)
    + 姿态估计或四元数估计

04. [Multiplicative vs. Additive Filtering for Spacecraft Attitude Determination - 2004](https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20040037784.pdf)
    + [Multiplicative vs. Additive Filtering for Spacecraft Attitude Determination](https://www.researchgate.net/publication/260347976_Multiplicative_vs_Additive_Filtering_for_Spacecraft_Attitude_Determination)
    + 航天器姿态确定的乘法与加法滤波器的对比

05. [Indirect Kalman filter for 3D attitude estimation - 2007](http://mars.cs.umn.edu/tr/reports/Trawny05b.pdf)
    + 三维姿态估计的间接卡尔曼滤波

06. [Rigid Body Motion and the Euclidean Group - 2008](https://www.seas.upenn.edu/~meam620/notes/RigidBodyMotion3.pdf)
    + 刚体运动与欧几里德群

07. [Lessons Learned - F. Landis Markley - The Complexity of Constraints - 2009](https://www.researchgate.net/publication/257288674_Lessons_Learned)
    + 经验总结 - F. Landis Markley - 约束的复杂性
    
08. [Multiplicative Quaternion Extended Kalman Filtering for Nonspinning Guided Projectiles - 2013](https://apps.dtic.mil/sti/pdfs/ADA588831.pdf)
    + 非自旋制导弹体的乘性四元数扩展卡尔曼滤波

09. [Recursive Attitude Estimation in the Presence of Multi-rate and Multi-delay Vector Measurements - 2015](http://users.cecs.anu.edu.au/~trumpf/pubs/khosravian_trumpf_mahony_hamel_ACC2015.pdf)
    + 多速率多延迟向量测量下的递推姿态估计

10. [NXP® Sensor Fusion - 2016](https://www.nxp.com/support/developer-resources/software-development-tools/sensor-developer-resources/nxp-sensor-fusion:XTRSICSNSTLBOXX)
    + AN5017-航空航天、Android和Windows坐标系
    + AN5018-卡尔曼滤波基本理论
    + AN5021-根据传感器数据计算方向矩阵
    + AN5023-传感器融合卡尔曼滤波器

11. [Lie Groups for 2D and 3D Transformations - 2017](http://ethaneade.com/lie.pdf)
    + 二维和三维变换的李群

12. [Quaternion kinematics for the error-state KF - 2017](http://www.iri.upc.edu/people/jsola/JoanSola/objectes/notes/kinematics.pdf)
    + 误差状态卡尔曼滤波器的四元数动力学
    
13. [Sensor Fusion Implementation - 2017](http://www.telesens.co/category/sensor-fusion/)
    + 用Matlab code实现一个21个状态的CAMERA姿态的ESKF
    
14. [Orientation Estimation by Means of Extended Kalman Filter, Quaternions, and Charts - 2017](https://rua.ua.es/dspace/bitstream/10045/67917/8/JoPhA_08_01_03.pdf)
    + 用扩展卡尔曼滤波、四元数和图表估计方向

15. [On the Manifold: Representing Geometry in C++ for State Estimation - 2018](https://uwspace.uwaterloo.ca/handle/10012/14264)
    + 流形上的用C++表示几何的状态估计

16. [Kalman Filtering for Attitude Estimation with Quaternions and Concepts from Manifold Theory - 2019](https://www.mdpi.com/1424-8220/19/1/149/pdf)
    + 四元数姿态估计的卡尔曼滤波及流形理论的概念

17. [Characterizing the Uncertainty of Jointly Distributed Poses in the Lie Algebra - 2019](https://arxiv.org/abs/1906.07795)
    + 李代数中联合分布位姿不确定性的刻画
    
18. [A micro Lie theory for state estimation in robotics - 2020](https://arxiv.org/abs/1812.01537)
    + [A small header-only library for Lie theory](https://github.com/artivis/manif)
    + 微型Lie理论

19. [ESKF-tutorial - 2020](https://github.com/martiabr/ESKF-tutorial)
    + ESKF简介

20. [The Multiplicative Extended Kalman Filter - 2020](https://matthewhampsey.github.io/blog/2020/07/18/mekf)
    + 乘性扩展卡尔曼滤波器
    
21. [Relative multiplicative extended Kalman filter for observable GPS-denied navigation - 2020](https://scholarsarchive.byu.edu/facpub/1963/)
    + 用于GPS缺失时可观测的导航相对乘性扩展卡尔曼滤波

22. [Full-Order Solution to the Attitude Reset Problem for Kalman Filtering of Attitudes - 2020](https://arc.aiaa.org/doi/pdfplus/10.2514/1.G004134)
    + 姿态卡尔曼滤波中姿态重置问题的全阶解

23. [Kalman Filtering for Orientation Estimation using IMUs - 2020](https://digitum.um.es/digitum/bitstream/10201/95443/1/Pablo%20Bernal%20Polo%20Tesis%20Doctoral.pdf)
    + 基于IMU的Kalman滤波方向估计

24. [Reducing the uncertainty about the uncertainties - 2021](https://gtsam.org/2021/02/23/uncertainties-part1.html)
    + 减少不确定性的不确定性

25. [PX4: Estimation & Control Library for Guidance, Navigation and Control Applications - EKF - 2021](https://github.com/PX4/ecl/tree/master/EKF/documentation)


