#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass ctex-article
\begin_preamble
% 如果没有这一句命令，XeTeX会出错，原因参见
% http://bbs.ctex.org/viewthread.php?tid=60547
\DeclareRobustCommand\nobreakspace{\leavevmode\nobreak\ }

%\XeTeXlinebreaklocale "zh"
%\XeTeXlinebreakskip = 0pt plus 1pt
%\usepackage{setspace}
%\onehalfspacing
%\XeTeXinterchartokenstate=1

%\usepackage[utf8]{inputenc}

%\usepackage{polyglossia}
%\setdefaultlanguage[variant=american]{english}
%\setotherlanguage{french}
\end_preamble
\options UTF8,fontset=founder
\use_default_options true
\begin_modules
subequations
\end_modules
\maintain_unincluded_children false
\language chinese-simplified
\language_package default
\inputencoding utf8-plain
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts true
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures false
\graphics default
\default_output_format pdf4
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref true
\pdf_title "位姿估计问题应用李群的思路与直觉"
\pdf_author "Shuyong Chen"
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks true
\pdf_pdfborder false
\pdf_colorlinks false
\pdf_backref false
\pdf_pdfusetitle true
\papersize a4paper
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 25.4mm
\topmargin 30mm
\rightmargin 25.4mm
\bottommargin 30mm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
位姿估计问题应用李群的思路与直觉
\end_layout

\begin_layout Author
Shuyong Chen
\end_layout

\begin_layout Standard
\noindent
\align right
— 题记：简单的理论，应该用简单的直觉解释。 
\end_layout

\begin_layout Section
简介
\end_layout

\begin_layout Standard
将相关知识点都串起来，通过推导并理解公式，思考应用李群进行位姿估计的思路与直觉。是彩虹还是麻线团，各有所得。
\end_layout

\begin_layout Standard
Too Long ; Don't Read !
\end_layout

\begin_layout Part
数学知识与直觉
\end_layout

\begin_layout Section
前置基础知识
\end_layout

\begin_layout Standard
竹篮打水把所涉及的数学知识捞一捞，捞不起月亮也捞几个碎片，以便用得上。
\end_layout

\begin_layout Subsection
李群和流形的基本概念
\end_layout

\begin_layout Standard
对于李群的一个简短定义是：李群是一个群，也是一个光滑流形。李群以前又被称为 "连续变换群"。
\end_layout

\begin_layout Standard
群是代数结构概念。流形是几何拓扑概念。李群连接了两者，具有两者的特性。李群做为一个群，同样有“封结幺逆”的特性，就是：一个群(group 
\begin_inset Formula $\left(\mathcal{G},\circ\right)$
\end_inset

)是一个集合，
\begin_inset Formula $\mathcal{G}$
\end_inset

具有组合运算，
\begin_inset Formula $\circ$
\end_inset

，这个算子，对于元素
\begin_inset Formula $\mathcal{X},\mathcal{Y},\mathcal{Z}\in\mathcal{G}$
\end_inset

,满足下列公理，
\begin_inset Formula 
\[
\begin{array}{rl}
\text{封闭于}'\circ' & :\mathcal{X}\circ\mathcal{Y}\in\mathcal{G}\\
\text{幺元}\mathcal{E} & :\mathcal{E}\circ\mathcal{X}=\mathcal{X}\circ\mathcal{E}=\mathcal{X}\\
\text{逆元}\mathcal{X}^{-1} & :\mathcal{X}^{-1}\circ\mathcal{X}=\mathcal{X}\circ\mathcal{X}^{-1}=\mathcal{E}\\
\text{结合性} & :\left(\mathcal{X}\circ\mathcal{Y}\right)\circ\mathcal{Z}=\mathcal{X}\circ\left(\mathcal{Y}\circ\mathcal{Z}\right)
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
在一个李群 (Lie group) 中，流形在每一点上看起来都是一样的 (例如在球面的表面上)，并且因此在任何点上的所有切空间都是相同的。群结构要求流形元素的组
合保持在流形上，并且每个元素在流形中也有一个逆元。其中一 个特别的元素是幺元，并因此有一个特殊的切空间是幺元处的正切空间，我们称之为李群的李代
 数。李群结合了光滑流形的局部性质，使我们能够利用群的全局性质进行微积分，从而实现远处对象的非线性组合。
\end_layout

\begin_layout Standard
很容易验证，单位四元数和旋转矩阵的集合与乘法构成群。另外，和运动相关的变换矩阵的乘法也构成群。这些都是李群的一种：
\end_layout

\begin_layout Itemize
特殊正交群
\begin_inset Formula $\mathrm{SO}(n)$
\end_inset

：也就是旋转群。
\end_layout

\begin_layout Itemize
特殊欧氏群
\begin_inset Formula $\mathrm{SE}(n)$
\end_inset

：也就是运动群。其中包含了旋转和平移运动。
\end_layout

\begin_layout Standard
在这里我们只关注在二维和三维空间中的旋转群
\begin_inset Formula $\mathrm{SO}(2)/\mathrm{SO}(3)$
\end_inset

和运动群
\begin_inset Formula $\mathrm{SE}(2)/\mathrm{SE}(3)$
\end_inset

。对于流形，有两个特性需要关注：
\end_layout

\begin_layout Itemize
局部(local)
\end_layout

\begin_layout Itemize
收回(retraction)
\end_layout

\begin_layout Standard
后面所要讨论的指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

就是收回(retraction)操作。它允许我们精确地将局部(local)的切空间的元素变换到群上。直观地说，
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

将切空间的元素缠绕(wrap)在测地线(geodesic)所在的流形上 (就像将琴弦缠绕在球面上一样)。反向映射是
\begin_inset Formula $\log\left(\:\right)$
\end_inset

，即展开(unwrap)操作。在我们的案例中，所谓流形就只局限在二维的圆和三维的球面上。相应的李群的特性见下图(Rodrigues-02.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../01/Rodrigues-02.pdf
	scale 68

\end_inset


\end_layout

\begin_layout Subsection
问题的起因
\end_layout

\begin_layout Standard
一个很自然的直觉，三维空间的旋转用三维向量表示。常见的有欧拉角表示和轴角表示(旋转向量，Rotation Vector, RV)。但是，不论哪种三维向量表示，都
存在有奇点，并且插值不均匀，表示姿态有不连续的跳跃问题，这些问题大多与
\begin_inset Formula $\tan()$
\end_inset

函数相关。数学上已经证明，姿态估计的基本约束条件是姿态矩阵是旋转群或特殊正交群
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

的成员。这就是说姿态矩阵必须是行列式为
\begin_inset Formula $+1$
\end_inset

的正交矩阵的群理论方法。对三维空间旋转来说，最少需要
\begin_inset Formula $4$
\end_inset

个参数的表示方法，也就是四元数表示法，才能无奇点的、连续的、采样均匀地表示三维旋转。
\end_layout

\begin_layout Standard
用
\begin_inset Formula $4$
\end_inset

个以上的参数表示三维旋转，必然要引入约束。比如，四元数是
\begin_inset Formula $4$
\end_inset

个参数，所以要引入单位范数这个约束，使得单位四元数可以表示三维旋转。而旋转矩阵是
\begin_inset Formula $9$
\end_inset

个参数，所以要引入
\begin_inset Formula $6$
\end_inset

个约束，即
\begin_inset Formula $\boldsymbol{R}\boldsymbol{R}^{\mathrm{T}}=\boldsymbol{R}^{\mathrm{T}}\boldsymbol{R}=\boldsymbol{I},\det\left(\boldsymbol{R}\right)=1$
\end_inset

。约束的本质就是降维。这也使得单位四元数和旋转矩阵不是向量而是群，也就是人们常说的旋转群或特殊正交群
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

。
\end_layout

\begin_layout Standard
表示三维旋转的单位四元数和旋转矩阵不是向量而是群，因此和基于向量的优化方法产生冲突。因为最常用的姿态估计方法就是卡尔曼滤波器。但是卡尔曼滤波器最核心的概念是协方
差矩阵，里面有一个重要的假设就是估计状态是向量，计算协方差采用的是减法'-'。而三维旋转只能用群来表示，这就使得两者产生了冲突。
\end_layout

\begin_layout Standard
为从数学上解决这个问题，有必要引入李群。引入李群的动机主要有这几方面：
\end_layout

\begin_layout Itemize
它是适当的：在旋转和运动的非线性空间上进行严格的微积分(导数和积分)演算。
\end_layout

\begin_layout Itemize
它是强大的：在最小的空间里适当地处理不确定性、优化步骤、增量。
\end_layout

\begin_layout Itemize
它是抽象的：在不同的方案中(2D/3D、四元数与旋转矩阵、IMU预积分与里程表)，实施统一的概念。
\end_layout

\begin_layout Itemize
它是优美的！具有数学上的简洁统一的美感。
\end_layout

\begin_layout Standard
实际上最重要动机就是能对群元素能进行加减法运算，从而能复用向量空间中成熟的算法。因为群存在约束，非线性约束以及约束所定义的作用，使得有些算法直接在群元素上进行运
算很困难，甚至违反了约束。因此在数学上引入李群是必须的。
\end_layout

\begin_layout Subsection
图示表示说明
\end_layout

\begin_layout Standard
本文所采用的四元数为传统的Hamilton约定，但为方便软件操作，这里所采用的四元数的顺序和教科书上略有不同，虚部在前而实部在后，这样软件指针不需要改变就可以取
出虚部做为向量使用。因此单位四元数
\begin_inset Formula $q$
\end_inset


\begin_inset Formula 
\begin{align*}
q & =x\mathbf{i}+y\mathbf{j}+z\mathbf{k}+w\\
 & =\mathbf{q}+w
\end{align*}

\end_inset

可以表示三维空间的姿态。但是单位四元数
\begin_inset Formula $q$
\end_inset

要想用图形表示出来，也是一个困难的事情，因为单位四元数
\begin_inset Formula $q$
\end_inset

所在的球面是嵌入
\begin_inset Formula $\mathbb{R}^{4}$
\end_inset

空间中的
\begin_inset Formula $\mathrm{S}^{3}$
\end_inset

球面。因此只能用如下示意图(fig3d-11.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename fig3d-11.pdf

\end_inset


\end_layout

\begin_layout Standard
如果用旋转矩阵
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

则是如下示意图(fig3d-13.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename fig3d-13.pdf

\end_inset


\end_layout

\begin_layout Standard
这两种表示的差异在于单位四元数
\begin_inset Formula $q$
\end_inset

表示旋转是两倍覆盖，所以所表示的姿态点是在半个球面上移动。另外需要注意的是幺元，对于单位四元数
\begin_inset Formula $q$
\end_inset

的幺元是
\begin_inset Formula $\left[\begin{array}{cccc}
0 & 0 & 0 & 1\end{array}\right]$
\end_inset

，对于旋转矩阵
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

是单位矩阵
\begin_inset Formula $\boldsymbol{I}$
\end_inset

。还有一种方法是用类似复平面的方式表示(fig2d-32.pdf)：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename fig2d-32.pdf

\end_inset


\end_layout

\begin_layout Standard
其中，实数轴
\begin_inset Formula $w$
\end_inset

做为南北轴。因为单位四元数
\begin_inset Formula $q$
\end_inset

表示旋转是两倍覆盖，即
\begin_inset Formula $q$
\end_inset

与
\begin_inset Formula $-q$
\end_inset

代表同一个旋转，并且其共轭为其逆
\begin_inset Formula $q^{*}=q^{-1}$
\end_inset

，所以一般选择
\begin_inset Formula $w\geq0$
\end_inset

的北半球表示一个三维旋转。图中的角度
\begin_inset Formula $\theta$
\end_inset

代表的是
\begin_inset Formula 
\[
\tan\left(\theta\right)=\dfrac{\left\Vert \mathbf{q}\right\Vert }{w}
\]

\end_inset


\end_layout

\begin_layout Subsection
切空间与李代数
\end_layout

\begin_layout Standard
刚体的姿态
\begin_inset Formula $\boldsymbol{R}$
\end_inset

为李群流形
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

上移动的点，其变化速度
\begin_inset Formula $\dot{\boldsymbol{R}}=\partial\boldsymbol{R}/\partial t$
\end_inset

属于在当前点
\begin_inset Formula $\boldsymbol{R}$
\end_inset

处与
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

正切的空间。假设球面上的向量以角速度
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

匀速旋转，根据约束条件
\begin_inset Formula 
\[
\boldsymbol{R}\boldsymbol{R}^{\mathrm{T}}=\boldsymbol{I}
\]

\end_inset

两边取导数
\begin_inset Formula 
\[
\dfrac{\mathrm{d}}{\mathrm{d}t}\left\{ \boldsymbol{R}\boldsymbol{R}^{\mathrm{T}}\right\} =\dfrac{\mathrm{d}}{\mathrm{d}t}\boldsymbol{I}\rightarrow\dot{\boldsymbol{R}}\boldsymbol{R}^{\mathrm{T}}+\boldsymbol{R}\dot{\boldsymbol{R}}^{\mathrm{T}}=0
\]

\end_inset

这就是一个斜对称矩阵
\begin_inset Formula 
\[
\dot{\boldsymbol{R}}\boldsymbol{R}^{\mathrm{T}}=-\left(\dot{\boldsymbol{R}}\boldsymbol{R}^{\mathrm{T}}\right)^{\mathrm{T}}
\]

\end_inset

定义
\begin_inset Formula 
\[
\left[\boldsymbol{\omega}\times\right]=\dot{\boldsymbol{R}}\boldsymbol{R}^{\mathrm{T}}
\]

\end_inset

则旋转矩阵的导数(旋转运动的基本方程)为：
\begin_inset Formula 
\[
\dot{\boldsymbol{R}}=\left[\boldsymbol{\omega}\times\right]\boldsymbol{R}
\]

\end_inset

当
\begin_inset Formula $\boldsymbol{R}\left(0\right)=\boldsymbol{I}$
\end_inset

时的解为
\begin_inset Formula 
\[
\boldsymbol{R}=e^{\left[\boldsymbol{\omega}\times\right]t}
\]

\end_inset

其中
\begin_inset Formula $\left[\boldsymbol{\omega}\times\right]$
\end_inset

表示在切空间中的角速度。
\end_layout

\begin_layout Standard
我们在笛卡尔空间测量得到的角速度
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

为向量
\begin_inset Formula 
\[
\boldsymbol{\omega}=\left[\begin{array}{c}
\omega_{x}\\
\omega_{y}\\
\omega_{z}
\end{array}\right]
\]

\end_inset

关连到
\begin_inset Formula $\left[\boldsymbol{\omega}\times\right]$
\end_inset

这个斜对称矩阵则为
\begin_inset Formula 
\[
\left[\boldsymbol{\omega}\times\right]=\left[\begin{array}{ccc}
0 & -\omega_{z} & \omega_{y}\\
\omega_{z} & 0 & -\omega_{x}\\
-\omega_{y} & \omega_{x} & 0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
旋转在切空间中的导数，也就是在切空间中的角速度，对于三维空间为
\begin_inset Formula 
\[
\dot{\boldsymbol{R}}=\begin{cases}
\left[\boldsymbol{\omega}\times\right] & \text{if }\boldsymbol{R}=\boldsymbol{I}\\
\left[\boldsymbol{\omega}\times\right]\boldsymbol{R} & \text{exp map}
\end{cases}
\]

\end_inset

这是在全局(global)坐标系中的表示。对于局部(local)坐标系的表示为
\begin_inset Formula 
\begin{align*}
\dot{\boldsymbol{R}} & =\left[\boldsymbol{\omega}\times\right]\boldsymbol{R}\in\mathrm{SO}(3)
\end{align*}

\end_inset

也就是，一个流形的所有切空间的结构都相同，都是在幺元处的结构。因此，在幺元处的切空间被称为流形的李代数(Lie algebra)。对于三维空间的幺元，单位四元数
表示为
\begin_inset Formula $\left[\begin{array}{cccc}
0 & 0 & 0 & 1\end{array}\right]$
\end_inset

，旋转矩阵表示为
\begin_inset Formula $\boldsymbol{R}=\boldsymbol{I}$
\end_inset

。
\end_layout

\begin_layout Standard
流形的切空间具有这样的性质：
\end_layout

\begin_layout Itemize
一个李群的切空间的结构在任何地方都是相同的。
\end_layout

\begin_layout Itemize
切空间是一个向量空间。
\end_layout

\begin_layout Itemize
切空间的维度和所属的流形的自由度相同。
\end_layout

\begin_layout Itemize
在原点或幺元处的切空间被称为李代数。
\end_layout

\begin_layout Standard
我们更熟悉的三维向量空间是笛卡尔空间
\begin_inset Formula $\mathbb{R}^{3}$
\end_inset

。李代数空间和笛卡尔空间是同构的(isomorphism)。也就是，流形局部的切空间的切点是一个很特殊的地方。它既属于流形又属于切空间，在此建立原点的切空间有向
量空间性质，并且切空间的元素既可以变换到笛卡尔空间也可以变换到流形空间中。因此在切点处我们会涉及三种空间：
\end_layout

\begin_layout Itemize
笛卡尔空间
\begin_inset Formula $\mathbb{R}^{3}$
\end_inset

。这是我们最熟悉的三维向量空间。 
\end_layout

\begin_layout Itemize
切空间。这也是三维向量空间。笛卡尔空间的三维向量通过
\begin_inset Formula $3$
\end_inset

个生成元进入这个空间，形成
\begin_inset Formula $3\times3$
\end_inset

的斜对称矩阵结构。 
\end_layout

\begin_layout Itemize
流形空间。在切空间的向量使用加减法进行各种最优估计之后，使用指数映射函数
\begin_inset Formula $\exp()$
\end_inset

就进入了流形空间，这就是流形的收回(retraction)操作。
\end_layout

\begin_layout Standard
具体到我们的例子，我们在运动物体中放置IMU传感器测量角速度。所获得的角速度向量
\begin_inset Formula $\boldsymbol{\omega}=\left[\omega_{x},\omega_{y},\omega_{z}\right]^{\mathrm{T}}$
\end_inset

位于局部坐标系中的笛卡尔空间，经过Hat(
\begin_inset Formula $\wedge$
\end_inset

)算子的变换到切空间的角速度矩阵
\begin_inset Formula $\boldsymbol{\omega}^{\wedge}=\left[\boldsymbol{\omega}\times\right]$
\end_inset

，再通过指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

作用(action)到切点处的流形的元素上，于是在一定的时间
\begin_inset Formula $\Delta t$
\end_inset

里，流形中的元素就发生了旋转(对于旋转群来说)，或者伴随有位移(对于运动群来说)。反之，Vee(
\begin_inset Formula $\vee$
\end_inset

)算子则是逆向变换，将切空间的角速度向量变换回笛卡尔空间的向量，
\begin_inset Formula $\boldsymbol{\omega}=\left[\boldsymbol{\omega}\times\right]^{\vee}$
\end_inset

。
\end_layout

\begin_layout Subsection
指数映射与对数映射
\end_layout

\begin_layout Standard
指数映射
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

与对数映射
\begin_inset Formula $\log\left(\:\right)$
\end_inset

的精确定义可以参看参考资料。这里主要从几何上展示直观的概念。指数映射
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

允许我们精确地将李代数的元素变换到群上，一般称为收回 (retraction) 操 作。直观地说，
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

将切空间的元素缠绕在大圆弧(great arc)或测地线 (geodesic) 跟随的流形上 (就像将柔软的琴弦缠绕在球上一样，)。反向映射是
\begin_inset Formula $\log\left(\:\right)$
\end_inset

，即展开操作。
\end_layout

\begin_layout Standard
因为从笛卡尔空间
\begin_inset Formula $\mathbb{R}^{3}$
\end_inset

的向量通过生成元进入切空间，再通过指数映射
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

进入流形空间，公式写起来太麻烦，所以有必要定义一种快捷方式，就是大写的指数映射函数
\begin_inset Formula $\mathrm{Exp}\left(\:\right)$
\end_inset

和对数映射函数
\begin_inset Formula $\mathrm{Log}\left(\:\right)$
\end_inset

，其输入或输出为向量。结果见下表(Rodrigues-01.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../01/Rodrigues-01.pdf
	scale 48

\end_inset


\end_layout

\begin_layout Standard
将旋转向量 (Rotation Vector, RV)代入指数映射函数
\begin_inset Formula $\mathrm{Exp}\left(\:\right)$
\end_inset

就将其收回(retraction)到流形中。这种映射属于等距投影 (Equidistant)，
\begin_inset Formula $\mathrm{E}^{3}$
\end_inset

空间位于幺元
\begin_inset Formula $\left[\begin{array}{cccc}
0 & 0 & 0 & 1\end{array}\right]^{\mathrm{T}}$
\end_inset

处。注意，在四元数版本中使用的是半角
\begin_inset Formula $\boldsymbol{\theta}/2$
\end_inset

，但为了绘图方便，下图将
\begin_inset Formula $\mathrm{E}^{3}$
\end_inset

空间半径缩小了
\begin_inset Formula $1/2$
\end_inset

的大小(fig2d-31.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../01/fig2d-31.pdf

\end_inset


\end_layout

\begin_layout Standard
从上图可知，在三维笛卡尔向量空间中，向量是在一个半径
\begin_inset Formula $r=\pi$
\end_inset

的圆球内取值，并且当速度恒定的时候，由时间
\begin_inset Formula $\Delta t$
\end_inset

决定向量的模长。
\end_layout

\begin_layout Standard
为方便且直观地进行群元素与向量之间的运算，有必要引入加号
\begin_inset Formula $\oplus$
\end_inset

和减号
\begin_inset Formula $\ominus$
\end_inset

算子。针对矩阵表示的李群，我们有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
\text{Plus operator:} & \boldsymbol{\mathcal{X}}\oplus\boldsymbol{\theta} & \triangleq\boldsymbol{\mathcal{X}}\cdot\mathrm{Exp}\left(\boldsymbol{\theta}\right)\\
\text{Minus operator:} & \boldsymbol{\mathcal{Y}}\ominus\boldsymbol{\mathcal{X}} & \triangleq\mathrm{Log}\left(\boldsymbol{\mathcal{X}}^{-1}\cdot\mathcal{\boldsymbol{\mathcal{Y}}}\right)
\end{array}
\]

\end_inset

针对四元数表示的李群，因为是操作半角
\begin_inset Formula $\boldsymbol{\theta}/2$
\end_inset

，区别于前面定义的面向旋转矩阵运算的加号
\begin_inset Formula $\oplus$
\end_inset

和减号
\begin_inset Formula $\ominus$
\end_inset

算子，另外定义有两个类似的面向四元数运算的半角加减操作算子：
\begin_inset Formula $\boxplus$
\end_inset

和
\begin_inset Formula $\boxminus$
\end_inset

。通过指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

可以将向量
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

做为纯虚四元数直接一步映射为单位四元数，也用算子
\begin_inset Formula $\wedge:\mathbb{R}^{3}\rightarrow\mathbb{H}$
\end_inset

表示，相应的逆映射用算子
\begin_inset Formula $\vee:\mathbb{H}\rightarrow\mathbb{R}^{3}$
\end_inset

表示。旋转向量(RV)映射到单位四元数的方程为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{\theta}^{\wedge} & \triangleq\exp\left(\boldsymbol{\theta}\right)=\left[\begin{array}{c}
\cos\left(\dfrac{\left\Vert \boldsymbol{\theta}\right\Vert }{2}\right)\\
\dfrac{\boldsymbol{\theta}}{\left\Vert \boldsymbol{\theta}\right\Vert }\sin\left(\dfrac{\left\Vert \boldsymbol{\theta}\right\Vert }{2}\right)
\end{array}\right]\\
q^{\vee} & \triangleq\log\left(q\right)=2\mathrm{atan2}\left(\left\Vert \boldsymbol{q}\right\Vert ,q_{0}\right)\dfrac{\boldsymbol{q}}{\left\Vert \boldsymbol{q}\right\Vert }
\end{align*}

\end_inset

因此半角加减操作算子
\begin_inset Formula $\boxplus$
\end_inset

和
\begin_inset Formula $\boxminus$
\end_inset

定义为：
\begin_inset Formula 
\[
\begin{array}{rlll}
q^{\prime} & =q*\boldsymbol{\theta}^{\wedge} & =q*\exp\left(\boldsymbol{\theta}\right) & =q\boxplus\boldsymbol{\theta}\\
\boldsymbol{\theta} & =\left(q^{-1}*q^{\prime}\right)^{\vee} & =\log\left(q^{-1}*q^{\prime}\right) & =q^{\prime}\boxminus q
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
我们试图直观地执行如下操作(fig2d-16.pdf)：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../kalman/ESKF/notes/09/fig2d-16.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
具体执行的是：
\begin_inset Formula 
\begin{align*}
\mathcal{\boldsymbol{\mathcal{X}}}_{2} & =\boldsymbol{\mathcal{E}}\oplus\boldsymbol{\theta}_{1}\oplus\boldsymbol{\theta}_{2}\\
 & =\boldsymbol{\mathcal{E}}\cdot\mathrm{Exp}\left(\boldsymbol{\theta}_{1}\right)\cdot\mathrm{Exp}\left(\boldsymbol{\theta}_{2}\right)
\end{align*}

\end_inset

我们期望
\begin_inset Formula 
\[
\exp\left(\boldsymbol{\theta}_{1}^{\wedge}\right)\exp\left(\boldsymbol{\theta}_{2}^{\wedge}\right)=\exp\left(\left(\boldsymbol{\theta}_{1}+\boldsymbol{\theta}_{2}\right)^{\wedge}\right),
\]

\end_inset

因为函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

运算慢，我们期望在向量空间中将所有的向量一次加减完成而只算一次函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

。但是，这个等式成立的条件是
\begin_inset Formula $\boldsymbol{\theta}_{1}^{\wedge}\boldsymbol{\theta}_{2}^{\wedge}=\boldsymbol{\theta}_{2}^{\wedge}\boldsymbol{\theta}_{1}^{\wedge}$
\end_inset

。显然，对于矩阵乘法，
\begin_inset Formula $\boldsymbol{\theta}_{1}^{\wedge}\boldsymbol{\theta}_{2}^{\wedge}\neq\boldsymbol{\theta}_{2}^{\wedge}\boldsymbol{\theta}_{1}^{\wedge}$
\end_inset

，所以
\begin_inset Formula 
\[
\exp\left(\boldsymbol{\theta}_{1}^{\wedge}\right)\exp\left(\boldsymbol{\theta}_{2}^{\wedge}\right)\neq\exp\left(\left(\boldsymbol{\theta}_{1}+\boldsymbol{\theta}_{2}\right)^{\wedge}\right).
\]

\end_inset


\end_layout

\begin_layout Standard
Baker–Campbell–Hausdorff (BCH) 公式告诉我们，当处理两个矩阵之积时，它们会产生一些由李括号组成的余项。直观上的理解，我们在上式的两
端同时乘上单位矩阵
\begin_inset Formula $\boldsymbol{I}$
\end_inset

，方程左边，旋转向量
\begin_inset Formula $\boldsymbol{\theta}_{1}$
\end_inset

收回并作用到幺元上，于是姿态点从幺元出发，沿测地线到达新的姿态点，我们称之为
\begin_inset Formula $\mathcal{\boldsymbol{\mathcal{X}}}_{1}$
\end_inset

，接着旋转向量
\begin_inset Formula $\boldsymbol{\theta}_{2}$
\end_inset

收回并作用到
\begin_inset Formula $\mathcal{\boldsymbol{\mathcal{X}}}_{1}$
\end_inset

上，于是姿态点从
\begin_inset Formula $\boldsymbol{\mathcal{X}}_{1}$
\end_inset

出发，沿测地线到达新的姿态点，我们称之为
\begin_inset Formula $\boldsymbol{\mathcal{X}}_{2}$
\end_inset

，前后两条测地线的方向并不相同。如果我们直接从幺元出发，沿测地线到达
\begin_inset Formula $\boldsymbol{\mathcal{X}}_{2}$
\end_inset

姿态点，那么在流形上我们将看到球面上的一个三角形。注意，我们不能用
\begin_inset Formula $\log\left(\:\right)$
\end_inset

函数将前两条测地线展开(unwrap)到向量空间并相加，
\begin_inset Formula $\boldsymbol{\theta}_{1}+\boldsymbol{\theta}_{2}$
\end_inset

，这个运算不可行，这是因为局部切空间发生了切换，第二次旋转是在
\begin_inset Formula $\boldsymbol{\mathcal{X}}_{1}$
\end_inset

姿态点上建立局部切空间进行计算，而第一次和第三次旋转是在幺元处的切空间进行计算，两处局部切空间产生的差异就是那些余项。(fig3d-05.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename fig3d-05.pdf

\end_inset


\end_layout

\begin_layout Standard
但是通过分析BCH公式，当
\begin_inset Formula $\boldsymbol{\theta}_{1}$
\end_inset

或
\begin_inset Formula $\boldsymbol{\theta}_{2}$
\end_inset

为小量时，公式可以做一些近似化简，从上面的直观理解也可以看出，当有一个向量为小量时，剩下两个向量就很相近。因为在工程中，增量向量通常是小量，而原有的状态通常是大
的量，因此近似方程很常用。对于旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

的化简，还会涉及到全局或局部坐标系选择的问题。因此通常约定是，小量在右边叫右乘，表示从机体坐标系变换到惯性坐标系的旋转，用
\begin_inset Formula $\boldsymbol{R}_{B}^{I}$
\end_inset

表示，所以有
\begin_inset Formula 
\[
\boldsymbol{R}_{B}^{I}\left(\boldsymbol{\theta}_{1}\right)\boldsymbol{R}_{B}^{I}\left(\boldsymbol{\theta}_{2}\right)\approx\boldsymbol{R}_{B}^{I}\left(\boldsymbol{\theta}_{1}\right)\left(\boldsymbol{I}+\left[\boldsymbol{\theta}_{2}\times\right]\right),
\]

\end_inset

小量在左边叫左乘，表示从惯性坐标系变换到机体坐标系的旋转，用
\begin_inset Formula $\mathbf{R}_{I}^{B}$
\end_inset

表示，所以有
\begin_inset Formula 
\[
\boldsymbol{R}_{I}^{B}\left(\boldsymbol{\theta}_{1}\right)\boldsymbol{R}_{I}^{B}\left(\boldsymbol{\theta}_{2}\right)\approx\left(\boldsymbol{I}-\left[\boldsymbol{\theta}_{1}\times\right]\right)\mathbf{R}_{I}^{B}\left(\boldsymbol{\theta}_{2}\right),
\]

\end_inset

这些都是应用旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

当
\begin_inset Formula $\boldsymbol{\theta}\rightarrow0$
\end_inset

时的简化方程。
\end_layout

\begin_layout Subsection
几种常见的映射方法
\end_layout

\begin_layout Standard
在很多参考文献里，流形的收回(retraction)操作所选择指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

，或大写指数映射函数
\begin_inset Formula $\mathrm{Exp}\left(\:\right)$
\end_inset

的运算和常见的四元数形式关联为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\mathrm{Exp}\left(\boldsymbol{\theta}\right) & =\exp\left(\left[\boldsymbol{\theta}\times\right]\right)\\
 & =\cos\left(\theta/2\right)+\sin\left(\theta/2\right)\mathbf{u}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
其实这个收回(retraction)操作，在不同的论文和项目里，有不同的版本。这个
\begin_inset Formula $1/2$
\end_inset

系数，是因为四元数
\begin_inset Formula $\mathrm{S}^{3}$
\end_inset

流形对
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

是双倍覆盖。于是在旋转矩阵形式的版本中使用的是全角
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

，而在四元数版本中使用的是半角
\begin_inset Formula $\boldsymbol{\theta}/2$
\end_inset

。
\end_layout

\begin_layout Standard
此外，因为在工程中IMU的取样间隔时间
\begin_inset Formula $\Delta t$
\end_inset

很小，所以一般增量角度
\begin_inset Formula $\boldsymbol{\theta}=\boldsymbol{\omega}\Delta t$
\end_inset

都很小，所以都会应用三角函数小角度近似的方法。于是在不同的论文出现了下面几种映射方法，(正式的是前4种，后两种为近似值)：
\end_layout

\begin_layout Enumerate
正交投影 (Orthographic, O)
\end_layout

\begin_layout Enumerate
Rodrigues 参数 (Rodrigues Parameters, RP)
\end_layout

\begin_layout Enumerate
改进型 Rodrigues 参数 (Modified Rodrigues Parameters, MRP) 
\end_layout

\begin_layout Enumerate
旋转向量 (Rotation Vector, RV)
\end_layout

\begin_layout Enumerate
二阶近似值(second-order approximation)。上述4种方法的二阶近似值。
\end_layout

\begin_layout Enumerate
一阶近似值(first-order approximation)。上述4种方法的一阶近似值。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
O
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(\begin{array}{c}
\sqrt{1-\left\Vert \boldsymbol{\theta}\right\Vert ^{2}/4}\\
\boldsymbol{\theta}/2
\end{array}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RP
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\dfrac{1}{\sqrt{4+\left\Vert \boldsymbol{\theta}\right\Vert ^{2}}}\left(\begin{array}{c}
2\\
\boldsymbol{\theta}
\end{array}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
MRP
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\dfrac{1}{16+\left\Vert \boldsymbol{\theta}\right\Vert ^{2}}\left(\begin{array}{c}
16-\left\Vert \boldsymbol{\theta}\right\Vert ^{2}\\
8\boldsymbol{\theta}
\end{array}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RV
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(\begin{array}{c}
\cos\left(\boldsymbol{\theta}/2\right)\\
\left(\boldsymbol{\theta}/\left\Vert \boldsymbol{\theta}\right\Vert \right)\sin\left(\boldsymbol{\theta}/2\right)
\end{array}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2nd
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(\begin{array}{c}
1-\left\Vert \boldsymbol{\theta}\right\Vert ^{2}/8\\
\boldsymbol{\theta}/2
\end{array}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
6
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1st
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(\begin{array}{c}
1\\
\boldsymbol{\theta}/2
\end{array}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
前三种是我们所知道的球极平面投影 (stereographic projection){这三种投影分别具体称为正交投影 (Orthographic)、日晷投影
 (Gnomonic) 和球极平面投影 (Stereographic)}。最后是所谓的等距投影 (Equidistant)。下面我们通过图形理解这些映射。
\end_layout

\begin_layout Standard
第一种，正交投影 (Orthographic)，其中
\begin_inset Formula $\mathrm{E}^{3}$
\end_inset

空间在
\begin_inset Formula $r\in\left[0,1\right]$
\end_inset

之间截取投影(fig2d-21.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../kalman/ESKF/notes/09/fig2d-21.pdf

\end_inset


\end_layout

\begin_layout Standard
第二种，Rodrigues 参数 (Rodrigues Parameters, RP)，又称Gibbs向量。这是
\begin_inset CommandInset href
LatexCommand href
name "Dr. F. Landis Markley"
target "http://www.acsu.buffalo.edu/~johnc/markley/"
literal "false"

\end_inset

的最爱，因为它是单映射，
\begin_inset Formula $+q$
\end_inset

和
\begin_inset Formula $-q$
\end_inset

都映射到同一个Gibbs向量，对于同一个旋转来说，这是
\begin_inset Formula $1:1$
\end_inset

表示。并且因为
\begin_inset Formula $\tan\left(\:\right)$
\end_inset

函数和高斯分布有一点点相像，就是两端有无限长尾。所以(NASA)大佬们的论文里更喜欢选择这个映射。在文献[2]里也偏向采用这种映射。这种映射属于日晷投影
 (Gnomonic)，
\begin_inset Formula $\mathrm{E}^{3}$
\end_inset

空间位于
\begin_inset Formula $r=1$
\end_inset

，通过圆心的两个单位四元数投影到同一个Gibbs向量 (fig2d-22.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../kalman/ESKF/notes/09/fig2d-22.pdf

\end_inset


\end_layout

\begin_layout Standard
第三种，改进型 Rodrigues 参数 (Modified Rodrigues Parameters, MRP)。这种映射与旋转向量映射有许多共同的特点，包括
离散跳跃的需求，但又避免了超越函数。这种映射属于球极平面投影 (Stereographic)，
\begin_inset Formula $\mathrm{E}^{3}$
\end_inset

空间位于
\begin_inset Formula $r=0$
\end_inset

，
\begin_inset Formula $\mathrm{S}^{3}$
\end_inset

的一个半球在三维
\begin_inset Formula $\mathbf{p}$
\end_inset

空间中投射到单位球体的内部，而
\begin_inset Formula $\mathrm{S}^{3}$
\end_inset

的另一个半球则投射到单位 
\begin_inset Formula $\mathbf{p}$
\end_inset

−sphere 的外部。(fig2d-23.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../kalman/ESKF/notes/09/fig2d-23.pdf

\end_inset


\end_layout

\begin_layout Standard
第四种，旋转向量 (Rotation Vector, RV)。实际上就是指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

，在旋转矩阵形式的版本中使用的是全角
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

，而在四元数版本中使用的是半角
\begin_inset Formula $\boldsymbol{\theta}/2$
\end_inset

。这种映射属于等距投影 (Equidistant)，
\begin_inset Formula $\mathrm{E}^{3}$
\end_inset

空间位于幺元处，并且在矩阵版本中向量的模长和测地线(geodesic)的弧长是
\begin_inset Formula $1:1$
\end_inset

关系(fig2d-24.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../kalman/ESKF/notes/09/fig2d-25.pdf

\end_inset


\end_layout

\begin_layout Standard
之所以同时存在这么多种映射关系，这往往体现了不同理论之间，还有理论和工程之间的差异。
\end_layout

\begin_layout Standard
如果说前三种映射关系是第四种的某种近似，因为这四种映射关系在零点附近的小角度情况下数值很接近，但大角度之后就明显不再是球面。如果球面是完美模型，选择前三种映射关
系可能是因为某种原因，例如选择正交投影 (Orthographic)是因为它可以简单地把单位四元数转换为轴-角向量，选择Rodrigues参数(RP)是因为它是
单映射，选择改进型Rodrigues参数(MRP)是因为它避免了超越函数的运算。此外，因为在工程中IMU的取样间隔时间
\begin_inset Formula $\Delta t$
\end_inset

很小，所以一般增量角度
\begin_inset Formula $\boldsymbol{\theta}=\boldsymbol{\omega}\Delta t$
\end_inset

都很小，所以都会应用三角函数小角度近似的方法。
\end_layout

\begin_layout Subsection
伴随与伴随矩阵
\end_layout

\begin_layout Standard
位姿元素形成一个群，它们之间只有乘法操作。因为矩阵乘法不可交换，所以坐标系的选择会影响乘法的顺序。
\end_layout

\begin_layout Standard
旋转矩阵有3种用途：
\end_layout

\begin_layout Enumerate
表示姿态；
\end_layout

\begin_layout Enumerate
进行坐标系变换，通过向量或坐标系来表示；
\end_layout

\begin_layout Enumerate
对向量或坐标系进行旋转变换。
\end_layout

\begin_layout Standard
位姿变换矩阵同样有3种用途：
\end_layout

\begin_layout Enumerate
表示刚体的位姿(位置和姿态)；
\end_layout

\begin_layout Enumerate
进行坐标系变换，通过向量或坐标系来表示；
\end_layout

\begin_layout Enumerate
表示向量或坐标系的位移。
\end_layout

\begin_layout Standard
在以上这些运算中，矩阵与向量的乘法比较容易理解，不会弄错。如果是两个矩阵相乘，哪个代表当前姿态或位姿，哪个代表运动变换，则容易搞混，所以有必要澄清一下。
\end_layout

\begin_layout Standard
如果有姿态矩阵
\begin_inset Formula $\mathbf{R}_{sb}$
\end_inset

表示
\begin_inset Formula $\left\{ b\right\} $
\end_inset

相对于
\begin_inset Formula $\left\{ s\right\} $
\end_inset

的姿态，并有将
\begin_inset Formula $\left\{ b\right\} $
\end_inset

围绕在
\begin_inset Formula $\left\{ s\right\} $
\end_inset

中的单位旋转轴
\begin_inset Formula $\hat{\boldsymbol{\omega}}_{s}$
\end_inset

旋转角度
\begin_inset Formula $\theta$
\end_inset

的运动，表示为
\begin_inset Formula $\mathbf{R}=\mathrm{Rot}\left(\hat{\boldsymbol{\omega}}_{s},\theta\right)$
\end_inset

。新的姿态
\begin_inset Formula $\mathbf{R}_{sb}^{\prime}$
\end_inset

计算为
\begin_inset Formula 
\begin{align*}
\mathbf{R}_{sb}^{\prime} & =\begin{cases}
\mathbf{R}\mathbf{R}_{sb} & \text{premultiply, rotate by \ensuremath{\mathbf{R}} in \ensuremath{\left\{ s\right\} } frame}\\
\mathbf{R}_{sb}\mathbf{R}^{-1} & \text{postmultiply, rotate by \ensuremath{\mathbf{R}^{-1}} in \ensuremath{\left\{ b\right\} } frame}
\end{cases}\\
\hat{\boldsymbol{\omega}}_{b} & =\mathbf{R}^{-1}\hat{\boldsymbol{\omega}}_{s}\\
\mathbf{R}^{-1} & =\mathrm{Rot}\left(\hat{\boldsymbol{\omega}}_{b},\theta\right)
\end{align*}

\end_inset

也就是，左乘
\begin_inset Formula $\mathbf{R}=\mathrm{Rot}\left(\hat{\boldsymbol{\omega}}_{s},\theta\right)$
\end_inset

会得到绕参考坐标系中的转轴
\begin_inset Formula $\hat{\boldsymbol{\omega}}_{s}$
\end_inset

的转动，右乘
\begin_inset Formula $\mathbf{R}^{-1}=\mathrm{Rot}\left(\hat{\boldsymbol{\omega}}_{b},\theta\right)$
\end_inset

会得到绕机体坐标系中的转轴
\begin_inset Formula $\hat{\boldsymbol{\omega}}_{b}$
\end_inset

的转动。两者可以表达空间中的同一个转动。
\end_layout

\begin_layout Standard
同样的，用位姿矩阵
\begin_inset Formula $\mathbf{T}_{sb}$
\end_inset

表示
\begin_inset Formula $\left\{ b\right\} $
\end_inset

相对于
\begin_inset Formula $\left\{ s\right\} $
\end_inset

的位姿，并用位姿齐次变换矩阵
\begin_inset Formula $\mathbf{T}=\left(\mathbf{R},\mathbf{r}\right)$
\end_inset

表示对位姿
\begin_inset Formula $\mathbf{T}_{sb}$
\end_inset

的作用。新的位姿
\begin_inset Formula $\mathbf{T}_{sb}^{\prime}$
\end_inset

计算为
\begin_inset Formula 
\[
\mathbf{T}_{sb}^{\prime}=\begin{cases}
\mathbf{T}\mathbf{T}_{sb} & \text{premultiply, transform by \ensuremath{\mathbf{T}} in \ensuremath{\left\{ s\right\} } frame}\\
\mathbf{T}_{sb}\mathbf{T}^{-1} & \text{postmultiply, transform by \ensuremath{\mathbf{T}^{-1}} in \ensuremath{\left\{ b\right\} } frame}
\end{cases}
\]

\end_inset


\end_layout

\begin_layout Standard
在这里的左乘和右乘与上面有相似的意义。因为从附着在机体中的传感器获得的测量值为机体坐标系中的数值，
\begin_inset Formula $\boldsymbol{\omega}_{b}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{b}$
\end_inset

，这时计算出来的是
\begin_inset Formula $\mathbf{R}_{b}$
\end_inset

和
\begin_inset Formula $\mathbf{T}_{b}$
\end_inset

，所以在工程中右乘用得较多一些。
\end_layout

\begin_layout Standard
空间坐标系中的元素与机体坐标系中的元素要相互转换，就需要用到伴随矩阵(adjoint matrix)。我们可以用下面的例子理解伴随矩阵的作用。在流形中的元素
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

如何变换到
\begin_inset Formula $\mathcal{\boldsymbol{\mathcal{Y}}}$
\end_inset

?(adj-01.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename adj-01.pdf

\end_inset


\end_layout

\begin_layout Standard
我们有两种路径实现这个变换，第一种是在
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

点处建立局部切空间，并在其中计算增量，然后将增量用指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

收回到流形中，并将其右乘到
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

点上，则
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

点的元素就沿着测地线移动到
\begin_inset Formula $\mathcal{\mathcal{\boldsymbol{\mathcal{Y}}}}$
\end_inset

点。因为局部切空间处处相同，所以增量是相对于参考坐标系定义的，但它们不需要指定结果坐标系。(adj-02.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename adj-02.pdf

\end_inset


\end_layout

\begin_layout Standard
第二种是
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

点不动，而移动全局坐标系，也就是移动幺元
\begin_inset Formula $\boldsymbol{\mathcal{E}}$
\end_inset

，在新坐标系中
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

点就描述为
\begin_inset Formula $\mathcal{\mathcal{\boldsymbol{\mathcal{Y}}}}$
\end_inset

点，这就是左乘。(adj-03.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename adj-03.pdf

\end_inset


\end_layout

\begin_layout Standard
这两者的关系就是伴随变换(adj-04.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename adj-04.pdf
	scale 60

\end_inset


\end_layout

\begin_layout Standard
伴随变换大多应用于将一处切空间中的向量变换到另一处切空间中。
\end_layout

\begin_layout Standard
常见李群的伴随矩阵的作用关系见下表：(screw-table2.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../01/screw-table2.pdf
	scale 50

\end_inset


\end_layout

\begin_layout Subsection
流形中的不确定性
\end_layout

\begin_layout Standard
收回(retraction)是定义流形不确定性的基本概念。因为直接在流形上定义不确定性比较麻烦，并且难以计算。一般的想法是，我们可以定义切空间上的分布，并使用收
回将它们映射回流形上。例如，我们可以在以
\begin_inset Formula $\mathbf{p}_{1}$
\end_inset

为中心的切空间中定义一个零均值的高斯变量
\begin_inset Formula $\eta\sim Gaussian(\mathbf{0}_{n\times1},\Sigma)$
\end_inset

，并使用收回：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
Gaussian(\mathbf{p}_{1},\boldsymbol{\eta}) & :=\text{retract}_{\mathbf{p}_{1}}(\boldsymbol{\eta})\\
 & =\mathbf{p}_{1}\,\mathrm{Exp}\left(\boldsymbol{\eta}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
通过收回，我们可以在以
\begin_inset Formula $\mathbf{p}_{1}$
\end_inset

为中心的切空间上定义高斯分布，并将它们映射回流形上，从而在具有均值
\begin_inset Formula $\mathbf{p}_{1}$
\end_inset

和协方差
\begin_inset Formula $\text{Cov}(\boldsymbol{\eta})=\boldsymbol{\Sigma}$
\end_inset

的流形上构造高斯分布。通过这样的定义，我们可以重新获取当前线性化点的高斯分布。
\end_layout

\begin_layout Standard
与上面一致，我们选择在右侧的收回作用。也是为了统一使用右乘的形式，根据各个公式的特点，我们将使用李群伴随的概念，将应用在右侧的增量或校正，与左侧的增量或校正联系
起来。这样的性质将允许我们用代数方法处理李群定义的不确定性，并获得不同协方差变换的表达式。我们将集中讨论3D位姿，即
\begin_inset Formula $\text{SE(3)}$
\end_inset

，因为它具有广泛的适用性，但是类似的定义也应该适用于其它李群，因为它们主要依赖于伴随的定义。
\end_layout

\begin_layout Standard
传播不确定性有位姿组合(Pose Composition)、位姿求逆(Pose Inverse)和相对位姿(Relative Pose)这三种操作。假设位姿是独
立的或是相关的，有两种类似的推导。对于位姿相关的公式的推导，需要用到BCH公式的四阶交叉项的展开式，复杂很多，精度会有提高，参见参考文献[3,5]。最后可以根据
精度和计算量的要求进行选择。(adj-table.pdf)
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename adj-table.pdf
	scale 82

\end_inset


\end_layout

\begin_layout Section
应用李群的基本思路
\end_layout

\begin_layout Subsection
坐标系
\end_layout

\begin_layout Standard
表示姿态的单位四元数
\begin_inset Formula $q$
\end_inset

是嵌入
\begin_inset Formula $\mathbb{R}^{4}$
\end_inset

空间中的
\begin_inset Formula $\mathrm{S}^{3}$
\end_inset

球面，球面上的每一个点都可以构建三维空间。这种球面在我们的三维世界里看不到，虽然比喻和事实必然有差异，但我们可以用篮球比喻这种
\begin_inset Formula $\mathrm{S}^{3}$
\end_inset

球面。机体的任意姿态都是在这种球面上的点。姿态变化，则当前姿态点就在球面上移动。
\end_layout

\begin_layout Standard
要研究姿态，我们首先要建立坐标系。那么抛开外部定义的坐标系，我们能不能根据球面自身的特性研究机体的运动？答案是肯定的，我们可以用李群的方法分析和解决问题。我们首
先在幺元上的切空间建立全局坐标系，又称原点坐标系，其它点的切空间为局部坐标系。因为李群是光滑流形，切空间是线性空间，并且其结构处处相同，都是幺元处的结构。
\end_layout

\begin_layout Standard
因为切空间是线性空间，所以可以复用各种成熟的线性优化算法，比如卡尔曼滤波算法。而附着在机体上的IMU传感器，其所获得的是局部的笛卡尔坐标系数据，这些数据用生成元
变换到切空间中参与计算。最终计算所得的向量或矩阵，通过指数映射函数
\begin_inset Formula $\exp\left(\:\right)$
\end_inset

的变换，就进入流形空间中。虽然该对象是相对于参考坐标系定义的，但因为切空间的结构处处相同，所以它们不需要指定结果坐标系就可以进行计算，它们只需要作用到当前姿态点
上，则当前姿态点就移动到新的姿态上，所走的路径为测地线，这种运动就是旋转。
\end_layout

\begin_layout Standard
那么在幺元处这个原点坐标系和外部定义的全局坐标系有什么关系呢？
\end_layout

\begin_layout Standard
如果我们以重力向量做为观测向量进行递归校正，则在幺元处的原点坐标系的一个轴就与重力向量平行，因而校正出以重力向量为法向量的当地水平面，但是因为没有其它校正数据，
该水平面还可以绕重力向量旋转，因此不能校正出北/东方向。如果我们以磁力计或以GPS类的全局数据进行递归校正，则可以进一步校正出北/东方向。也就是通过递归校正，在
幺元处的原点坐标系与当地的北/东/地的全局坐标系重合，因此附着在机体上的IMU测量得到的局部坐标系的数据，通过伴随矩阵变换到在幺元处的原点坐标系，就得到机体相对
于当地的北/东/地的全局坐标系的姿态。
\end_layout

\begin_layout Subsection
研究对象
\end_layout

\begin_layout Standard
目前应用李群的算法直接处理的对象，大多是扰动、增量、误差等等这种小量。因为要无奇点地表示三维空间中的旋转群
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

和运动群
\begin_inset Formula $\mathrm{SE}(3)$
\end_inset

，就有过度参数化的问题，需要施加约束，则只有乘法是封闭的。但是当数据采样频率足够快时，噪声扰动、增量或误差等等这些小量足够小，就在零点附近抖动，此时它们的性质近
线性，并且远离奇点，所以可以用向量表示。并且我们假定位姿的变化是随机过程，是增量或误差这些小量的变化符合高斯分布。
\end_layout

\begin_layout Standard
借助于计算机的快速运算，我们是用递归方法求解问题。因此我们很自然地把所要求解的状态量分为大的标称量和小的增量两个部分。对于线性系统，在
\begin_inset Formula $i$
\end_inset

时刻的外推状态向量
\begin_inset Formula $\bar{\boldsymbol{x}}_{i}$
\end_inset

由上一时刻的最优估计的状态向量
\begin_inset Formula $\hat{\boldsymbol{x}}_{i-1}$
\end_inset

和当前时刻的真实增量
\begin_inset Formula $\Delta\boldsymbol{x}_{i}$
\end_inset

，以及测量噪声
\begin_inset Formula $\boldsymbol{N}_{i}$
\end_inset

组合而成
\begin_inset Formula 
\[
\bar{\boldsymbol{x}}_{i}=\hat{\boldsymbol{x}}_{i-1}+\Delta\boldsymbol{x}_{i}+\boldsymbol{N}_{i}
\]

\end_inset


\end_layout

\begin_layout Standard
但是旋转群和运动群不能用加法，只能用乘法，因此对于我们要估计的位于李群中的状态
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

，上式变为
\begin_inset Formula 
\[
\bar{\boldsymbol{\mathcal{X}}}_{i}=\hat{\boldsymbol{\mathcal{X}}}_{i-1}\times\Delta\boldsymbol{\mathcal{X}}_{i}\times\boldsymbol{N}_{i}
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{N}_{i}$
\end_inset

是由噪声向量变换来的噪声矩阵。虽然在测量增量
\begin_inset Formula $\Delta\bar{\boldsymbol{\mathcal{X}}}_{i}=\Delta\boldsymbol{\mathcal{X}}_{i}\times\boldsymbol{N}_{i}$
\end_inset

中的噪声无法分离，但我们可以根据传感器的噪声方差
\begin_inset Formula $\boldsymbol{\eta}$
\end_inset

估计出最优误差
\begin_inset Formula $\delta\boldsymbol{\mathcal{X}}_{i}=\mathrm{Exp}\left(\mathrm{function}\left(\boldsymbol{\eta}\right)\right)$
\end_inset

，将其作用到外推状态
\begin_inset Formula $\bar{\boldsymbol{\mathcal{X}}}_{i}$
\end_inset

上以消除误差，则当前状态
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{i}$
\end_inset

为最优估计，也就是在现有条件下最接近真实值
\begin_inset Formula $\boldsymbol{\mathcal{X}}_{i}$
\end_inset

的值。用新的符号表示就是
\begin_inset Formula 
\[
\hat{\boldsymbol{\mathcal{X}}}_{i}=\hat{\boldsymbol{\mathcal{X}}}_{i-1}\oplus\Delta\bar{\boldsymbol{\mathcal{X}}}_{i}\oplus\delta\boldsymbol{\mathcal{X}}_{i}
\]

\end_inset


\end_layout

\begin_layout Standard
我们是在局部切空间中计算
\begin_inset Formula $\Delta\bar{\boldsymbol{\mathcal{X}}}_{i}$
\end_inset

和
\begin_inset Formula $\delta\boldsymbol{\mathcal{X}}_{i}$
\end_inset

这些小量，因为IMU传感器的数值及其噪声是在局部笛卡尔坐标系中测量得到，所以这些数据需要用生成元变换到局部切空间中以计算
\begin_inset Formula $\Delta\bar{\boldsymbol{\mathcal{X}}}_{i}$
\end_inset

和
\begin_inset Formula $\delta\boldsymbol{\mathcal{X}}_{i}$
\end_inset

。因为当前状态
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{i}$
\end_inset

已经最优估计，所以当前误差及其协方差需要重置操作。
\end_layout

\begin_layout Subsection
研究方法
\end_layout

\begin_layout Standard
这些基于高斯分布的最优估计，大多是某种递归的非线性最小二乘法。根据我们所认为的系统的非线性的程度不同，根据我们所要的精度和算力的平衡，我们可以选择标准卡尔曼滤波
器，EKF，UKF，粒子滤波器或因子图等等最优算法估计机体的位姿状态。
\end_layout

\begin_layout Standard
对于最小二乘法的理解，它是对超定方程组
\begin_inset Formula $A\boldsymbol{x}=\boldsymbol{b}$
\end_inset

的一个最优近似解
\begin_inset Formula $\hat{\boldsymbol{x}}$
\end_inset

。我们可以基于矩阵的QR分解去直观地理解最小二乘法：
\end_layout

\begin_layout Itemize
矩阵
\begin_inset Formula $A\in\boldsymbol{R}^{m\times n},\ m>n$
\end_inset

，是满秩，瘦型矩阵。
\end_layout

\begin_layout Itemize
将其进行QR分解，
\begin_inset Formula $A=QR$
\end_inset

，其中
\begin_inset Formula $Q^{\mathrm{T}}Q=I$
\end_inset

，并且
\begin_inset Formula $R\in\boldsymbol{R}^{n\times n}$
\end_inset

为上三角矩阵且可逆。
\end_layout

\begin_layout Itemize
伪逆矩阵为
\begin_inset Formula 
\[
\left(A^{\mathrm{T}}A\right)^{-1}A^{\mathrm{T}}=\left(R^{\mathrm{T}}Q^{\mathrm{T}}QR\right)^{-1}R^{\mathrm{T}}Q^{\mathrm{T}}=R^{-1}Q^{\mathrm{T}}
\]

\end_inset

所以
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}=R^{-1}Q^{\mathrm{T}}\boldsymbol{b}
\]

\end_inset


\end_layout

\begin_layout Itemize
投影到
\begin_inset Formula $A$
\end_inset

的列空间
\begin_inset Formula $C(A)$
\end_inset

中的矩阵为
\begin_inset Formula 
\[
A\left(A^{\mathrm{T}}A\right)^{-1}A^{\mathrm{T}}=AR^{-1}Q^{\mathrm{T}}=QQ^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Itemize
矩阵
\begin_inset Formula $A$
\end_inset

的完全QR因子分解为：
\begin_inset Formula 
\[
A=\left[\begin{array}{cc}
Q_{1} & Q_{2}\end{array}\right]\left[\begin{array}{c}
R_{1}\\
0
\end{array}\right]
\]

\end_inset

其中，
\begin_inset Formula $\left[\begin{array}{cc}
Q_{1} & Q_{2}\end{array}\right]\in\boldsymbol{R}^{m\times m}$
\end_inset

且为正交矩阵，
\begin_inset Formula $R_{1}\in\boldsymbol{R}^{n\times n}$
\end_inset

为上三角矩阵且可逆。
\end_layout

\begin_layout Itemize
与正交矩阵相乘不改变矩阵范数，所以
\begin_inset Formula 
\begin{align*}
\left\Vert A\boldsymbol{x}-\boldsymbol{b}\right\Vert ^{2} & =\left\Vert \left[\begin{array}{cc}
Q_{1} & Q_{2}\end{array}\right]\left[\begin{array}{c}
R_{1}\\
0
\end{array}\right]\boldsymbol{x}-\boldsymbol{b}\right\Vert ^{2}\\
 & =\left\Vert \left[\begin{array}{cc}
Q_{1} & Q_{2}\end{array}\right]^{\mathrm{T}}\left[\begin{array}{cc}
Q_{1} & Q_{2}\end{array}\right]\left[\begin{array}{c}
R_{1}\\
0
\end{array}\right]\boldsymbol{x}-\left[\begin{array}{cc}
Q_{1} & Q_{2}\end{array}\right]^{\mathrm{T}}\boldsymbol{b}\right\Vert ^{2}\\
 & =\left\Vert \left[\begin{array}{c}
R_{1}\boldsymbol{x}-Q_{1}^{\mathrm{T}}\boldsymbol{b}\\
-Q_{2}^{\mathrm{T}}\boldsymbol{b}
\end{array}\right]\right\Vert ^{2}\\
 & =\left\Vert R_{1}\boldsymbol{x}-Q_{1}^{\mathrm{T}}\boldsymbol{b}\right\Vert ^{2}+\left\Vert Q_{2}^{\mathrm{T}}\boldsymbol{b}\right\Vert ^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Itemize
这显然可以通过选择最小化
\begin_inset Formula $\hat{\boldsymbol{x}}$
\end_inset

，即上式左边第一项为
\begin_inset Formula $0$
\end_inset

：
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}=R_{1}^{-1}Q_{1}^{\mathrm{T}}\boldsymbol{b}
\]

\end_inset


\end_layout

\begin_layout Itemize
则
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的最优化的残差为
\begin_inset Formula 
\[
\boldsymbol{\epsilon}=A\hat{\boldsymbol{x}}-\boldsymbol{b}=-Q_{2}Q_{2}^{\mathrm{T}}\boldsymbol{b}
\]

\end_inset


\end_layout

\begin_layout Itemize
矩阵
\begin_inset Formula $Q_{1}Q_{1}^{\mathrm{T}}$
\end_inset

给出了到
\begin_inset Formula $A$
\end_inset

的列空间
\begin_inset Formula $C(A)$
\end_inset

中的的投影。
\end_layout

\begin_layout Itemize
矩阵
\begin_inset Formula $Q_{2}Q_{2}^{\mathrm{T}}$
\end_inset

给出了到列空间的正交空间
\begin_inset Formula $C(A)^{\perp}$
\end_inset

，即
\begin_inset Formula $A^{\mathrm{T}}$
\end_inset

的零空间
\begin_inset Formula $N(A^{\mathrm{T}})$
\end_inset

的投影。
\end_layout

\begin_layout Itemize
列空间
\begin_inset Formula $C(A)$
\end_inset

的满秩为
\begin_inset Formula $n$
\end_inset

，则零空间
\begin_inset Formula $N(A^{\mathrm{T}})$
\end_inset

的秩为
\begin_inset Formula $m-n$
\end_inset

，两者的秩之和为
\begin_inset Formula $m$
\end_inset

。
\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
上述关系的示意图如下：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../LinearAlgebra/notes/02/Least-squares-01.pdf

\end_inset


\end_layout

\begin_layout Standard
接着是对带权重的最小二乘法的理解。我们假定数据按照高斯分布，并且系统噪声为零均值的白高斯噪声。是测量传感器的噪声方差将白化数据变成了一个椭球。噪声协方差矩阵中的
特征向量指示了数据扩散的方向，特征值指示了扩散的程度。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ../../../LinearAlgebra/notes/02/covariance-matrix-02.pdf

\end_inset


\end_layout

\begin_layout Standard
因为各轴的方差不一样，因此各轴的数据扩散程度也不一样，体现在数据刻度不一样。这时直接在这样的数据集合上进行估计并不是最优估计。因此我们需要引入权重矩阵
\begin_inset Formula $W$
\end_inset

以校正这种变形。经过推导，数据的误差的方差和系统噪声的方差正相关。根据矩阵施瓦兹不等式，我们有
\begin_inset Formula 
\[
Q^{\top}Q\geq\left(P^{\top}Q\right)^{\top}\left(P^{\top}P\right)^{-1}\left(P^{\top}Q\right)
\]

\end_inset

其中，
\begin_inset Formula $Q^{\top}Q$
\end_inset

为数据的误差协方差矩阵，因此
\begin_inset Formula $Q$
\end_inset

为误差的标准差矩阵。矩阵
\begin_inset Formula $P$
\end_inset

为原始量测矩阵
\begin_inset Formula $C$
\end_inset

经过权重矩阵
\begin_inset Formula $W$
\end_inset

校正过后新的量测矩阵，以抵消系统噪声的协方差矩阵
\begin_inset Formula $R$
\end_inset

的影响。
\end_layout

\begin_layout Standard
经过一些繁琐的矩阵代数运算，最终得到的最优权重矩阵为
\begin_inset Formula $\hat{W}=R^{-1}$
\end_inset

，因此对冲了系统噪声的影响，这很符合直觉。这时上述不等式的等号成立，数据的误差最小，
\begin_inset Formula $Q^{\top}Q=\left(P^{\top}P\right)^{-1}$
\end_inset

。此时
\begin_inset Formula $P=\left(R^{1/2}\right)^{-1}C$
\end_inset

，其中标准差的倒数
\begin_inset Formula $\left(R^{1/2}\right)^{-1}$
\end_inset

又称精度矩阵，由此左乘校正了量测矩阵
\begin_inset Formula $C$
\end_inset

，因此
\begin_inset Formula 
\[
\Sigma=\left(P^{\top}P\right)^{-1}=\left(C^{\top}R^{-1}C\right)^{-1}
\]

\end_inset

被称为最小二乘解的协方差，并且这种二次型矩阵被称为Fisher信息矩阵或Hessian矩阵。并且
\begin_inset Formula $\left(C^{\top}R^{-1}C\right)^{-1}C^{\top}R^{-1}$
\end_inset

为矩阵
\begin_inset Formula $C$
\end_inset

的最优权重伪逆矩阵，因为
\begin_inset Formula 
\begin{align*}
\left(C^{\top}R^{-1}C\right)^{-1}C^{\top}R^{-1}C & =\left(\left(\left(R^{1/2}\right)^{-1}C\right)^{\top}\left(\left(R^{1/2}\right)^{-1}C\right)\right)^{-1}\left(\left(R^{1/2}\right)^{-1}C\right)^{\top}\left(R^{1/2}\right)^{-1}C\\
 & =\left(P^{\top}P\right)^{-1}P^{\top}P\\
 & =I
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
最终，我们是在校正后的白化数据集合上进行最小二乘估计，并且此时的估计为无偏估计。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename /home/shuyong/Documents/math/study-notes-math/LinearAlgebra/notes/02/covariance-matrix-03.pdf

\end_inset


\end_layout

\begin_layout Standard
至于如何计算递归权重，是那些非线性算法具体要考虑的事情。从另一方面理解，最小二乘的解，是将高维满秩空间的解降维到低维的列空间中的解，并且误差最小。降维以减少运算
量也是我们追求的目标之一。而约束的引入又使得所要估计的状态不再是向量而是群，于是最终需要引入李群和李代数，在切空间中计算扰动、增量或误差，然后将其收回并作用到当
前流形元素上，于是当前流形元素就是最优估计。
\end_layout

\begin_layout Subsection
不确定性的表示
\end_layout

\begin_layout Standard
我们定义局部扰动
\begin_inset Formula $\boldsymbol{\tau}$
\end_inset

为在切向量空间
\begin_inset Formula $T_{\bar{\boldsymbol{\mathcal{X}}}}\mathcal{M}$
\end_inset

中围绕着点
\begin_inset Formula $\bar{\boldsymbol{\mathcal{X}}}\in\mathcal{M}$
\end_inset

的扰动，使用右结合 (right-) 的
\begin_inset Formula $\oplus$
\end_inset

和
\begin_inset Formula $\ominus$
\end_inset

，
\begin_inset Formula 
\[
\boldsymbol{\mathcal{X}}=\bar{\boldsymbol{\mathcal{X}}}\oplus\boldsymbol{\tau},\quad\boldsymbol{\tau}=\boldsymbol{\mathcal{X}}\ominus\bar{\boldsymbol{\mathcal{X}}}\in T_{\bar{\boldsymbol{\mathcal{X}}}}\mathcal{M}.
\]

\end_inset


\end_layout

\begin_layout Standard
协方差矩阵可以通过标准期望算子
\begin_inset Formula $\mathbb{E}\left[\cdot\right]$
\end_inset

在
\begin_inset Formula $\bar{\boldsymbol{\mathcal{X}}}$
\end_inset

处的切空间上正确定义，
\begin_inset Formula 
\[
\boldsymbol{\Sigma}_{\boldsymbol{\mathcal{X}}}\triangleq\mathbb{E}\left[\boldsymbol{\tau}\boldsymbol{\tau}^{\top}\right]=\mathbb{E}\left[\left(\boldsymbol{\mathcal{X}}\ominus\bar{\boldsymbol{\mathcal{X}}}\right)\left(\boldsymbol{\mathcal{X}}\ominus\bar{\boldsymbol{\mathcal{X}}}\right)^{\top}\right]\in\mathbb{R}^{m\times m},
\]

\end_inset

这允许我们定义流形上的高斯变量，
\begin_inset Formula $\boldsymbol{\mathcal{X}}\sim\mathcal{N}\left(\bar{\boldsymbol{\mathcal{X}}},\boldsymbol{\Sigma}_{\boldsymbol{\mathcal{X}}}\right)$
\end_inset

。注意，虽然我们写
\begin_inset Formula $\boldsymbol{\Sigma}_{\boldsymbol{\mathcal{X}}}$
\end_inset

，但协方差还是正切扰动
\begin_inset Formula $\boldsymbol{\tau}$
\end_inset

的协方差。由于 
\begin_inset Formula $T\mathcal{M}$
\end_inset

的维度
\begin_inset Formula $m$
\end_inset

与
\begin_inset Formula $\mathcal{M}$
\end_inset

的自由度相匹配，因此这些协方差被很好地定义。
\end_layout

\begin_layout Standard
扰动也可以在全局参考中表示，即在原点
\begin_inset Formula $T_{\mathcal{E}}\mathcal{M}$
\end_inset

处的切空间中，使用左结合 (left-) 的
\begin_inset Formula $\oplus$
\end_inset

和
\begin_inset Formula $\ominus$
\end_inset

，
\begin_inset Formula 
\[
\boldsymbol{\mathcal{X}}=\boldsymbol{\tau}\oplus\bar{\boldsymbol{\mathcal{X}}},\quad\boldsymbol{\tau}=\boldsymbol{\mathcal{X}}\ominus\bar{\boldsymbol{\mathcal{X}}}\in T_{\mathcal{E}}\mathcal{M}.
\]

\end_inset


\end_layout

\begin_layout Standard
这允许使用在
\begin_inset Formula $\boldsymbol{\Sigma}_{\boldsymbol{\mathcal{X}}}$
\end_inset

方程中的左结合 (left-) 减号的协方差矩阵的全局规范。因为“水平 (horizontal)”是一个全局规范，因此必须在全局参考中指定
\begin_inset Formula $^{\mathcal{E}}\boldsymbol{\Sigma}$
\end_inset

。
\end_layout

\begin_layout Standard
因为全局扰动和局部扰动由伴随方程联系起来，它们的协方差的变换可以用方程
\begin_inset Formula 
\[
^{\mathcal{E}}\boldsymbol{\Sigma}_{\mathcal{X}}=\mathbf{Ad}_{\mathcal{X}}{}^{\mathcal{X}}\boldsymbol{\Sigma}_{\mathcal{X}}\mathbf{A}\mathbf{d}_{\mathcal{X}}{}^{\top}.
\]

\end_inset


\end_layout

\begin_layout Standard
协方差的传播通过函数
\begin_inset Formula $f:\mathcal{M}\rightarrow\mathcal{N};\mathcal{X}\mapsto\mathcal{Y}=f\left(\mathcal{X}\right)$
\end_inset

只需要用 Jacobian 矩阵方程来线性化点
\begin_inset Formula $\mathcal{Y}=f\left(\mathcal{X}\right)$
\end_inset

附近
\begin_inset Formula $\boldsymbol{\tau}$
\end_inset

小值的近似方程
\begin_inset Formula $f\left(\mathcal{X}\oplus{}^{\mathcal{X}}\boldsymbol{\tau}\right)\underset{^{\mathcal{X}}\boldsymbol{\tau}\rightarrow0}{\longrightarrow}f\left(\mathcal{X}\right)\oplus\frac{^{\mathcal{X}}Df\left(\mathcal{X}\right)}{D\mathcal{X}}\,{}^{\mathcal{X}}\boldsymbol{\tau}$
\end_inset

以获得熟悉的公式，
\begin_inset Formula 
\[
\boldsymbol{\Sigma}_{\mathcal{Y}}\approx\frac{Df}{D\mathcal{X}}\boldsymbol{\Sigma}_{\mathcal{X}}\frac{Df^{\top}}{D\mathcal{X}}\quad\in\mathbb{R}^{n\times n}.
\]

\end_inset


\end_layout

\begin_layout Standard
那么我们该如何理解与获得这个流形上的均值元素
\begin_inset Formula $\bar{\boldsymbol{\mathcal{X}}}$
\end_inset

？假设在某个时刻我们测量得到
\begin_inset Formula $n$
\end_inset

个流形元素
\begin_inset Formula $\boldsymbol{\mathcal{X}}_{i}$
\end_inset

，则均值均值元素
\begin_inset Formula $\bar{\boldsymbol{\mathcal{X}}}$
\end_inset

有特性
\begin_inset Formula 
\[
\arg\min\sum_{i=1}^{n}\left\Vert \left(\boldsymbol{\mathcal{X}}_{i}\ominus\bar{\boldsymbol{\mathcal{X}}}\right)\right\Vert ^{2}=\arg\min\sum_{i=1}^{n}\left(\boldsymbol{\tau}_{i}^{\top}\boldsymbol{\tau}_{i}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
我们可以用
\begin_inset Formula $\mathrm{SO}(3)$
\end_inset

的均值从几何上直观理解这个问题。找来一个篮球，用笔随便找一个地方均匀点几个点，这就是我们抽样得到的随机旋转。然后我们估摸着在这几个点的中心区域点一个点，这就是我
们猜测的平均旋转。我们手上只有直尺，量不了球面上两点的距离。但我们手上还有一些柔软的琴弦(string)，于是我们用琴弦从猜测点出发，到其中一个随机点的时候用手
按住标记，然后拉直了琴弦在直尺上看数据，这就是从猜测点到随机点的距离。把所有的距离相加就是总距离。 
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename fig3d-06.pdf

\end_inset


\end_layout

\begin_layout Standard
刚才那个猜测点是随便猜的。我们按照某种梯度下降方法继续猜下一个点，直到找到总距离最小的那个点。在这期间，我们用琴弦量弧段，就是量测地线。琴弦拉直了用直尺量，就是
\begin_inset Formula $\mathrm{Log}\left(\:\right)$
\end_inset

操作，或者说展开(unwrap)操作，将球面(流形)上的元素映射到了向量空间。在向量空间中，距离相加就得到了总距离。因为局部切空间不同，各个点映射到切空间中的向
量也不同，所以总距离就有变化。而平均旋转，就是总距离最小的那个点，但我们没有解析解，因为各处局部切空间无法直接相互比较。所以要求全局最小总距离，就只能靠某种方法
试探和逼近。 
\end_layout

\begin_layout Standard
随着切点的不同，在以切点为原点建立的切空间中，各个映射点围成的多面体的体积/面积也不相同。我们需要在流形上试探找到一个点，在该点上建立的切空间中，切点/原点正好
是多面体的几何中心，也就是平均向量最小，
\begin_inset Formula 
\[
\left\Vert \sum_{i=1}^{n}\left(\boldsymbol{\mathcal{X}}_{i}\ominus\bar{\boldsymbol{\mathcal{X}}}\right)\right\Vert ^{2}=0
\]

\end_inset

这样从原点出发到各个映射点的总距离最小，这时各个映射点围成的多面体的体积/面积也最小。这实际上也是施瓦兹不等式的一个应用。但是该点没有解析解，只能靠搜索找到。
\end_layout

\begin_layout Standard
在卡尔曼滤波器这样的递归算法中，协方差
\begin_inset Formula $\boldsymbol{\Sigma}_{\boldsymbol{\mathcal{X}}}$
\end_inset

的传播通过时间更新和测量更新步骤中在局部坐标系中计算，而最优估计值
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{i}$
\end_inset

可以认为是由多种传感器的测量值以其噪声为权重进行校正后再进行计算的均值元素。
\end_layout

\begin_layout Subsection
不确定性与概率分布
\end_layout

\begin_layout Standard
如果我们在局部切空间中有协方差矩阵
\begin_inset Formula $\boldsymbol{\Sigma}_{\boldsymbol{\mathcal{X}}}$
\end_inset

，在卡尔曼滤波器中称为
\begin_inset Formula $\boldsymbol{P}$
\end_inset

矩阵，表示最小二乘法的解的不确定性。我们知道协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

所代表的概率分布在空间中张成一个椭球，其中矩阵的特征向量指示数据扩散方向，而特征值，即方差，指示扩散程度，矩阵中的协方差项指示椭球在原点坐标系中的旋转角度。协方
差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的概率分布的中心就位于局部切空间中的原点上。我们要表示流形上位姿点
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

周围的概率分布，或者说均值位姿的不确定性，就用公式
\begin_inset Formula 
\begin{align*}
Gaussian(\boldsymbol{\mathcal{X}},\boldsymbol{\eta}) & :=\text{retract}_{\boldsymbol{\mathcal{X}}}(\boldsymbol{\eta})\\
 & =\boldsymbol{\mathcal{X}}\,\mathrm{Exp}\left(\boldsymbol{\eta}\right)
\end{align*}

\end_inset

其中
\begin_inset Formula $\boldsymbol{\eta}$
\end_inset

为协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

对角线上的方差向量，因为非对角线上的协方差项只影响旋转，不会影响扩散程度。用位姿点上的概率分布，根据位姿组合(Pose Composition)、位姿求逆(Po
se Inverse)和相对位姿(Relative Pose)这三种操作，我们就可以求出相关位姿点周围的概率分布。
\end_layout

\begin_layout Standard
位姿点会随着时间变化，或受到噪声的扰动。我们是在局部切空间中计算运动旋量，再将其收回到流形上并作用到当前位姿点上，则位姿点就沿测地线前进移动到新的位姿点上。相对
应的，协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

也是在局部切空间中传播。但是我们希望新的协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

所代表的概率分布的中心也是新的位姿点，所以在切换局部切空间时，也需要对协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

做一次变换。虽然因为现在传感器的采样周期很快，这个变换矩阵
\begin_inset Formula $\boldsymbol{\Gamma}\rightarrow\boldsymbol{I}$
\end_inset

，所以大多数实现算法都忽略这个步骤，但是理解这一步骤的几何意义对于理解局部切空间的切换与伴随矩阵，理解协方差矩阵和概率中心等等概念很有帮助。
\end_layout

\begin_layout Section
参考文献
\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Lie Groups for 2D and 3D Transformations - 2017"
target "http://ethaneade.com/lie.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Orientation Estimation by Means of Extended Kalman Filter, Quaternions, and Charts - 2017"
target "https://rua.ua.es/dspace/bitstream/10045/67917/8/JoPhA_08_01_03.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Characterizing the Uncertainty of Jointly Distributed Poses in the Lie Algebra - 2019"
target "https://arxiv.org/abs/1906.07795"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "A micro Lie theory for state estimation in robotics - 2020"
target "https://arxiv.org/abs/1812.01537"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Reducing the uncertainty about the uncertainties - 2021"
target "https://gtsam.org/2021/02/23/uncertainties-part1.html"
literal "false"

\end_inset


\begin_inset Newpage newpage
\end_inset


\end_layout

\begin_layout Part
ESKF系统的设计与推导
\end_layout

\begin_layout Standard
在这里根据文献[4]设计一个简化版本的ESKF系统，演示ESKF系统的设计与推导。
\end_layout

\begin_layout Section
ESKF简单回顾
\end_layout

\begin_layout Subsection
标准KF系统
\end_layout

\begin_layout Standard
对于一个在状态空间描述的线性或者准线性系统，状态
\begin_inset Formula $k$
\end_inset

从
\begin_inset Formula $k-1$
\end_inset

的状态演变而来，根据
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}_{k}=\boldsymbol{F}_{k}\boldsymbol{x}_{k-1}+\boldsymbol{G}_{k}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}
\]

\end_inset

在这里，
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

是状态转换矩阵。对于简单的问题，这个矩阵可以是一个常数，但是对于大多数实际应用程序，转换矩阵依赖于状态向量的值并每次迭代改变。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

是应用于控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

的控制输入模型。这可用于为系统的已知控制输入建模，例如应用于机器人电机的电流、汽车方向盘的位置等。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{w}_{k}$
\end_inset

是过程噪声，假定从零均值多元正态分布
\begin_inset Formula $\mathcal{N}$
\end_inset

中提取，利用协方差矩阵
\begin_inset Formula $\boldsymbol{Q}_{k}:\boldsymbol{w}_{k}\sim\mathcal{N}\left(0,\boldsymbol{Q}_{k}\right)$
\end_inset

。为这个矩阵确定一个合适的值是很棘手的，并且在卡尔曼滤波器的文献中经常被忽视。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在时间“
\begin_inset Formula $k$
\end_inset

”时刻，一个真实状态的观测(或测量)
\begin_inset Formula $\boldsymbol{z}_{k}$
\end_inset

根据
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{z}_{k}=\boldsymbol{H}_{k}\boldsymbol{x}_{k}+\boldsymbol{v}_{k}
\]

\end_inset

其中
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

是将状态空间映射到观测空间的观测模型。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{v}_{k}$
\end_inset

是假设为零均值高斯协方差的观测噪声
\begin_inset Formula $\boldsymbol{R}_{k}:\boldsymbol{v}_{k}\sim\mathcal{N}\left(0,\boldsymbol{R}_{k}\right)$
\end_inset


\end_layout

\begin_layout Standard
注意，
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

将状态向量映射到观测值，而不是相反。这是因为
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

通常是不可逆的，也就是说，它不提供对状态的直接可见性。
\end_layout

\begin_layout Standard
滤波器的状态由两个变量表示：
\end_layout

\begin_layout Itemize
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k}$
\end_inset

，时间k的后验状态估计，给出时间
\begin_inset Formula $k$
\end_inset

之前(包括该时间)的观测值；
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{P}_{k\mid k}$
\end_inset

，后验误差协方差矩阵(状态估计精度的度量)。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
滤波器分两步工作：
\end_layout

\begin_layout Itemize
一个时间更新(预测)步骤，其中状态和协方差矩阵根据我们对系统动力学和误差特征的了解进行更新，这些特征由
\begin_inset Formula $\boldsymbol{F}$
\end_inset

和
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

矩阵建模。预测步骤不包括观察结果的影响。
\end_layout

\begin_layout Itemize
一个测量更新(校正)步骤，其中包括观测的影响，以完善状态估计和协方差矩阵。这一步需要确定测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}$
\end_inset

矩阵。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
预测和校正步骤的相应方程式如下：其中符号
\begin_inset Formula $\hat{\mathbf{x}}_{n\mid m}$
\end_inset

表示在给定
\begin_inset Formula $n$
\end_inset

时刻观测直至并包括
\begin_inset Formula $m\leq n$
\end_inset

时刻的
\begin_inset Formula $\mathbf{x}$
\end_inset

的估计值。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
预测
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测(先验)状态估计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k-1}=\boldsymbol{F}_{k}\hat{\boldsymbol{x}}_{k-1\mid k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测(先验)估计协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{Q}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
校正
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
新息或测量残差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-\boldsymbol{H}_{k}\hat{\boldsymbol{x}}_{k\mid k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
新息(或残差)协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最佳卡尔曼增益
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
更新(后验)的状态估计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k}=\hat{\boldsymbol{x}}_{k\mid k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
更新(后验)的协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
卡尔曼滤波实现的主要任务是利用系统动力学模型和测量模型，提出状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

和系统噪声特性，设计过程和测量噪声协方差矩阵。
\end_layout

\begin_layout Subsection
KF系统的设计
\end_layout

\begin_layout Standard
虽然我们不一定要亲自去设计一个KF系统，但是了解一个KF系统设计过程中所要考虑的问题，对我们把握一个新的KF系统很有帮助。这里有两篇很有用的教材值得一读：
\end_layout

\begin_layout Itemize
\begin_inset CommandInset href
LatexCommand href
name "07-Kalman-Filter-Math"
target "https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python/blob/master/07-Kalman-Filter-Math.ipynb"
literal "false"

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset CommandInset href
LatexCommand href
name "08-Designing-Kalman-Filters"
target "https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python/blob/master/08-Designing-Kalman-Filters.ipynb"
literal "false"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
KF系统的运行大致分为三个步骤：
\end_layout

\begin_layout Itemize
初始化
\end_layout

\begin_deeper
\begin_layout Enumerate
初始化滤波器的状态
\end_layout

\begin_layout Enumerate
初始化我们对状态的信念
\end_layout

\end_deeper
\begin_layout Itemize
预测
\end_layout

\begin_deeper
\begin_layout Enumerate
使用过程模型预测下一个时间步骤的状态
\end_layout

\begin_layout Enumerate
调整信念以解释预测中的不确定性
\end_layout

\end_deeper
\begin_layout Itemize
更新
\end_layout

\begin_deeper
\begin_layout Enumerate
获得测量结果，并对其准确性关联信念
\end_layout

\begin_layout Enumerate
计算估计状态和测量之间的残差
\end_layout

\begin_layout Enumerate
根据测量或预测是否更准确计算比例因子
\end_layout

\begin_layout Enumerate
根据比例因子设置预测和测量之间的状态
\end_layout

\begin_layout Enumerate
根据我们在测量中的确定度更新对状态的信念
\end_layout

\end_deeper
\begin_layout Standard
我们要处理这些变量：
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{x}$
\end_inset

, 
\begin_inset Formula $\boldsymbol{P}$
\end_inset

是状态均值和协方差。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{F}$
\end_inset

是状态转换函数。当乘以
\begin_inset Formula $\boldsymbol{x}$
\end_inset

时，它计算先验值。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

是过程协方差。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{G}$
\end_inset

和
\begin_inset Formula $\boldsymbol{u}$
\end_inset

让我们对系统的输入进行建模控制。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{H}$
\end_inset

是测量函数。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{z}$
\end_inset

，
\begin_inset Formula $\boldsymbol{R}$
\end_inset

是测量平均值和噪声协方差。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{y}$
\end_inset

和
\begin_inset Formula $\boldsymbol{K}$
\end_inset

是残差和卡尔曼增益。
\end_layout

\begin_layout Standard
我们要应用这些概念：
\end_layout

\begin_layout Itemize
使用高斯分布表示我们对状态和误差的估计
\end_layout

\begin_layout Itemize
使用高斯分布表示测量及其误差
\end_layout

\begin_layout Itemize
使用高斯分布表示过程模型
\end_layout

\begin_layout Itemize
使用过程模型预测下一个状态(先验)
\end_layout

\begin_layout Itemize
在测量和先验测量之间形成一个部分估计
\end_layout

\begin_layout Itemize
作为一名设计师，我们的工作将是设计状态
\begin_inset Formula $(\boldsymbol{x},\boldsymbol{P})$
\end_inset

、过程
\begin_inset Formula $(\boldsymbol{F},\boldsymbol{Q})$
\end_inset

、测量
\begin_inset Formula $(\boldsymbol{z},\boldsymbol{R})$
\end_inset

和测量函数
\begin_inset Formula $\boldsymbol{H}$
\end_inset

。如果系统有控制输入，例如机器人，我们还将设计
\begin_inset Formula $\boldsymbol{G}$
\end_inset

和
\begin_inset Formula $\boldsymbol{u}$
\end_inset

。
\end_layout

\begin_layout Subsection
微分方程的求解
\end_layout

\begin_layout Standard
我们需要确定如下形式的状态外推方程：
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k|k}=\boldsymbol{F}\hat{\boldsymbol{x}}_{k-1,k-1}+\boldsymbol{G}\hat{\boldsymbol{u}}_{k-1,k-1}+\boldsymbol{w}_{k-1}
\]

\end_inset

为了达到这一点，我们将求解描述状态空间表示的微分方程。
\end_layout

\begin_layout Subsubsection
无输入变量的动态系统
\end_layout

\begin_layout Standard
无外部输入的线性时不变(Linear Time-Invariant,LTI)动态系统可用一阶微分方程描述：
\begin_inset Formula 
\[
\dot{\boldsymbol{x}}=\boldsymbol{A}\boldsymbol{x}
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{A}$
\end_inset

是系统动力学矩阵。
\end_layout

\begin_layout Standard
我们的目标是找到状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

。我们需要解微分方程，才能找到
\begin_inset Formula $\boldsymbol{F}$
\end_inset

。
\end_layout

\begin_layout Standard
对于一维系统，微分方程如下所示：
\begin_inset Formula 
\begin{align*}
\frac{\mathrm{d}x}{\mathrm{d}t} & =kx\\
\frac{\mathrm{d}x}{x} & =k\mathrm{d}t
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
两边积分得到：
\begin_inset Formula 
\[
\int_{x_{0}}^{x_{1}}\frac{1}{x}\mathrm{d}x=\int_{0}^{\Delta t}k\mathrm{d}t
\]

\end_inset


\end_layout

\begin_layout Standard
求解积分：
\begin_inset Formula 
\begin{align*}
ln\left(x_{1}\right)-ln\left(x_{0}\right) & =k\Delta t\\
ln\left(x_{1}\right) & =ln\left(x_{0}\right)+k\Delta t\\
x_{1} & =e^{ln\left(x_{0}\right)+k\Delta t}\\
x_{1} & =e^{ln\left(x_{0}\right)}e^{k\Delta t}\\
x_{1} & =x_{0}e^{k\Delta t}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
扩展到多维动态系统的方程，其解为：
\begin_inset Formula 
\[
\boldsymbol{x}_{k+1}=e^{\boldsymbol{A}\Delta t}\boldsymbol{x}_{k}
\]

\end_inset

其中，
\begin_inset Formula $e^{\boldsymbol{A}t}$
\end_inset

是
\begin_inset CommandInset href
LatexCommand href
name "矩阵指数"
target "https://en.wikipedia.org/wiki/Matrix_exponential"
literal "false"

\end_inset

。
\end_layout

\begin_layout Standard
矩阵指数可通过泰勒级数展开计算：
\begin_inset Formula 
\[
e^{\boldsymbol{X}}=\sum_{k=0}^{\infty}\frac{1}{k!}\boldsymbol{X}^{k}
\]

\end_inset

因此：
\begin_inset Formula 
\[
\boldsymbol{F}=e^{\boldsymbol{A}\Delta t}=\boldsymbol{I}+\boldsymbol{A}\Delta t+\frac{\left(\boldsymbol{A}\Delta t\right)^{2}}{2!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{3}}{3!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{4}}{4!}+\ldots
\]

\end_inset


\end_layout

\begin_layout Subsubsection
带输入变量的动态系统
\end_layout

\begin_layout Standard
对于零阶保持采样，假设输入为分段常数，状态空间方程为：
\begin_inset Formula 
\[
\dot{\boldsymbol{x}}(t)=\boldsymbol{A}\boldsymbol{x}(t)+\boldsymbol{B}\boldsymbol{u}(t)
\]

\end_inset

其通解形式由下式给出：
\begin_inset Formula 
\[
\boldsymbol{x}(t+\Delta t)=\underbrace{e^{\boldsymbol{A}\Delta t}}_{\boldsymbol{F}}\boldsymbol{x}(t)+\underbrace{\int_{0}^{\Delta t}e^{\boldsymbol{A}t}\mathrm{d}t\boldsymbol{B}}_{\boldsymbol{G}}\boldsymbol{u}(t)
\]

\end_inset

其中控制输入矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

同样可以通过泰勒级数展开计算：
\begin_inset Formula 
\[
\boldsymbol{G}=\int_{0}^{\Delta t}e^{\boldsymbol{A}t}\mathrm{d}t\boldsymbol{B}=\Delta t\left(\boldsymbol{I}+\frac{\boldsymbol{A}\Delta t}{2!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{2}}{3!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{3}}{4!}+\ldots\right)\boldsymbol{B}
\]

\end_inset


\end_layout

\begin_layout Subsubsection
观测矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

的作用
\end_layout

\begin_layout Standard
在许多情况下，测量值不是所需的系统状态。例如，数字电子温度计测量电流，而系统状态是温度。需要将系统状态（输入）转换为测量（输出）。观测矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

的目的是利用线性变换将系统状态转换为输出。
\end_layout

\begin_layout Standard
观测矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

比较容易计算，它的用法有：
\end_layout

\begin_layout Itemize
状态缩放
\end_layout

\begin_layout Itemize
状态选择
\end_layout

\begin_layout Itemize
状态组合
\end_layout

\begin_layout Subsection
EKF系统
\end_layout

\begin_layout Standard
在扩展卡尔曼滤波中，状态转移和观测模型不需要是状态的线性函数，而可以是
\begin_inset CommandInset href
LatexCommand href
name "可微"
target "https://en.wikipedia.org/wiki/Differentiable_function"
literal "false"

\end_inset

函数。我们考虑非加性噪声的更一般形式的构想及方程
\begin_inset Formula 
\begin{align*}
\boldsymbol{x}_{k} & =f(\boldsymbol{x}_{k-1},\boldsymbol{u}_{k-1},\boldsymbol{w}_{k-1})\\
\boldsymbol{z}_{k} & {\displaystyle =h(\boldsymbol{x}_{k},\boldsymbol{v}_{k})}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{w}_{k}$
\end_inset

和
\begin_inset Formula $\boldsymbol{v}_{k}$
\end_inset

是过程噪声和观测噪声，它们分别被假定为
\begin_inset CommandInset href
LatexCommand href
name "协方差"
target "https://en.wikipedia.org/wiki/Covariance_matrix"
literal "false"

\end_inset

为
\begin_inset Formula $\boldsymbol{Q}_{k}$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}_{k}$
\end_inset

的零均值
\begin_inset CommandInset href
LatexCommand href
name "多元高斯"
target "https://en.wikipedia.org/wiki/Multivariate_normal_distribution"
literal "false"

\end_inset

噪声。
\begin_inset Formula $\boldsymbol{u}_{k}$
\end_inset

是控制向量。
\end_layout

\begin_layout Standard
函数
\begin_inset Formula $f()$
\end_inset

可用于根据先前估计计算预测状态，类似地，函数
\begin_inset Formula $h()$
\end_inset

可用于根据预测状态计算预测测量。然而，
\begin_inset Formula $f()$
\end_inset

和
\begin_inset Formula $h()$
\end_inset

不能直接应用于协方差。而是计算偏导数矩阵(
\begin_inset CommandInset href
LatexCommand href
name "雅可比矩阵"
target "https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant"
literal "false"

\end_inset

)。
\end_layout

\begin_layout Standard
在每个时间步骤，用当前预测状态来评估雅可比矩阵。这些雅可比矩阵可用于卡尔曼滤波方程。该过程基本上是将非线性函数在当前估计值周围使其线性化。
\end_layout

\begin_layout Standard
对于标准KF系统，EKF的方程则增加了本地线性化的处理，变化后的预测和校正步骤的相应方程式如下：
\end_layout

\begin_layout Itemize

\series bold
预测
\end_layout

\begin_deeper
\begin_layout Itemize
预测(先验)状态估计
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k\mid k-1}=f\left(\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k},\boldsymbol{w}_{k}\right)
\]

\end_inset


\end_layout

\begin_layout Itemize
预测(先验)估计协方差
\begin_inset Formula 
\[
\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{G}_{k}\boldsymbol{Q}_{k}\boldsymbol{G}_{k}^{\mathrm{T}}
\]

\end_inset

其中，状态转移矩阵
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{F}_{k}=\left.\dfrac{\partial f}{\partial\boldsymbol{x}}\right|_{\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k}}
\]

\end_inset

控制输入矩阵
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{G}_{k}=\left.\dfrac{\partial f}{\partial\boldsymbol{w}}\right|_{\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k}}
\]

\end_inset


\end_layout

\end_deeper
\begin_layout Itemize

\series bold
校正
\end_layout

\begin_deeper
\begin_layout Itemize
新息或测量残差
\begin_inset Formula 
\[
\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)
\]

\end_inset


\end_layout

\begin_layout Itemize
新息(或残差)协方差
\begin_inset Formula 
\[
\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}
\]

\end_inset

其中，观测矩阵
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{H}_{k}=\left.\dfrac{\partial h}{\partial\boldsymbol{x}}\right|_{\hat{\boldsymbol{x}}_{k\mid k-1}}
\]

\end_inset


\end_layout

\begin_layout Itemize
最佳卡尔曼增益
\begin_inset Formula 
\[
\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}
\]

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的状态估计
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k\mid k}=\hat{\boldsymbol{x}}_{k\mid k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k}
\]

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的协方差
\begin_inset Formula 
\[
\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}
\]

\end_inset


\end_layout

\end_deeper
\begin_layout Standard
对于EKF，新增的任务就是计算状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、控制输入矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

和测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

的Jacobian矩阵。
\end_layout

\begin_layout Subsection
ESKF系统
\end_layout

\begin_layout Standard
ESKF系统其实是EKF系统针对位姿估计的具体应用。它将要估计的状态量分为量部分，一部份为标称状态量，为大数值量，另一部份为扰动或误差，为小数值量。它将扰动或误
差这种小量以向量形式采用EKF系统进行最优估计，然后再将其转换为李群形式作用到标称状态量。此时标称状态量就为最优估计，已没有误差，则系统需要进行重置操作。ESK
F系统简述如下。
\end_layout

\begin_layout Standard
我们要估计的是一个流形上的元素
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

，它在软件中用向量形式
\begin_inset Formula $\boldsymbol{x}$
\end_inset

存储，两者关系为
\begin_inset Formula 
\[
\boldsymbol{\mathcal{X}}=\mathrm{Exp}\left(\boldsymbol{x}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
在符号表示上，我们用帽子符号
\begin_inset Formula $\hat{\ }$
\end_inset

代表估计值，用下标
\begin_inset Formula $i|i-1$
\end_inset

代表用
\begin_inset Formula $i-1$
\end_inset

时刻的数据外推
\begin_inset Formula $i$
\end_inset

时刻的估计值，用下标
\begin_inset Formula $i|i$
\end_inset

代表
\begin_inset Formula $i$
\end_inset

时刻的最优估计值，因此，
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

、
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{i|i-1}$
\end_inset

、
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{i|i}$
\end_inset

分别代表状态的真值、外推估计值、最优估计值。流形元素
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

的变化由控制信号向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

所驱动，例如IMU的输出在采样时间
\begin_inset Formula $\Delta t$
\end_inset

内的积分。该控制信号已被加性高斯噪声
\begin_inset Formula $\boldsymbol{w}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{Q}\right)$
\end_inset

损坏。因此当
\begin_inset Formula $k$
\end_inset

时刻到达时我们得到一个控制信号
\begin_inset Formula $\boldsymbol{u}_{k}$
\end_inset

，如果已知上一时刻最优估计值
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}$
\end_inset

，则新的外推估计值为
\begin_inset Formula 
\[
\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}=\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}\oplus\boldsymbol{u}_{k}\triangleq\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}\mathrm{Exp}\left(\boldsymbol{u}_{k}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
因为控制信号
\begin_inset Formula $\boldsymbol{u}$
\end_inset

的噪声引入的累积误差是无界的(unbounded)，所以我们需要对外推估计值
\begin_inset Formula $\bar{\boldsymbol{\mathcal{X}}}$
\end_inset

做最优估计，以使其有界(bounded)。因为只擅长处理向量的卡尔曼滤波器不好直接估计流形元素
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

，因此我们需要间接的方法对其进行最优估计。
\end_layout

\begin_layout Standard
我们假定外推估计值和真值之间存在一个误差
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

，
\begin_inset Formula 
\[
\delta\boldsymbol{x}\triangleq\boldsymbol{\mathcal{X}}\ominus\hat{\boldsymbol{\mathcal{X}}}
\]

\end_inset

并且因
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

数量小，可以用向量形式表示而无过度参数化的问题，并且其协方差
\begin_inset Formula $\boldsymbol{P}$
\end_inset

在
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}$
\end_inset

处切空间中表示为
\begin_inset Formula 
\[
\boldsymbol{P}\triangleq\mathbb{E}\left[\left(\boldsymbol{\mathcal{X}}\ominus\hat{\boldsymbol{\mathcal{X}}}\right)\left(\boldsymbol{\mathcal{X}}\ominus\hat{\boldsymbol{\mathcal{X}}}\right)^{\top}\right]
\]

\end_inset

因此
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

可用卡尔曼滤波器进行最优估计。为此我们还需要其它传感器的测量值
\begin_inset Formula $\boldsymbol{z}$
\end_inset

对其进行校正，该测量值同样被加性高斯噪声
\begin_inset Formula $\boldsymbol{v}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{R}\right)$
\end_inset

损坏。根据
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}$
\end_inset

这两种由噪声构建的协方差矩阵，我们就可以对
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

进行最优估计。再将其作用到外推估计值
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}$
\end_inset

上，
\begin_inset Formula 
\[
\hat{\boldsymbol{\mathcal{X}}}_{k|k}=\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}\oplus\delta\boldsymbol{x}_{k}
\]

\end_inset

这就间接得到了当前
\begin_inset Formula $k$
\end_inset

时刻的流形元素的最优估计值。因此我们把估计值
\begin_inset Formula $\hat{\boldsymbol{\mathcal{X}}}$
\end_inset

称为标称状态量，外推状态和最优状态是其自身的两种状态，它们和误差状态量
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

的关系是
\begin_inset Formula 
\[
\begin{cases}
\hat{\boldsymbol{\mathcal{X}}}_{k|k-1} & \text{if}\ \delta\boldsymbol{x}\neq\boldsymbol{0}\\
\hat{\boldsymbol{\mathcal{X}}}_{k|k} & \text{if}\ \delta\boldsymbol{x}=\boldsymbol{0}
\end{cases}
\]

\end_inset

既当误差
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

作用到标称状态量后，我们认为标称状态量已经是最接近真实值的量，已无误差，所以ESKF算法在循环迭代结束时必须执行重置步骤。
\end_layout

\begin_layout Standard
ESKF计算步骤如下：
\end_layout

\begin_layout Itemize

\series bold
预测
\end_layout

\begin_deeper
\begin_layout Itemize
预测(先验)状态估计
\begin_inset Formula 
\begin{align}
\hat{\boldsymbol{\mathcal{X}}}_{k|k-1} & =\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}\oplus\boldsymbol{u}_{k}\nonumber \\
\delta\boldsymbol{x}_{k|k-1} & =f\left(\hat{\boldsymbol{\mathcal{X}}}_{k|k-1},\boldsymbol{u}_{k}\right)\delta\boldsymbol{x}_{k-1|k-1}\label{eq:1}
\end{align}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{u}$
\end_inset

是系统的控制向量，也是流形元素的增量向量，由其引入了误差。因为上一次迭代都会执行重置操作
\begin_inset Formula $\delta\boldsymbol{x}_{k-1|k-1}=\boldsymbol{0}$
\end_inset

，所以大多数情况下都会省略方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:1"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，代表着误差直到测量更新时才会显现出来，时间更新阶段则关注推导误差状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

和控制矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

。
\end_layout

\begin_layout Itemize
预测(先验)估计协方差
\begin_inset Formula 
\begin{equation}
\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{G}_{k}\boldsymbol{Q}_{k}\boldsymbol{G}_{k}^{\mathrm{T}}\label{eq:2}
\end{equation}

\end_inset

其中，误差状态转移矩阵
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{k} & =\dfrac{\partial\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}}{\partial\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}}\\
 & =\dfrac{\partial\left(\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}\oplus\boldsymbol{u}_{k}\right)}{\partial\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}}\\
 & =\mathbf{Ad}_{\mathrm{Exp}\left(\boldsymbol{u}_{k}\right)}{}^{-1}
\end{align*}

\end_inset

误差控制输入矩阵
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{G}_{k} & =\dfrac{\partial\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}}{\partial\boldsymbol{u}_{k}}\\
 & =\dfrac{\partial\left(\hat{\boldsymbol{\mathcal{X}}}_{k-1|k-1}\oplus\boldsymbol{u}_{k}\right)}{\partial\boldsymbol{u}_{k}}\\
 & =\boldsymbol{J}_{r}\left(\boldsymbol{u}_{k}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Itemize
协方差重置
\begin_inset Formula 
\begin{align*}
\boldsymbol{P}_{k\mid k-1} & =\boldsymbol{\Gamma}\left(\boldsymbol{u}_{k}\right)\boldsymbol{P}_{k\mid k-1}\boldsymbol{\Gamma}\left(\boldsymbol{u}_{k}\right)^{\top}
\end{align*}

\end_inset


\end_layout

\end_deeper
\begin_layout Itemize

\series bold
校正
\end_layout

\begin_deeper
\begin_layout Itemize
新息或测量残差
\begin_inset Formula 
\[
\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}^{-1}\cdot\boldsymbol{v}_{I}
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{v}_{I}$
\end_inset

为全局坐标系下的观测向量。
\end_layout

\begin_layout Itemize
新息(或残差)协方差
\begin_inset Formula 
\[
\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}
\]

\end_inset

其中，观测矩阵
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{k} & =\dfrac{\partial\left(\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}^{-1}\cdot\boldsymbol{v}_{I}\right)}{\partial\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}}\\
 & =\dfrac{\partial\left(\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}^{-1}\cdot\boldsymbol{v}_{I}\right)}{\partial\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}^{-1}}\cdot\dfrac{\partial\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}^{-1}}{\partial\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}}
\end{align*}

\end_inset


\end_layout

\begin_layout Itemize
最佳卡尔曼增益
\begin_inset Formula 
\begin{equation}
\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}\label{eq:3}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的状态估计
\begin_inset Formula 
\begin{align}
\delta\boldsymbol{x}_{k|k} & =\begin{cases}
\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k} & \delta\boldsymbol{x}_{k|k-1}=\boldsymbol{0}\\
\delta\boldsymbol{x}_{k|k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k} & \delta\boldsymbol{x}_{k|k-1}\neq\boldsymbol{0}
\end{cases}\label{eq:4}\\
\hat{\boldsymbol{\mathcal{X}}}_{k|k} & =\hat{\boldsymbol{\mathcal{X}}}_{k|k-1}\oplus\delta\boldsymbol{x}_{k|k}\nonumber 
\end{align}

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的协方差
\begin_inset Formula 
\begin{equation}
\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}\label{eq:5}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
协方差矩阵重置
\begin_inset Formula 
\begin{align*}
\boldsymbol{P}_{k\mid k-1} & =\boldsymbol{\Gamma}\left(\delta\boldsymbol{x}_{k|k}\right)\boldsymbol{P}_{k\mid k-1}\boldsymbol{\Gamma}\left(\delta\boldsymbol{x}_{k|k}\right)^{\top}
\end{align*}

\end_inset


\end_layout

\begin_layout Itemize
误差重置
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\delta\boldsymbol{x}_{k|k}=\boldsymbol{0}
\]

\end_inset


\end_layout

\end_deeper
\begin_layout Standard
相对于常规EKF，ESKF的更改地方，当流形元素与向量运算时，将常规的
\begin_inset Formula $+$
\end_inset

算子替换为
\begin_inset Formula $\oplus$
\end_inset

算子，并且Jacobian矩阵都用李理论计算。它们的用法和标准的EKF中的用法相同，这就是李理论提供的抽象层次带来的好处。因为是间接估计，所以ESKF新增的任务
就是重置步骤。其中协方差重置步骤因为改变很小，在大多数实现算法中都忽略，但是理解这一步骤的含意对于理解李群的概念十分有帮助。
\end_layout

\begin_layout Standard
ESKF系统的计算过程及输入输出的示意图如下：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-01.png
	scale 55

\end_inset


\end_layout

\begin_layout Standard
从图中可以看出，对于传感器数据有一个并行采样的假设。如果不满足这个假设，并且在现今复杂系统上大多不满足这个假设，所以在实现中，我们需要对传感器输入流做预处理，或
对估计系统的输出流做校正处理。这又是另外的话题。
\end_layout

\begin_layout Section
旋转表示与约定
\end_layout

\begin_layout Standard
三维旋转有两种常用的表示方法：单位四元数和旋转矩阵。旋转矩阵比较统一，都是右手坐标系，不容易出错。但单位四元数因为数学上的原因，并行有两种约定，很容易出错，所以
有必要澄清一下。
\end_layout

\begin_layout Standard
单位四元数表示旋转，有两种常见的约定(convention)，或者说两种符号(notation)系统。一种是Hamilton约定，一种是JPL约定。前者是右手坐
标系，后者是左手坐标系。两种约定都流行，而两者推导出来的方程有差异，于是造成了很大的混乱。稍不留神就会掉进沟里。
\end_layout

\begin_layout Subsection
Hamilton约定
\end_layout

\begin_layout Standard
四元数由Hamilton先生发明，由一个实数和三个复数构成：
\begin_inset Formula 
\[
q=q_{0}+q_{1}\boldsymbol{i}+q_{2}\boldsymbol{j}+q_{3}\boldsymbol{k}
\]

\end_inset

其中，
\begin_inset Formula $\boldsymbol{i}\boldsymbol{j}=\boldsymbol{k}$
\end_inset

，所以有
\begin_inset Formula $\boldsymbol{i}\boldsymbol{j}\boldsymbol{k}=-1$
\end_inset

。一般为方便书写，也可写成这样：
\begin_inset Formula 
\begin{align*}
q & =\left[\begin{array}{cccc}
q_{0} & q_{1} & q_{2} & q_{3}\end{array}\right]^{\mathrm{T}}\\
 & =\left[\begin{array}{cc}
q_{0} & \boldsymbol{q}_{v}\end{array}\right]^{\mathrm{T}}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{q}_{v}$
\end_inset

表示由三个复数构成的三维向量。
\end_layout

\begin_layout Standard
我们对四元数乘法感兴趣：
\begin_inset Formula 
\[
p*q=\left[\begin{array}{c}
p_{0}q_{0}-\boldsymbol{p}\cdot\boldsymbol{q}\\
p_{0}\boldsymbol{q}+q_{0}\boldsymbol{p}+\boldsymbol{p}\times\boldsymbol{q}
\end{array}\right]
\]

\end_inset

其中，``
\begin_inset Formula $\cdot$
\end_inset

''和``
\begin_inset Formula $\times$
\end_inset

''符号分别是向量的点乘和叉乘。
\end_layout

\begin_layout Standard
对于四元数乘法，还有矩阵形式的表示，在很多分析中经常用到：
\begin_inset Formula 
\begin{align*}
p*q & =\left[\begin{array}{cc}
p_{0} & -\boldsymbol{p}^{\mathrm{T}}\\
\boldsymbol{p} & p_{0}\boldsymbol{I}+\left[\boldsymbol{p}\times\right]
\end{array}\right]\left[\begin{array}{c}
q_{0}\\
\boldsymbol{q}
\end{array}\right]\\
 & =\left[\begin{array}{cc}
q_{0} & -\boldsymbol{q}^{\mathrm{T}}\\
\boldsymbol{q} & q_{0}\boldsymbol{I}-\left[\boldsymbol{q}\times\right]
\end{array}\right]\left[\begin{array}{c}
p_{0}\\
\boldsymbol{p}
\end{array}\right]
\end{align*}

\end_inset

四元数的左边是一个
\begin_inset Formula $4\times4$
\end_inset

矩阵，其中符号
\begin_inset Formula $\left[\boldsymbol{p}\times\right]$
\end_inset

表示一个很常用的三维向量转变为
\begin_inset Formula $3\times3$
\end_inset

的斜对称矩阵的运算：
\begin_inset Formula 
\[
\left[\boldsymbol{p}\times\right]=\left[\begin{array}{ccc}
0 & -p_{z} & p_{y}\\
p_{z} & 0 & -p_{x}\\
-p_{y} & p_{x} & 0
\end{array}\right]
\]

\end_inset

并且有这样的性质：
\begin_inset Formula 
\[
\left[\boldsymbol{p}\times\right]\boldsymbol{q}=-\left[\boldsymbol{q}\times\right]\boldsymbol{p}
\]

\end_inset

同时请注意
\begin_inset Formula $p$
\end_inset

和
\begin_inset Formula $q$
\end_inset

交换后，矩阵右下角
\begin_inset Formula $3\times3$
\end_inset

矩阵中正负符号的变化。
\end_layout

\begin_layout Standard
单位四元数
\begin_inset Formula 
\[
q_{0}^{2}+q_{1}^{2}+q_{2}^{2}+q_{3}^{2}=1
\]

\end_inset

用于表示旋转：
\begin_inset Formula 
\[
q=\left[\begin{array}{cc}
\cos\left(\dfrac{\theta}{2}\right) & \sin\left(\dfrac{\theta}{2}\right)\boldsymbol{u}^{R}\end{array}\right]^{\mathrm{T}}
\]

\end_inset

其中，
\begin_inset Formula $\boldsymbol{u}^{R}$
\end_inset

表示旋转轴是参考系
\begin_inset Formula $\boldsymbol{R}$
\end_inset

下的单位向量，
\begin_inset Formula $\dfrac{\theta}{2}$
\end_inset

表示绕
\begin_inset Formula $\boldsymbol{u}^{R}$
\end_inset

轴旋转
\begin_inset Formula $\theta$
\end_inset

角度，因为有这个著名的向量旋转公式
\begin_inset Formula $\boldsymbol{v}^{\prime}=q\boldsymbol{v}q^{-1}$
\end_inset

。上式表明，如果我们想要用轴-角(Axis-Angle)方式构造四元数，应当将旋转轴放在参考系下描述。
\begin_inset Formula $\boldsymbol{R}$
\end_inset

一般会选择水平地理导航系(Navigation frame)、世界坐标系(World frame)、全局坐标系(Global frame)或惯性坐标系(Iner
tial frame)作为参考系。相对应的就是机体坐标系(Body frame)。后面为简化符号，一般直接用
\begin_inset Formula $\boldsymbol{u}$
\end_inset

表示旋转轴，省略参考系
\begin_inset Formula $\boldsymbol{R}$
\end_inset

的表示。
\end_layout

\begin_layout Standard
轴-角(Axis-Angle)方式指的是在一个向量中同时表示旋转轴和旋转角度：
\begin_inset Formula 
\[
\boldsymbol{\theta}\triangleq\boldsymbol{u}\theta\in\mathbb{R}^{3}
\]

\end_inset


\end_layout

\begin_layout Standard
可以通过欧拉公式将其映射为四元数，一般用算子
\begin_inset Formula $\wedge:\mathbb{R}^{3}\rightarrow\mathbb{H}$
\end_inset

表示，相应的逆映射用算子
\begin_inset Formula $\vee:\mathbb{H}\rightarrow\mathbb{R}^{3}$
\end_inset

表示。两者定义为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{\theta}^{\wedge} & \triangleq\exp\left(\dfrac{\boldsymbol{\theta}}{2}\right)=\left[\begin{array}{c}
\cos\left(\dfrac{\left\Vert \boldsymbol{\theta}\right\Vert }{2}\right)\\
\dfrac{\boldsymbol{\theta}}{\left\Vert \boldsymbol{\theta}\right\Vert }\sin\left(\dfrac{\left\Vert \boldsymbol{\theta}\right\Vert }{2}\right)
\end{array}\right]\\
q^{\vee} & \triangleq\log\left(q\right)=2\mathrm{atan2}\left(\left\Vert \boldsymbol{q}\right\Vert ,q_{0}\right)\dfrac{\boldsymbol{q}}{\left\Vert \boldsymbol{q}\right\Vert }
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在引入李群和流形(manifold)后多了两个类似的算子：
\begin_inset Formula $\boxplus$
\end_inset

和
\begin_inset Formula $\boxminus$
\end_inset

。这些符号的关系为：
\begin_inset Formula 
\[
\begin{array}{rlll}
q^{\prime} & =q*\boldsymbol{\theta}^{\wedge} & =q*\exp\left(\dfrac{\boldsymbol{\theta}}{2}\right) & =q\boxplus\boldsymbol{\theta}\\
\boldsymbol{\theta} & =\left(q^{-1}*q^{\prime}\right)^{\vee} & =\log\left(q^{-1}*q^{\prime}\right) & =q^{\prime}\boxminus q
\end{array}
\]

\end_inset

其中对于
\begin_inset Formula $\boxminus$
\end_inset

算子请注意四元数乘法的顺序。
\end_layout

\begin_layout Standard
当
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

的角度很小时，一般用
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

表示，上述方程有数值稳定的问题。于是用二阶Gibbs向量参数化：
\begin_inset Formula 
\begin{align*}
\delta\boldsymbol{\theta}^{\wedge} & \approx\dfrac{1}{\sqrt{4+\delta\boldsymbol{\theta}^{\mathrm{T}}\delta\boldsymbol{\theta}}}\left[\begin{array}{c}
2\\
\delta\boldsymbol{\theta}
\end{array}\right]\\
 & \approx\left[\begin{array}{c}
1-\delta\boldsymbol{\theta}^{\mathrm{T}}\delta\boldsymbol{\theta}/8\\
\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
如果用一阶近似就更简单：
\begin_inset Formula 
\[
\delta\boldsymbol{\theta}^{\wedge}\approx\left[\begin{array}{c}
1\\
\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]
\]

\end_inset

并且
\begin_inset Formula 
\[
\delta\boldsymbol{\theta}=\delta q^{\vee}\approx2\mathrm{sign}\left(\delta q_{0}\right)\delta\boldsymbol{q}
\]

\end_inset


\end_layout

\begin_layout Standard
物体的旋转可以用旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

表示。使用
\begin_inset Formula $\boldsymbol{R}_{B}^{I}$
\end_inset

表示从机体坐标系变换到惯性坐标系的旋转，从李群的角度说，就是从局部坐标系变换到原点坐标系，因此对于机体坐标系中的向量
\begin_inset Formula $\boldsymbol{v}^{B}$
\end_inset

，
\begin_inset Formula $\boldsymbol{R}_{B}^{I}\boldsymbol{v}^{B}=\boldsymbol{v}^{I}$
\end_inset

，通俗地说就是站在大地上看无人机的姿态。
\begin_inset Formula $\boldsymbol{R}_{I}^{B}$
\end_inset

则表示从惯性坐标系变换到机体坐标系的旋转。因此两者关系为
\begin_inset Formula $\boldsymbol{R}_{I}^{B}=\left(\boldsymbol{R}_{B}^{I}\right)^{\mathrm{T}}$
\end_inset

。很自然的，单位四元数
\begin_inset Formula $q$
\end_inset

可以转换为旋转矩阵，两者的转换关系为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{B}^{I}\left(q\right) & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\\
\boldsymbol{R}_{I}^{B}\left(q\right) & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
如果用罗德里格斯旋转方程(Rodrigues Rotation Formula)表示，则为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{B}^{I}\left(q\right) & =\left(q_{0}^{2}-\left|\boldsymbol{q}_{v}\right|^{2}\right)\boldsymbol{I}_{3\times3}+2q_{0}\left[\boldsymbol{q}_{v}\times\right]+2\boldsymbol{q}_{v}\boldsymbol{q}_{v}^{\mathrm{T}}\\
\boldsymbol{R}_{I}^{B}\left(q\right) & =\left(q_{0}^{2}-\left|\boldsymbol{q}_{v}\right|^{2}\right)\boldsymbol{I}_{3\times3}-2q_{0}\left[\boldsymbol{q}_{v}\times\right]+2\boldsymbol{q}_{v}\boldsymbol{q}_{v}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在这里还请注意在
\begin_inset Formula $\left[\boldsymbol{q}_{v}\times\right]$
\end_inset

前面的正负符号，在这里经常出现抄写错误而造成软件出错。
\end_layout

\begin_layout Standard
此外，物体的旋转和角速度
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

的关系可以用单位四元数的微分方程表示：
\begin_inset Formula 
\[
\dot{q}=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\dfrac{1}{2}\left[\begin{array}{c}
0\\
\boldsymbol{\omega}
\end{array}\right]q
\]

\end_inset

其中，式中的
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

为角速度对惯性坐标系投影。而现在常用的IMU得到的测量结果是角速度对机体坐标系的投影。于是上式在工程应用中应该这样计算：
\begin_inset Formula 
\begin{equation}
\dot{q}=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\dfrac{1}{2}q\left[\begin{array}{c}
0\\
\boldsymbol{\omega}
\end{array}\right]\label{eq:6}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
习惯上，物体的
\begin_inset Formula $k$
\end_inset

时刻的姿态用单位四元数
\begin_inset Formula $q_{k}$
\end_inset

表示，物体
\begin_inset Formula $k+1$
\end_inset

时刻的旋转用增量四元数
\begin_inset Formula $\Delta q$
\end_inset

表示，则新的姿态用四元数乘法表示。根据上式就是用四元数右乘表示物体向前旋转，也就是教材里所说的：Right-to-left products mean
 Local-to-Global。因为IMU采样频率很高，间隔时间内的增量角度
\begin_inset Formula $\Delta\boldsymbol{\theta}=\boldsymbol{\omega}\Delta t$
\end_inset

很小，所以其所表示的单位四元数可以简化计算为：
\begin_inset Formula 
\[
\Delta q=\delta\boldsymbol{\theta}^{\wedge}\approx\left[\begin{array}{c}
1\\
\dfrac{\Delta\boldsymbol{\theta}}{2}
\end{array}\right]
\]

\end_inset

于是对于精度不高的快速运算，机体的新姿态计算为：
\begin_inset Formula 
\begin{align*}
q_{k+1} & =q_{k}\cdot\Delta q\\
 & =q_{k}\cdot\left[\begin{array}{c}
1\\
\dfrac{\Delta\boldsymbol{\theta}}{2}
\end{array}\right]\\
 & =q_{k}+\dfrac{1}{2}q_{k}\cdot\left[\begin{array}{c}
0\\
\Delta\boldsymbol{\theta}
\end{array}\right]
\end{align*}

\end_inset

上式就是在论文和教材中很常见的欧拉积分法，或称一阶积分法。
\end_layout

\begin_layout Standard
相应方程用算子
\begin_inset Formula $\boxplus$
\end_inset

和
\begin_inset Formula $\boxminus$
\end_inset

表示则为：
\begin_inset Formula 
\begin{align*}
q_{k+1} & =q_{k}\boxplus\left(\Delta\boldsymbol{\theta}\right)\\
\Delta\boldsymbol{\theta} & =q_{k+1}\boxminus q_{k}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
相应的用四元数左乘表示物体向后旋转：
\begin_inset Formula 
\[
q_{t}=\delta q\cdot\hat{q}
\]

\end_inset


\end_layout

\begin_layout Standard
在习惯上，认为上面两个方程计算出来的姿态四元数代表的是全局的姿态
\begin_inset Formula $_{B}^{I}q$
\end_inset

，于是选择定义：
\begin_inset Formula 
\[
\boldsymbol{R}\left(q\right)=\boldsymbol{R}_{B}^{I}\left(_{B}^{I}q\right)
\]

\end_inset

根据Hamilton约定的乘法规则，四元数乘法与旋转矩阵的乘法的映射为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{B}^{I}\left(q\right) & =\boldsymbol{R}_{B}^{I}\left(\hat{q}\cdot\delta q\right)\\
 & =\boldsymbol{R}_{B}^{I}\left(\delta q\right)\cdot\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
请注意四元数乘法拆分为矩阵乘法后位置的翻转。因为上式的数学表现形式不够完美，不是数学上的同构的(isomorphic)或同态(homomorphy)，于是有人发
明了JPL约定的四元数。
\end_layout

\begin_layout Subsection
JPL约定
\end_layout

\begin_layout Standard
JPL约定是由Shuster先生发明的，所以称为Shuster Notation。因为他在NASA工作，使用这种约定的人和软件也主要和航天有关，如参考文献[1,
2]，因为有名的NASA Jet Propulsion Laboratory (JPL)，于是又称为JPL约定。
\end_layout

\begin_layout Standard
发明JPL约定的目的，可能是出于科学家对于数学完美追求，解决前面的同构问题。于是把前面的
\begin_inset Formula $\boldsymbol{i}\boldsymbol{j}=\boldsymbol{k}$
\end_inset

，改变为
\begin_inset Formula $\boldsymbol{i}\boldsymbol{j}=-\boldsymbol{k}$
\end_inset

，所以有
\begin_inset Formula $\boldsymbol{i}\boldsymbol{j}\boldsymbol{k}=1$
\end_inset

。乘法从右手系变成了左手系，并且有：
\begin_inset Formula 
\[
\boldsymbol{R}\left(\delta q\cdot\hat{q}\right)=\boldsymbol{R}\left(\delta q\right)\cdot\boldsymbol{R}\left(\hat{q}\right)
\]

\end_inset

这形式在数学上就是同构。
\end_layout

\begin_layout Standard
为区分Hamilton约定，JPL约定定义的四元数存储顺序相反：
\begin_inset Formula 
\begin{align*}
q & =\left[\begin{array}{cccc}
q_{1} & q_{2} & q_{3} & q_{4}\end{array}\right]^{\mathrm{T}}\\
 & =\left[\begin{array}{cc}
\boldsymbol{q}_{v} & q_{4}\end{array}\right]^{\mathrm{T}}
\end{align*}

\end_inset

并且用叉乘符号
\begin_inset Formula $\otimes$
\end_inset

代表JPL约定的乘法符号，用点乘符号
\begin_inset Formula $\odot$
\end_inset

代表Hamilton约定的乘法符号。
\end_layout

\begin_layout Standard
相应的，JPL约定定义的乘法相关的方程和Hamilton约定顺序相反。首先是单位四元数的微分方程：
\begin_inset Formula 
\begin{equation}
\dot{q}=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\dfrac{1}{2}\left[\begin{array}{c}
0\\
\boldsymbol{\omega}
\end{array}\right]q\label{eq:7}
\end{equation}

\end_inset

其中，式中的
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

为角速度对机体坐标系的投影，也就是用四元数左乘表示物体向前旋转，也就是教材里所说的：Right-to-left products means Global-to
-Local。但是用罗德里格斯旋转方程(Rodrigues Rotation Formula)表示的含义相同：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{I}^{B}\left(q\right) & =\left(q_{4}^{2}-\left|\boldsymbol{q}_{v}\right|^{2}\right)\boldsymbol{I}_{3\times3}-2q_{4}\left[\boldsymbol{q}_{v}\times\right]+2\boldsymbol{q}_{v}\boldsymbol{q}_{v}^{\mathrm{T}}\\
\boldsymbol{R}_{B}^{I}\left(q\right) & =\left(q_{4}^{2}-\left|\boldsymbol{q}_{v}\right|^{2}\right)\boldsymbol{I}_{3\times3}+2q_{4}\left[\boldsymbol{q}_{v}\times\right]+2\boldsymbol{q}_{v}\boldsymbol{q}_{v}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
注意上式排列顺序和Hamilton约定相反的地方。也就是用JPL约定的方程计算出来的姿态四元数
\begin_inset Formula $q$
\end_inset

，表示的是从惯性坐标系变换到机体坐标系的旋转
\begin_inset Formula $_{I}^{B}q$
\end_inset

。于是有定义：
\begin_inset Formula 
\[
\boldsymbol{R}\left(q\right)=\boldsymbol{R}_{I}^{B}\left(_{I}^{B}q\right)
\]

\end_inset


\end_layout

\begin_layout Standard
并且有：
\begin_inset Formula 
\[
\boldsymbol{R}_{I}^{B}\left(\delta q\cdot\hat{q}\right)=\boldsymbol{R}_{I}^{B}\left(\delta q\right)\cdot\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
采用JPL约定可能有一个现实的好处，可能和“Right-to-left products mean”有关。Local和Global是相对的概念。以相机的视角举例
，假设初始状态机体坐标系(相机)和固定坐标系(大地)是重合的，经过一段时间的运动之后：
\end_layout

\begin_layout Itemize
Local-to-Global意味着是将相机在新的视角看到的空间某个固定点的坐标转成初始相机视角下的坐标。
\end_layout

\begin_layout Itemize
Global-to-Local意味着是将相机在初始视角看到的空间某个固定点坐标转成相机在新的视角下的坐标。
\end_layout

\begin_layout Standard
载人航天器自然要以宇航员优先。假如宇航员在太空飞船里，看到的景象就是飞船不动，而外面的世界围绕着飞船旋转。JPL约定就是宇航员视角看到的坐标，同时根据上面的方程
式，姿态矩阵也容易理解一点。同样的，相机坐标系用JPL约定也会自然一些，因为这就是人眼看到的物体的倾斜方向。
\end_layout

\begin_layout Subsection
不同约定造成的迷惑
\end_layout

\begin_layout Standard
对于两种约定，因为所有和乘法相关的方程的顺序或正负符号都相反，两者又都流行，于是给大家都带来了大麻烦。看资料的时候都要留个心：这到底是哪家的门派。下面举一个后面
会遇到的例子，看看我们会碰倒怎样的迷惑。
\end_layout

\begin_layout Standard
我们先对罗德里格斯旋转方程做简化。因为间隔时间
\begin_inset Formula $\Delta t$
\end_inset

内增量角度
\begin_inset Formula $\Delta\boldsymbol{\theta}=\boldsymbol{\omega}\Delta t$
\end_inset

很小，所以其误差角度
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

更小，将误差表示的方程
\begin_inset Formula $\delta q=\left[\begin{array}{cc}
1 & \dfrac{\delta\boldsymbol{\theta}}{2}\end{array}\right]^{\mathrm{T}}$
\end_inset

代入旋转方程，并忽略二阶项得到：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{I}^{B}\left(\delta q\right) & \approx\boldsymbol{I}_{3\times3}-\left[\delta\boldsymbol{\theta}\times\right]\\
\boldsymbol{R}_{B}^{I}\left(\delta q\right) & \approx\boldsymbol{I}_{3\times3}+\left[\delta\boldsymbol{\theta}\times\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
IMU传感器定时采样，采样间隔时间为
\begin_inset Formula $\Delta t$
\end_inset

，获得
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
测量角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}_{m}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}_{m}$
\end_inset

数据。然后IMU测量值去除测量偏差得到
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}_{B}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}_{B}$
\end_inset

数据做后面的运算，其中下标
\begin_inset Formula $B$
\end_inset

代表机体坐标系。首先，我们定义机体的真实姿态为
\begin_inset Formula $q_{t}$
\end_inset

，使用
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

根据前面的积分方程外推得到姿态为
\begin_inset Formula $\hat{q}$
\end_inset

，它和真实姿态之间有一个误差，定义为
\begin_inset Formula $\delta q$
\end_inset

。因为旋转运算只对乘法封闭，于是
\begin_inset Formula $\delta q$
\end_inset

和
\begin_inset Formula $\hat{q}$
\end_inset

之间只能有乘法运算。但是四元数或矩阵乘法不支持交换律，这时出现第一个问题，当
\begin_inset Formula $\delta q$
\end_inset

要注入到
\begin_inset Formula $\hat{q}$
\end_inset

中，使得
\begin_inset Formula $\hat{q}$
\end_inset

是最优估计，那么
\begin_inset Formula $\delta q$
\end_inset

乘在
\begin_inset Formula $\hat{q}$
\end_inset

的左边还是右边？
\end_layout

\begin_layout Standard
对于JPL约定，他们选择
\begin_inset Formula $\delta q$
\end_inset

是局部的角度误差，也就是文献[4]第5.3节“连续时间的系统动力学”中提到的“角度误差
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

同样是相对于标称方向的局部 (locally)定义”，就是和动力学微分方程(7)的方向一致，在这里是左乘：
\begin_inset Formula 
\[
q_{t}=\delta q\otimes\hat{q}
\]

\end_inset


\end_layout

\begin_layout Standard
于是有
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{I}^{B}\left(q_{t}\right) & =\boldsymbol{R}_{I}^{B}\left(\delta q\otimes\hat{q}\right)\\
 & =\boldsymbol{R}_{I}^{B}\left(\delta q\right)\cdot\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\\
 & \approx\left(\boldsymbol{I}_{3\times3}-\left[\delta\boldsymbol{\theta}\times\right]\right)\cdot\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
对于Hamilton约定，如果我们同样选择
\begin_inset Formula $\delta q$
\end_inset

是局部的角度误差，和动力学微分方程(6)的顺序一致，也就是右乘
\begin_inset Formula $\hat{q}=\hat{q}\odot\delta q$
\end_inset

，为了使得后面的推导结果和JPL约定的一致，这时选择四元数乘法与旋转矩阵的乘法的映射为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{I}^{B}\left(q\right) & =\boldsymbol{R}_{I}^{B}\left(\hat{q}\odot\delta q\right)\\
 & =\boldsymbol{R}_{I}^{B}\left(\delta q\right)\cdot\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\\
\\
\boldsymbol{R}_{B}^{I}\left(q\right) & =\left(\boldsymbol{R}_{I}^{B}\left(q\right)\right)^{\mathrm{T}}\\
\boldsymbol{R}_{B}^{I}\left(\hat{q}\odot\delta q\right) & =\left(\boldsymbol{R}_{I}^{B}\left(\hat{q}\odot\delta q\right)\right)^{\mathrm{T}}\\
 & =\left(\boldsymbol{R}_{I}^{B}\left(\delta q\right)\cdot\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\right)^{\mathrm{T}}\\
 & =\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)\cdot\boldsymbol{R}_{B}^{I}\left(\delta q\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
于是有：
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}_{B}^{I}\left(q\right) & =\boldsymbol{R}_{B}^{I}\left(\hat{q}\odot\delta q\right)\\
 & =\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)\cdot\boldsymbol{R}_{B}^{I}\left(\delta q\right)\\
 & \approx\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)\cdot\left(\boldsymbol{I}_{3\times3}+\left[\delta\boldsymbol{\theta}\times\right]\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这两种矩阵不同，但在后面的计算 Jacobian 矩阵时得到一样的结果，也就是不管使用什么约定，物理模型只有一个结果。但是对于Hamilton约定，我们需要时刻
注意
\begin_inset Formula $\boldsymbol{R}$
\end_inset

的上下标，因为稍微不注意，就得到不同的结果。
\end_layout

\begin_layout Standard
这是文献[7]的提议：
\begin_inset Formula 
\[
\boldsymbol{C}_{H}\left(_{B}^{I}q\right)=\boldsymbol{R}_{I}^{B}
\]

\end_inset

该提议能保持同构：
\begin_inset Formula 
\[
\boldsymbol{C}_{H}\left(\hat{q}\otimes\delta q\right)=\boldsymbol{C}_{H}\left(\hat{q}\right)\boldsymbol{C}_{H}\left(\delta q\right)
\]

\end_inset


\end_layout

\begin_layout Standard
文献[7]的提议很好，但是这里还是有一次上下标的坐标系的翻转，不符合抄写的直觉。对于Hamilton约定，不管乘法顺序还是上下标顺序，始终有一次翻转。
\end_layout

\begin_layout Standard
事情就是这么无奈。因为Malcolm D.
 Shuster最先发现Hamilton约定的反同态问题并提出了JPL约定。并且误差状态卡尔曼滤波器是在NASA中被发明出来。而他和F.
 Landis Markley，既是研究ESKF的主力，也是推广JPL约定的主力。出现得最早又把最好的地方给占住了，在这个领域不管你怎么走都会碰倒他们。后来的人
有再多的解释，始终要容纳Hamilton约定有一次翻转的不完美事实。
\end_layout

\begin_layout Standard
不管怎么样，如果要学习卡尔曼滤波器和姿态估计，了解 JPL 约定是少不了的工作，因为 NASA / JPL 这群聪明人同样也是这方面的研究主力。于是
 JPL 约定就像泥石流一样，肆虐着四元数的应用领域。
\end_layout

\begin_layout Standard
本文后面的方程推导，采用的是Hamilton约定，因为采用Hamilton约定的开源软件是最多的，容易验证对错。并且用开源的Eigen库是最方便快捷计算四元数和
矩阵的旋转。本文采用文献[4]的方程编排和推导结果，因为文献[3]也有同样的结果，所以照着推导，无论过程还是结果都容易得到验证。
\end_layout

\begin_layout Section
预测步骤
\end_layout

\begin_layout Subsection
状态量的设计
\end_layout

\begin_layout Standard
这里设计的状态量，是文献[4]里的简化版本，为演示用，如果用在工程中，还需要做很多工程上的考量。
\end_layout

\begin_layout Standard
位姿
\begin_inset Formula $\mathrm{SE}(3)$
\end_inset

属于李群中的运动群。全状态量
\begin_inset Formula $\boldsymbol{\mathcal{X}}$
\end_inset

是组合流形
\begin_inset Formula $\mathcal{M}$
\end_inset

中的一个元素，它是以状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

形式存储：
\begin_inset Formula 
\[
\boldsymbol{x}=\left[\begin{array}{cccccc}
q^{\mathrm{T}} & \boldsymbol{V}_{I}^{\mathrm{T}} & \boldsymbol{P}_{I}^{\mathrm{T}} & \boldsymbol{\omega}_{b}^{\mathrm{T}} & \boldsymbol{a}_{b}^{\mathrm{T}} & \boldsymbol{M}_{b}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\]

\end_inset

其中，姿态四元数
\begin_inset Formula $q$
\end_inset

，用于定义 XYZ 机体坐标系相对于 NED 导航
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
坐标系
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
的姿态，
\begin_inset Formula 
\[
q=\left[\begin{array}{c}
x\\
y\\
z\\
w
\end{array}\right]=\left[\begin{array}{c}
\mathbf{q}\\
w
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{V}_{I}$
\end_inset

表示在 NED 坐标系的机体速度，
\begin_inset Formula 
\[
\boldsymbol{V}_{I}=\left[\begin{array}{c}
V_{I_{x}}\\
V_{I_{y}}\\
V_{I_{z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{P}_{I}$
\end_inset

表示在 NED 坐标系的机体位置，
\begin_inset Formula 
\[
\boldsymbol{P}_{I}=\left[\begin{array}{c}
P_{I_{x}}\\
P_{I_{y}}\\
P_{I_{z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{\omega}_{b}$
\end_inset

表示在 XYZ 机体坐标系的角速度偏差(bias)，
\begin_inset Formula 
\[
\boldsymbol{\omega}_{b}=\left[\begin{array}{c}
\omega_{b_{x}}\\
\omega_{b_{y}}\\
\omega_{b_{z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{a}_{b}$
\end_inset

表示在 XYZ 机体坐标系的加速度偏差(bias)，
\begin_inset Formula 
\[
\boldsymbol{a}_{b}=\left[\begin{array}{c}
a_{b_{x}}\\
a_{b_{y}}\\
a_{b_{z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{M}_{b}$
\end_inset

表示在 XYZ 机体坐标系的磁场偏差(bias)
\begin_inset Formula 
\[
\boldsymbol{M}_{b}=\left[\begin{array}{c}
M_{b_{x}}\\
M_{b_{y}}\\
M_{b_{z}}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
所使用的传感器与用途列表：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="6">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测量值
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
符号
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
单位
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
来源
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最小频率
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
用途
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
加速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s^{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
地球磁场
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{gauss}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
磁力计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{V}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
这是一种常见的设计，其中姿态四元数
\begin_inset Formula $q$
\end_inset

与表示在 NED 坐标系的
\begin_inset Formula $\boldsymbol{P}_{I}$
\end_inset

构成位姿矩阵
\begin_inset Formula $\boldsymbol{T}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{T}=\left[\begin{array}{cc}
\boldsymbol{R}\left(q\right) & \boldsymbol{P}\\
\boldsymbol{0}^{\mathrm{T}} & 1
\end{array}\right]
\]

\end_inset

而角速度
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

的积分构成增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}$
\end_inset

，加速度
\begin_inset Formula $\boldsymbol{a}$
\end_inset

的积分构成增量速度
\begin_inset Formula $\boldsymbol{\Delta V}$
\end_inset

，两者构成速度旋量
\begin_inset Formula $\boldsymbol{\xi}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{\xi}=\left[\begin{array}{c}
\boldsymbol{\Delta\theta}\\
\boldsymbol{\Delta V}
\end{array}\right]
\]

\end_inset

速度旋量
\begin_inset Formula $\boldsymbol{\xi}$
\end_inset

通过指数映射函数
\begin_inset Formula $\mathrm{Exp}\left(\;\right)$
\end_inset

进入到流形以后再作用到位姿矩阵
\begin_inset Formula $\boldsymbol{T}$
\end_inset

上，则位姿矩阵沿测地线移动到新的位姿点上，这是旋量理论的内容。
\end_layout

\begin_layout Standard
这是基于运动学方程的设计。之所以不采用动力学方程的设计，是因为外部环境多变，并且质量分布也变化，因此无法根据动力学方程精确建模。但是IMU是系统内部的部件，我们
可以精确了解它的特性，并且在这种设计里，IMU的噪声就是系统的过程噪声，能精确测量就能精确建模，因此基于运动学方程设计的系统更好设计。
\end_layout

\begin_layout Standard
另外，估计下标为
\begin_inset Formula $b$
\end_inset

的传感器偏差值，是一种传感器自校正的算法。
\end_layout

\begin_layout Subsection
标称状态量建模
\end_layout

\begin_layout Standard
物体的运动有两种基本方式：旋转和位移。旋转由角速度所驱动，位移由速度所驱动。惯性是物体的内赋秉性，惯性测量单元（Inertial measurement
 unit, IMU）利用惯性测量出物体在机体坐标系中的
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}$
\end_inset

数据，一般比较精确也很难被外界干扰。所以将IMU数据用于旋转和位移的状态预测，
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}$
\end_inset

两者构成标称状态量的转移方程中的控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

。
\end_layout

\begin_layout Standard
IMU传感器定时采样，采样间隔时间为
\begin_inset Formula $\Delta t$
\end_inset

，获得
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
测量角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}_{m}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}_{m}$
\end_inset

数据。所以我们得到增量角度的测量值为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta\theta}_{m}=\boldsymbol{\omega}_{m}\Delta t\label{eq:8}
\end{equation}

\end_inset

还有增量速度的测量值为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta V}_{m}=\boldsymbol{a}_{m}\Delta t\label{eq:9}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
已知陀螺仪的测量方差为
\begin_inset Formula $\boldsymbol{\sigma}_{gyro}^{2}$
\end_inset

，加速计的测量方差为
\begin_inset Formula $\boldsymbol{\sigma}_{accel}^{2}$
\end_inset

。所以我们有增量角度的测量方差为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}=\boldsymbol{\sigma}_{gyro}^{2}\Delta t^{2}\label{eq:10}
\end{equation}

\end_inset

还有增量速度的测量方差为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}=\boldsymbol{\sigma}_{accel}^{2}\Delta t^{2}\label{eq:11}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测量值
\begin_inset Formula $\boldsymbol{\Delta\theta}_{m}$
\end_inset

和增量角度偏差
\begin_inset Formula $\boldsymbol{\Delta\theta}_{b}=\boldsymbol{\omega}_{b}\Delta t$
\end_inset

计算出真增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{t}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta\theta}_{t}=\boldsymbol{\Delta\theta}_{m}-\boldsymbol{\Delta\theta}_{b}\label{eq:12}
\end{equation}

\end_inset

增量四元数
\begin_inset Formula $\Delta q$
\end_inset

定义了从第
\begin_inset Formula $k$
\end_inset

时刻到第
\begin_inset Formula $k+1$
\end_inset

时刻四元数的旋转，使用小角度近似从真增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{t}$
\end_inset

计算：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\Delta q=\left[\begin{array}{c}
1\\
\dfrac{\boldsymbol{\Delta\theta}_{t}}{2}
\end{array}\right]\label{eq:13}
\end{equation}

\end_inset

从
\begin_inset Formula $k$
\end_inset

时刻到
\begin_inset Formula $k+1$
\end_inset

时刻，四元数乘积规则用于将姿态四元数
\begin_inset Formula $q$
\end_inset

的状态向前旋转增量四元数
\begin_inset Formula $\Delta q$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
q_{k+1} & =q_{k}\cdot\Delta q\\
 & =q_{k}+q_{k}\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{t}}{2}
\end{array}\right]
\end{array}\label{eq:14}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测量值
\begin_inset Formula $\boldsymbol{\Delta V}_{m}$
\end_inset

和增量速度偏差
\begin_inset Formula $\boldsymbol{\Delta V}_{b}=\boldsymbol{a}_{b}\Delta t$
\end_inset

计算出机体坐标系的真增量速度
\begin_inset Formula $\boldsymbol{\Delta V}_{t}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta V}_{t}=\boldsymbol{\Delta V}_{m}-\boldsymbol{\Delta V}_{b}\label{eq:15}
\end{equation}

\end_inset

已知
\begin_inset Formula $k$
\end_inset

时刻的机体速度为
\begin_inset Formula $\boldsymbol{V}_{I}$
\end_inset

，从
\begin_inset Formula $k$
\end_inset

时刻到
\begin_inset Formula $k+1$
\end_inset

时刻，将真增量速度向量
\begin_inset Formula $\boldsymbol{\Delta V}_{t}$
\end_inset

从机体坐标系旋转到惯性坐标系，并减去重力，计算速度状态变化：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\left(\boldsymbol{V}_{I}\right)_{k+1} & =\left(\boldsymbol{V}_{I}\right)_{k}+\boldsymbol{R}_{B}^{I}\left(q_{k}\right)\cdot\boldsymbol{\Delta V}_{t}+\left[\begin{array}{c}
0\\
0\\
-g
\end{array}\right]\cdot\Delta t\end{array}\label{eq:16}
\end{equation}

\end_inset

对于机体位置
\begin_inset Formula $\boldsymbol{P}_{I}$
\end_inset

则使用欧拉积分更新位置状态：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\left(\boldsymbol{P}_{I}\right)_{k+1} & =\left(\boldsymbol{P}_{I}\right)_{k}+\left(\boldsymbol{V}_{I}\right)_{k}\cdot\Delta t\end{array}+\dfrac{1}{2}\left(\boldsymbol{R}_{B}^{I}\left(q_{k}\right)\left(\boldsymbol{a}_{m}-\boldsymbol{a}_{b}\right)+\left[\begin{array}{c}
0\\
0\\
-g
\end{array}\right]\right)\Delta t^{2}\label{eq:17}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
IMU传感器的偏差、磁场偏差均采用静态过程模型：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\begin{array}{c}
\boldsymbol{\omega}_{b}\\
\boldsymbol{a}_{b}\\
\boldsymbol{M}_{b}
\end{array}\right]_{k+1}=\left[\begin{array}{c}
\boldsymbol{\omega}_{b}\\
\boldsymbol{a}_{b}\\
\boldsymbol{M}_{b}
\end{array}\right]_{k}\label{eq:18}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
将上述方程整理成矩阵形式，就是预测(先验)状态估计
\begin_inset Formula 
\begin{align*}
\hat{\boldsymbol{\mathcal{X}}}_{k+1|k} & =\hat{\boldsymbol{\mathcal{X}}}_{k|k}\oplus\boldsymbol{u}_{k+1}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
我们关心位姿
\begin_inset Formula $\boldsymbol{T}$
\end_inset

的算子
\begin_inset Formula $\oplus$
\end_inset

。简化的表示，对于
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
校正后的角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}_{t}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
线性加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}_{t}$
\end_inset

得到
\begin_inset Formula 
\begin{align*}
\boldsymbol{\Delta\theta}_{t} & =\boldsymbol{\omega}_{t}\Delta t\\
\boldsymbol{\Delta V}_{t} & =\boldsymbol{a}_{t}\Delta t
\end{align*}

\end_inset

根据旋量理论，得到增量位姿
\begin_inset Formula $\Delta\boldsymbol{T}$
\end_inset

为
\begin_inset Formula 
\begin{align*}
\Delta\boldsymbol{T} & =\exp\left(\boldsymbol{\xi}^{\wedge}\right)\\
 & =\exp\left(\left[\begin{array}{c}
\boldsymbol{\Delta\theta}_{t}\\
\boldsymbol{\Delta V}_{t}
\end{array}\right]^{\wedge}\right)\\
 & =\exp\left(\left[\begin{array}{cc}
\left(\boldsymbol{\Delta\theta}_{t}\right)^{\wedge} & \boldsymbol{\Delta V}_{t}\\
\boldsymbol{0}^{\mathrm{T}} & 0
\end{array}\right]\right)\\
 & =\left[\begin{array}{cc}
\Delta\boldsymbol{R} & \boldsymbol{V}\boldsymbol{\Delta V}_{t}\\
\boldsymbol{0}^{\mathrm{T}} & 1
\end{array}\right]
\end{align*}

\end_inset

则新的位姿
\begin_inset Formula $\boldsymbol{T}_{k+1}$
\end_inset

为
\begin_inset Formula 
\begin{align*}
\boldsymbol{T}_{k+1} & =\boldsymbol{T}_{k}\oplus\Delta\boldsymbol{T}\\
 & =\left[\begin{array}{cc}
\boldsymbol{R}_{k} & \boldsymbol{P}_{k}\\
\boldsymbol{0}^{\mathrm{T}} & 1
\end{array}\right]\left[\begin{array}{cc}
\Delta\boldsymbol{R} & \boldsymbol{V}\boldsymbol{\Delta V}_{t}\\
\boldsymbol{0}^{\mathrm{T}} & 1
\end{array}\right]\\
 & =\left[\begin{array}{cc}
\boldsymbol{R}_{k}\Delta\boldsymbol{R} & \boldsymbol{P}_{k}+\boldsymbol{R}_{k}\boldsymbol{V}\boldsymbol{\Delta V}_{t}\\
\boldsymbol{0}^{\mathrm{T}} & 1
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
从位姿矩阵的组合方程可以看出，
\begin_inset Formula $k+1$
\end_inset

时刻的平移是增量旋转和增量平移的交错，计算量很大。而前面的工程式则做了很多假设，简化了计算，提高了速度。所以这里的方程符合
\begin_inset Formula $\mathrm{SE}(3)$
\end_inset

组合算子
\begin_inset Formula $\oplus$
\end_inset

的定义。
\end_layout

\begin_layout Standard
上述方程已经完成预测(先验)状态估计的计算，剩下的事情似乎很简单，将这些状态值交给卡尔曼滤波器去做最优估计。可惜这种想法是有问题的。因为旋转不是向量，而是群，它
只对乘法封闭。卡尔曼滤波器假定所有的状态变量都是向量，同时，它的核心概念，协方差矩阵，其所使用的算子是减法'-'，就不能用于旋转中。因为这种数学上的冲突，一群N
ASA的聪明人想出了一个解决方案：误差状态卡尔曼滤波器。
\end_layout

\begin_layout Subsection
误差状态量建模
\end_layout

\begin_layout Standard
误差状态卡尔曼滤波器的优点与解释见文献[4]中第5章的内容，这里不再重复。
\end_layout

\begin_layout Standard
上一节所估计的状态被称为标称状态。相对应的真实值被称为真实状态。真实状态和标称状态之间的差异被称为误差状态。标称状态因为包含旋转所以不能直接使用卡尔曼滤波器进行
最优估计。但是精心设计的误差状态都是向量值，所以可以直接使用卡尔曼滤波器进行最优估计。最终将误差状态注入到标称状态，则标称状态也成了最优估计。
\end_layout

\begin_layout Standard
在此选择的误差状态向量为：
\begin_inset Formula 
\[
\delta\boldsymbol{x}=\left[\begin{array}{cccccc}
\delta\boldsymbol{\theta}^{\mathrm{T}} & \delta\boldsymbol{V}^{\mathrm{T}} & \delta\boldsymbol{P}^{\mathrm{T}} & \delta\boldsymbol{\omega}_{b}^{\mathrm{T}} & \delta\boldsymbol{a}_{b}^{\mathrm{T}} & \delta\boldsymbol{M}_{b}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\]

\end_inset

其中，
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

是姿态误差的三维向量化表示，速度误差
\begin_inset Formula $\delta\boldsymbol{V}$
\end_inset

和位置误差
\begin_inset Formula $\delta\boldsymbol{P}$
\end_inset

位于NED坐标系中，角速度偏差
\begin_inset Formula $\boldsymbol{\omega}_{b}$
\end_inset

，加速度偏差
\begin_inset Formula $\boldsymbol{a}_{b}$
\end_inset

，磁力计偏差
\begin_inset Formula $\boldsymbol{M}_{b}$
\end_inset

位于机体坐标系中。
\end_layout

\begin_layout Standard
真实状态、标称状态和误差状态之间的关系见下表：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="15" columns="7">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
向量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
真实
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
标称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
误差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
组合
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
噪声
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
全状态
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{x}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{x}_{t}=\hat{\boldsymbol{x}}\oplus\delta\boldsymbol{x}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{P}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{P}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{t}=\hat{\boldsymbol{P}}+\delta\boldsymbol{P}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{V}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{V}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{V}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{V}_{t}=\hat{\boldsymbol{V}}+\delta\boldsymbol{V}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
四元数
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $q_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{q}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta q$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $q_{t}=\hat{q}\otimes\delta q$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
旋转矩阵
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{R}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{R}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{R}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{R}_{t}=\boldsymbol{R}\cdot\delta\boldsymbol{R}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角度向量
\end_layout

\end_inset
</cell>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta q=e^{\delta\boldsymbol{\theta}/2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{R}=e^{\left[\delta\boldsymbol{\theta}\times\right]}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
陀螺仪偏差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{bt}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{\omega}}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{\omega}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{bt}=\hat{\boldsymbol{\omega}}_{b}+\delta\boldsymbol{\omega}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{w}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
加速计偏差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{bt}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{a}}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{a}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{bt}=\hat{\boldsymbol{a}}_{b}+\delta\boldsymbol{a}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{w}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
磁力计偏差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{bt}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{M}}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\delta\boldsymbol{M}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{bt}=\hat{\boldsymbol{M}}_{b}+\delta\boldsymbol{M}_{b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{w}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{m}=\boldsymbol{\omega}_{t}+\boldsymbol{\omega}_{bt}+\boldsymbol{\omega}_{n}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{m}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}_{n}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
加速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{m}=\boldsymbol{R}_{t}^{\mathrm{T}}\cdot\left(\boldsymbol{a}_{t}-\boldsymbol{g}_{t}\right)+\boldsymbol{a}_{bt}+\boldsymbol{a}_{n}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{m}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}_{n}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
地磁
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{m}=\boldsymbol{R}_{t}^{\mathrm{T}}\cdot\boldsymbol{M}_{t}+\boldsymbol{M}_{bt}+\boldsymbol{M}_{n}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{m}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{n}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
重力向量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{g}_{t}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{g}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
其中，旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

为
\begin_inset Formula $\boldsymbol{R}_{B}^{I}$
\end_inset

的简化，表示从机体坐标系变换到惯性坐标系的旋转。相应的
\begin_inset Formula $\boldsymbol{R}^{\mathrm{T}}$
\end_inset

为
\begin_inset Formula $\boldsymbol{R}_{I}^{B}$
\end_inset

的简化。注意四元数和旋转矩阵的组合方程，根据前面的讨论，我们选择
\begin_inset Formula 
\begin{align*}
q_{t} & =\hat{q}\otimes\delta q\\
\boldsymbol{R}_{B}^{I}\left(q_{t}\right) & =\boldsymbol{R}_{B}^{I}\left(\hat{q}\otimes\delta q\right)\\
 & =\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)\cdot\boldsymbol{R}_{B}^{I}\left(\delta q\right)\\
 & \approx\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)\cdot\left(\boldsymbol{I}_{3\times3}+\left[\delta\boldsymbol{\theta}\times\right]\right)
\end{align*}

\end_inset

这是文献[4]第5.3.3节方程(238)的选择，是其推导方程(237b)的基础。如果选择常规的旋转矩阵翻转，则推导出另外的结果。
\end_layout

\begin_layout Standard
误差状态建模一个很重要的假设就是：系统的误差由噪声所驱动。因此误差状态向量的转移方程中的控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

由传感器的噪声构成，因此误差状态向量的控制输入矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

又称为干扰矩阵。
\end_layout

\begin_layout Subsection
连续时间的系统动力学
\end_layout

\begin_layout Subsubsection
真实状态动力学
\end_layout

\begin_layout Standard
真实状态动力学是
\begin_inset Formula 
\begin{align*}
\dot{q}_{t} & =\dfrac{1}{2}q_{t}\cdot\boldsymbol{\omega}_{t}\\
\dot{\boldsymbol{V}}_{t} & =\boldsymbol{a}_{t}\\
\dot{\boldsymbol{P}}_{t} & =\boldsymbol{V}_{t}\\
\dot{\boldsymbol{\omega}}_{bt} & =\boldsymbol{\omega}_{w}\\
\dot{\boldsymbol{a}}_{bt} & =\boldsymbol{a}_{w}\\
\dot{\boldsymbol{M}}_{bt} & =\boldsymbol{M}_{w}
\end{align*}

\end_inset

在这里，根据传感器动力学误差模型，在机体坐标系中，从 IMU 中以带噪声的传感器读数
\begin_inset Formula $\boldsymbol{\omega}_{m}$
\end_inset

和
\begin_inset Formula $\boldsymbol{a}_{m}$
\end_inset

的形式获得真实的角速度
\begin_inset Formula $\boldsymbol{\omega}_{t}$
\end_inset

和加速度
\begin_inset Formula $\boldsymbol{a}_{t}$
\end_inset

 ，从磁力计中以带噪声的传感器读数
\begin_inset Formula $\boldsymbol{M}_{m}$
\end_inset

的形式获得真实的地磁数据
\begin_inset Formula $\boldsymbol{M}_{t}$
\end_inset

，即
\begin_inset Formula 
\begin{align*}
\boldsymbol{\omega}_{m} & =\boldsymbol{\omega}_{t}+\boldsymbol{\omega}_{bt}+\boldsymbol{\omega}_{n}\\
\boldsymbol{a}_{m} & =\boldsymbol{R}_{t}^{\mathrm{T}}\cdot\left(\boldsymbol{a}_{t}-\boldsymbol{g}_{t}\right)+\boldsymbol{a}_{bt}+\boldsymbol{a}_{n}\\
\boldsymbol{M}_{m} & =\boldsymbol{R}_{t}^{\mathrm{T}}\cdot\boldsymbol{M}_{t}+\boldsymbol{M}_{bt}+\boldsymbol{M}_{n}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{R}_{t}\triangleq\boldsymbol{R}_{B}^{I}\left(q_{t}\right)$
\end_inset

。这样，真实值就可以被分离出来 (这意味着我们已经将测量方程颠倒了)，
\begin_inset Formula 
\begin{align*}
\boldsymbol{\omega}_{t} & =\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{bt}-\boldsymbol{\omega}_{n}\\
\boldsymbol{a}_{t} & =\boldsymbol{R}_{t}\cdot\left(\boldsymbol{a}_{m}-\boldsymbol{a}_{bt}-\boldsymbol{a}_{n}\right)+\boldsymbol{g}_{t}\\
\boldsymbol{M}_{t} & =\boldsymbol{R}_{t}\cdot\left(\boldsymbol{M}_{m}-\boldsymbol{M}_{bt}-\boldsymbol{M}_{n}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
代入上面的结果得到真实状态的动力学系统
\begin_inset Formula 
\begin{align*}
\dot{q}_{t} & =\dfrac{1}{2}q_{t}\cdot\left(\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{bt}-\boldsymbol{\omega}_{n}\right)\\
\dot{\boldsymbol{V}}_{t} & =\boldsymbol{R}_{t}\cdot\left(\boldsymbol{a}_{m}-\boldsymbol{a}_{bt}-\boldsymbol{a}_{n}\right)+\boldsymbol{g}_{t}\\
\dot{\boldsymbol{P}}_{t} & =\boldsymbol{V}_{t}\\
\dot{\boldsymbol{\omega}}_{bt} & =\boldsymbol{\omega}_{w}\\
\dot{\boldsymbol{a}}_{bt} & =\boldsymbol{a}_{w}\\
\dot{\boldsymbol{M}}_{bt} & =\boldsymbol{M}_{w}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
我们可以把它命名为
\begin_inset Formula $\boldsymbol{x}_{t}=f_{t}(\boldsymbol{x}_{t},\boldsymbol{u},\boldsymbol{w})$
\end_inset

。这个系统具有状态
\begin_inset Formula $\boldsymbol{x}_{t}$
\end_inset

，由 IMU 带噪声的读数
\begin_inset Formula $\boldsymbol{u}$
\end_inset

控制，并受白高斯噪声
\begin_inset Formula $\boldsymbol{w}$
\end_inset

干扰，所有这些都定义为
\begin_inset Formula 
\[
\boldsymbol{x}_{t}=\left[\begin{array}{cccccc}
q_{t}^{\mathrm{T}} & \boldsymbol{V}_{t}^{\mathrm{T}} & \boldsymbol{P}_{t}^{\mathrm{T}} & \boldsymbol{\omega}_{bt}^{\mathrm{T}} & \boldsymbol{a}_{bt}^{\mathrm{T}} & \boldsymbol{M}_{bt}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}},\;\boldsymbol{u}=\left[\begin{array}{c}
\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{n}\\
\boldsymbol{a}_{m}-\boldsymbol{a}_{n}\\
\boldsymbol{M}_{m}-\boldsymbol{M}_{n}
\end{array}\right],\;\boldsymbol{w}=\left[\begin{array}{c}
\boldsymbol{\omega}_{w}\\
\boldsymbol{a}_{w}\\
\boldsymbol{M}_{w}
\end{array}\right]
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{M}_{w}$
\end_inset

为磁强计的过程噪声。磁强计将在最终的 Kalman 滤波实现中用作测量。磁强计不是惯性传感器，其误差动态与惯性导航状态不耦合，但由于 Kalman
 滤波测量更新方程会引入一定的相关性，因此仍会在总误差状态 向量中增加偏差项。这里的磁强计偏差向量
\begin_inset Formula $\boldsymbol{M}_{m}-\boldsymbol{M}_{n}$
\end_inset

被视为一个缓慢发散的随机游走过程，由噪声过程
\begin_inset Formula $\boldsymbol{M}_{w}$
\end_inset

驱动，具有互相关。
\end_layout

\begin_layout Subsubsection
标称状态动力学
\end_layout

\begin_layout Standard
我们要做最优估计的目标，标称状态向量为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\hat{\boldsymbol{x}}=\left[\begin{array}{cccccc}
\hat{q}^{\mathrm{T}} & \hat{\boldsymbol{V}}^{\mathrm{T}} & \hat{\boldsymbol{P}}^{\mathrm{T}} & \hat{\boldsymbol{\omega}}_{b}^{\mathrm{T}} & \hat{\boldsymbol{a}}_{b}^{\mathrm{T}} & \hat{\boldsymbol{M}}_{b}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
标称状态动力学对应于无噪声或扰动的建模系统，也就是最终估计出来的结果去除了噪声或扰动，
\begin_inset Formula 
\begin{align*}
\dot{\hat{q}} & =\dfrac{1}{2}\hat{q}\cdot\left(\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}\right)\\
\dot{\hat{\boldsymbol{V}}} & =\boldsymbol{R}\cdot\left(\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\right)+\boldsymbol{g}\\
\dot{\hat{\boldsymbol{P}}} & =\hat{\boldsymbol{V}}\\
\dot{\hat{\boldsymbol{\omega}}}_{b} & =0\\
\dot{\hat{\boldsymbol{a}}}_{b} & =0\\
\dot{\hat{\boldsymbol{M}}}_{b} & =0
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{R}\triangleq\boldsymbol{R}_{B}^{I}\left(\hat{q}\right)$
\end_inset

。
\end_layout

\begin_layout Subsubsection
误差状态动力学
\end_layout

\begin_layout Standard
目标是确定误差状态的线性化动力学。有误差状态向量：
\begin_inset Formula 
\begin{equation}
\delta\boldsymbol{x}=\left[\begin{array}{cccccc}
\delta\boldsymbol{\theta}^{\mathrm{T}} & \delta\boldsymbol{V}^{\mathrm{T}} & \delta\boldsymbol{P}^{\mathrm{T}} & \delta\boldsymbol{\omega}_{b}^{\mathrm{T}} & \delta\boldsymbol{a}_{b}^{\mathrm{T}} & \delta\boldsymbol{M}_{b}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
对于每个状态方程，我们在上表中显示了它和标称状态的组合方程，在此求解误差状态并简化所有二阶无穷小。我们在此给出全误差状态动力学系统，并进行证明。
\begin_inset Formula 
\begin{align}
\dot{\delta\boldsymbol{\theta}} & =-\left[\left(\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}\right)\times\right]\delta\boldsymbol{\theta}-\delta\boldsymbol{\omega}_{b}-\boldsymbol{\omega}_{n}\\
\dot{\delta\boldsymbol{V}} & =-\boldsymbol{R}\cdot\left[\left(\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\right)\times\right]\delta\boldsymbol{\theta}-\boldsymbol{R}\cdot\delta\boldsymbol{a}_{b}-\boldsymbol{R}\cdot\boldsymbol{a}_{n}\\
\dot{\delta\boldsymbol{P}} & =\delta\boldsymbol{V}\\
\delta\dot{\boldsymbol{\omega}}_{b} & =\boldsymbol{\omega}_{w}\\
\delta\dot{\boldsymbol{a}}_{b} & =\boldsymbol{a}_{w}\\
\delta\dot{\boldsymbol{M}}_{b} & =\boldsymbol{M}_{w}
\end{align}

\end_inset


\end_layout

\begin_layout Standard
方程 (23)，(24)，(25) 和 (26)，分别是位置和3个偏差，从线性方程组导出，并且它们的误差状态动力学是平凡的。
\end_layout

\begin_layout Standard
姿态误差方程 (21) 和速度方程 (22)，需要对非线性方程 (21) 和 (22) 进行一些非平凡的操作，以获得线性化动力学。它们的证明在以下两个部分中展开
。
\end_layout

\begin_layout Paragraph
姿态误差动力学
\end_layout

\begin_layout Standard
我们想确定
\begin_inset Formula $\dot{\delta\boldsymbol{\theta}}$
\end_inset

，角度误差的动力学。我们从以下关系开始
\begin_inset Formula 
\begin{align*}
\dot{q}_{t} & =\dfrac{1}{2}q_{t}\cdot\boldsymbol{\omega}_{t}\\
\dot{\hat{q}} & =\dfrac{1}{2}\hat{q}\cdot\boldsymbol{\omega}
\end{align*}

\end_inset

这是四元数导数的真实定义和标称定义。其中，
\begin_inset Formula $q$
\end_inset

为估计的相对于惯性坐标系的机体当前姿态。
\end_layout

\begin_layout Standard
为了清晰起见，我们把角速度按大信号和小信号项分组，
\begin_inset Formula 
\begin{align*}
\hat{\boldsymbol{\omega}} & \triangleq\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}\\
\delta\boldsymbol{\omega} & \triangleq-\left(\boldsymbol{\omega}_{bt}-\hat{\boldsymbol{\omega}}_{b}\right)-\boldsymbol{\omega}_{n}\\
 & =-\delta\boldsymbol{\omega}_{b}-\boldsymbol{\omega}_{n}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\hat{\boldsymbol{\omega}}$
\end_inset

即为机体坐标系中估计的角速度。则真实角速度
\begin_inset Formula $\boldsymbol{\omega}_{t}$
\end_inset

可以分为一个标称部分和一个误差部分，
\begin_inset Formula 
\begin{align*}
\boldsymbol{\omega}_{t} & =\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{bt}-\boldsymbol{\omega}_{n}\\
 & =\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}-\left(\boldsymbol{\omega}_{bt}-\hat{\boldsymbol{\omega}}_{b}\right)-\boldsymbol{\omega}_{n}\\
 & =\hat{\boldsymbol{\omega}}+\delta\boldsymbol{\omega}
\end{align*}

\end_inset

根据上一小节的说明，由此看出，
\begin_inset Formula $\hat{\boldsymbol{\omega}}$
\end_inset

去除了噪声或扰动，而将噪声或扰动集中于
\begin_inset Formula $\delta\boldsymbol{\omega}$
\end_inset

中。后面的误差动力系统也就是要对
\begin_inset Formula $\delta\boldsymbol{\omega}$
\end_inset

的变化进行分析。
\end_layout

\begin_layout Standard
对于
\begin_inset Formula $\dot{\delta\boldsymbol{\theta}}$
\end_inset

，我们先根据方程
\begin_inset Formula $q_{t}=\delta q\cdot\hat{q}$
\end_inset

，得到
\begin_inset Formula $\delta q=q_{t}\cdot\hat{q}^{-1}$
\end_inset

，然后对此方程求微分
\begin_inset Formula 
\begin{align*}
\delta q\left(\delta\boldsymbol{\theta}\right) & =q\cdot\hat{q}^{-1}\\
\dot{\delta q}\left(\delta\boldsymbol{\theta}\right) & =\dot{q}\cdot\hat{q}^{-1}+q\cdot\dot{\hat{q}}^{-1}\\
 & \because\hat{q}^{-1}\cdot\hat{q}=1\;\therefore\dfrac{\mathrm{d}\left(\hat{q}^{-1}\cdot\hat{q}\right)}{\mathrm{d}t}=0\\
 & \because\dfrac{\mathrm{d}\left(\hat{q}^{-1}\cdot\hat{q}\right)}{\mathrm{d}t}=\dot{\hat{q}}^{-1}\cdot\hat{q}+\hat{q}^{-1}\cdot\dot{\hat{q}}\\
 & \therefore\dot{\hat{q}}^{-1}=-\hat{q}^{-1}\cdot\dot{\hat{q}}\cdot\hat{q}^{-1}=-\hat{q}^{-1}\cdot\dfrac{1}{2}\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\hat{q}\cdot\hat{q}^{-1}=-\dfrac{1}{2}\hat{q}^{-1}\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\\
\dot{\delta q}\left(\delta\boldsymbol{\theta}\right) & =\dot{q}\hat{q}^{-1}+q\cdot\dot{\hat{q}}^{-1}\\
 & =\dfrac{1}{2}\left[\begin{array}{c}
0\\
\boldsymbol{\omega}_{t}
\end{array}\right]q\cdot\hat{q}^{-1}-\dfrac{1}{2}q\cdot\hat{q}^{-1}\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\\
 & =\dfrac{1}{2}\left[\begin{array}{c}
0\\
\boldsymbol{\omega}_{t}
\end{array}\right]\delta q\left(\delta\boldsymbol{\theta}\right)-\dfrac{1}{2}\delta q\left(\delta\boldsymbol{\theta}\right)\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\\
 & =\dfrac{1}{2}\left[\begin{array}{c}
0\\
\delta\boldsymbol{\omega}
\end{array}\right]\delta q\left(\delta\boldsymbol{\theta}\right)+\dfrac{1}{2}\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\delta q\left(\delta\boldsymbol{\theta}\right)-\dfrac{1}{2}\delta q\left(\delta\boldsymbol{\theta}\right)\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\\
2\dot{\delta q}\left(\delta\boldsymbol{\theta}\right) & =\left[\begin{array}{c}
0\\
\delta\boldsymbol{\omega}
\end{array}\right]\left[\begin{array}{c}
1\\
\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]+\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\left[\begin{array}{c}
1\\
\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]-\left[\begin{array}{c}
1\\
\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]\left[\begin{array}{c}
0\\
\hat{\boldsymbol{\omega}}
\end{array}\right]\\
2\left[\begin{array}{c}
\dot{1}\\
\dfrac{\dot{\delta\boldsymbol{\theta}}}{2}
\end{array}\right] & =\left[\begin{array}{c}
-\delta\boldsymbol{\omega}\cdot\dfrac{\delta\boldsymbol{\theta}}{2}\\
\delta\boldsymbol{\omega}+\delta\boldsymbol{\omega}\times\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]+\left[\begin{array}{c}
-\hat{\boldsymbol{\omega}}\cdot\dfrac{\delta\boldsymbol{\theta}}{2}\\
\hat{\boldsymbol{\omega}}+\hat{\boldsymbol{\omega}}\times\dfrac{\delta\boldsymbol{\theta}}{2}
\end{array}\right]-\left[\begin{array}{c}
-\dfrac{\delta\boldsymbol{\theta}}{2}\cdot\hat{\boldsymbol{\omega}}\\
\hat{\boldsymbol{\omega}}+\dfrac{\delta\boldsymbol{\theta}}{2}\times\hat{\boldsymbol{\omega}}
\end{array}\right]\\
\left[\begin{array}{c}
\dot{2}\\
\dot{\delta\boldsymbol{\theta}}
\end{array}\right] & =\left[\begin{array}{c}
-\delta\boldsymbol{\omega}\cdot\dfrac{\delta\boldsymbol{\theta}}{2}\\
\delta\boldsymbol{\omega}+\delta\boldsymbol{\omega}\times\dfrac{\delta\boldsymbol{\theta}}{2}-\hat{\boldsymbol{\omega}}\times\delta\boldsymbol{\theta}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
忽略
\begin_inset Formula $\dot{\delta\boldsymbol{\theta}}$
\end_inset

中高于一阶的项和与角速度误差的乘积，给出线性 EKF 近似值
\begin_inset Formula 
\begin{align*}
\dot{\delta\boldsymbol{\theta}} & =\delta\boldsymbol{\omega}-\hat{\boldsymbol{\omega}}\times\delta\boldsymbol{\theta}\\
 & =-\delta\boldsymbol{\omega}_{b}-\boldsymbol{\omega}_{n}-\left[\left(\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}\right)\times\right]\delta\boldsymbol{\theta}\\
 & =-\left[\left(\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}\right)\times\right]\delta\boldsymbol{\theta}-\delta\boldsymbol{\omega}_{b}-\boldsymbol{\omega}_{n}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在早期的论文中，
\begin_inset Formula $\delta\boldsymbol{\omega}$
\end_inset

会被展开，则该方程变为
\begin_inset Formula 
\[
\dot{\delta\boldsymbol{\theta}}=-\left[\left(\boldsymbol{\omega}_{m}-\hat{\boldsymbol{\omega}}_{b}\right)\times\right]\delta\boldsymbol{\theta}+\hat{\boldsymbol{\omega}}_{b}-\boldsymbol{\omega}_{bt}-\boldsymbol{\omega}_{n}
\]

\end_inset


\end_layout

\begin_layout Paragraph
线速度误差动力学
\end_layout

\begin_layout Standard
根据方程
\begin_inset Formula $\dot{\hat{\boldsymbol{V}}}=\boldsymbol{R}\cdot\left(\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\right)+\boldsymbol{g}$
\end_inset

，我们重写方程引入机体坐标系中的估计加速度
\begin_inset Formula $\hat{\boldsymbol{a}}_{B}$
\end_inset

和加速度偏差
\begin_inset Formula $\delta\boldsymbol{a}_{B}$
\end_inset

，定义为机体坐标系中的大信号和小信号加速度，
\begin_inset Formula 
\begin{align*}
\hat{\boldsymbol{a}}_{B} & \triangleq\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\\
\delta\boldsymbol{a}_{B} & \triangleq-\left(\boldsymbol{a}_{bt}-\hat{\boldsymbol{a}}_{b}\right)-\boldsymbol{a}_{n}\\
 & =-\delta\boldsymbol{a}_{b}-\boldsymbol{a}_{n}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\hat{\boldsymbol{a}}_{B}$
\end_inset

即为机体坐标系中估计的加速度。所以我们可以把惯性系中的真实加速度
\begin_inset Formula $\boldsymbol{a}_{t}$
\end_inset

分成大、小信号项的组合，
\begin_inset Formula 
\begin{align*}
\dot{\boldsymbol{V}} & =\boldsymbol{a}_{t}\\
 & =\boldsymbol{R}_{t}\cdot\left(\hat{\boldsymbol{a}}_{B}+\delta\boldsymbol{a}_{B}\right)+\boldsymbol{g}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
估计速度的动力学方程为，
\begin_inset Formula 
\[
\dot{\hat{\boldsymbol{V}}}=\boldsymbol{R}\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{g}
\]

\end_inset


\end_layout

\begin_layout Standard
将四元数变换为旋转矩阵的公式为
\begin_inset CommandInset href
LatexCommand href
name "Rodrigues 的旋转公式"
target "https://en.wikipedia.org/wiki/Rodrigues%27_rotation_formula"
literal "false"

\end_inset

：
\begin_inset Formula 
\[
\boldsymbol{R}\left(q\right)=2\boldsymbol{q_{v}}\boldsymbol{q_{v}}^{\mathrm{T}}+\boldsymbol{I}_{3\times3}\left(q_{r}^{2}-\boldsymbol{q_{v}}^{\mathrm{T}}\boldsymbol{q_{v}}\right)+2q_{r}\left[\boldsymbol{q_{v}}\times\right]
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
因为误差
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

很小，所以
\begin_inset Formula $q_{r}\rightarrow1,\left\Vert \boldsymbol{q_{v}}\right\Vert \rightarrow0$
\end_inset

，所以上式忽略二阶误差项：
\begin_inset Formula 
\[
\boldsymbol{R}\left(\delta q\right)=\boldsymbol{I}+\left[\delta\boldsymbol{\theta}\times\right]
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
并且
\begin_inset Formula 
\begin{align*}
\boldsymbol{R}\left(q_{t}\right) & =\boldsymbol{R}\left(\hat{q}\otimes\delta q\right)\\
 & =\boldsymbol{R}\left(\hat{q}\right)\boldsymbol{R}\left(\delta q\right)\\
 & =\boldsymbol{R}\left(\hat{q}\right)\left(\boldsymbol{I}+\left[\delta\boldsymbol{\theta}\times\right]\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
我们希望确定的
\begin_inset Formula $\dot{\delta\boldsymbol{V}}$
\end_inset

，速度误差的动力学方程为：
\begin_inset Formula 
\begin{align*}
\dot{\delta\boldsymbol{V}} & =\dot{\boldsymbol{V}}-\dot{\hat{\boldsymbol{V}}}\\
 & =\boldsymbol{R}_{t}\cdot\left(\hat{\boldsymbol{a}}_{B}+\delta\boldsymbol{a}_{B}\right)+\boldsymbol{g}-\left(\boldsymbol{R}\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{g}\right)\\
 & =\boldsymbol{R}_{t}\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{R}_{t}\cdot\delta\boldsymbol{a}_{B}-\boldsymbol{R}\cdot\hat{\boldsymbol{a}}_{B}\\
 & =\boldsymbol{R}\left(\hat{q}\right)\left(\boldsymbol{I}+\left[\delta\boldsymbol{\theta}\times\right]\right)\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{R}\left(\hat{q}\right)\left(\boldsymbol{I}+\left[\delta\boldsymbol{\theta}\times\right]\right)\cdot\delta\boldsymbol{a}_{B}-\boldsymbol{R}\left(\hat{q}\right)\cdot\hat{\boldsymbol{a}}_{B}\\
 & =\boldsymbol{R}\left(\hat{q}\right)\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{R}\left(\hat{q}\right)\left[\delta\boldsymbol{\theta}\times\right]\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{R}\left(\hat{q}\right)\cdot\delta\boldsymbol{a}_{B}+\boldsymbol{R}\left(\hat{q}\right)\left[\delta\boldsymbol{\theta}\times\right]\cdot\delta\boldsymbol{a}_{B}-\boldsymbol{R}\left(\hat{q}\right)\cdot\hat{\boldsymbol{a}}_{B}\\
 & =\boldsymbol{R}\left(\hat{q}\right)\left[\delta\boldsymbol{\theta}\times\right]\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{R}\left(\hat{q}\right)\cdot\delta\boldsymbol{a}_{B}+\boldsymbol{R}\left(\hat{q}\right)\left[\delta\boldsymbol{\theta}\times\right]\cdot\delta\boldsymbol{a}_{B}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
去掉二阶项，重新组织一些交叉积 (用
\begin_inset Formula $\left[\boldsymbol{a}\times\right]\boldsymbol{b}=-\left[\boldsymbol{b}\times\right]\boldsymbol{a}$
\end_inset

)，我们得到
\begin_inset Formula 
\begin{align*}
\dot{\delta\boldsymbol{V}} & =-\boldsymbol{R}\left(\hat{q}\right)\left[\left(\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\right)\times\right]\delta\boldsymbol{\theta}+\boldsymbol{R}\left(\hat{q}\right)\left(-\delta\boldsymbol{a}_{b}-\boldsymbol{a}_{n}\right)\\
 & =-\boldsymbol{R}\left(\hat{q}\right)\left[\left(\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\right)\times\right]\delta\boldsymbol{\theta}-\boldsymbol{R}\left(\hat{q}\right)\delta\boldsymbol{a}_{b}-\boldsymbol{R}\left(\hat{q}\right)\boldsymbol{a}_{n}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
为简化方程减少运算量，文献[4]第5.3.3节的方程(247)-(248)进一步证明，在假设加速度计噪声是白色的、不相关的、各向同性的情况下，
\begin_inset Formula $\boldsymbol{R}\left(\hat{q}\right)\boldsymbol{a}_{n}\rightarrow\boldsymbol{a}_{n}$
\end_inset

，所以上式可以写为
\begin_inset Formula 
\[
\dot{\delta\boldsymbol{V}}=-\boldsymbol{R}\left(\hat{q}\right)\left[\left(\boldsymbol{a}_{m}-\hat{\boldsymbol{a}}_{b}\right)\times\right]\delta\boldsymbol{\theta}-\boldsymbol{R}\left(\hat{q}\right)\delta\boldsymbol{a}_{b}-\boldsymbol{a}_{n}
\]

\end_inset


\end_layout

\begin_layout Subsubsection
状态空间形式的误差状态动力学
\end_layout

\begin_layout Standard
根据前面的推导，我们为 Kalman 滤波器需要将误差状态动力学方程整理为状态空间形式：
\begin_inset Formula 
\begin{align*}
\dot{\delta\boldsymbol{x}} & =\boldsymbol{A}\cdot\delta\boldsymbol{x}+\boldsymbol{G}\cdot\boldsymbol{w}\\
\left[\begin{array}{c}
\dot{\delta\boldsymbol{\theta}}\\
\dot{\delta\boldsymbol{V}}\\
\dot{\delta\boldsymbol{P}}\\
\dot{\delta\boldsymbol{\omega}_{b}}\\
\dot{\delta\boldsymbol{a}_{b}}\\
\dot{\delta\boldsymbol{M}_{b}}
\end{array}\right] & =\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & -\boldsymbol{I}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \boldsymbol{I}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}
\end{array}\right]\left[\begin{array}{c}
\delta\boldsymbol{\theta}\\
\delta\boldsymbol{V}\\
\delta\boldsymbol{P}\\
\delta\boldsymbol{\omega}_{b}\\
\delta\boldsymbol{a}_{b}\\
\delta\boldsymbol{M}_{b}
\end{array}\right]+\left[\begin{array}{c}
-\boldsymbol{\omega}_{n}\\
-\boldsymbol{a}_{n}\\
\mathbf{0}_{3\times1}\\
\boldsymbol{\omega}_{w}\\
\boldsymbol{a}_{w}\\
\boldsymbol{M}_{w}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
因此动力学矩阵
\begin_inset Formula $\boldsymbol{A}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{A}=\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & -\boldsymbol{I}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \boldsymbol{I}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
这个
\begin_inset Formula $18\times18$
\end_inset

项的误差状态空间模型将用于 Kalman 滤波。一个重要的结果是，该模型是线性和时变的误差状态。这种方法的优点是，在实现实时 Kalman 滤波时，可以根据
 IMU 积分得到的信息构造状态转移矩阵，而不必知道最后测量时刻的误差状态。这种形式的另一个优点是它的计算不涉及三角运算。第三个优点是，该模型是一个真正的随机系
统，由白噪声序列驱动，白噪声序列具有可测量或易于逼近的谱密度。
\end_layout

\begin_layout Standard
因为向量
\begin_inset Formula $\boldsymbol{w}$
\end_inset

是一个单位方差零均值的白噪声序列。矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

将白噪声序列转化为干扰 (disturbance) 向量，因此矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{G}=\left[\begin{array}{cccccc}
\mathrm{diag}\left(-\boldsymbol{\sigma}_{\omega}\right) & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathrm{diag}\left(-\boldsymbol{\sigma}_{a}\right) & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathrm{diag}\left(\boldsymbol{\sigma}_{\omega_{b}}\right) & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathrm{diag}\left(\boldsymbol{\sigma}_{a_{b}}\right) & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathrm{diag}\left(\boldsymbol{\sigma}_{M_{b}}\right)
\end{array}\right]
\]

\end_inset

因此，干扰向量的不确定性可以表示为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
E\left[\left(\boldsymbol{G}\mathbf{w}\left(t\right)\right)\left(\boldsymbol{G}\mathbf{w}\left(\tau\right)\right)^{\mathrm{T}}\right]=\boldsymbol{Q}_{c}\delta\left(t-\tau\right),
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{Q}_{c}$
\end_inset

为连续时间的过程噪声协方差矩阵，其可简化为：
\begin_inset Formula 
\[
\boldsymbol{Q}_{c}\delta(t-\tau)=\boldsymbol{G}\boldsymbol{G}^{\mathrm{T}}\delta(t-\tau)=\left[\begin{array}{cccccc}
\mathrm{diag}\left(\boldsymbol{\sigma}_{\omega}^{2}\right) & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0}\\
\mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{a}^{2}\right) & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{\omega_{b}}^{2}\right) & \boldsymbol{0} & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{a_{b}}^{2}\right) & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{M_{b}}^{2}\right)
\end{array}\right]\delta(t-\tau).
\]

\end_inset


\end_layout

\begin_layout Subsection
离散时间系统动力学
\end_layout

\begin_layout Standard
对于离散系统，上面的微分方程需要积分到差分方程中，以考虑离散时间间隔
\begin_inset Formula $\Delta t>0$
\end_inset

。积分方法可能有所不同。在某些情况下，可以使用精确的闭式解。在其它情况下，可采用不同精度的数值积分。
\end_layout

\begin_layout Standard
需要对以下子系统进行积分：
\end_layout

\begin_layout Enumerate
标称状态。 
\end_layout

\begin_layout Enumerate
误差状态。 
\end_layout

\begin_deeper
\begin_layout Enumerate
确定性部分：状态动力学和控制。 
\end_layout

\begin_layout Enumerate
随机部分：噪声和扰动。
\end_layout

\end_deeper
\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
此外，后面的方程里使用的
\begin_inset Formula $\hat{\boldsymbol{\omega}}$
\end_inset

和
\begin_inset Formula $\hat{\boldsymbol{a}}_{B}$
\end_inset

为机体坐标系中估计的角速度和加速度，其值可以为当前的估计值，也可以是采用梯形积分法计算的平均值。计算四元数的平均值的方法见文献[2]第1.6.2节、文献[3]附录B
、文献[4]第4.6.2节，各自都从不同角度计算四元数的平均值。
\end_layout

\begin_layout Subsubsection
标称状态动力学
\end_layout

\begin_layout Standard
根据标称状态向量的定义：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}=\left[\begin{array}{cccccc}
\hat{q}^{\mathrm{T}} & \hat{\boldsymbol{V}}^{\mathrm{T}} & \hat{\boldsymbol{P}}^{\mathrm{T}} & \hat{\boldsymbol{\omega}}_{b}^{\mathrm{T}} & \hat{\boldsymbol{a}}_{b}^{\mathrm{T}} & \hat{\boldsymbol{M}}_{b}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
我们可以把标称状态的差分方程，也就是注入误差方程，写为
\begin_inset Formula 
\begin{align*}
\hat{q} & \leftarrow\hat{q}\otimes\delta q\left\{ \hat{\boldsymbol{\omega}}\Delta t\right\} \\
\hat{\boldsymbol{V}} & \leftarrow\hat{\boldsymbol{V}}+\left(\boldsymbol{R}\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{g}\right)\Delta t\\
\hat{\boldsymbol{P}} & \leftarrow\hat{\boldsymbol{P}}+\hat{\boldsymbol{V}}\Delta t+\dfrac{1}{2}\left(\boldsymbol{R}\cdot\hat{\boldsymbol{a}}_{B}+\boldsymbol{g}\right)\Delta t^{2}\\
\hat{\boldsymbol{\omega}}_{b} & \leftarrow\hat{\boldsymbol{\omega}}_{b}\\
\hat{\boldsymbol{a}}_{b} & \leftarrow\hat{\boldsymbol{a}}_{b}\\
\hat{\boldsymbol{M}}_{b} & \leftarrow\hat{\boldsymbol{M}}_{b}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{x}\leftarrow f\left(\boldsymbol{x},\bullet\right)$
\end_inset

表示类型为
\begin_inset Formula $\boldsymbol{x}_{k+1}=f\left(\boldsymbol{x}_{k},\bullet_{k}\right)$
\end_inset

, 
\begin_inset Formula $\boldsymbol{R}\triangleq\boldsymbol{R}\left(\hat{q}\right)$
\end_inset

的时间更新是与当前标称方向
\begin_inset Formula $\hat{q}$
\end_inset

相关联的旋转矩阵，并且
\begin_inset Formula $\delta q\left\{ \boldsymbol{v}\right\} $
\end_inset

是与旋转向量
\begin_inset Formula $\boldsymbol{v}$
\end_inset

相关联的四元数。
\end_layout

\begin_layout Subsubsection
误差状态动力学
\end_layout

\begin_layout Standard
根据前面所推导的误差状态动力学方程，我们可以写出误差状态的差分方程。因为所有的不确定性都归于误差，所以差分方程会分为确定性和随机性两个部分。确定性部分是正常积分
的，同时随机部分的积分产生随机脉冲(impulse) ，参见文献[3]附录E，因此，
\begin_inset Formula 
\begin{align*}
\delta\boldsymbol{\theta} & \leftarrow\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)\delta\boldsymbol{\theta}-\delta\boldsymbol{\omega}_{b}\Delta t+\boldsymbol{\theta}_{i}\\
\delta\boldsymbol{V} & \leftarrow\delta\boldsymbol{V}+\left(\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\delta\boldsymbol{\theta}-\boldsymbol{R}\left(\hat{q}\right)\delta\boldsymbol{a}_{b}\right)\Delta t+\boldsymbol{v}_{i}\\
\delta\boldsymbol{P} & \leftarrow\delta\boldsymbol{P}+\delta\boldsymbol{V}\Delta t\\
\delta\boldsymbol{\omega}_{b} & \leftarrow\delta\boldsymbol{\omega}_{b}+\boldsymbol{\omega}_{i}\\
\delta\boldsymbol{a}_{b} & \leftarrow\delta\boldsymbol{a}_{b}+\boldsymbol{a}_{i}\\
\delta\boldsymbol{M}_{b} & \leftarrow\delta\boldsymbol{M}_{b}+\boldsymbol{m}_{i}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这里的
\begin_inset Formula $\boldsymbol{\theta}_{i}$
\end_inset

，
\begin_inset Formula $\boldsymbol{V}_{i}$
\end_inset

，
\begin_inset Formula $\boldsymbol{\omega}_{i}$
\end_inset

，
\begin_inset Formula $\boldsymbol{a}_{i}$
\end_inset

和
\begin_inset Formula $\boldsymbol{m}_{i}$
\end_inset

是应用于方向、速度、和几个偏差估计的随机脉冲，由白色高斯过程建模。它们的均值为零，并且它们的协方差矩阵由在时间步
\begin_inset Formula $\Delta t$
\end_inset

内的
\begin_inset Formula $\boldsymbol{\omega}_{n}$
\end_inset

，
\begin_inset Formula $\boldsymbol{a}_{n}$
\end_inset

 ，
\begin_inset Formula $\boldsymbol{\omega}_{w}$
\end_inset

，
\begin_inset Formula $\boldsymbol{a}_{w}$
\end_inset

和
\begin_inset Formula $\boldsymbol{M}_{w}$
\end_inset

的协方差的积分获得的 (参见文献[3]附录E)，
\begin_inset Formula 
\begin{align*}
\boldsymbol{\Theta}_{i} & =\boldsymbol{\sigma}_{\omega}^{2}\Delta t^{2}\boldsymbol{I}\\
\boldsymbol{V}_{i} & =\boldsymbol{\sigma}_{a}\Delta t^{2}\boldsymbol{I}\\
\boldsymbol{\Omega}_{i} & =\boldsymbol{\sigma}_{\omega_{b}}\Delta t\boldsymbol{I}\\
\boldsymbol{A}_{i} & =\boldsymbol{\sigma}_{a_{b}}\Delta t\boldsymbol{I}\\
\boldsymbol{M}_{i} & =\boldsymbol{\sigma}_{M_{b}}\Delta t\boldsymbol{I}
\end{align*}

\end_inset

这些
\begin_inset Formula $\boldsymbol{\sigma}$
\end_inset

应根据 IMU 数据表中的信息或通过实验测量确定。
\end_layout

\begin_layout Standard
值得注意的是，因为ESKF在每一次循环迭代结束的时候都会有一次重置操作，因为误差已经注入到标称状态中，所以
\begin_inset Formula $\delta\boldsymbol{x}=0$
\end_inset

，所以上述确定性部分都为零。又因为误差的
\begin_inset Formula $\boldsymbol{\sigma}$
\end_inset

已经很小，误差的误差的
\begin_inset Formula $\boldsymbol{\sigma}$
\end_inset

会更小，并且IMU都是高频采样，
\begin_inset Formula $\Delta t$
\end_inset

也很小，所以随机脉冲部分也会趋向零。所以在很多ESKF的实现中，基本上都是假设
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

不变化，从而跳过计算
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

的时间更新步骤。这一阶段的主要目的是要计算误差协方差
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的时间更新，也就是下一节的内容。
\end_layout

\begin_layout Subsubsection
误差状态 Jacobian 矩阵
\end_layout

\begin_layout Standard
误差状态的 Jacobians 矩阵是通过简单检查前面章节中的误差状态差分方程得到的。
\end_layout

\begin_layout Standard
状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

为
\begin_inset Formula 
\begin{align*}
\delta\boldsymbol{x}_{k+1} & =\boldsymbol{F}\cdot\delta\boldsymbol{x}_{k}\\
 & =e^{\boldsymbol{A}\Delta t}\cdot\delta\boldsymbol{x}_{k}
\end{align*}

\end_inset

其中
\begin_inset Formula $\boldsymbol{F}$
\end_inset

称为状态转移矩阵。这个转移矩阵的泰勒展开式是
\begin_inset Formula 
\[
\boldsymbol{F}=e^{\boldsymbol{A}\Delta t}=\boldsymbol{I}+\boldsymbol{A}\Delta t+\frac{\left(\boldsymbol{A}\Delta t\right)^{2}}{2!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{3}}{3!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{4}}{4!}+\ldots=\sum_{k=0}^{\infty}\dfrac{1}{k!}\left(\boldsymbol{A}\Delta t\right)^{k}
\]

\end_inset


\end_layout

\begin_layout Standard
因为误差状态一般都很小，为简化计算，离散状态转移模型可以采用一阶形式，该模型由误差状态向量的动力学以明显的形式确定：
\begin_inset Formula 
\[
\boldsymbol{F}=\boldsymbol{I}+\boldsymbol{A}\Delta t
\]

\end_inset

或者是二阶形式，
\begin_inset Formula 
\[
\boldsymbol{F}=\boldsymbol{I}+\boldsymbol{A}\Delta t+\dfrac{1}{2}\boldsymbol{A}^{2}\Delta t^{2}
\]

\end_inset


\end_layout

\begin_layout Standard
如果需要更高精度的封闭积分形式的解，在文献[2]第2.5节和文献[4]附录B中有推导方法。在下一章中我们将采用文献[2,3]的方法推导封闭积分形式的解。
\end_layout

\begin_layout Standard
连续时间的过程噪声协方差矩阵
\begin_inset Formula $\boldsymbol{Q}_{c}$
\end_inset

在前面的章节以及推导除了。离散时间的过程噪声协方差矩阵
\begin_inset Formula $\boldsymbol{Q}_{d}$
\end_inset

，在此被称为状态误差矩阵：
\begin_inset Formula 
\[
Q_{d}=\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau)}Q_{c}e^{\boldsymbol{A}^{T}(\Delta t-\tau)}d\tau
\]

\end_inset


\end_layout

\begin_layout Standard
参考文献[3]的第2.5.2节，我们可以在
\begin_inset Formula $\hat{\boldsymbol{\omega}}=\hat{\boldsymbol{a}}=0$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}(\hat{q})=\boldsymbol{I}$
\end_inset

周围线性化
\begin_inset Formula $\boldsymbol{A}$
\end_inset

，推导得到文献[3]的方程(97)：
\begin_inset Formula 
\[
\boldsymbol{Q}_{d}=\tiny\left[\begin{array}{cccccc}
\wedge(\sigma_{\omega}^{2})\Delta t+\wedge(\sigma_{\omega_{b}}^{2})\frac{\Delta t^{3}}{3} & 0 & 0 & -\wedge(\sigma_{\omega_{b}}^{2})\frac{\Delta t^{2}}{2} & 0 & 0\\
0 & \wedge(\sigma_{a}^{2})\Delta t+\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{3}}{3} & \wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{4}}{8}+\wedge(\sigma_{a}^{2})\frac{\Delta t^{2}}{2} & 0 & -\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{2}}{2} & 0\\
0 & \wedge(\sigma_{a}^{2})\frac{\Delta t^{2}}{2}+\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{4}}{8} & \wedge(\sigma_{a}^{2})\frac{\Delta t^{3}}{3}+\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{5}}{20} & 0 & -\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{3}}{6} & 0\\
-\wedge(\sigma_{\omega_{b}}^{2})\frac{\Delta t^{2}}{2} & 0 & 0 & \wedge(\sigma_{\omega_{b}}^{2})\Delta t & 0 & 0\\
0 & -\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{2}}{2} & -\wedge(\sigma_{a_{b}}^{2})\frac{\Delta t^{3}}{6} & 0 & \wedge(\sigma_{a_{b}}^{2})\Delta t & 0\\
0 & 0 & 0 & 0 & 0 & \wedge(\sigma_{M_{b}}^{2})\Delta t
\end{array}\right]
\]

\end_inset

其中
\begin_inset Formula $\wedge(\boldsymbol{x})=\begin{pmatrix}x_{0} & 0 & 0\\
0 & x_{1} & 0\\
0 & 0 & x_{2}
\end{pmatrix}$
\end_inset

。
\end_layout

\begin_layout Section
先验协方差传播的高阶解
\end_layout

\begin_layout Standard
我们已知误差状态动力学方程的状态空间形式为：
\begin_inset Formula 
\[
\dot{\delta\boldsymbol{x}}=\boldsymbol{A}\cdot\delta\boldsymbol{x}+\boldsymbol{G}\cdot\boldsymbol{w}
\]

\end_inset

其中，动力学矩阵
\begin_inset Formula $\boldsymbol{A}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{A}=\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & -\boldsymbol{I}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \boldsymbol{I}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}
\end{array}\right]
\]

\end_inset

其中，
\begin_inset Formula $\hat{\boldsymbol{\omega}}$
\end_inset

和
\begin_inset Formula $\hat{\boldsymbol{a}}_{B}$
\end_inset

为机体坐标系中估计的角速度和加速度，其值可以为当前的估计值，也可以是采用梯形积分法计算的平均值。计算四元数的平均值的方法见文献[2]第1.6.2节、文献[3]附录B
、文献[4]第4.6.2节，各自都从不同角度计算四元数的平均值。并且
\begin_inset Formula $\boldsymbol{w}$
\end_inset

为单位方差，零均值白噪声向量。干扰矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{G}=\left[\begin{array}{cccccc}
\mathrm{diag}\left(-\boldsymbol{\sigma}_{\omega}\right) & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathrm{diag}\left(-\boldsymbol{\sigma}_{a}\right) & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathrm{diag}\left(\boldsymbol{\sigma}_{\omega_{b}}\right) & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathrm{diag}\left(\boldsymbol{\sigma}_{a_{b}}\right) & \mathbf{0}_{3\times3}\\
\mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathbf{0}_{3\times3} & \mathrm{diag}\left(\boldsymbol{\sigma}_{M_{b}}\right)
\end{array}\right]
\]

\end_inset

因此，干扰向量的不确定性可以表示为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
E\left[\left(\mathbf{G}\mathbf{w}\left(t\right)\right)\left(\mathbf{G}\mathbf{w}\left(\tau\right)\right)^{\mathrm{T}}\right]=\mathbf{Q}_{c}\delta\left(t-\tau\right),
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{Q}_{c}$
\end_inset

为连续时间的过程噪声协方差矩阵，其可简化为：
\begin_inset Formula 
\[
\mathbf{Q}_{c}\delta(t-\tau)=\mathbf{GG}^{\mathrm{T}}\delta(t-\tau)=\left[\begin{array}{cccccc}
\mathrm{diag}\left(\boldsymbol{\sigma}_{\omega}^{2}\right) & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0}\\
\mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{a}^{2}\right) & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{\omega_{b}}^{2}\right) & \boldsymbol{0} & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{a_{b}}^{2}\right) & \mathbf{0}\\
\mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathrm{diag}\left(\boldsymbol{\sigma}_{M_{b}}^{2}\right)
\end{array}\right]\delta(t-\tau).
\]

\end_inset


\end_layout

\begin_layout Standard
状态空间微分方程的解是众所周知的结果：
\begin_inset Formula 
\[
\delta\boldsymbol{x}(t)=e^{\boldsymbol{A}(t-t_{0})}\delta\boldsymbol{x}(t_{0})+\int_{t_{0}}^{t}e^{\boldsymbol{A}(t-\tau)}\boldsymbol{G}\boldsymbol{w}(\tau)d\tau
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
我们感兴趣的是
\begin_inset Formula $t=t_{k}$
\end_inset

和
\begin_inset Formula $t_{0}=t_{k-1}$
\end_inset

，因此
\begin_inset Formula $t_{k}-t_{k-1}=\Delta t$
\end_inset

，并在
\begin_inset Formula $\tau'=\tau-t_{k-1}$
\end_inset

的积分中进行替换
\begin_inset Formula 
\[
\delta\boldsymbol{x}(t_{k})=e^{\boldsymbol{A}\Delta t}\delta\boldsymbol{x}(t_{k-1})+\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau')}\boldsymbol{G}\boldsymbol{w}(\tau'+t_{k-1})d\tau'
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
\begin_inset Formula $\delta\boldsymbol{x}(t_{k})$
\end_inset

的协方差由以下公式给出：
\begin_inset Formula 
\begin{align*}
\boldsymbol{P}_{k|k-1} & =E\left[\delta\boldsymbol{x}(t_{k})\delta\boldsymbol{x}(t_{k})^{\mathrm{T}}\right]\\
 & =\small E\left[\begin{pmatrix}e^{\boldsymbol{A}\Delta t}\delta\boldsymbol{x}(t_{k-1})+\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau')}\boldsymbol{G}\boldsymbol{w}(\tau'+t_{k-1})d\tau'\end{pmatrix}\begin{pmatrix}e^{\boldsymbol{A}\Delta t}\delta\boldsymbol{x}(t_{k-1})+\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau'')}\boldsymbol{G}\boldsymbol{w}(\tau''+t_{k-1})d\tau''\end{pmatrix}^{\mathrm{T}}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\noindent
在此基础上，我们删除了
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

和
\begin_inset Formula $\boldsymbol{w}$
\end_inset

的乘积，因为它们是不相关的，并且都有
\begin_inset Formula $0$
\end_inset

的期望值：
\begin_inset Formula 
\begin{align*}
E\left[\delta\boldsymbol{x}(t_{k})\delta\boldsymbol{x}(t_{k})^{\mathrm{T}}\right]= & e^{\boldsymbol{A}\Delta t}E[\delta\boldsymbol{x}(t_{k-1})\delta\boldsymbol{x}(t_{k-1})^{\mathrm{T}}]e^{\boldsymbol{A}^{\mathrm{T}}\Delta t}\\
 & +\int_{0}^{\Delta t}\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau')}E[\boldsymbol{G}\boldsymbol{w}(\tau'+t_{k-1})\boldsymbol{w}(\tau''+t_{k-1})^{\mathrm{T}}\boldsymbol{G}^{\mathrm{T}}]e^{\boldsymbol{A}^{\mathrm{T}}(\Delta t-\tau'')}d\tau'd\tau''\\
E\left[\delta\boldsymbol{x}(t_{k})\delta\boldsymbol{x}(t_{k})^{\mathrm{T}}\right] & =e^{\boldsymbol{A}\Delta t}\boldsymbol{P}_{(k-1|k-1)}e^{\boldsymbol{A}^{\mathrm{T}}\Delta t}+\int_{0}^{\Delta t}\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau')}\boldsymbol{Q}_{c}\delta(\tau'-\tau'')e^{\boldsymbol{A}^{\mathrm{T}}(\Delta t-\tau'')}d\tau'd\tau''\\
E\left[\delta\boldsymbol{x}(t_{k})\delta\boldsymbol{x}(t_{k})^{\mathrm{T}}\right] & =\boldsymbol{F}\boldsymbol{P}_{(k-1|k-1)}\boldsymbol{F}^{\mathrm{T}}+\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau'')}\boldsymbol{Q}_{c}e^{\boldsymbol{A}^{\mathrm{T}}(\Delta t-\tau'')}d\tau''
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\noindent
因此，
\begin_inset Formula $\boldsymbol{Q}_{d}=\int_{0}^{\Delta t}e^{\boldsymbol{A}(\Delta t-\tau)}\boldsymbol{Q}_{c}e^{\boldsymbol{A}^{\mathrm{T}}(\Delta t-\tau)}d\tau$
\end_inset

，这是所需的结果。
\end_layout

\begin_layout Subsection
转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

的闭式解
\end_layout

\begin_layout Standard
在许多情况下，可以为积分步骤得到一个封闭形式的表达式。我们考虑相对于时间
\begin_inset Formula $t$
\end_inset

的一阶线性微分方程的情况，
\begin_inset Formula 
\[
\dot{\boldsymbol{x}}_{t}=\boldsymbol{A}\cdot\boldsymbol{x}_{t}
\]

\end_inset

也就是说，这个关系是线性的，并且在区间上是常数。在这种情况下，在区间
\begin_inset Formula $\left[t_{n},t_{n}+\Delta t\right]$
\end_inset

上的积分导致
\begin_inset Formula 
\[
\boldsymbol{x}_{n+1}=e^{\boldsymbol{A}\Delta t}\boldsymbol{x}_{n}=\boldsymbol{F}\boldsymbol{x}_{n}
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{F}$
\end_inset

称为状态转移矩阵。这个转移矩阵的泰勒展开式是
\begin_inset Formula 
\[
\boldsymbol{F}=e^{\boldsymbol{A}\Delta t}=\boldsymbol{I}+\boldsymbol{A}\Delta t+\frac{\left(\boldsymbol{A}\Delta t\right)^{2}}{2!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{3}}{3!}+\frac{\left(\boldsymbol{A}\Delta t\right)^{4}}{4!}+\ldots=\sum_{k=0}^{\infty}\dfrac{1}{k!}\left(\boldsymbol{A}\Delta t\right)^{k}
\]

\end_inset


\end_layout

\begin_layout Standard
在为
\begin_inset Formula $\boldsymbol{A}$
\end_inset

的已知实例编写此级数时，有时可以在结果中标识已知级数。这允许以封闭形式编写结果积分。
\end_layout

\begin_layout Standard
动力学矩阵
\begin_inset Formula $\boldsymbol{A}$
\end_inset

为
\begin_inset Formula $18\times18$
\end_inset

的 Jacobian 稀疏矩阵。我们首先简单计算
\begin_inset Formula $\boldsymbol{A}$
\end_inset

的幂次
\begin_inset Formula 
\begin{align*}
\boldsymbol{A} & =\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{I} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & \boldsymbol{I} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\\
\boldsymbol{A}^{2} & =\tiny\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{I} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & \boldsymbol{I} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{I} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & \boldsymbol{I} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\\
 & =\left[\begin{array}{cccccc}
\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3} & \left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3}\\
\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & \boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\\
\boldsymbol{A}^{3} & =\tiny\left[\begin{array}{cccccc}
\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3} & \left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3}\\
\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & \boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{I} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & \boldsymbol{I} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\\
 & =\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right]^{3} & 0_{3\times3} & 0_{3\times3} & -\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3}\\
\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & \boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\\
\boldsymbol{A}^{4} & =\tiny\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right]^{3} & 0_{3\times3} & 0_{3\times3} & -\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3}\\
\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & \boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\left[\begin{array}{cccccc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{I} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right] & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right) & 0_{3\times3}\\
0_{3\times3} & \boldsymbol{I} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]\\
 & =\left[\begin{array}{cccccc}
\left[\hat{\boldsymbol{\omega}}\times\right]^{4} & 0_{3\times3} & 0_{3\times3} & \left[\hat{\boldsymbol{\omega}}\times\right]^{3} & 0_{3\times3} & 0_{3\times3}\\
\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right]^{3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3}\\
-\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & 0_{3\times3} & 0_{3\times3} & -\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\left[\hat{\boldsymbol{\omega}}\times\right] & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
我们可以观察到
\begin_inset Formula $\boldsymbol{A}$
\end_inset

的幂增长项有一个固定的部分和一个幂增长项部分。这些幂次项可以导致封闭形式的解。我们观察到以下情况，
\end_layout

\begin_layout Itemize
这个幂增长项部分来源于旋转项
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

，这是
\begin_inset Formula $\boldsymbol{A}$
\end_inset

中对角线中的唯一项，，按 
\begin_inset Formula $\boldsymbol{A}^{k}$
\end_inset

 幂次的顺序向右和向下传播。所有不受此传播影响的项都将消失。
\end_layout

\begin_layout Itemize
在第
\begin_inset Formula $3$
\end_inset

次幂之后，
\begin_inset Formula $\boldsymbol{A}$
\end_inset

的幂的稀疏性是稳定的。也就是说，在
\begin_inset Formula $\boldsymbol{A}$
\end_inset

中对于大于
\begin_inset Formula $3$
\end_inset

的 幂，没有更多的非零块出现或消失。
\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
我们将
\begin_inset Formula $\boldsymbol{A}^{k}$
\end_inset

代回状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

的方程里，得到一个稀疏矩阵，下面列出所有非零值的位置：
\begin_inset Formula 
\[
\boldsymbol{F}=\left[\begin{array}{cccccc}
\boldsymbol{F}_{\theta\theta} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{F}_{\theta\omega b} & 0_{3\times3} & 0_{3\times3}\\
\boldsymbol{F}_{v\theta} & \boldsymbol{I} & 0_{3\times3} & \boldsymbol{F}_{v\omega b} & \boldsymbol{F}_{vab} & 0_{3\times3}\\
\boldsymbol{F}_{p\theta} & \boldsymbol{F}_{pv} & \boldsymbol{I} & \boldsymbol{F}_{p\omega b} & \boldsymbol{F}_{pab} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I} & 0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}
\end{array}\right]
\]

\end_inset

其中，
\end_layout

\begin_layout Standard
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="3">
<features tabularvalignment="middle">
<column alignment="left" valignment="top">
<column alignment="left" valignment="top">
<column alignment="left" valignment="top">
<row>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
符号
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
方程
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{\theta\theta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角度误差的积分项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{\theta\theta}=\Sigma_{0}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{\theta\omega b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角度误差对比陀螺仪偏差项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{\theta\omega b}=\Sigma_{1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{v\theta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度对比角度项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{v\theta}=\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\Sigma_{1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{v\omega b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度对比陀螺仪偏差项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{v\omega b}=\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\Sigma_{2}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{vab}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度对比加速计偏差项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{vab}=-\boldsymbol{R}\left(\hat{q}\right)\Delta t$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{p\theta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置对比角度项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{p\theta}=-\boldsymbol{F}_{v\omega b}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{pv}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置对比速度项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{pv}=\dfrac{1}{2}\Delta t^{2}\boldsymbol{I}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{p\omega b}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置对比陀螺仪偏差项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{p\omega b}=\boldsymbol{R}\left(\hat{q}\right)\left[\hat{\boldsymbol{a}}_{B}\times\right]\Sigma_{3}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{pab}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置对比加速计偏差项
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{F}_{pab}=-\dfrac{1}{2}\Delta t^{2}\boldsymbol{R}\left(\hat{q}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
其中简单的方程已经在上表中直接列出。和旋转项
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

相关的级数的方程，
\begin_inset Formula $\Sigma_{0},\Sigma_{1},\Sigma_{2},\Sigma_{3}$
\end_inset

，将在下面推导。在此之前，我们先总结后面计算所需
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

的幂次的变化规律：
\begin_inset Formula 
\begin{align*}
\left[\hat{\boldsymbol{\omega}}\times\right]^{2} & =\hat{\boldsymbol{\omega}}\hat{\boldsymbol{\omega}}^{\mathrm{T}}-\left|\hat{\boldsymbol{\omega}}\right|^{2}\cdot\boldsymbol{I}_{3\times3}=\left|\hat{\boldsymbol{\omega}}\right|^{2}\left(\dfrac{\hat{\boldsymbol{\omega}}}{\left|\hat{\boldsymbol{\omega}}\right|}\dfrac{\hat{\boldsymbol{\omega}}^{\mathrm{T}}}{\left|\hat{\boldsymbol{\omega}}\right|}-\boldsymbol{I}_{3\times3}\right)\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{3} & =-\left|\hat{\boldsymbol{\omega}}\right|^{2}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]\rightarrow-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{3}}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}=\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{4} & =-\left|\hat{\boldsymbol{\omega}}\right|^{2}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{5} & =+\left|\hat{\boldsymbol{\omega}}\right|^{4}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{6} & =+\left|\hat{\boldsymbol{\omega}}\right|^{4}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{7} & =-\left|\hat{\boldsymbol{\omega}}\right|^{6}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{8} & =-\left|\hat{\boldsymbol{\omega}}\right|^{6}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{9} & =+\left|\hat{\boldsymbol{\omega}}\right|^{8}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]\\
\left[\hat{\boldsymbol{\omega}}\times\right]^{10} & =+\left|\hat{\boldsymbol{\omega}}\right|^{8}\cdot\left[\hat{\boldsymbol{\omega}}\times\right]^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Subsubsection
角度误差的积分项
\end_layout

\begin_layout Standard
对于角度误差的积分
\begin_inset Formula $\boldsymbol{F}_{\theta\theta}$
\end_inset

，是研究得最多的项。在文献[1-4]中都有推导。在此标记为
\begin_inset Formula $\Sigma_{0}$
\end_inset

，我们使用斜对称矩阵
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

的幂次的性质 (参见文献[2]第1.3.2节) 并重新排序条目，得出
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\theta\theta} & =\boldsymbol{I}_{3\times3}-\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t+\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}-\dfrac{1}{3!}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{3}+\dfrac{1}{4!}\left[\hat{\boldsymbol{\omega}}\times\right]^{4}\Delta t^{4}+\ldots\\
 & =\boldsymbol{I}_{3\times3}+\left(-\Delta t+\dfrac{1}{3!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{3}-\ldots\right)\left[\hat{\boldsymbol{\omega}}\times\right]+\left(\dfrac{1}{2!}\Delta t^{2}-\dfrac{1}{4!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{4}+\ldots\right)\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\dfrac{1}{3!}\left|\hat{\boldsymbol{\omega}}\right|^{3}\Delta t^{3}+\ldots\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\left(1-\dfrac{1}{2!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}+\dfrac{1}{4!}\left|\hat{\boldsymbol{\omega}}\right|^{4}\Delta t^{4}-\ldots\right)\right)\\
 & =\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\\
 & =\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\cdot\boldsymbol{I}_{3\times3}-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\cdot\left[\dfrac{\hat{\boldsymbol{\omega}}}{\left|\hat{\boldsymbol{\omega}}\right|}\times\right]+\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\cdot\dfrac{\hat{\boldsymbol{\omega}}}{\left|\hat{\boldsymbol{\omega}}\right|}\dfrac{\hat{\boldsymbol{\omega}}^{\mathrm{T}}}{\left|\hat{\boldsymbol{\omega}}\right|}\\
 & =\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
因此，
\begin_inset Formula $\boldsymbol{F}_{\theta\theta}$
\end_inset

实际上是
\begin_inset Formula $\boldsymbol{R}_{I}^{B}$
\end_inset

的旋转矩阵，其中
\begin_inset Formula $\hat{\boldsymbol{\omega}}/\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

为旋转轴，
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|\Delta t$
\end_inset

为旋转角度。 对于
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

的小值，上述任何一个表达式都将导致数值不稳定。通过极限和应用 L'Hôpital 法则， 我们得出
\begin_inset Formula 
\[
\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\boldsymbol{F}_{\theta\theta}=\boldsymbol{I}_{3\times3}-\Delta t\left[\hat{\boldsymbol{\omega}}\times\right]+\dfrac{\Delta t^{2}}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}
\]

\end_inset


\end_layout

\begin_layout Subsubsection
角度误差对比陀螺仪偏差项
\end_layout

\begin_layout Standard
角度误差对比陀螺仪偏差的积分项
\begin_inset Formula $\boldsymbol{F}_{\theta\omega b}$
\end_inset

也是研究得最多的项，在此标记为
\begin_inset Formula $\Sigma_{1}$
\end_inset

，
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\theta\omega b} & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t^{2}-\dfrac{1}{3!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{3}+\dfrac{1}{4!}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{4}-\ldots\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\left(\dfrac{1}{2!}\Delta t^{2}-\dfrac{1}{4!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{4}+\ldots\right)\left[\hat{\boldsymbol{\omega}}\times\right]+\left(-\dfrac{1}{3!}\Delta t^{3}+\dfrac{1}{5!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{5}-\ldots\right)\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\left(1-\dfrac{1}{2!}\Delta t^{2}+\dfrac{1}{4!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{4}-\ldots\right)\right)\\
 & \quad+\left(-\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\Delta t}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}+\left(\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\Delta t}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}-\dfrac{1}{3!}\Delta t^{3}+\dfrac{1}{5!}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{5}-\ldots\right)\right)\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\\
 & \quad+\left(-\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\Delta t}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}+\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\dfrac{1}{3!}\left|\hat{\boldsymbol{\omega}}\right|^{3}\Delta t^{3}+\dfrac{1}{5!}\left|\hat{\boldsymbol{\omega}}\right|^{5}\Delta t^{5}-\ldots\right)\right)\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\\
 & =-\boldsymbol{\Gamma}\left(\hat{\boldsymbol{\omega}}\Delta t\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
对于
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

的小值，我们可以再次取其极限，应用 L'Hôpital 法则， 得到
\begin_inset Formula 
\begin{align*}
\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\boldsymbol{F}_{\theta\omega b} & =-\boldsymbol{I}_{3\times3}\Delta t+\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\dfrac{\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\Delta t}{2\left|\hat{\boldsymbol{\omega}}\right|}\left[\hat{\boldsymbol{\omega}}\times\right]-\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\dfrac{\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\Delta t}{3\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\dfrac{\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\Delta t^{2}}{2}\left[\hat{\boldsymbol{\omega}}\times\right]-\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\dfrac{\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\Delta t^{2}}{6\left|\hat{\boldsymbol{\omega}}\right|}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\Delta t^{2}}{2}\left[\hat{\boldsymbol{\omega}}\times\right]-\lim_{\left|\hat{\boldsymbol{\omega}}\right|\to0}\dfrac{\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\Delta t^{3}}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\Delta t^{2}}{2}\left[\hat{\boldsymbol{\omega}}\times\right]-\dfrac{\Delta t^{3}}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
实际上
\begin_inset Formula $\boldsymbol{F}_{\theta\omega b}$
\end_inset

是一个起始缺一次项的旋转矩阵，并且
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

的幂次比
\begin_inset Formula $\Delta t$
\end_inset

少一次。我们使用
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

的幂次这个工具可以对其变形，以了解其中的几何意义：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\theta\omega b} & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\\
 & =-\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\cdot\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\\
 & =-\boldsymbol{I}_{3\times3}\Delta t-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{3}}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\cdot\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\\
 & =-\left(\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)\right)\right)\\
 & =-\left(\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\boldsymbol{I}_{3\times3}-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t\right)\right)\\
 & =-\left(\boldsymbol{I}_{3\times3}\Delta t+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t\right)\right)\\
 & =-\boldsymbol{\Gamma}\left(\hat{\boldsymbol{\omega}}\Delta t\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这样就可以看到旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

所在的位置，及其与
\begin_inset Formula $\boldsymbol{\Gamma}$
\end_inset

矩阵的关系。这与文献[4]推导的方程(368b)的结果类似。
\end_layout

\begin_layout Subsubsection
三次起始项
\end_layout

\begin_layout Standard
\begin_inset Formula $\Sigma_{2}$
\end_inset

是一个起始缺二次项的旋转矩阵，并且
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

的幂次比
\begin_inset Formula $\Delta t$
\end_inset

少两次。参照文献[4]的推导
\begin_inset Formula 
\begin{align*}
\Sigma_{2} & =\dfrac{1}{2!}\Delta t^{2}\boldsymbol{I}_{3\times3}-\left[\hat{\boldsymbol{\omega}}\times\right]\dfrac{1}{3!}\Delta t^{3}+\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\dfrac{1}{4!}\Delta t^{4}-\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{5!}\Delta t^{5}+\ldots\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\left|\hat{\boldsymbol{\omega}}\right|^{2}\left[\hat{\boldsymbol{\omega}}\times\right]\dfrac{1}{3!}\Delta t^{3}-\left|\hat{\boldsymbol{\omega}}\right|^{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\dfrac{1}{4!}\Delta t^{4}+\left|\hat{\boldsymbol{\omega}}\right|^{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{5!}\Delta t^{5}-\ldots\right)\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(-\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{3!}\Delta t^{3}+\left[\hat{\boldsymbol{\omega}}\times\right]^{4}\dfrac{1}{4!}\Delta t^{4}-\left[\hat{\boldsymbol{\omega}}\times\right]^{5}\dfrac{1}{5!}\Delta t^{5}+\ldots\right)\\
 & =\tiny\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\boldsymbol{I}_{3\times3}-\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t+\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}-\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{3!}\Delta t^{3}+\left[\hat{\boldsymbol{\omega}}\times\right]^{4}\dfrac{1}{4!}\Delta t^{4}-\left[\hat{\boldsymbol{\omega}}\times\right]^{5}\dfrac{1}{5!}\Delta t^{5}+\ldots\right)\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)\right)\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
从中可以看到旋转矩阵所在的位置。并且对比上一小节的
\begin_inset Formula $\Sigma_{1}$
\end_inset

，可以看到缺项对旋转矩阵的影响。因为
\begin_inset Formula $\Sigma_{2}$
\end_inset

在
\begin_inset Formula $\boldsymbol{A}^{2}$
\end_inset

之后才出现，影响已经相当小，所以对于
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

的小值，可取截断级数的值为
\begin_inset Formula 
\[
\Sigma_{2}\approx\dfrac{\Delta t^{2}}{2}\boldsymbol{I}_{3\times3}
\]

\end_inset


\end_layout

\begin_layout Standard
如果需要对
\begin_inset Formula $\Sigma_{2}$
\end_inset

求极限，前一方程并不方便求极限，所以需要做另外的变形
\begin_inset Formula 
\begin{align*}
\Sigma_{2} & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}\right)\\
 & =\tiny\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}\right)\\
 & =\tiny\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t}{\left|\hat{\boldsymbol{\omega}}\right|}-\dfrac{\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\right)\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)}{\left|\hat{\boldsymbol{\omega}}\right|}\left[\hat{\boldsymbol{\omega}}\times\right]-\dfrac{\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}-\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\right)\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)}{\left|\hat{\boldsymbol{\omega}}\right|^{3}}\left[\hat{\boldsymbol{\omega}}\times\right]+\dfrac{\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}-\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =\dfrac{1}{2}\boldsymbol{I}_{3\times3}\Delta t^{2}-\dfrac{\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)}{\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)^{3}}\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t^{3}+\dfrac{\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}-\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)}{\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)^{4}}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{4}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
对于
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

的小值，采用文献[2]第2.5.1节的方法求极限可得
\begin_inset Formula 
\[
\Sigma_{2}=\dfrac{\Delta t^{2}}{2}\boldsymbol{I}_{3\times3}-\dfrac{\Delta t^{3}}{6}\left[\hat{\boldsymbol{\omega}}\times\right]+\dfrac{\Delta t^{4}}{24}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}
\]

\end_inset


\end_layout

\begin_layout Subsubsection
四次起始项
\end_layout

\begin_layout Standard
\begin_inset Formula $\Sigma_{3}$
\end_inset

是一个起始缺三次项的旋转矩阵，并且
\begin_inset Formula $\left[\hat{\boldsymbol{\omega}}\times\right]$
\end_inset

的幂次比
\begin_inset Formula $\Delta t$
\end_inset

少三次。参照文献[4]的推导
\begin_inset Formula 
\begin{align*}
\Sigma_{3} & =\dfrac{1}{3!}\Delta t^{3}\boldsymbol{I}_{3\times3}-\left[\hat{\boldsymbol{\omega}}\times\right]\dfrac{1}{4!}\Delta t^{4}+\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\dfrac{1}{5!}\Delta t^{5}-\ldots\\
 & =\dfrac{1}{3!}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(\left|\hat{\boldsymbol{\omega}}\right|^{4}\dfrac{1}{4!}\Delta t^{4}-\left|\hat{\boldsymbol{\omega}}\right|^{4}\left[\hat{\boldsymbol{\omega}}\times\right]\dfrac{1}{5!}\Delta t^{5}+\ldots\right)\\
 & =\dfrac{1}{3!}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(\left[\hat{\boldsymbol{\omega}}\times\right]^{4}\dfrac{1}{4!}\Delta t^{4}-\left[\hat{\boldsymbol{\omega}}\times\right]^{5}\dfrac{1}{5!}\Delta t^{5}+\ldots\right)\\
 & =\dfrac{1}{3!}\Delta t^{3}\boldsymbol{I}_{3\times3}\\
 & \quad-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{3!}\Delta t^{3}\right.\\
 & \qquad\qquad\quad\;\left.+\boldsymbol{I}_{3\times3}-\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t+\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}-\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{3!}\Delta t^{3}+\left[\hat{\boldsymbol{\omega}}\times\right]^{4}\dfrac{1}{4!}\Delta t^{4}-\left[\hat{\boldsymbol{\omega}}\times\right]^{5}\dfrac{1}{5!}\Delta t^{5}+\ldots\right)\\
 & =\dfrac{1}{3!}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2!}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\dfrac{1}{3!}\Delta t^{3}+\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)\right)\\
 & =\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\dfrac{1}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{3}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
从中可以看到旋转矩阵所在的位置。并且对比上一小节的
\begin_inset Formula $\Sigma_{2}$
\end_inset

，可以看到缺项对旋转矩阵的影响。因为
\begin_inset Formula $\Sigma_{3}$
\end_inset

在
\begin_inset Formula $\boldsymbol{A}^{3}$
\end_inset

之后才出现，影响已经很小，所以对于
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

的小值，可取截断级数的值为
\begin_inset Formula 
\[
\Sigma_{3}\approx\dfrac{\Delta t^{3}}{6}\boldsymbol{I}_{3\times3}
\]

\end_inset


\end_layout

\begin_layout Standard
如果需要对
\begin_inset Formula $\Sigma_{3}$
\end_inset

求极限，前一方程并不方便求极限，所以需要做另外的变形
\begin_inset Formula 
\begin{align*}
\Sigma_{3} & =\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\dfrac{1}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{3}\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)-\boldsymbol{I}_{3\times3}+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\dfrac{1}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{3}\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{2}+\dfrac{1}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{3}\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{3}}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t-\dfrac{1}{2}\left[\hat{\boldsymbol{\omega}}\times\right]^{3}\Delta t^{2}+\dfrac{1}{6}\left[\hat{\boldsymbol{\omega}}\times\right]^{4}\Delta t^{3}\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\dfrac{-\left|\hat{\boldsymbol{\omega}}\right|^{2}\left[\hat{\boldsymbol{\omega}}\times\right]}{\left|\hat{\boldsymbol{\omega}}\right|^{2}}\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t+\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}\left[\hat{\boldsymbol{\omega}}\times\right]-\dfrac{1}{6}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{3}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(-\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|}\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)-\left[\hat{\boldsymbol{\omega}}\times\right]\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\dfrac{\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\left|\hat{\boldsymbol{\omega}}\right|\Delta t}{\left|\hat{\boldsymbol{\omega}}\right|}+\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}\left[\hat{\boldsymbol{\omega}}\times\right]-\dfrac{\dfrac{1}{6}\left|\hat{\boldsymbol{\omega}}\right|^{3}\Delta t^{3}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}}{\left|\hat{\boldsymbol{\omega}}\right|}\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{1}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left(\dfrac{-\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)+\left|\hat{\boldsymbol{\omega}}\right|\Delta t-\dfrac{1}{6}\left|\hat{\boldsymbol{\omega}}\right|^{3}\Delta t^{3}}{\left|\hat{\boldsymbol{\omega}}\right|}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}+\left(-\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)+\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}\right)\left[\hat{\boldsymbol{\omega}}\times\right]\right)\\
 & =\tiny\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}-\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)}{\left|\hat{\boldsymbol{\omega}}\right|^{4}}\left[\hat{\boldsymbol{\omega}}\times\right]+\dfrac{\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)-\left|\hat{\boldsymbol{\omega}}\right|\Delta t+\dfrac{1}{6}\left|\hat{\boldsymbol{\omega}}\right|^{3}\Delta t^{3}}{\left|\hat{\boldsymbol{\omega}}\right|^{5}}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\\
 & =\dfrac{1}{6}\Delta t^{3}\boldsymbol{I}_{3\times3}-\dfrac{\dfrac{1}{2}\left|\hat{\boldsymbol{\omega}}\right|^{2}\Delta t^{2}-\left(1-\cos\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)\right)}{\left|\hat{\boldsymbol{\omega}}\right|^{4}\Delta t^{4}}\left[\hat{\boldsymbol{\omega}}\times\right]\Delta t^{4}+\dfrac{\sin\left(\left|\hat{\boldsymbol{\omega}}\right|\Delta t\right)-\left|\hat{\boldsymbol{\omega}}\right|\Delta t+\dfrac{1}{6}\left|\hat{\boldsymbol{\omega}}\right|^{3}\Delta t^{3}}{\left|\hat{\boldsymbol{\omega}}\right|^{5}\Delta t^{5}}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}\Delta t^{5}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
对于
\begin_inset Formula $\left|\hat{\boldsymbol{\omega}}\right|$
\end_inset

的小值，采用文献[2]第2.5.1节的方法求极限可得
\begin_inset Formula 
\[
\Sigma_{3}=\dfrac{\Delta t^{3}}{6}\boldsymbol{I}_{3\times3}-\dfrac{\Delta t^{4}}{24}\left[\hat{\boldsymbol{\omega}}\times\right]+\dfrac{\Delta t^{5}}{120}\left[\hat{\boldsymbol{\omega}}\times\right]^{2}
\]

\end_inset


\end_layout

\begin_layout Subsection
过程噪声协方差矩阵
\begin_inset Formula $\boldsymbol{Q}_{d}$
\end_inset

的高阶解
\end_layout

\begin_layout Standard
在
\begin_inset Formula $\hat{\boldsymbol{\omega}}=\hat{\boldsymbol{a}}_{B}=0$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}(\hat{q})=\boldsymbol{I}$
\end_inset

周围线性化
\begin_inset Formula $\boldsymbol{A}$
\end_inset

，使得
\begin_inset Formula 
\[
\boldsymbol{A}\approx\left[\begin{array}{cccccc}
0 & 0 & 0 & -\boldsymbol{I} & 0 & 0\\
0 & 0 & 0 & 0 & -\boldsymbol{I} & 0\\
0 & \boldsymbol{I} & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0 & 0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
并且
\begin_inset Formula 
\[
\boldsymbol{I}+\boldsymbol{A}(\Delta t-\tau)+\frac{1}{2}\boldsymbol{A}^{2}(\Delta t-\tau)^{2}=\left[\begin{array}{cccccc}
\boldsymbol{I} & 0 & 0 & -\boldsymbol{I}(\Delta t-\tau) & 0 & 0\\
0 & \boldsymbol{I} & 0 & 0 & -\boldsymbol{I}(\Delta t-\tau) & 0\\
0 & \boldsymbol{I}(\Delta t-\tau) & \boldsymbol{I} & 0 & -\frac{\boldsymbol{I}}{2}(\Delta t-\tau)^{2} & 0\\
0 & 0 & 0 & \boldsymbol{I} & 0 & 0\\
0 & 0 & 0 & 0 & \boldsymbol{I} & 0\\
0 & 0 & 0 & 0 & 0 & \boldsymbol{I}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
在
\begin_inset Formula $e^{\boldsymbol{A}(\Delta t-\tau)}\boldsymbol{Q}_{c}e^{\boldsymbol{A}^{\mathrm{T}}(\Delta t-\tau)}$
\end_inset

中使用这个近似值可以得到：
\begin_inset Formula 
\[
\tiny\boldsymbol{Q}_{d}=\int_{0}^{\Delta t}\left[\begin{array}{cccccc}
\wedge(\sigma_{\omega}^{2})+\wedge(\sigma_{\omega_{b}}^{2})(\Delta t-\tau)^{2} & 0 & 0 & -\wedge(\sigma_{\omega_{b}}^{2})(\Delta t-\tau) & 0 & 0\\
0 & \wedge(\sigma_{a}^{2})+\wedge(\sigma_{a_{b}}^{2})(\Delta t-\tau)^{2} & \wedge(\sigma_{a_{b}}^{2})\frac{(\Delta t-\tau)^{3}}{2}+\wedge(\sigma_{a}^{2})(\Delta t-\tau) & 0 & -\wedge(\sigma_{a_{b}}^{2})(\Delta t-\tau) & 0\\
0 & \wedge(\sigma_{a}^{2})(\Delta t-\tau)+\wedge(\sigma_{a_{b}}^{2})\frac{(\Delta t-\tau)^{3}}{2} & \wedge(\sigma_{a}^{2})(\Delta t-\tau)^{2}+\wedge(\sigma_{a_{b}}^{2})\frac{(\Delta t-\tau)^{4}}{4} & 0 & -\wedge(\sigma_{a_{b}}^{2})\frac{(\Delta t-\tau)^{2}}{2} & 0\\
-\wedge(\sigma_{\omega_{b}}^{2})(\Delta t-\tau) & 0 & 0 & \wedge(\sigma_{\omega_{b}}^{2}) & 0 & 0\\
0 & -\wedge(\sigma_{a_{b}}^{2})(\Delta t-\tau) & -\wedge(\sigma_{a_{b}}^{2})\frac{(\Delta t-\tau)^{2}}{2} & 0 & \wedge(\sigma_{a_{b}}^{2}) & 0\\
0 & 0 & 0 & 0 & 0 & \wedge(\sigma_{M_{b}}^{2})
\end{array}\right]d\tau
\]

\end_inset

计算这个积分可以得到
\begin_inset Formula $\boldsymbol{Q}_{d}$
\end_inset

过程噪声近似的期望结果。
\end_layout

\begin_layout Subsection
小结
\end_layout

\begin_layout Standard
在EKF中，状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

为Jacobian 矩阵。根据参考文献[4,6]里的推导，该 Jacobian 矩阵实际为控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

的流形的伴随矩阵的逆矩阵。为简化分析，我们采用参考文献[1,2]的成果进行分析。对于误差向量
\begin_inset Formula 
\[
\delta\boldsymbol{x}=\left[\begin{array}{c}
\delta\boldsymbol{\theta}\\
\delta\boldsymbol{b}
\end{array}\right]
\]

\end_inset

其中
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

为角度误差向量，
\begin_inset Formula $\delta\boldsymbol{b}$
\end_inset

为角度偏差的误差向量。其动力学矩阵为
\begin_inset Formula 
\[
\boldsymbol{A}=\left[\begin{array}{cc}
-\left[\hat{\boldsymbol{\omega}}\times\right] & -\boldsymbol{I}_{3\times3}\\
\boldsymbol{0}_{3\times3} & \boldsymbol{0}_{3\times3}
\end{array}\right]
\]

\end_inset

对此积分并用泰勒级数计算得到封闭形式的状态转移矩阵
\begin_inset Formula 
\[
\boldsymbol{F}=\left[\begin{array}{cc}
\boldsymbol{R}_{B}^{I}\left(\hat{\boldsymbol{\omega}}\Delta t\right) & -\boldsymbol{\Gamma}\left(\hat{\boldsymbol{\omega}}\Delta t\right)\\
\boldsymbol{0}_{3\times3} & \boldsymbol{I}_{3\times3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
从左上角的增量角度
\begin_inset Formula $\hat{\boldsymbol{\omega}}\Delta t$
\end_inset

的矩阵块就可以明显看出，
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
旋转矩阵
\begin_inset Formula $\boldsymbol{R}_{B}^{I}\left(\hat{\boldsymbol{\omega}}\Delta t\right)$
\end_inset

的伴随矩阵是其自身，其逆为
\begin_inset Formula $\boldsymbol{R}_{I}^{B}\left(\hat{\boldsymbol{\omega}}\Delta t\right)$
\end_inset

，其直觉就是增量角度误差好像是某种“惯性”，滞后于旋转方向。其它矩阵块和旋量理论中的
\begin_inset Formula $\mathrm{SE}(3)$
\end_inset

的
\begin_inset Formula $\boldsymbol{V}$
\end_inset

矩阵的转置矩阵
\begin_inset Formula $\boldsymbol{\Gamma}\left(\hat{\boldsymbol{\omega}}\Delta t\right)$
\end_inset

相关，距离
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
增量角度
\begin_inset Formula $\hat{\boldsymbol{\omega}}\Delta t$
\end_inset

越远则幂次缺项越高，代表着增量角度误差的传播方向。
\end_layout

\begin_layout Standard
从误差状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

的封闭形式可以看出我们关注的误差的来源。注意到增量角度和增量速度的测量方差由IMU方差乘以时间的平方。所以要减小位姿估计误差，就有两个途径，一个是选择更好的、有
更小方差的IMU，二是提高采样率，让时间间隔更小。此外还有一个推论，如果机体运转越快，也就是单位时间内的增量角度和增量速度越大，那么误差就越大，这时候就越应该提
高采样率以减小误差。
\end_layout

\begin_layout Standard
不过在实际项目中，因为采样率很高，很多项，特别是高于
\begin_inset Formula $2$
\end_inset

次幂的项都趋向于零，所以
\begin_inset Formula $\boldsymbol{F}$
\end_inset

矩阵和
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

矩阵可以大大化简，删除很多不必要的高阶项，以提高运算速度。
\end_layout

\begin_layout Section
前重置操作
\end_layout

\begin_layout Standard
在ESKF的预测步骤结束时，应该有一次前重置操作，需要对协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

进行校正处理。在参考文献[4,6]里的有详细推导，因为太复杂，这里不再重复。校正矩阵
\begin_inset Formula $\boldsymbol{\Gamma}$
\end_inset

实际上是
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
旋量理论中的
\begin_inset Formula $\mathrm{SE}(3)$
\end_inset

的
\begin_inset Formula $\boldsymbol{V}$
\end_inset

矩阵的转置矩阵，其输入为
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
增量角度
\begin_inset Formula $\boldsymbol{\theta}=\hat{\boldsymbol{\omega}}\Delta t$
\end_inset

，其影响范围是协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的左上角的增量角度的矩阵块
\begin_inset Formula $\boldsymbol{P}_{\theta}$
\end_inset

，
\begin_inset Formula 
\begin{align*}
\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right) & =\boldsymbol{V}\left(\boldsymbol{\theta}\right)^{\mathrm{T}}\\
 & =\boldsymbol{I}_{3\times3}-\frac{1-\cos\left(\left\Vert \boldsymbol{\theta}\right\Vert \right)}{\left\Vert \boldsymbol{\theta}\right\Vert ^{2}}\left[\boldsymbol{\theta}\times\right]+\frac{\left\Vert \boldsymbol{\theta}\right\Vert -\sin\left(\left\Vert \boldsymbol{\theta}\right\Vert \right)}{\left\Vert \boldsymbol{\theta}\right\Vert ^{3}}\left[\boldsymbol{\theta}\times\right]^{2}\\
\boldsymbol{P}_{\theta} & =\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right)\boldsymbol{P}_{\theta}\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right)^{\top}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
对于
\begin_inset Formula $\boldsymbol{\Gamma}\boldsymbol{P}\boldsymbol{\Gamma}^{\top}$
\end_inset

这种形式的矩阵，因为
\begin_inset Formula $\boldsymbol{P}$
\end_inset

为正定的对称矩阵，所以我们有
\begin_inset Formula 
\begin{align*}
\boldsymbol{\Gamma}\boldsymbol{P}\boldsymbol{\Gamma}^{\top} & =\boldsymbol{\Gamma}\boldsymbol{P}^{1/2}\left(\boldsymbol{P}^{1/2}\right)^{\top}\boldsymbol{\Gamma}^{\top}\\
 & =\left(\boldsymbol{\Gamma}\boldsymbol{P}^{1/2}\right)\left(\boldsymbol{\Gamma}\boldsymbol{P}^{1/2}\right)^{\top}
\end{align*}

\end_inset

其中是校正矩阵
\begin_inset Formula $\boldsymbol{\Gamma}$
\end_inset

左乘了标准差矩阵
\begin_inset Formula $\boldsymbol{P}^{1/2}$
\end_inset

，这意味着全局坐标系发生了变化，使得新的协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

是以新的姿态点为概率中心。
\end_layout

\begin_layout Standard
对于MEKF中常用的Gibbs向量映射，校正矩阵
\begin_inset Formula $\boldsymbol{\Gamma}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right)=\frac{1}{1+\left\Vert \boldsymbol{\theta}\right\Vert ^{2}/4}\left(\boldsymbol{I}_{3\times3}-\left[\boldsymbol{\theta}\times\right]/2\right)
\]

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

通常都很小，所以校正矩阵
\begin_inset Formula $\boldsymbol{\Gamma}$
\end_inset

的一阶近似为
\begin_inset Formula 
\[
\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right)\approx\boldsymbol{I}_{3\times3}-\frac{1}{2}\left[\boldsymbol{\theta}\times\right]
\]

\end_inset


\end_layout

\begin_layout Standard
由此也可以看出，当
\begin_inset Formula $\boldsymbol{\theta}\rightarrow\boldsymbol{0}$
\end_inset

时，校正矩阵
\begin_inset Formula $\boldsymbol{\Gamma}\rightarrow\boldsymbol{I}_{3\times3}$
\end_inset

。所以大多数ESKF的实现都忽略协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

校正这一步。
\end_layout

\begin_layout Section
更新步骤
\end_layout

\begin_layout Subsection
磁力计融合方程
\end_layout

\begin_layout Standard
最常见的测量校正方法是向量观测，又称向量测量，其中向量的坐标是先验已知的，或者是在惯性系和物体固定系中测量的。由于磁强计可能是业界最常用的向量测量，地球磁场向量
\begin_inset Formula $\boldsymbol{M}$
\end_inset

将用于说明误差状态到向量测量残差的映射。假设比例因子和未对准项已知，由磁强计测量的磁场向量由下式给出：
\begin_inset Formula 
\[
\tilde{\boldsymbol{M}}_{m}=\boldsymbol{R}_{I}^{B}\left(q_{t}\right)\boldsymbol{M}_{I}+\boldsymbol{M}_{b}+\boldsymbol{M}_{n}
\]

\end_inset


\end_layout

\begin_layout Standard
也就是说，测量的
\begin_inset Formula $\tilde{\boldsymbol{M}}_{m}$
\end_inset

是惯性坐标
\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

中的已知向量，转换成机体坐标，加上将机体固定偏差向量
\begin_inset Formula $\boldsymbol{M}_{b}$
\end_inset

和加性零平均白噪声项
\begin_inset Formula $\boldsymbol{\eta}_{m}$
\end_inset

。残差
\begin_inset Formula $\delta\tilde{\boldsymbol{M}}_{m}$
\end_inset

由实际测量值减去预测测量值
\begin_inset Formula $\hat{\tilde{\boldsymbol{M}}}_{m}$
\end_inset

得到。
\end_layout

\begin_layout Standard
预测的测量值是当前估计四元数的函数：
\begin_inset Formula 
\[
\hat{\tilde{\boldsymbol{M}}}_{m}=\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\boldsymbol{M}_{I}
\]

\end_inset


\end_layout

\begin_layout Standard
将罗德里格斯旋转方程简化式代入前一个方程可得：
\begin_inset Formula 
\begin{align*}
\tilde{\boldsymbol{M}}_{m} & =\boldsymbol{R}_{I}^{B}\left(q_{t}\right)\boldsymbol{M}_{I}+\boldsymbol{M}_{b}+\boldsymbol{M}_{n}\\
 & \approx\left(\boldsymbol{I}_{3\times3}-\left[\delta\boldsymbol{\theta}\times\right]\right)\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\tilde{\boldsymbol{M}}_{m}+\boldsymbol{M}_{b}+\boldsymbol{M}_{n}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
然后测量残差为：
\begin_inset Formula 
\[
\tilde{\boldsymbol{M}}_{m}-\hat{\tilde{\boldsymbol{M}}}_{m}=\left(\boldsymbol{I}_{3\times3}-\left[\delta\boldsymbol{\theta}\times\right]\right)\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\tilde{\boldsymbol{M}}_{m}+\boldsymbol{M}_{b}+\boldsymbol{M}_{n}-\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\tilde{\boldsymbol{M}}_{m}
\]

\end_inset


\end_layout

\begin_layout Standard
其可简化为误差状态的线性映射：
\begin_inset Formula 
\[
\delta\tilde{\boldsymbol{M}}_{m}=\left[\begin{array}{cccccc}
\left[\left(\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\boldsymbol{M}_{I}\right)\times\right] & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \boldsymbol{I}_{3\times3}\end{array}\right]\left[\begin{array}{c}
\delta\boldsymbol{\theta}\\
\vdots\\
\boldsymbol{M}_{b}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
所以对于磁强计测量的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{m}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{H}_{m}=\left[\begin{array}{cccccc}
\left[\left(\boldsymbol{R}_{I}^{B}\left(\hat{q}\right)\boldsymbol{M}_{I}\right)\times\right] & \mathbf{0} & \mathbf{0} & \mathbf{0} & \mathbf{0} & \boldsymbol{I}_{3\times3}\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Subsection
速度与位置融合方程
\end_layout

\begin_layout Standard
GPS提供的是直接的位置和速度。所以从误差状态到直接位置或速度残差的映射很简单：
\begin_inset Formula 
\begin{align*}
\tilde{\boldsymbol{P}}-\hat{\tilde{\boldsymbol{P}}} & =\left[\boldsymbol{I}\right]\delta\boldsymbol{P}+\boldsymbol{\eta}_{p}\\
\tilde{\boldsymbol{V}}-\hat{\tilde{\boldsymbol{V}}} & =\left[\boldsymbol{I}\right]\delta\boldsymbol{V}+\boldsymbol{\eta}_{v}
\end{align*}

\end_inset

则观测矩阵在相对应的项为
\begin_inset Formula $\boldsymbol{H}=\boldsymbol{I}$
\end_inset

。
\end_layout

\begin_layout Subsection
后重置操作
\end_layout

\begin_layout Standard
在ESKF算法中，有一个显式的重置操作要求。在误差注入标称状态后，误差状态
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

被重置。这与方向部分特别相关，因为新的方向误差将是相对于新标称状态的方向坐标系的局部表示，如前面的前重置章节里讨论的那样。为了使 ESKF 更新完成，
 需要根据此项修改更新误差的协方差。
\end_layout

\begin_layout Standard
ESKF 误差重置操作
\begin_inset Formula $g()$
\end_inset

是
\begin_inset Formula 
\begin{align*}
\delta\boldsymbol{x} & \leftarrow0\\
\boldsymbol{P} & \leftarrow\boldsymbol{\varGamma}\boldsymbol{P}\boldsymbol{\varGamma}^{\mathrm{T}}
\end{align*}

\end_inset

其中
\begin_inset Formula $\boldsymbol{\varGamma}$
\end_inset

是 Jacobian 矩阵，定义为
\begin_inset Formula 
\begin{align*}
\boldsymbol{\varGamma} & \triangleq\left.\dfrac{\partial g}{\partial\delta\boldsymbol{x}}\right|_{\delta\boldsymbol{x}}\\
 & =\left[\begin{array}{cc}
\boldsymbol{I}_{3\times3}-\left[\left(\dfrac{1}{2}\delta\boldsymbol{\theta}\right)\times\right] & \mathbf{0}\\
\mathbf{0} & \boldsymbol{I}_{15\times15}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在大多数情况下，误差项
\begin_inset Formula $\delta\boldsymbol{\theta}$
\end_inset

很小以至于可以被忽略，直接导出 Jacobian 矩阵
\begin_inset Formula $\boldsymbol{\varGamma}=\boldsymbol{I}_{18\times18}$
\end_inset

，从而导致一个平凡的误差重置。这就是 ESKF 的大多数实现所做的。这里提供的表达式应该产生更精确的结果，这可能有助于减少里程计系统中的长期误差漂移。
\end_layout

\begin_layout Standard
这个方程的推导过程参见文献[4]第6.3.1的内容，以及文献[6]里的讨论。
\end_layout

\begin_layout Section
运行步骤的直觉
\end_layout

\begin_layout Standard
我们用姿态变化的图示，直观演示 ESKF 每个运行步骤的目的。为简化显示，在后面的图示中，我们用
\begin_inset Formula $\bar{q}_{i}$
\end_inset

代表
\begin_inset Formula $i$
\end_inset

时刻的外推估计
\begin_inset Formula $\hat{q}_{i|i-1}$
\end_inset

，用
\begin_inset Formula $\hat{q}_{i}$
\end_inset

代表
\begin_inset Formula $i$
\end_inset

时刻的最优估计
\begin_inset Formula $\hat{q}_{i|i}$
\end_inset

。
\end_layout

\begin_layout Standard
我们有上一时刻的姿态的最优估计值
\begin_inset Formula $\hat{q}_{k-1}$
\end_inset

，其已经没有误差，
\begin_inset Formula $\delta\boldsymbol{x}_{k-1}=\boldsymbol{0}$
\end_inset

。当IMU数据到达，增量角度为
\begin_inset Formula $\boldsymbol{\theta}=\boldsymbol{\omega}\Delta t$
\end_inset

，则机体新的姿态为
\begin_inset Formula 
\[
\bar{q}_{k}=\hat{q}_{k-1}\boxplus\boldsymbol{\theta}
\]

\end_inset

增量向量是在
\begin_inset Formula $\hat{q}_{k-1}$
\end_inset

的局部切空间中计算，在假定匀速旋转的条件下，由时间
\begin_inset Formula $\Delta t$
\end_inset

控制向量的模长，然后将其收回并作用到当前姿态点上，则当前姿态点沿测地线移动到新的位置。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-02.pdf

\end_inset


\end_layout

\begin_layout Standard
因为每次迭代结束都执行重置操作，误差向量
\begin_inset Formula $\delta\boldsymbol{x}=\boldsymbol{0}$
\end_inset

，所以接下来只需要推导其动力学矩阵
\begin_inset Formula $\boldsymbol{A}$
\end_inset

，并推导出状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

，然后是输入控制矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

。我们是在
\begin_inset Formula $\hat{q}_{k-1}$
\end_inset

的局部切空间中计算协方差的传播
\begin_inset Formula 
\[
\bar{\boldsymbol{P}}_{k}=\boldsymbol{F}\hat{\boldsymbol{P}}_{k-1}\boldsymbol{F}^{\mathrm{T}}+\boldsymbol{G}\boldsymbol{Q}\boldsymbol{G}^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-03.pdf

\end_inset


\end_layout

\begin_layout Standard
但是这是在以
\begin_inset Formula $\hat{q}_{k-1}$
\end_inset

为切点建立的局部切空间中计算协方差的传播，并且
\begin_inset Formula $\hat{\boldsymbol{P}}_{k-1}$
\end_inset

是以切点
\begin_inset Formula $\hat{q}_{k-1}$
\end_inset

为中心的概率分布。我们同样期望
\begin_inset Formula $\bar{\boldsymbol{P}}_{k}$
\end_inset

的概率中心位于切点
\begin_inset Formula $\bar{q}_{k}$
\end_inset

处，因为后续的协方差的计算将在以
\begin_inset Formula $\bar{q}_{k}$
\end_inset

为切点建立的局部切空间中进行，所以这里需要对协方差矩阵进行一次重置操作
\begin_inset Formula 
\[
\bar{\boldsymbol{P}}_{k}=\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right)\bar{\boldsymbol{P}}_{k}\boldsymbol{\Gamma}\left(\boldsymbol{\theta}\right)^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
并且我们有一个重要的假设：误差向量
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

是一个零均值的向量，
\begin_inset Formula $\mathbb{E}\left(\delta\boldsymbol{x}\right)=\boldsymbol{0}$
\end_inset

。因此
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

此时的协方差就是在
\begin_inset Formula $\bar{q}_{k}$
\end_inset

的局部切空间中的协方差
\begin_inset Formula $\bar{\boldsymbol{P}}_{k}$
\end_inset

。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-04.pdf

\end_inset


\end_layout

\begin_layout Standard
接下来是测量更新步骤，也称校正步骤。在全局切空间中存在一个固定向量，例如地磁向量
\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

，我们在
\begin_inset Formula $\bar{q}_{k}$
\end_inset

的局部切空间中观测它，所以需要用伴随矩阵将其变换到局部切空间中，并与我们的测量值相减形成残差。因为旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

的伴随矩阵是其自身，则从全局到局部切空间的伴随矩阵为
\begin_inset Formula $\boldsymbol{R}^{-1}=\boldsymbol{R}^{\mathrm{T}}$
\end_inset

，因此测量残差为
\begin_inset Formula 
\[
\tilde{\boldsymbol{y}}=\boldsymbol{M}_{m}-\boldsymbol{R}^{-1}\boldsymbol{M}_{I}
\]

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-05.pdf

\end_inset


\end_layout

\begin_layout Standard
测量残差可简化为误差状态
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

的线性映射，即观测矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{H}=\left[\begin{array}{cc}
\left[\left(\boldsymbol{R}^{-1}\boldsymbol{M}_{I}\right)\times\right] & \boldsymbol{I}_{3\times3}\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
对于卡尔曼增益矩阵
\begin_inset Formula $\boldsymbol{K}$
\end_inset

，如果我们忽略传感器的测量噪声，则可以写为
\begin_inset Formula 
\[
\boldsymbol{K}=\boldsymbol{P}\boldsymbol{H}^{\mathrm{T}}\left(\boldsymbol{H}\boldsymbol{P}\boldsymbol{H}^{\mathrm{T}}\right)^{-1}
\]

\end_inset

其可以认为是观测矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

的最优权重右伪逆矩阵，因为
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}\boldsymbol{K} & =\boldsymbol{H}\boldsymbol{P}\boldsymbol{H}^{\mathrm{T}}\left(\boldsymbol{H}\boldsymbol{P}\boldsymbol{H}^{\mathrm{T}}\right)^{-1}\\
 & =\left(\boldsymbol{H}\boldsymbol{P}^{1/2}\right)\left(\boldsymbol{H}\boldsymbol{P}^{1/2}\right)^{\mathrm{T}}\left(\left(\boldsymbol{H}\boldsymbol{P}^{1/2}\right)\left(\boldsymbol{H}\boldsymbol{P}^{1/2}\right)^{\mathrm{T}}\right)^{-1}\\
 & =\boldsymbol{Q}\boldsymbol{Q}^{\mathrm{T}}\left(\boldsymbol{Q}\boldsymbol{Q}^{\mathrm{T}}\right)^{-1}\\
 & =\boldsymbol{I}
\end{align*}

\end_inset

其中
\begin_inset Formula $\boldsymbol{Q}\boldsymbol{Q}^{\mathrm{T}}$
\end_inset

为数据的误差协方差矩阵，
\begin_inset Formula $\boldsymbol{Q}=\boldsymbol{H}\boldsymbol{P}^{1/2}$
\end_inset

是用标准差
\begin_inset Formula $\boldsymbol{P}^{1/2}$
\end_inset

矩阵右乘校正了观测矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

，我们是在校正后的白化数据集合上进行最小二乘估计。
\end_layout

\begin_layout Standard
最终在
\begin_inset Formula $\bar{q}_{k}$
\end_inset

的局部切空间中误差向量
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

计算为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\delta\boldsymbol{x}=\boldsymbol{K}\tilde{\mathbf{y}}
\]

\end_inset

并将其收回并作用在当前姿态点
\begin_inset Formula $\bar{q}_{k}$
\end_inset

上，则当前姿态点移动到最优估计点
\begin_inset Formula $\hat{q}_{k}$
\end_inset

上。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-06.pdf

\end_inset


\end_layout

\begin_layout Standard
接着更新协方差为最优估计协方差
\begin_inset Formula $\hat{\boldsymbol{P}}_{k}$
\end_inset

。误差向量
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

之所以是最优估计是因为它指向的是协方差
\begin_inset Formula $\hat{\boldsymbol{P}}_{k}$
\end_inset

所代表的概率中心。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-07.pdf

\end_inset


\end_layout

\begin_layout Standard
当误差向量
\begin_inset Formula $\delta\boldsymbol{x}$
\end_inset

已经作用到当前姿态点上，这意味着当前姿态点
\begin_inset Formula $\hat{q}_{k}$
\end_inset

已经没有误差，所以需要进行重置操作，
\begin_inset Formula $\delta\boldsymbol{x}=\boldsymbol{0}$
\end_inset

。并且需要把最优估计协方差
\begin_inset Formula $\hat{\boldsymbol{P}}_{k}$
\end_inset

变换到以切点
\begin_inset Formula $\hat{q}_{k}$
\end_inset

为中心的概率分布，以备下一次迭代使用。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-08.pdf

\end_inset


\end_layout

\begin_layout Standard
从整体看，ESKF的每一步骤的输出是当前姿态点的估计值，以及以其为概率中心的协方差矩阵。协方差矩阵张成一个椭球，中心点就是概率中心，就是真实值最有可能存在的地方
。误差向量就是在局部切空间中以当前姿态点为原点指向概率中心。误差向量作用(乘法)到当前姿态点，则当前姿态点移动到真实值最有可能存在的地方，因此新的姿态点就是最优
估计。这时相当于当前姿态点已经没有误差，因此误差向量需要清零，这就是重置。 
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename ESKF-09.pdf

\end_inset


\end_layout

\begin_layout Standard
我们永远不能知道真实值
\begin_inset Formula $q_{k}$
\end_inset

在哪里。但是概率中心是真实值最有可能存在的地方，不过真实值不一定存在于这个地方，这是概率问题，就是高斯曲线的积分，在
\begin_inset Formula $\pm3$
\end_inset

倍标准差范围内，真实值的存在概率为
\begin_inset Formula $99.7\%$
\end_inset

。因为我们不知道真实值
\begin_inset Formula $q_{k}$
\end_inset

在哪里，所以我们只有选择最优估计值
\begin_inset Formula $\hat{q}_{k}$
\end_inset

，距离真实值
\begin_inset Formula $q_{k}$
\end_inset

最近的点，只要传感器方差越小，椭球就越小，真实值变化的范围就越小，估计值就越精确。
\end_layout

\begin_layout Standard
对于协方差
\begin_inset Formula $\hat{\boldsymbol{P}}_{k}$
\end_inset

的用途，一是评估当前姿态点
\begin_inset Formula $\hat{q}_{k}$
\end_inset

的估计质量，二是表示线性化点周围的不确定性。当前线性化点周围的高斯分布可以用下式表示
\begin_inset Formula 
\[
Gaussian\left(\boldsymbol{R}\left(\hat{q}_{k}\right),\boldsymbol{\eta}\right)=\boldsymbol{R}\left(\hat{q}_{k}\right)\mathrm{Exp}\left(\boldsymbol{\eta}\right)
\]

\end_inset

其中
\begin_inset Formula $\boldsymbol{\eta}$
\end_inset

是从协方差
\begin_inset Formula $\hat{\boldsymbol{P}}_{k}$
\end_inset

对角线上取出来的方差向量。
\end_layout

\begin_layout Section
总结
\end_layout

\begin_layout Standard
PX4 ECL/EKF2 的算法总体和这里类似，都是对位姿进行最优估计，同样采用 IMU 数据进行位姿预测，用磁力计和GPS等传感器数据进行位姿校正。只不过
 PX4 ECL/EKF2 的算法直接对位姿进行最优估计，简单直接得多，没有估计误差向量的误差以及偏差向量的误差这种弯弯绕，只要你能接受表示旋转的单位四元数是个
四元向量这个假设即可，并且事实证明，当传感器采样率足够快的时候，这个假设也无不可，估计精度也足够。
\end_layout

\begin_layout Standard
不过对比 PX4 ECL/EKF2 里面的Jacobians 矩阵，从数学上来说，ESKF中的Jacobians 矩阵更简单也更可解释，并且理论上其估计精度应该
更高。但是位姿估计是一个工程问题，不是单单靠数学解决问题的。这领域最终还是调参侠的天下。
\end_layout

\begin_layout Section
参考文献
\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Attitude Error Representations for Kalman Filtering - 2003"
target "https://www.researchgate.net/publication/245432681_Attitude_Error_Representations_for_Kalman_Filtering"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Indirect Kalman filter for 3D attitude estimation - 2007"
target "http://mars.cs.umn.edu/tr/reports/Trawny05b.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Multiplicative Quaternion Extended Kalman Filtering for Nonspinning Guided Projectiles - 2013"
target "https://apps.dtic.mil/sti/pdfs/ADA588831.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Quaternion kinematics for the error-state KF - 2017"
target "http://www.iri.upc.edu/people/jsola/JoanSola/objectes/notes/kinematics.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "The Multiplicative Extended Kalman Filter - 2020"
target "https://matthewhampsey.github.io/blog/2020/07/18/mekf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Full-Order Solution to the Attitude Reset Problem for Kalman Filtering of Attitudes - 2020"
target "https://arc.aiaa.org/doi/pdfplus/10.2514/1.G004134"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Why and How to Avoid the Flipped Quaternion Multiplication"
target "https://arxiv.org/abs/1801.07478"
literal "false"

\end_inset


\end_layout

\end_body
\end_document
