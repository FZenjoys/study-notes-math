#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass ctex-book
\begin_preamble
% 如果没有这一句命令，XeTeX会出错，原因参见
% http://bbs.ctex.org/viewthread.php?tid=60547
\DeclareRobustCommand\nobreakspace{\leavevmode\nobreak\ }
\end_preamble
\options UTF8
\use_default_options true
\maintain_unincluded_children false
\language chinese-simplified
\language_package none
\inputencoding utf8-plain
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures false
\graphics default
\default_output_format pdf4
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
四元数与空间旋转–学习笔记
\end_layout

\begin_layout Author
Shuyong Chen
\end_layout

\begin_layout Chapter
前言
\end_layout

\begin_layout Standard
这篇文章的主要目的就是学习四元数(Quaternion)与三维旋转之间的关系。虽然网上四元数相关的资料有很多了，但是目前很多资料都使用了比较抽象比较高深的方式来
解释这一问题。似乎不如此不足以显示作者的数学水平。结果就让我们这些初学者、搬运工看得是云里雾里，不知所云。直到我发现了文档[1]这份教材。
\end_layout

\begin_layout Standard
我赞同文档[1]中的这个观点：因为3D空间还是在我们理解范围之内的，所以四元数与三维旋转的一些关系可以直接使用一些基础的几何学和线性代数的知识来推导和理解，并不
会那么复杂。我们在大部分的时间中也会采用这一方式来理解四元数。
\end_layout

\begin_layout Standard
古人有云：书非借而不能读也。现在互联网发达，借书的情形已经很少。但是我现在的体会是：书非抄而不能学。所以我抄写了不少资料，整理成这个学习笔记。在抄写和整理过程中
，确实发现了不少原本以为我懂了、其实还没有懂的知识点。又得回头看原文，才弄明白了一些基本概念。这对自己是个提高。
\end_layout

\begin_layout Standard
本文的前半部分主要来自于文档[1][2]。其它的来源，在文中标注。具体的内容可以查看参考资料一章。
\end_layout

\begin_layout Standard
网上讨论四元数与三维旋转的文章的侧重点大多偏向计算机图形学中的应用。本文主要的侧重点会偏向四元数与姿态表示之间的关系。
\end_layout

\begin_layout Standard
本文采用「CC BY-NC-SA 4.0」协议，在共享的时候请记得署名以及采用相同的协议，并且不要用于商业用途。
\end_layout

\begin_layout Chapter
复数与二维向量
\end_layout

\begin_layout Standard
在我们能够完全理解四元数之前，我们必须先知道四元数是怎么来的。四元数的根源是基于复数系统(Complex Number System)的概念。在介绍四元数与3D
旋转之间的关系之前，我们先来讨论一下复数(Complex Number)的一些性质以及它与2D旋转之间的关系。四元数的很多性质在很多层面上都与复数非常类似，所以
理解复数的一些性质会对理解四元数非常有帮助。
\end_layout

\begin_layout Section
定义
\end_layout

\begin_layout Standard
复数系统引入了一个新的数集——虚数。虚数的发明是为了解一些特定的无解的方程，例如：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
x^{2}+1=0
\]

\end_inset


\end_layout

\begin_layout Standard
要解这个等式，必须让
\begin_inset Formula $x^{2}=−1$
\end_inset

，这当然是不行的，因为任意实数（正数或负数）的平方都是非负数。
\end_layout

\begin_layout Standard
一般而言，数学家是不能忍受一个等式是无解的。于是，一个新的术语被发明了，它就是
\begin_inset CommandInset href
LatexCommand href
name "虚数"
target "http://mathworld.wolfram.com/ImaginaryNumber.html"
literal "false"

\end_inset

，一个可以解上面这个等式的数。
\end_layout

\begin_layout Standard
虚数有这样的形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
i^{2}=−1
\]

\end_inset


\end_layout

\begin_layout Standard
不要为这个术语较真，因为逻辑上这个数是不存在的。只要知道
\begin_inset Formula $i$
\end_inset

是一个平方等于
\begin_inset Formula $-1$
\end_inset

的东西即可。
\end_layout

\begin_layout Standard
虚数的集合可以用
\begin_inset Formula $\mathbb{I}$
\end_inset

来表示。
\end_layout

\begin_layout Standard
复数的集合
\begin_inset Formula $\mathbb{C}$
\end_inset

是一个实数和一个虚数的和，形式如下：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{ccc}
z=a+bi & a,b\in\mathbb{R}, & i^{2}=-1\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
我们将
\begin_inset Formula $a$
\end_inset

称之为这个复数的实部(Real Part)，
\begin_inset Formula $b$
\end_inset

称之为这个复数的虚部(Imaginary Part)。可以认为所有实数都是
\begin_inset Formula $b=0$
\end_inset

的复数、所有虚数都是
\begin_inset Formula $a=0$
\end_inset

的复数。
\end_layout

\begin_layout Standard
复数也可以表示为平面上的二维向量。因为这个向量有两个元素,我们可以使用复平面上的一个点来表示一个复数.复平面的横坐标
\begin_inset Formula $Re$
\end_inset

代表它的实部,纵坐标
\begin_inset Formula $Im$
\end_inset

代表它的虚部:
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure2.1.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
复平面与二维向量
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
性质
\end_layout

\begin_layout Subsection
复数加减法
\end_layout

\begin_layout Standard
复数可以通过加减实部和虚部来加减。
\end_layout

\begin_layout Standard
加法：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
(a_{1}+b_{1}i)+(a_{2}+b_{2}i)=(a_{1}+a_{2})+(b_{1}+b_{2})i
\]

\end_inset


\end_layout

\begin_layout Standard
减法：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
(a_{1}+b_{1}i)-(a_{2}+b_{2}i)=(a_{1}-a_{2})+(b_{1}-b_{2})i
\]

\end_inset


\end_layout

\begin_layout Standard
复平面上的两个向量的加减法叫做三角形法，或者是平行四边形法。加法是两个向量夹角中的对角线。减法是减数指向被减数的对角线。加减法在做向量的合成与分解时会用到，例如
一个向量对另外一个向量可以分解为一个投影向量和一个正交向量的组合。另外，在牛顿力学中，力的合成与分解也大量应用了向量的加减法。
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure2.2.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
两个向量的加减法的平行四边形法则
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsection
复数乘法
\end_layout

\begin_layout Standard
复数也可以通过应用正规的乘法分配律规则来相乘。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
z_{1} & =(a_{1}+b_{1}i)\\
z_{2} & =(a_{2}+b_{2}i)\\
z_{1}z_{2} & =(a_{1}+b_{1}i)(a_{2}+b_{2}i)\\
 & =a_{1}a_{2}+a_{1}b_{2}i+b_{1}a_{2}i+b_{1}b_{2}i^{2}\\
 & =(a_{1}a_{2}-b_{1}b_{2})+(a_{1}b_{2}+b_{1}a_{2})i
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
上述结果可以表达为一个矩阵与向量相乘的结果,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
z_{1}z_{2}=\left[\begin{array}{cc}
a_{1} & -b_{1}\\
b_{1} & a_{1}
\end{array}\right]\left[\begin{array}{c}
a_{2}\\
b_{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
右侧的
\begin_inset Formula $\left[\begin{array}{c}
a_{2}\\
b_{2}
\end{array}\right]$
\end_inset

是用向量的形式来表示的
\begin_inset Formula $z_{2}$
\end_inset

，也就是一个复数其实就是对于
\begin_inset Formula ${1,i}$
\end_inset

这个基(Basis)的线性组合(Linear Combination)。而左侧的
\begin_inset Formula $\left[\begin{array}{cc}
a_{1} & -b_{1}\\
b_{1} & a_{1}
\end{array}\right]$
\end_inset

则是
\begin_inset Formula $z_{1}$
\end_inset

的矩阵形式。我们可以发现，复数相乘这个运算,其实是与
\begin_inset Formula $\left[\begin{array}{cc}
a_{1} & -b_{1}\\
b_{1} & a_{1}
\end{array}\right]$
\end_inset

这个矩阵所代表的变换是等价的。我们可以把转换矩阵想象成一个“基空间(Basis Space)”，当你用这个矩阵乘以向量、点（或甚至其它矩阵）后，你就把这些向量、
点、矩阵转换进这个矩阵所代表的空间了。
\end_layout

\begin_layout Standard
那么，在矩阵形式下,复数与复数的相乘也可以表示为矩阵的相乘，那么与
\begin_inset Formula $z_{1}z_{2}$
\end_inset

所代表的变换则可以表示为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
z_{1}z_{2}=\left[\begin{array}{cc}
a_{1} & -b_{1}\\
b_{1} & a_{1}
\end{array}\right]\left[\begin{array}{cc}
a_{2} & -b_{2}\\
b_{2} & a_{2}
\end{array}\right]=\left[\begin{array}{cc}
a_{1}a_{2}-b_{1}b_{2} & -(a_{1}b_{2}+b_{1}a_{2})\\
a_{1}b_{2}+b_{1}a_{2} & a_{1}a_{2}-b_{1}b_{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Subsection
复数的共轭与模长
\end_layout

\begin_layout Standard
复数的共轭(
\begin_inset Formula $\mathbf{conjugate}$
\end_inset

)就是指把复数的虚数部分变成负的。共轭复数的符号是
\begin_inset Formula $\bar{z}$
\end_inset

或
\begin_inset Formula $z^{*}$
\end_inset

。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
z & =(a+bi)\\
z^{*} & =(a-bi)
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
复数和它的共轭复数的乘积是：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
z & =(a+bi)\\
z^{*} & =(a-bi)\\
zz^{*} & =(a+bi)(a-bi)\\
 & =a^{2}-abi+abi+b^{2}\\
 & =a^{2}+b^{2}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
我们可以用复数的共轭(
\begin_inset Formula $\mathbf{conjugate}$
\end_inset

)来计算复数的绝对值（或范数(
\begin_inset Formula $\mathbf{norm}$
\end_inset

)或模长(
\begin_inset Formula $\mathbf{magnitude}$
\end_inset

)）。复数的绝对值是复数乘以其共轭(
\begin_inset Formula $\mathbf{conjugate}$
\end_inset

)的平方根，表示为
\begin_inset Formula $\left|z\right|$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
z & =(a+bi)\\
\left|z\right| & =\sqrt{zz^{*}}\\
 & =\sqrt{(a+bi)(a-bi)}\\
 & =\sqrt{a^{2}+b^{2}}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Section
复数相乘与2D旋转
\end_layout

\begin_layout Subsection
旋转的矩阵形式
\end_layout

\begin_layout Standard
现在,我们回到之前的话题,既然与复数的相乘代表着
\begin_inset Formula $\left[\begin{array}{cc}
a & -b\\
b & a
\end{array}\right]$
\end_inset

矩阵所作出的变换，那这种变换代表着什么呢? 实际上,如果我们对这个矩阵进行一些变形，将矩阵中每一个元素都除以模长
\begin_inset Formula $\left|z\right|=\sqrt{a^{2}+b^{2}}$
\end_inset

，这个问题就很容易理解了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left[\begin{array}{cc}
a & -b\\
b & a
\end{array}\right]=\sqrt{a^{2}+b^{2}}\left[\begin{array}{cc}
\dfrac{a}{\sqrt{a^{2}+b^{2}}} & \dfrac{-b}{\sqrt{a^{2}+b^{2}}}\\
\dfrac{b}{\sqrt{a^{2}+b^{2}}} & \dfrac{a}{\sqrt{a^{2}+b^{2}}}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
经过这一变换，我们只需要观察一下复平面就能够解答之前的问题了：
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure2.3.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
向量与坐标轴的夹角
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
可以看到,
\begin_inset Formula $\left|z\right|$
\end_inset

正是复数
\begin_inset Formula $z$
\end_inset

与坐标轴所形成的三角形的斜边长，而
\begin_inset Formula $a$
\end_inset

,
\begin_inset Formula $b$
\end_inset

分别为三角形的两个直角边。如果将斜边与实数轴
\begin_inset Formula $Re$
\end_inset

正方向的夹角记为
\begin_inset Formula $\theta$
\end_inset

的话，按照三角函数的定义可以得出
\begin_inset Formula $\dfrac{a}{\sqrt{a^{2}+b^{2}}}=\cos(\theta)$
\end_inset

，且
\begin_inset Formula $\dfrac{b}{\sqrt{a^{2}+b^{2}}}=\sin(\theta)$
\end_inset

，这个角度
\begin_inset Formula $\theta$
\end_inset

其实就是
\begin_inset Formula $\mathrm{atan2}(b,a)$
\end_inset

。因此上式可以变形为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left[\begin{array}{cc}
a & -b\\
b & a
\end{array}\right]=\left|z\right|\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]=\left[\begin{array}{cc}
\left|z\right| & 0\\
0 & \left|z\right|
\end{array}\right]\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
因此，复数是两个变换矩阵的复合，左边
\begin_inset Formula $\left[\begin{array}{cc}
\left|z\right| & 0\\
0 & \left|z\right|
\end{array}\right]$
\end_inset

为缩放矩阵，而右边的
\begin_inset Formula $\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]$
\end_inset

则是2D旋转矩阵。旋转矩阵又称为旋转子(Rotors)。
\end_layout

\begin_layout Standard
所以，复数的相乘其实是旋转与缩放变换的复合。如果有一个复数
\begin_inset Formula $z=a+bi$
\end_inset

，那么
\begin_inset Formula $z$
\end_inset

与任意一个复数
\begin_inset Formula $c$
\end_inset

相乘都会将
\begin_inset Formula $c$
\end_inset

逆时针旋转 
\begin_inset Formula $\theta=\mathrm{atan2}(b,a)$
\end_inset

度，并将其缩放
\begin_inset Formula $\left|z\right|=\sqrt{a^{2}+b^{2}}$
\end_inset

倍。
\end_layout

\begin_layout Standard
如果
\begin_inset Formula $\left|z\right|=1$
\end_inset

,也就是说
\begin_inset Formula $a^{2}+b^{2}=1$
\end_inset

，即这个复数可以用一个单位向量来表示，那么这个复数所代表的几何意义就完全只有旋转了。所留下来的部分就只有纯粹的旋转矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
z=\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
如果我们想让2D空间中任意一个向量
\begin_inset Formula $\mathbf{v}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

度,那么我们就可以使用这个矩阵对
\begin_inset Formula $\mathbf{v}$
\end_inset

进行变换：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 1:
\end_layout

\begin_layout Plain Layout
2D旋转公式(矩阵型)
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
\mathbf{v}'=\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]\mathbf{v}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure2.4.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
2D旋转矩阵的变换
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsection
旋转的复数形式
\end_layout

\begin_layout Standard
注意,其实
\begin_inset Formula $\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]$
\end_inset

这个旋转矩阵如果写成复数形式的话就是
\begin_inset Formula $\cos(\theta)+\sin(\theta)i$
\end_inset

。
\end_layout

\begin_layout Standard
如果我们将向量
\begin_inset Formula $\mathbf{v}=\left[\begin{array}{cc}
x & y\end{array}\right]$
\end_inset

看作是一个复数
\begin_inset Formula $v=x+yi$
\end_inset

，其中实部为
\begin_inset Formula $x$
\end_inset

，虚部为
\begin_inset Formula $y$
\end_inset

。那么，我们可以构造一个复数
\begin_inset Formula $z=\cos(\theta)+\sin(\theta)i$
\end_inset

，并将它与
\begin_inset Formula $v$
\end_inset

相乘来进行旋转。旋转
\begin_inset Formula $\theta$
\end_inset

度之后的向量
\begin_inset Formula $v′$
\end_inset

可以用等价的复数乘法来表示：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 2:
\end_layout

\begin_layout Plain Layout
2D旋转公式(复数积型)
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{align}
v' & =zv\nonumber \\
 & =\left(\cos(\theta)+\sin(\theta)\right)v
\end{align}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
旋转的极坐标形式
\end_layout

\begin_layout Standard
根据欧拉公式(Euler's Formula)，
\begin_inset Formula $\cos(\theta)+\sin(\theta)i$
\end_inset

可以变换为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\cos(\theta)+\sin(\theta)i=e^{\theta i}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因此对于任意复数
\begin_inset Formula $z$
\end_inset

，可以表示为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
z & =\left|z\right|\left[\begin{array}{cc}
\cos(\theta) & -\sin(\theta)\\
\sin(\theta) & \cos(\theta)
\end{array}\right]\\
 & =\left|z\right|\left(\cos(\theta)+\sin(\theta)i\right)\\
 & =\left|z\right|e^{\theta i}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
如果我们定义
\begin_inset Formula $r=\left|z\right|$
\end_inset

，我们就得到了复数的极坐标形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
z=re^{\theta i}
\]

\end_inset


\end_layout

\begin_layout Standard
现在复数的定义就与实部与虚部的两个分量
\begin_inset Formula $a,b$
\end_inset

无关了，我们可以使用一个缩放因 子
\begin_inset Formula $r$
\end_inset

和旋转角度
\begin_inset Formula $\theta$
\end_inset

的形式来定义任意一个复数，而且它旋转与缩放的性质仍然存在。 如果我们想对2D空间中向量
\begin_inset Formula $\mathbf{v}=\left[\begin{array}{cc}
x & y\end{array}\right]$
\end_inset

进行旋转并缩放，我们可以类似地将这个向量看作是一个复数
\begin_inset Formula $v=x+yi$
\end_inset

。那么，经过旋转
\begin_inset Formula $\theta$
\end_inset

度，缩放
\begin_inset Formula $r$
\end_inset

倍之后的向量
\begin_inset Formula $v′$
\end_inset

就可以这样计算：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
v'=re^{\theta i}v
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因此我们可以使用一个缩放因子
\begin_inset Formula $r=\left|z\right|$
\end_inset

和旋转角度
\begin_inset Formula $\theta=\mathrm{atan2}(b,a)$
\end_inset

的形式来定义任意一个复数。
\end_layout

\begin_layout Standard
如果仅需要旋转
\begin_inset Formula $\theta$
\end_inset

度的话，可以令缩放因子
\begin_inset Formula $r=1$
\end_inset

，那么变换后的结果就是：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 3:
\end_layout

\begin_layout Plain Layout
2D旋转公式(指数型)
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
v'=e^{\theta i}v
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
这三种2D旋转公式其实都是等价的。根据不同的需求我们可以使用旋转的不同形态。在我们之后讨论四元数的时候，我们也会看到非常类似的公式。
\end_layout

\begin_layout Section
旋转的组合
\end_layout

\begin_layout Standard
如果我们有两个代表2D旋转的单位复数
\begin_inset Formula $z_{1}=\cos(\theta)+\sin(\theta)i$
\end_inset

和
\begin_inset Formula $z_{2}=\cos(\phi)+\sin(\phi)i$
\end_inset

，因为复数的相乘遵守交换律，所以：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
z_{net}=z_{1}z_{2}=z_{2}z_{1}
\]

\end_inset


\end_layout

\begin_layout Standard
展开，我们得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
z_{net} & =\left(\cos(\theta)+\sin(\theta)i\right)\left(\cos(\phi)+\sin(\phi)i\right)\\
 & =\cos(\theta)\cos(\phi)+\left(\cos(\theta)\sin(\phi)\right)i+\left(\sin(\theta)\cos(\phi)\right)i-\sin(\theta)\sin(\phi)\\
 & =\left(\cos(\theta)\cos(\phi)-\sin(\theta)\sin(\phi)\right)+\left(\cos(\theta)\sin(\phi)+\sin(\theta)\cos(\phi)\right)i\\
 & \text{(利用三角恒等式化简)}\\
 & =\cos(\theta+\phi)+\sin(\theta+\phi)i
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
所以，当我们对两个2D旋转进行复合时，所得到的变换
\begin_inset Formula $z_{net}$
\end_inset

仍是一个旋转，而且与施加的次序无关。这个等效变换的旋转角是
\begin_inset Formula $z_{1}$
\end_inset

与
\begin_inset Formula $z_{2}$
\end_inset

旋转角之和。
\end_layout

\begin_layout Chapter
三维空间中的旋转
\end_layout

\begin_layout Standard
在讨论四元数之前，我们先来研究一下三维空间中的旋转。
\end_layout

\begin_layout Standard
表示三维空间中旋转的方法有很多种，但我们这里关注的是轴角式(Axis-angle)的旋转。
\end_layout

\begin_layout Standard
假设我们有一个经过原点的(如果旋转轴不经过原点我们可以先将旋转轴平移到原点，进行旋转，再平移回原处)旋转轴
\begin_inset Formula $\mathbf{u}=\left[\begin{array}{ccc}
x & y & z\end{array}\right]$
\end_inset

，我们希望将一个向量
\begin_inset Formula $\mathbf{v}$
\end_inset

，沿着这个旋转轴旋转
\begin_inset Formula $\theta$
\end_inset

度，变换到
\begin_inset Formula $\mathbf{v}'$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure3.1.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
三维向量旋转示意
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
注意，本文和大多数教程一样，使用右手坐标系统，并且使用右手定则来定义旋转的正方向。你可以将右手拇指指向旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

的正方向，这时其它四个手指弯曲的方向即为旋转的正方向。在上图中即为逆时针方向。
\end_layout

\begin_layout Standard
在本文中我们规定旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

的模长为
\begin_inset Formula $\left|\mathbf{u}\right|=\sqrt{x^{2}+y^{2}+z^{2}}=1$
\end_inset

,也就是说
\begin_inset Formula $\mathbf{u}$
\end_inset

是一个单位向量。规定
\begin_inset Formula $\left|\mathbf{u}\right|=1$
\end_inset

能为我们之后的推导和计算带来很多的便利，这也是数学和物理中对方向定义的惯例。
\end_layout

\begin_layout Section
三维向量的点乘与叉乘
\end_layout

\begin_layout Standard
在推导与旋转相关的向量公式中，应用到了向量的点乘与叉乘。从几何角度去理解向量的点乘与叉乘的意义，对于理解旋转公式很重要。
\end_layout

\begin_layout Subsection
向量的点乘与几何解释
\end_layout

\begin_layout Standard
向量的点乘又叫点积、数量积，符号为'
\begin_inset Formula $\cdot$
\end_inset

'。如果有两个向量
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

，两者的点乘公式为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
a\cdot b=\left|a\right|\left|b\right|\cos(\theta)
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
点乘的几何意义是可以用来表征或计算两个向量之间的夹角，以及在一个向量在另一个向量方向上的投影的积，也就是同方向的积。
\end_layout

\begin_layout Standard
当
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

两个向量为单位向量，模长等于
\begin_inset Formula $1$
\end_inset

，通过点乘算法很容易得出两个向量之间的夹角：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
a\cdot b & =\cos(\theta)\\
\text{\theta} & =\arccos(a\cdot b)
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
工程上经常使用向量的点乘来判断两个向量是否同向(
\begin_inset Formula $\cos(\theta)>0$
\end_inset

)、垂直或正交(
\begin_inset Formula $\cos(\theta)=0$
\end_inset

)、反向(
\begin_inset Formula $\cos(\theta)<0$
\end_inset

)。
\end_layout

\begin_layout Subsection
向量的叉乘与几何解释
\end_layout

\begin_layout Standard
向量的叉乘(Cross Product)又叫叉积，符号为'
\begin_inset Formula $\times$
\end_inset

'。如果有两个向量
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

，两者的夹角为
\begin_inset Formula $\theta$
\end_inset

，则叉乘公式为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align}
a\times b & =\left(\left|a\right|\left|b\right|\sin(\theta)\right)n_{0}\\
 & \text{向量}n_{0}\text{是垂直于\ensuremath{a}和\ensuremath{b}展成平面的单位法向量}\nonumber 
\end{align}

\end_inset

也就是两个向量
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

的叉乘会产生垂直于
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

展成平面的新向量。新向量的方向由右手定则确定。向量的叉乘的定义来源于物理中的“转矩/扭矩”概念，在电磁场的公式中也有应用。
\end_layout

\begin_layout Standard
在三维空间中，叉乘的概念非常有用，可以通过两个向量的叉乘，生成第三个垂直于
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

的法向量，从而构建新的
\begin_inset Formula $(x,y,z)$
\end_inset

坐标系。当
\begin_inset Formula $a$
\end_inset

和
\begin_inset Formula $b$
\end_inset

两个向量为单位向量，模长等于
\begin_inset Formula $1$
\end_inset

，新生成的向量就是单位法向量。
\end_layout

\begin_layout Standard
在二维空间中，叉乘还有另外一个几何意义就是：
\begin_inset Formula $a\times b$
\end_inset

等于由向量
\begin_inset Formula $a$
\end_inset

和向量
\begin_inset Formula $b$
\end_inset

构成的平行四边形的面积。
\end_layout

\begin_layout Section
旋转的分解
\end_layout

\begin_layout Standard
有了本章开头描述的约束，我们回头考虑旋转。首先，我们可以将
\begin_inset Formula $\mathbf{v}$
\end_inset

分解为平行(投影
\begin_inset Formula $\parallel$
\end_inset

)于旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

以及正交(垂直
\begin_inset Formula $\perp$
\end_inset

)于
\begin_inset Formula $\mathbf{u}$
\end_inset

的两个分量，
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

，即：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mathbf{v}=\mathbf{v}_{\parallel}+\mathbf{v}_{\perp}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure3.2.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
向量分解示意图
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
我们可以分别旋转这两个分向量，再将它们旋转的结果相加获得旋转后的向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mathbf{v}'=\mathbf{v}_{\parallel}'+\mathbf{v}_{\perp}'
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
可以看到，
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

其实就是
\begin_inset Formula $\mathbf{v}$
\end_inset

在
\begin_inset Formula $\mathbf{u}$
\end_inset

上的正交投影(Orthogonal Projection)，根据正交投影的公式，我们可以得出：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rlc}
\mathbf{v}_{\parallel} & =proj_{\mathbf{u}}(\mathbf{v})\\
 & =\dfrac{\mathbf{u}\cdot\mathbf{v}}{\mathbf{u}\cdot\mathbf{u}}\mathbf{u}\\
 & =\dfrac{\mathbf{u}\cdot\mathbf{v}}{\left|\mathbf{u}\right|^{2}}\mathbf{u} & \left|\mathbf{u}\right|^{2}=\mathbf{u}\cdot\mathbf{u}\\
 & =(\mathbf{u}\cdot\mathbf{v})\mathbf{u} & \left|\mathbf{u}\right|^{2}=1
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
公式中包含一个向量的点乘，假设
\begin_inset Formula $\mathbf{v}$
\end_inset

与
\begin_inset Formula $\mathbf{u}$
\end_inset

的夹角为
\begin_inset Formula $\phi$
\end_inset

，则
\begin_inset Formula $\mathbf{u}\cdot\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\cos(\phi)$
\end_inset

，所以投影的几何意义一目了然。
\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\mathbf{v}=\mathbf{v}_{\parallel}+\mathbf{v}_{\perp}$
\end_inset

，我们可以得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\mathbf{v}_{\perp} & =\mathbf{v}-\mathbf{v}_{\parallel}\\
 & =\mathbf{v}-(\mathbf{u}\cdot\mathbf{v})\mathbf{u}
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
接下来我们分别讨论对
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的旋转。
\end_layout

\begin_layout Section
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

的旋转
\end_layout

\begin_layout Standard
首先，我们来看一下平行于
\begin_inset Formula $\mathbf{u}$
\end_inset

的
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

。这种情况其实非常简单，从之前的图示中就可以看到，
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

其实根本就没有被旋转，仍然与旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

重合。所以：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 4:
\end_layout

\begin_layout Plain Layout
3D旋转公式(向量型，平行情况)
\end_layout

\begin_layout Plain Layout
当
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

平行于旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

时。旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的
\begin_inset Formula $\mathbf{v}_{\parallel}'$
\end_inset

为：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
\mathbf{v}_{\parallel}'=\mathbf{v}_{\parallel}=(\mathbf{u}\cdot\mathbf{v})\mathbf{u}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\mathbf{u}\cdot\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\cos(\phi)$
\end_inset

，所以旋转过后
\begin_inset Formula $\mathbf{v}$
\end_inset

与
\begin_inset Formula $\mathbf{u}$
\end_inset

的夹角还为
\begin_inset Formula $\phi$
\end_inset

，没有变化。
\end_layout

\begin_layout Section
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的旋转
\end_layout

\begin_layout Standard
接下来，就是正交于
\begin_inset Formula $\mathbf{u}$
\end_inset

的
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的旋转。因为这两个向量是正交的，这个旋转可以看做是平面内的一个旋转。因为旋转不改变
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的长度，所以路径是一个圆。下面是这个旋转的示意图。右侧的为俯视图：
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure3.3.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

向量旋转示意图
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
现在，3D的旋转就被我们转化为了2D平面上的旋转。假设在这个平面上有一个向量
\begin_inset Formula $\mathbf{w}$
\end_inset

，正交于向量
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

，并且模长与向量
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的模长一样，所以
\begin_inset Formula $\mathbf{w}$
\end_inset

也位于圆上。则旋转后的新向量
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

，可以由两个向量，
\begin_inset Formula $\mathbf{v}_{v}'$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{w}'$
\end_inset

，组合而成。向量
\begin_inset Formula $\mathbf{v}_{v}'$
\end_inset

是向量
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

在向量
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

上的投影，向量
\begin_inset Formula $\mathbf{v}_{w}'$
\end_inset

是向量
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

在向量
\begin_inset Formula $\mathbf{w}$
\end_inset

上的投影。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
\mathbf{v}_{v}' & =\cos(\theta)\mathbf{v}_{\perp}\\
\mathbf{v}_{w}' & =\sin(\theta)\mathbf{w}\\
\mathbf{v}_{\perp}' & =\mathbf{v}_{v}'+\mathbf{v}_{w}'
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
向量
\begin_inset Formula $\mathbf{w}$
\end_inset

是同时正交于
\begin_inset Formula $\mathbf{u}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的向量，这个向量可以通过叉乘来获得：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
\mathbf{w} & =\mathbf{u}\times\mathbf{v}_{\perp}\\
 & =\left(\left|\mathbf{u}\right|\left|\mathbf{v}_{\perp}\right|\sin(\pi/2)\right)n_{0}\\
 & =\left|\mathbf{v}_{\perp}\right|n_{0}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
向量
\begin_inset Formula $n_{0}$
\end_inset

是垂直于
\begin_inset Formula $\mathbf{u}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

展成平面的单位法向量。因为
\begin_inset Formula $\mathbf{u}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

正交，所以两个向量的夹角为
\begin_inset Formula $\pi/2$
\end_inset

。因为
\begin_inset Formula $\mathbf{u}$
\end_inset

为单位向量，所以
\begin_inset Formula $\left|\mathbf{u}\right|=1$
\end_inset

。所以
\begin_inset Formula $\mathbf{u}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

叉乘的结果就是得到一个模长
\begin_inset Formula $\left|\mathbf{w}\right|=\left|\mathbf{v}_{\perp}\right|$
\end_inset

，同时正交于
\begin_inset Formula $\mathbf{u}$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

的向量
\begin_inset Formula $\mathbf{w}$
\end_inset

。
\end_layout

\begin_layout Standard
现在，我们就可以计算旋转后的新向量
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
\mathbf{v}_{\perp}' & =\mathbf{v}_{v}'+\mathbf{v}_{w}'\\
 & =\cos(\theta)\mathbf{v}_{\perp}+\sin(\theta)\mathbf{w}\\
 & =\cos(\theta)\mathbf{v}_{\perp}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}_{\perp}\right)
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
这也就完成了旋转的第二步，我们可以得到这样一个定理：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 5:
\end_layout

\begin_layout Plain Layout
3D旋转公式(向量型，正交情况)
\end_layout

\begin_layout Plain Layout
当
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

正交与旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

时，旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

为：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
\mathbf{v}_{\perp}'=\cos(\theta)\mathbf{v}_{\perp}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}_{\perp}\right)
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
\begin_inset Formula $\mathbf{v}$
\end_inset

的旋转
\end_layout

\begin_layout Standard
将上面的两个结果组合就可以获得：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\mathbf{v}' & =\mathbf{v}_{\parallel}'+\mathbf{v}_{\perp}'\\
 & =\mathbf{v}_{\parallel}+\cos(\theta)\mathbf{v}_{\perp}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}_{\perp}\right)
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因为叉乘遵守分配律：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
\mathbf{u}\times\mathbf{v}_{\perp} & =\mathbf{u}\times\left(\mathbf{v}-\mathbf{v}_{\parallel}\right)\\
 & =\mathbf{u}\times\mathbf{v}-\mathbf{u}\times\mathbf{v}_{\parallel}\;(\mathbf{u}\text{平行于}\mathbf{v}_{\parallel},\text{所以}\mathbf{u}\times\mathbf{v}_{\parallel}=0)\\
 & =\mathbf{u}\times\mathbf{v}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
可以回头看图3.3的左图理解叉乘
\begin_inset Formula $\mathbf{u}\times\mathbf{v}$
\end_inset

的几何意义。
\end_layout

\begin_layout Standard
最后,将
\begin_inset Formula $\mathbf{v}_{\parallel}=(\mathbf{u}\cdot\mathbf{v})\mathbf{u}$
\end_inset

 与
\begin_inset Formula $\mathbf{v}_{\perp}=\mathbf{v}-(\mathbf{u}\cdot\mathbf{v})\mathbf{u}$
\end_inset

代入：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
\mathbf{v}' & =(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\cos(\theta)\left(\mathbf{v}-(\mathbf{u}\cdot\mathbf{v})\mathbf{u}\right)+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\\
 & =\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
这样我们就得到了一般形式的旋转公式：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 6:
\end_layout

\begin_layout Plain Layout
3D旋转公式(向量型，一般情况，也叫做「Rodrigues' Rotation Formula」)
\end_layout

\begin_layout Plain Layout
在3D空间中任意一个向量
\begin_inset Formula $\mathbf{v}$
\end_inset

沿着单位向量
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的新向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

为:
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
\mathbf{v}'=\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
这个公式表明，向量
\begin_inset Formula $\mathbf{v}$
\end_inset

围绕单位向量
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转生成的新向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

，除了与旋转角度
\begin_inset Formula $\theta$
\end_inset

有关，还与两个向量的点乘和叉乘有关。实际上就是和两个向量的夹角
\begin_inset Formula $\phi$
\end_inset

有关(点乘的几何意义)，同时需要建立一个新的坐标系(叉乘的几何意义)去确定新向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

的方向。此外，旋转后的新向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

与向量
\begin_inset Formula $\mathbf{v}$
\end_inset

有两个值保持不变：
\end_layout

\begin_layout Enumerate
与向量
\begin_inset Formula $\mathbf{u}$
\end_inset

的夹角
\begin_inset Formula $\phi$
\end_inset

保持不变。
\end_layout

\begin_layout Enumerate
模长
\begin_inset Formula $\left|\mathbf{v}'\right|=\left|\mathbf{v}\right|$
\end_inset

保持不变。
\end_layout

\begin_layout Standard
虽然最后结果看起来很复杂，但我们很快就能看到四元数与上面这些公式之间的联系。
\end_layout

\begin_layout Chapter
四元数
\end_layout

\begin_layout Standard
利用复数系统和复平面的知识，我们可以把它推广到三维空间，除了
\begin_inset Formula $i$
\end_inset

之外，我们还可以在数字系统中加入两个虚数。
\end_layout

\begin_layout Standard
四元数的一般形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{cc}
q=s+xi+yj+zk & s,x,y,z\in\mathbb{R}\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
上面的公式是根据Hamilton的著名的表达式得到的：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
i^{2}=j^{2}=k^{2}=ijk=-1
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
以及：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{ccc}
ij=k & jk=i & ki=j\\
ji=-k & kj=-i & ik=-j
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
你可能已经注意到了，
\begin_inset Formula $i$
\end_inset

、
\begin_inset Formula $j$
\end_inset

、
\begin_inset Formula $k$
\end_inset

之间的关系非常像笛卡尔坐标系下单位向量的叉积规则：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{ccc}
\mathbf{x}\times\mathbf{y}=\mathbf{z} & \mathbf{y}\times\mathbf{z}=\mathbf{x} & \mathbf{z}\times\mathbf{x}=\mathbf{y}\\
\mathbf{y}\times\mathbf{x}=-\mathbf{z} & \mathbf{z}\times\mathbf{y}=-\mathbf{x} & \mathbf{x}\times\mathbf{z}=-\mathbf{y}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
Hamilton自己也发现
\begin_inset Formula $i$
\end_inset

、
\begin_inset Formula $j$
\end_inset

、
\begin_inset Formula $k$
\end_inset

虚数可以被用来表达3个笛卡尔坐标系单位向量
\begin_inset Formula $\mathbf{i}$
\end_inset

、
\begin_inset Formula $\mathbf{j}$
\end_inset

、
\begin_inset Formula $\mathbf{k}$
\end_inset

，并且仍然保持有虚数的性质，也即
\begin_inset Formula $\mathbf{i}^{2}=\mathbf{j}^{2}=\mathbf{k}^{2}=-1$
\end_inset

。
\end_layout

\begin_layout Standard
与复数类似，因为四元数其实就是对于基
\begin_inset Formula ${1,i,j,k}$
\end_inset

的线性组合，四元数也可以写成向量的形式
\begin_inset Formula $q=\left[\begin{array}{cccc}
s & x & y & z\end{array}\right]$
\end_inset

。除此之外，我们经常将四元数的实部与虚部分开，并用一个三维的向量
\begin_inset Formula $\mathbf{v}$
\end_inset

来表示虚部, 将它表示为标量和向量的有序对形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{cc}
q=[s,\mathbf{v}] & s\in R,\mathbf{v}\in\mathbb{R}^{3}\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
其中的向量
\begin_inset Formula $\mathbf{v}$
\end_inset

，也可以用它各自独立的
\begin_inset Formula $3$
\end_inset

个分量表示：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{cc}
q=[s,x\mathbf{i}+y\mathbf{j}+z\mathbf{k}] & s,x,y,z\in\mathbb{R}\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
使用这种表示法，我们可以更容易地展示四元数和复数之间的相似性。
\end_layout

\begin_layout Section
性质
\end_layout

\begin_layout Subsection
共轭四元数
\end_layout

\begin_layout Standard
共轭四元数的计算，就是将四元数的虚向量取反：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
q & =[s,\mathbf{v}]\\
q^{*} & =[s,-\mathbf{v}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
四元数和它的共轭四元数的乘积：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
qq^{*} & =[s,\mathbf{v}][s,-\mathbf{v}]\\
 & =[s^{2}-\mathbf{v}\cdot(-\mathbf{v}),-s\mathbf{v}+s\mathbf{v}+\mathbf{v}\times(-\mathbf{v})]\\
 & =[s^{2}+\mathbf{v}\cdot\mathbf{v},\mathbf{0}]\\
 & =[s^{2}+v^{2},\mathbf{0}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Subsection
四元数的模长(范数)
\end_layout

\begin_layout Standard
回忆下复数范数的定义：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
|z| & =\sqrt{a^{2}+b^{2}}\\
zz^{*} & =|z|^{2}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
类似的，四元数的范数可以这样定义：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
q & =[s,\mathbf{v}]\\
|q| & =\sqrt{s^{2}+v^{2}}\\
 & =\sqrt{s^{2}+x^{2}+y^{2}+z^{2}}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
这也让我们可以这样表达四元数范数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
qq^{*}=|q|^{2}
\]

\end_inset


\end_layout

\begin_layout Standard
显然，四元数的模长很难用三维几何的方法来进行理解，因为它代表的是一个四维的长度。但是，和高维向量的模长一样，这只是类比复数模长进行衍生定义的结果。你只需要将它理
解为一个定义就可以了。
\end_layout

\begin_layout Subsection
四元数加减法
\end_layout

\begin_layout Standard
和复数类似，四元数也可以被加减：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
q_{a} & =[s_{a},\mathbf{a}]\\
q_{b} & =[s_{b},\mathbf{b}]\\
q_{a}+q_{b} & =[s_{a}+s_{b},\mathbf{a}+\mathbf{b}]\\
q_{a}-q_{b} & =[s_{a}-s_{b},\mathbf{a}-\mathbf{b}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Subsection
四元数乘法
\end_layout

\begin_layout Standard
四元数之间的乘法比较特殊，它们不遵守交换律。也就是说一般情况下
\begin_inset Formula $q_{1}q_{2}\neq q_{2}q_{1}$
\end_inset

。这也就有了左乘和右乘的区别。如果是
\begin_inset Formula $q_{1}q_{2}$
\end_inset

，那么我们就说「
\begin_inset Formula $q_{2}$
\end_inset

左乘以
\begin_inset Formula $q_{1}$
\end_inset

」。如果是
\begin_inset Formula $q_{2}q_{1}$
\end_inset

，那我们就说「
\begin_inset Formula $q_{2}$
\end_inset

右乘以
\begin_inset Formula $q_{1}$
\end_inset

」。除了交换律之外,我们经常使用的结合律和分配律在四元数内都是成立的。
\end_layout

\begin_layout Standard
那么，如果有两个四元数
\begin_inset Formula $q_{a}$
\end_inset

和
\begin_inset Formula $q_{b}$
\end_inset

，它们的乘积为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
q_{a} & = & [s_{a},\mathbf{a}]\\
q_{b} & = & [s_{b},\mathbf{b}]\\
q_{a}q_{b} & = & [s_{a},\mathbf{a}][s_{b},\mathbf{b}]\\
 & = & (s_{a}+x_{a}i+y_{a}j+z_{a}k)(s_{b}+x_{b}i+y_{b}j+z_{b}k)\\
 & = & (s_{a}s_{b}-x_{a}x_{b}-y_{a}y_{b}-z_{a}z_{b})+\\
 &  & (x_{a}s_{b}+s_{a}x_{b}-z_{a}y_{b}+y_{a}z_{b})i+\\
 &  & (y_{a}s_{b}+z_{a}x_{b}+s_{a}y_{b}-x_{a}z_{b})j+\\
 &  & (z_{a}s_{b}-y_{a}x_{b}+x_{a}y_{b}+s_{a}z_{b})k
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
可以看到，四元数的乘积依然还是一个四元数。如果我们把虚数
\begin_inset Formula $i$
\end_inset

、
\begin_inset Formula $j$
\end_inset

 、
\begin_inset Formula $k$
\end_inset

替换成有序对：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{ccc}
i=[0,\mathbf{i}] & j=[0,\mathbf{j}] & k=[0,\mathbf{k}]\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
以及还有
\begin_inset Formula $[1,\mathbf{0}]=1$
\end_inset

，将它们代入前面的表达式，就得到了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
[s_{a},\mathbf{a}][s_{b},\mathbf{b}] & = & (s_{a}s_{b}-x_{a}x_{b}-y_{a}y_{b}-z_{a}z_{b})[1,\mathbf{0}]+\\
 &  & (x_{a}s_{b}+s_{a}x_{b}-z_{a}y_{b}+y_{a}z_{b})[0,\mathbf{i}]+\\
 &  & (y_{a}s_{b}+z_{a}x_{b}+s_{a}y_{b}-x_{a}z_{b})[0,\mathbf{j}]+\\
 &  & (z_{a}s_{b}-y_{a}x_{b}+x_{a}y_{b}+s_{a}z_{b})[0,\mathbf{k}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
再把这个表达式扩展成多个有序对的和：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
[s_{a},\mathbf{a}][s_{b},\mathbf{b}] & = & [s_{a}s_{b}-x_{a}x_{b}-y_{a}y_{b}-z_{a}z_{b},\mathbf{0}]+\\
 &  & [\mathbf{0},(x_{a}s_{b}+s_{a}x_{b}-z_{a}y_{b}+y_{a}z_{b})\mathbf{i}]+\\
 &  & [\mathbf{0},(y_{a}s_{b}+z_{a}x_{b}+s_{a}y_{b}-x_{a}z_{b})\mathbf{j}]+\\
 &  & [\mathbf{0},(z_{a}s_{b}-y_{a}x_{b}+x_{a}y_{b}+s_{a}z_{b})\mathbf{k}]+
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
如果我们与四元数单位相乘并提取公共向量分量，我们可以这样重写此方程：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
[s_{a},\mathbf{a}][s_{b},\mathbf{b}] & = & [s_{a}s_{b}-x_{a}x_{b}-y_{a}y_{b}-z_{a}z_{b},\mathbf{0}]+\\
 &  & [0,s_{a}(x_{b}\mathbf{i}+y_{b}\mathbf{j}+z_{b}\mathbf{k})+s_{b}(x_{a}\mathbf{i}+y_{a}\mathbf{j}+z_{a}\mathbf{k})\\
 &  & +(y_{a}z_{b}-z_{a}y_{b})\mathbf{i}+(z_{a}x_{b}-x_{a}z_{b})\mathbf{j}+(x_{a}y_{b}-y_{a}x_{b})\mathbf{k}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
这个等式是两个有序对的和。第一个有序对是一个实(
\begin_inset Formula $\mathbf{Real}$
\end_inset

)四元数，第2个是一个纯(
\begin_inset Formula $\mathbf{Pure}$
\end_inset

)四元数。这两个四元数也可以合并成一个：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
[s_{a},\mathbf{a}][s_{b},\mathbf{b}] & = & [s_{a}s_{b}-x_{a}x_{b}-y_{a}y_{b}-z_{a}z_{b},\\
 &  & s_{a}(x_{b}\mathbf{i}+y_{b}\mathbf{j}+z_{b}\mathbf{k})+s_{b}(x_{a}\mathbf{i}+y_{a}\mathbf{j}+z_{a}\mathbf{k})+\\
 &  & (y_{a}z_{b}-z_{a}y_{b})\mathbf{i}+(z_{a}x_{b}-x_{a}z_{b})\mathbf{j}+(x_{a}y_{b}-y_{a}x_{b})\mathbf{k}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
如果把下面的表达式代入上面的等式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
\mathbf{a} & = & x_{a}\mathbf{i}+y_{a}\mathbf{j}+z_{a}\mathbf{k}\\
\mathbf{b} & = & x_{b}\mathbf{i}+y_{b}\mathbf{j}+z_{b}\mathbf{k}\\
\mathbf{a}\cdot\mathbf{b} & = & x_{a}x_{b}+y_{a}y_{b}+z_{a}z_{b}\\
\mathbf{a}\times\mathbf{b} & = & \left|\begin{array}{ccc}
\mathbf{i} & \mathbf{j} & \mathbf{k}\\
x_{a} & y_{a} & z_{a}\\
x_{b} & y_{b} & z_{b}
\end{array}\right|\\
 & = & (y_{a}z_{b}-z_{a}y_{b})\mathbf{i}+(z_{a}x_{b}-x_{a}z_{b})\mathbf{j}+(x_{a}y_{b}-y_{a}x_{b})\mathbf{k}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
注意，第三条'
\begin_inset Formula $\cdot$
\end_inset

'和第四条'
\begin_inset Formula $\times$
\end_inset

'并不是四元数的点乘和叉乘，而是向量的点乘和叉乘。其实按照历史的顺序来说叉乘是在这里被定义的。
\end_layout

\begin_layout Standard
我们就得到了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q_{a}q_{b} & =[s_{a},\mathbf{a}][s_{b},\mathbf{b}]\\
 & =[s_{a}s_{b}-\mathbf{a}\cdot\mathbf{b},s_{a}\mathbf{b}+s_{b}\mathbf{a}+\mathbf{a}\times\mathbf{b}]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这就是四元数乘积的一般式。这个结果也被叫做Grassmann积(Grassmann Product)，一般来说：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 7:
\end_layout

\begin_layout Plain Layout
Grassmann积
\end_layout

\begin_layout Plain Layout
对于任意四元数
\begin_inset Formula $q_{a}=[s_{a},\mathbf{a}],q_{b}=[s_{b},\mathbf{b}]$
\end_inset

，
\begin_inset Formula $q_{a}q_{b}$
\end_inset

的结果是
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
q_{a}q_{b}=[s_{a}s_{b}-\mathbf{a}\cdot\mathbf{b},s_{a}\mathbf{b}+s_{b}\mathbf{a}+\mathbf{a}\times\mathbf{b}]
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
如果你还记得之前推导3D旋转公式时的结果，你应该就能注意到上面这个公式会成为将四元数与旋转联系起来的关键。
\end_layout

\begin_layout Subsection
矩阵形式
\end_layout

\begin_layout Standard
可以看到，四元数的相乘其实也是一个线性组合。我们同样可以将它写成矩阵的形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q_{a}q_{b}=\left[\begin{array}{cccc}
s_{a} & -x_{a} & -y_{a} & -z_{a}\\
x_{a} & s_{a} & -z_{a} & y_{a}\\
y_{a} & z_{a} & s_{a} & -x_{a}\\
z_{a} & -y_{a} & x_{a} & s_{a}
\end{array}\right]\left[\begin{array}{c}
s_{b}\\
x_{b}\\
y_{b}\\
z_{b}
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
注意，这个矩阵所做出的变换等价于左乘
\begin_inset Formula $q_{a}$
\end_inset

。因为四元数不符合交换律，所以右乘
\begin_inset Formula $q_{a}$
\end_inset

的变换是一个不同的矩阵。它可以使用完全相同的方法推导而得。下面这个矩阵所做出的变换等价于右乘
\begin_inset Formula $q_{a}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q_{b}q_{a}=\left[\begin{array}{cccc}
s_{a} & -x_{a} & -y_{a} & -z_{a}\\
x_{a} & s_{a} & z_{a} & -y_{a}\\
y_{a} & -z_{a} & s_{a} & x_{a}\\
z_{a} & y_{a} & -x_{a} & s_{a}
\end{array}\right]\left[\begin{array}{c}
s_{b}\\
x_{b}\\
y_{b}\\
z_{b}
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
两个变换矩阵的差异在于右下角
\begin_inset Formula $3\times3$
\end_inset

子矩阵是转置关系。
\end_layout

\begin_layout Subsection
纯四元数与三维向量
\end_layout

\begin_layout Standard
Hamilton还将纯(
\begin_inset Formula $\mathbf{Pure}$
\end_inset

)四元数定义为具有零标量项的四元数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q=[0,\mathbf{v}]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
也可以写成下面的形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q=xi+yj+zk
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因为纯四元数仅由虚部的3D向量决定，所以我们可以将任意的3D向量转换为纯四元数。按照惯例，如果一个3D向量为
\begin_inset Formula $\mathbf{v}$
\end_inset

，则字母加粗。如果不加粗、没有上标的
\begin_inset Formula $v$
\end_inset

则为它对应的纯四元数
\begin_inset Formula $v=[0,\mathbf{v}]$
\end_inset

。
\end_layout

\begin_layout Standard
两个纯(
\begin_inset Formula $\mathbf{Pure}$
\end_inset

)四元数的乘积：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rcl}
q_{a} & = & [0,\mathbf{a}]\\
q_{b} & = & [0,\mathbf{b}]\\
q_{a}q_{b} & = & [0,\mathbf{a}][0,\mathbf{b}]\\
 & = & [-\mathbf{a}\cdot\mathbf{b},\mathbf{a}\times\mathbf{b}]\\
q_{b}q_{a} & = & [0,\mathbf{b}][0,\mathbf{a}]\\
 & = & [-\mathbf{a}\cdot\mathbf{b},-\mathbf{a}\times\mathbf{b}]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
所以有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q_{a}q_{b}-q_{b}q_{a} & =[-\mathbf{a}\cdot\mathbf{b},\mathbf{a}\times\mathbf{b}]-[-\mathbf{a}\cdot\mathbf{b},-\mathbf{a}\times\mathbf{b}]\\
 & =2[0,\mathbf{a}\times\mathbf{b}]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这个公式在推导四元数微分方程时会用到。
\end_layout

\begin_layout Subsection
四元数的逆与共轭
\end_layout

\begin_layout Standard
四元数的逆用
\begin_inset Formula $q^{-1}$
\end_inset

表示。因为四元数是不遵守交换律的，我们通常不会将两个四元数相除写为
\begin_inset Formula $\dfrac{p}{q}$
\end_inset

的形式。取而代之的是将乘法的逆运算定义为
\begin_inset Formula $pq^{-1}$
\end_inset

或者
\begin_inset Formula $q^{-1}p$
\end_inset

。注意它们的结果一般是不同的。
\end_layout

\begin_layout Standard
如果
\begin_inset Formula $q^{-1}$
\end_inset

是
\begin_inset Formula $q$
\end_inset

的逆(Inverse)，我们规定：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
qq^{-1}=q^{-1}q=1\;(q\neq0)
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
要计算四元数的逆，需要用四元数的共轭四元数去除以四元数的范数的平方：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q^{-1}=\dfrac{q^{*}}{|q|^{2}}
\]

\end_inset


\end_layout

\begin_layout Standard
为了证明这个式子，我们先根据逆的定义，有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
qq^{-1}=[1,\mathbf{0}]=1
\]

\end_inset


\end_layout

\begin_layout Standard
两边都左乘共轭四元数
\begin_inset Formula $q^{*}$
\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q^{*}qq^{-1}=q^{*}
\]

\end_inset


\end_layout

\begin_layout Standard
通过替换我们得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
|q|^{2}q^{-1} & =q^{*}\\
q^{-1} & =\dfrac{q^{*}}{|q|^{2}}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
对于单位四元数，它的范数是
\begin_inset Formula $1$
\end_inset

，所以可以写成：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q^{-1}=q^{*}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
四元数规范化
\end_layout

\begin_layout Standard
利用四元数范数的定义，就可以对四元数进行规范化。要让一个四元数规范化，只需要让这个四元数去除以它的
\begin_inset Formula $|q|$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q^{\text{′}}=\dfrac{q}{\sqrt{s^{2}+v^{2}}}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
在工程中，因为算法的问题和计算精度的问题，经过一次计算之后，会使得新生成的四元数
\begin_inset Formula $q$
\end_inset

的模长偏离
\begin_inset Formula $1$
\end_inset

。所以在一次工程迭代计算后，通常需要对新生成的四元数
\begin_inset Formula $q$
\end_inset

进行规范化处理，使得该数据在下次迭代计算时符合单位四元数的假设。
\end_layout

\begin_layout Section
四元数与3D旋转
\end_layout

\begin_layout Standard
有了以上知识，我们就能开始讨论四元数与3D旋转之间的关联了。
\end_layout

\begin_layout Standard
回忆一下我们之前讨论过的内容：如果我们需要将一个向量
\begin_inset Formula $\mathbf{v}$
\end_inset

绕着一个用单位向量所定义的旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

度，那么我们可以将这个向量
\begin_inset Formula $\mathbf{v}$
\end_inset

分解为正交于旋转轴的
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

以及平行于旋转轴的
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

。我们可以分别对这两个分向量进行旋转，获得
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\parallel}'$
\end_inset

。将它们相加就是
\begin_inset Formula $\mathbf{v}$
\end_inset

旋转之后的结果
\begin_inset Formula $\mathbf{v}'=\mathbf{v}_{\parallel}'+\mathbf{v}_{\perp}'$
\end_inset

。
\end_layout

\begin_layout Standard
我们可以将这些向量定义为纯四元数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rclcrcl}
v & = & \left[0,\mathbf{v}\right] &  & v' & = & \left[0,\mathbf{v}'\right]\\
v_{\perp} & = & \left[0,\mathbf{v}_{\perp}\right] &  & v_{\perp}' & = & \left[0,\mathbf{v}_{\perp}'\right]\\
v_{\parallel} & = & \left[0,\mathbf{v}_{\parallel}\right] &  & v_{\parallel}' & = & \left[0,\mathbf{v}_{\parallel}'\right]\\
u & = & \left[0,\mathbf{u}\right]
\end{array}\label{eq:4.12}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
那么我们就能得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{ccc}
v=v_{\parallel}+v_{\perp} &  & v'=v_{\parallel}'+v_{\perp}'\end{array}\label{eq:4.13}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
和之前一样，我们在这里也分开讨论
\begin_inset Formula $v_{\perp}$
\end_inset

和
\begin_inset Formula $v_{\parallel}$
\end_inset

的旋转情况。
\end_layout

\begin_layout Subsection
\begin_inset Formula $v_{\perp}$
\end_inset

的旋转
\end_layout

\begin_layout Standard
我们首先讨论正交于旋转轴的
\begin_inset Formula $v_{\perp}$
\end_inset

。我们之前推导过，如果一个向量
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

正交于旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

，那么：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\mathbf{v}_{\perp}'=\cos(\theta)\mathbf{v}_{\perp}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}_{\perp}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
我们可以很容易地将前面的
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

替换为
\begin_inset Formula $v_{\perp}'$
\end_inset

和
\begin_inset Formula $v_{\perp}$
\end_inset

,但是我们仍遗留下来了一 个
\begin_inset Formula $\mathbf{u}\times\mathbf{v}_{\perp}$
\end_inset

。幸运的是，利用四元数的性质，我们可以将它写成四元数积的形式。我们之前推导过，如果有两个纯四元数
\begin_inset Formula $u=[0,\mathbf{u}]$
\end_inset

，
\begin_inset Formula $v=[0,\mathbf{v}]$
\end_inset

，那么
\begin_inset Formula $uv=[-\mathbf{u}\cdot\mathbf{v},\mathbf{u}\times\mathbf{v}]$
\end_inset

。类似地：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
uv_{\perp}=[-\mathbf{u}\cdot\mathbf{v}_{\perp},\mathbf{u}\times\mathbf{v}_{\perp}]
\]

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

正交于
\begin_inset Formula $\mathbf{u}$
\end_inset

，所以
\begin_inset Formula $\mathbf{u}\cdot\mathbf{v}_{\perp}=0$
\end_inset

，也就是说：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
uv_{\perp} & =[0,\mathbf{u}\times\mathbf{v}_{\perp}]\\
 & =\mathbf{u}\times\mathbf{v}_{\perp}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
也就是
\begin_inset Formula $uv_{\perp}$
\end_inset

同样是一个纯四元数。将这个等式以及之前定义的纯四元数代入，我们就能获得：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v_{\perp}'=\cos(\theta)v_{\perp}+\sin(\theta)\left(uv_{\perp}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
因为四元数的乘法遵守分配律，我们可以继续变换这个等式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
v_{\perp}' & =\cos(\theta)v_{\perp}+\sin(\theta)\left(uv_{\perp}\right)\\
 & =\left(\cos(\theta)+\sin(\theta)u\right)v_{\perp}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
这时我们可以注意到，如果我们将
\begin_inset Formula $\left(\cos(\theta)+\sin(\theta)u\right)$
\end_inset

看做是一个四元数，我们就能将旋转写成四元数的乘积了。到此为止，我们已经将旋转与四元数的积联系起来了。如果令
\begin_inset Formula $q=\cos(\theta)+\sin(\theta)u$
\end_inset

，我们能得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v_{\perp}'=qv_{\perp}
\]

\end_inset


\end_layout

\begin_layout Standard
如果我们能构造一个
\begin_inset Formula $q$
\end_inset

，那么我们就能完成这个旋转了。我们可以对
\begin_inset Formula $q$
\end_inset

继续进行变形：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
q & =\cos(\theta)+\sin(\theta)u\\
 & =\left[\cos(\theta),\mathbf{0}\right]+\left[0,\sin(\theta)\mathbf{u}\right]\\
 & =\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
也就是说，如果旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

的坐标为
\begin_inset Formula $\left[\begin{array}{ccc}
u_{x} & u_{y} & u_{z}\end{array}\right]$
\end_inset

，旋转角为
\begin_inset Formula $\theta$
\end_inset

，那么完成这一旋转所需要的四元数
\begin_inset Formula $q$
\end_inset

可以构造为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=\cos(\theta)+\sin(\theta)u_{x}i+\sin(\theta)u_{y}j+\sin(\theta)u_{z}k
\]

\end_inset


\end_layout

\begin_layout Standard
这样我们就完成了对
\begin_inset Formula $v_{\perp}$
\end_inset

的旋转，我们可以得到下面这个定理：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 8:
\end_layout

\begin_layout Plain Layout
3D旋转公式(四元数型，正交情况)
\end_layout

\begin_layout Plain Layout
当
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

正交于旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

时，旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

可以使用四元数乘法来获得。
\begin_inset Formula $v_{\perp}=\left[0,\mathbf{v}_{\perp}\right]$
\end_inset

，
\begin_inset Formula $q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

，那么：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
v_{\perp}'=qv_{\perp}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
这个四元数
\begin_inset Formula $q$
\end_inset

其实还有一个性质，我们可以注意到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rlc}
\left|q\right| & =\sqrt{\cos^{2}(\theta)+\left(\sin(\theta)\mathbf{u}\cdot\sin(\theta)\mathbf{u}\right)}\\
 & =\sqrt{\cos^{2}(\theta)+\sin^{2}(\theta)\left(\mathbf{u}\cdot\mathbf{u}\right)}\\
 & =\sqrt{\cos^{2}(\theta)+\sin^{2}(\theta)\left(\left|\mathbf{u}\right|^{2}\right)} & (\mathbf{u}\cdot\mathbf{u}=\left|\mathbf{u}\right|^{2})\\
 & =\sqrt{\cos^{2}(\theta)+\sin^{2}(\theta)} & (\left|\mathbf{u}\right|^{2}=1)\\
 & =1 & (\text{三角恒等式})
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
所以，我们构造出来的这个
\begin_inset Formula $q$
\end_inset

其实是一个单位四元数。我们之前讨论过，复数的乘法的几何意义可以理解为缩放与旋转的复合。这个性质可以类比到四元数，而因为
\begin_inset Formula $\left|q\right|=1$
\end_inset

，所以它所代表的变换并不会对原向量进行缩放，而是一个纯旋转。
\end_layout

\begin_layout Subsection
\begin_inset Formula $v_{\parallel}$
\end_inset

的旋转
\end_layout

\begin_layout Standard
接下来是平行于旋转轴的
\begin_inset Formula $v_{\parallel}$
\end_inset

。我们之前讨论过，如果一个向量
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

平行于
\begin_inset Formula $\mathbf{u}$
\end_inset

，那么旋转不会对它作出任何的变换，也就是说：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 9:
\end_layout

\begin_layout Plain Layout
3D旋转公式(四元数型，平行情况)，当
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

平行于旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

时，旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的
\begin_inset Formula $\mathbf{v}_{\parallel}'$
\end_inset

用四元数可以写为
\begin_inset Foot
status open

\begin_layout Plain Layout
魔鬼藏在细节里，见后面第
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:对四元数旋转理解的困难"
plural "false"
caps "false"
noprefix "false"

\end_inset

节后面的讨论。
\end_layout

\end_inset

：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
v_{\parallel}'=v_{\parallel}\label{eq:4.15}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Formula $v$
\end_inset

的旋转
\end_layout

\begin_layout Standard
有了上面这些知识，我们能够获得一般情况下
\begin_inset Formula $v'$
\end_inset

的结果了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rlc}
v' & =v_{\parallel}'+v_{\perp}'\\
 & =v_{\parallel}+qv_{\perp} & (q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right])
\end{array}\label{eq:4.16}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
我们当然可以像以前那样将
\begin_inset Formula $v_{\parallel}$
\end_inset

和
\begin_inset Formula $v_{\perp}$
\end_inset

拆开，继续进行化简。但是这里我们不会这么做，因为我们有更好的办法来进一步化简它。
\end_layout

\begin_layout Standard
在进一步化简之前，我们需要证明三个引理。
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Lemma 1:
\end_layout

\begin_layout Plain Layout
如
\begin_inset Formula $q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

，而且
\begin_inset Formula $\mathbf{u}$
\end_inset

为单位向量，那么
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\[
q^{2}=qq=\left[\cos(2\theta),\sin(2\theta)\mathbf{u}\right]
\]

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Paragraph
Proof.
\end_layout

\begin_layout Standard
这个引理的证明很简单，只需要使用四元数乘积和一些三角恒等式就可以了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
q^{2} & =\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]*\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]\\
 & =\left[\cos^{2}(\theta)-\left(\sin(\theta)\mathbf{u}\cdot\sin(\theta)\mathbf{u}\right),\left(\cos(\theta)\sin(\theta)+\sin(\theta)\cos(\theta)\right)\mathbf{u}+\left(\sin(\theta)\mathbf{u}\times\sin(\theta)\mathbf{u}\right)\right]\\
 & =\left[\cos^{2}(\theta)-\sin^{2}(\theta)\left|\mathbf{u}\right|^{2},2\sin(\theta)\cos(\theta)\mathbf{u}+\mathbf{0}\right]\\
 & =\left[\cos^{2}(\theta)-\sin^{2}(\theta),2\sin(\theta)\cos(\theta)\mathbf{u}\right]\\
 & =\left[\cos(2\theta),\sin(2\theta)\mathbf{u}\right]
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
其实这个引理的几何意义就是：如果绕着同一个轴
\begin_inset Formula $\mathbf{u}$
\end_inset

连续旋转
\begin_inset Formula $\theta$
\end_inset

度两次，那么所做出的变换等同于直接一次绕着
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $2\theta$
\end_inset

度。
\end_layout

\begin_layout Standard
有了这个引理，我们再来回忆一下四元数逆的定义：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
qq^{-1}=1
\]

\end_inset


\end_layout

\begin_layout Standard
现在，我们就能够对原本的旋转公式进行变形了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rlc}
v' & =v_{\parallel}+qv_{\perp} & (q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right])\\
 & =1\cdot v_{\parallel}+qv_{\perp}\\
 & =pp^{-1}v_{\parallel}+ppv_{\perp} & \left(令q=p^{2},则p=\left[\cos(\dfrac{1}{2}\theta),\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]\right)
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
在这里，我们引入了一个新的四元数
\begin_inset Formula $p=\left[\cos(\dfrac{1}{2}\theta),\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]$
\end_inset

。根据刚刚证明的公式，我们可以验证：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
pp & =p^{2}\\
 & =\left[\cos(2\cdot\dfrac{1}{2}\theta),\sin(2\cdot\dfrac{1}{2}\theta)\mathbf{u}\right]\\
 & =\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]\\
 & =q
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
注意到，和
\begin_inset Formula $q$
\end_inset

一样，
\begin_inset Formula $\left|p\right|=1$
\end_inset

，
\begin_inset Formula $p$
\end_inset

也是一个单位四元数，也就是说：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
p^{-1}=p^{*}
\]

\end_inset


\end_layout

\begin_layout Standard
将这个结果代入之前的等式中：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
v' & =pp^{-1}v_{\parallel}+ppv_{\perp}\\
 & =pp^{*}v_{\parallel}+ppv_{\perp}
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
我们还能进一步化简这个公式,但在继续之前还需要再证明两个引理。
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Lemma 2:
\end_layout

\begin_layout Plain Layout
假设
\begin_inset Formula $v_{\parallel}=\left[0,\mathbf{v}_{\parallel}\right]$
\end_inset

是一个纯四元数，而
\begin_inset Formula $q=[\alpha,\beta\mathbf{u}]$
\end_inset

，其中
\begin_inset Formula $\mathbf{u}$
\end_inset

是一个单位向量，
\begin_inset Formula $\alpha,\beta\in\mathbb{R}$
\end_inset

。在这种条件下，如果
\begin_inset Formula $\mathbf{v}_{\parallel}$
\end_inset

平行于
\begin_inset Formula $\mathbf{u}$
\end_inset

，那么
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\[
qv_{\parallel}=v_{\parallel}q
\]

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Paragraph
Proof.
\end_layout

\begin_layout Standard
这个引理的证明同样需要使用四元数乘积。我们先计算等式左边：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rlc}
LHS & =qv_{\parallel}\\
 & =[\alpha,\beta\mathbf{u}]\cdot\left[0,\mathbf{v}_{\parallel}\right]\\
 & =\left[0-\beta\mathbf{u}\cdot\mathbf{v}_{\parallel},\alpha\mathbf{v}_{\parallel}+\mathbf{0}+\beta\mathbf{u}\times\mathbf{v}_{\parallel}\right]\\
 & =\left[-\beta\mathbf{u}\cdot\mathbf{v}_{\parallel},\alpha\mathbf{v}_{\parallel}\right] & (\mathbf{v}_{\parallel}\text{平行于}\mathbf{u}\text{，}\text{所以}\beta\mathbf{u}\times\mathbf{v}_{\parallel}=0)
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
接下来计算等式的右边：
\begin_inset Formula 
\[
\begin{array}{rlc}
RHS & =v_{\parallel}q\\
 & =\left[0,\mathbf{v}_{\parallel}\right]\cdot[\alpha,\beta\mathbf{u}]\\
 & =\left[0-\mathbf{v}_{\parallel}\cdot\beta\mathbf{u},\mathbf{0}+\alpha\mathbf{v}_{\parallel}+\mathbf{v}_{\parallel}\times\beta\mathbf{u}\right]\\
 & =\left[-\mathbf{v}_{\parallel}\cdot\beta\mathbf{u},\alpha\mathbf{v}_{\parallel}\right] & (\mathbf{v}_{\parallel}\text{平行于}\mathbf{u}\text{，}\text{所以}\mathbf{v}_{\parallel}\times\beta\mathbf{u}=0)\\
 & =\left[-\beta\mathbf{u}\cdot\mathbf{v}_{\parallel},\alpha\mathbf{v}_{\parallel}\right] & (\text{点乘遵守交换律})\\
 & =LHS
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
下面是第三个引理
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Lemma 3:
\end_layout

\begin_layout Plain Layout
假设
\begin_inset Formula $v_{\perp}=\left[0,\mathbf{v}_{\perp}\right]$
\end_inset

是一个纯四元数，而
\begin_inset Formula $q=[\alpha,\beta\mathbf{u}]$
\end_inset

，其中
\begin_inset Formula $\mathbf{u}$
\end_inset

是一个单位向量，
\begin_inset Formula $\alpha,\beta\in\mathbb{R}$
\end_inset

。在这种条件下，如果
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

正交于
\begin_inset Formula $\mathbf{u}$
\end_inset

，那么
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\[
qv_{\perp}=v_{\perp}q^{*}
\]

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Paragraph
Proof.
\end_layout

\begin_layout Standard
这个引理的证明与之前的引理完全类似：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rlc}
LHS & =qv_{\perp}\\
 & =[\alpha,\beta\mathbf{u}]\cdot\left[0,\mathbf{v}_{\perp}\right]\\
 & =\left[0-\beta\mathbf{u}\cdot\mathbf{v}_{\perp},\alpha\mathbf{v}_{\perp}+\mathbf{0}+\beta\mathbf{u}\times\mathbf{v}_{\perp}\right]\\
 & =\left[0,\alpha\mathbf{v}_{\perp}+\beta\mathbf{u}\times\mathbf{v}_{\perp}\right] & (\mathbf{v}_{\perp}\text{正交于}\mathbf{u}\text{，}\text{所以}\beta\mathbf{u}\cdot\mathbf{v}_{\perp}=0)\\
RHS & =v_{\perp}q^{*}\\
 & =\left[0,\mathbf{v}_{\perp}\right]\cdot[\alpha,-\beta\mathbf{u}]\\
 & =\left[0+\mathbf{v}_{\perp}\cdot\beta\mathbf{u},\mathbf{0}+\alpha\mathbf{v}_{\perp}+\mathbf{v}_{\perp}\times\left(-\beta\mathbf{u}\right)\right]\\
 & =\left[0,\alpha\mathbf{v}_{\perp}+\mathbf{v}_{\perp}\times\left(-\beta\mathbf{u}\right)\right] & (\mathbf{v}_{\perp}\text{正交于}\mathbf{u}\text{，}\text{所以}\mathbf{v}_{\perp}\cdot\beta\mathbf{u}=0)\\
 & =\left[0,\alpha\mathbf{v}_{\perp}-\left(-\beta\mathbf{u}\right)\times\mathbf{v}_{\perp}\right] & (\mathbf{a}\times\mathbf{b}=-\mathbf{b}\times\mathbf{a})\\
 & =\left[0,\alpha\mathbf{v}_{\perp}+\beta\mathbf{u}\times\mathbf{v}_{\perp}\right]\\
 & =LHS
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
现在，我们就能对之前的公式做出最后的变形了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
v' & =pp^{*}v_{\parallel}+ppv_{\perp}\\
 & =pv_{\parallel}p^{*}+pv_{\perp}p^{*}\\
 & =p\left(v_{\parallel}+v_{\perp}\right)p^{*}
\end{array}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
显然，
\begin_inset Formula $v=v_{\parallel}+v_{\perp}$
\end_inset

，所以：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
v'=pvp^{*}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
到此为止，我们就解开了四元数与3D旋转之间的谜题。虽然我们之前将
\begin_inset Formula $v$
\end_inset

划分成了两个分量，但是推导的结果其实并没有包含
\begin_inset Formula $v_{\parallel}$
\end_inset

和
\begin_inset Formula $v_{\perp}$
\end_inset

。3D空间中任意一个旋转都能够用三个四元数相乘的形式表达出来。虽然推导的结果可能比较冗长，但是最终的结果非常简短。我们可以总结为一个定理：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 10:
\end_layout

\begin_layout Plain Layout
3D旋转公式(四元数型，一般情况)
\end_layout

\begin_layout Plain Layout
任意向量
\begin_inset Formula $\mathbf{v}$
\end_inset

沿着以单位向量定义的旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

度之后的
\begin_inset Formula $v'$
\end_inset

可以使用四元数乘法来获得。
\begin_inset Formula $v=\left[0,\mathbf{v}\right]$
\end_inset

，
\begin_inset Formula $q=\left[\cos(\dfrac{1}{2}\theta),\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]$
\end_inset

，那么：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
v'=qvq^{*}=qvq^{-1}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
换句话说，如果我们有
\begin_inset Formula $q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

，那么
\begin_inset Formula $v'=qvq^{*}$
\end_inset

可以将
\begin_inset Formula $\mathbf{v}$
\end_inset

围绕着
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $2\theta$
\end_inset

度。
\end_layout

\begin_layout Standard
虽然这个公式非常简洁，但是它并不是那么直观。如果你想了解它真正的含义的话，还需要将它还原到变形之前的公式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
v'=qvq^{*}=qq^{*}v_{\parallel}+qqv_{\perp}=v_{\parallel}+q^{2}v_{\perp}\label{eq:4.21}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
这也就是说，
\begin_inset Formula $qvq^{*}$
\end_inset

这个变换，对
\begin_inset Formula $\mathbf{v}$
\end_inset

平行于旋转轴的分量
\begin_inset Formula $v_{\parallel}$
\end_inset

实施的变换是
\begin_inset Formula $qq^{*}$
\end_inset

，这两个变换完全抵消了，也就是没有旋转。而对于正交于旋转轴的分量
\begin_inset Formula $v_{\perp}$
\end_inset

则实施的是两次变换
\begin_inset Formula $q^{2}=qq$
\end_inset

，将它旋转
\begin_inset Formula $\dfrac{1}{2}\theta+\dfrac{1}{2}\theta=\theta$
\end_inset

度。
\end_layout

\begin_layout Standard
实际上，这个公式也是与上一章推导的「Rodrigues' Rotation Formula」完全等价的。如果要确认我们的推导没有错误，可以试试证明下面这个等式(
提示：证明可能会用到
\begin_inset Formula $\mathbf{a}\times(\mathbf{b}\times\mathbf{c})=(\mathbf{a}\cdot\mathbf{c})\mathbf{b}-(\mathbf{a}\cdot\mathbf{b})\mathbf{c}$
\end_inset

这个公式)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
qvq^{*}=\left[0,\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
虽然这个等式的证明可能看起来会非常麻烦，但我仍推荐读者去尝试一下。除了一些三角公式，证明所需要的全部知识我们都已经涉及到了。它会让你更清楚地了解变换的整个过程以
及为什么变换的结果是一个纯四元数。
\end_layout

\begin_layout Standard
因为所有的旋转四元数的实部都只是一个角度的余弦值，假设有一个单位四元数
\begin_inset Formula $q=[a,\mathbf{b}]$
\end_inset

，如果我们想要提取它所对应旋转的角度，那么我们可以直接得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\theta}{2}=\cos^{-1}(a)
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
如果想要再获得旋转轴，那么只需要将虚部
\begin_inset Formula $\mathbf{b}$
\end_inset

的每一项都除以
\begin_inset Formula $\sin\left(\dfrac{\theta}{2}\right)$
\end_inset

就可以了：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mathbf{u}=\dfrac{\mathbf{b}}{\sin\left(\cos^{-1}\left(a\right)\right)}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
我们再稍微做一些变形。设任意单位四元数
\begin_inset Formula $q=\left[s,\mathbf{v}\right]$
\end_inset

，我们有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
s^{2}+\mathbf{v}^{2}=s^{2}+\left|\mathbf{v}\right|^{2}=1=\cos^{2}(\theta)+\sin^{2}(\theta)
\]

\end_inset


\end_layout

\begin_layout Standard
所以有
\begin_inset Formula $\cos(\theta)=s,\sin(\theta)=\left|\mathbf{v}\right|$
\end_inset

。单位四元数可以改写为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q=\cos(\theta)+\left|\mathbf{v}\right|\dfrac{\mathbf{v}}{\left|\mathbf{v}\right|}=\cos(\theta)+\sin(\theta)\dfrac{\mathbf{v}}{\left|\mathbf{v}\right|}=\cos(\theta)+\sin(\theta)\mathbf{u}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
其中单位向量
\begin_inset Formula $\mathbf{u}=\dfrac{\mathbf{v}}{\left|\mathbf{v}\right|}$
\end_inset

。
\end_layout

\begin_layout Standard
当小角度的时候，根据三角函数小角度近似原理，有
\begin_inset Formula $\theta\to0,\cos(\theta)\to1,\sin(\theta)\to\theta$
\end_inset

，所以工程上有快速构建近似单位四元数
\begin_inset Formula $q$
\end_inset

的方程：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=1+\theta\dfrac{\mathbf{v}}{\left|\mathbf{v}\right|}=1+\theta\mathbf{u}
\]

\end_inset


\end_layout

\begin_layout Section
3D旋转的矩阵形式
\end_layout

\begin_layout Standard
在实际的应用中，我们可能会需要将旋转与平移和缩放进行复合，所以需要用到四元数旋转的矩阵形式。它可以很容易地从上面这个公式推导出来。我们之前讨论过，左乘一个四元数
\begin_inset Formula $q=s+xi+yj+zk$
\end_inset

等同于下面这个矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L(q)=\left[\begin{array}{cccc}
s & -x & -y & -z\\
x & s & -z & y\\
y & z & s & -x\\
z & -y & x & s
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
而右乘
\begin_inset Formula $q$
\end_inset

等同于这个矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
R(q)=\left[\begin{array}{cccc}
s & -x & -y & -z\\
x & s & z & -y\\
y & -z & s & x\\
z & y & -x & s
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
所以，我们可以利用这两个公式将
\begin_inset Formula $v'=qvq^{*}$
\end_inset

写成矩阵形式。假设
\begin_inset Formula $s=\cos\left(\dfrac{1}{2}\theta\right)$
\end_inset

，
\begin_inset Formula $x=\sin\left(\dfrac{1}{2}\theta\right)u_{x}$
\end_inset

，
\begin_inset Formula $y=\sin\left(\dfrac{1}{2}\theta\right)u_{y}$
\end_inset

，
\begin_inset Formula $z=\sin\left(\dfrac{1}{2}\theta\right)u_{z}$
\end_inset

，
\begin_inset Formula $q=s+xi+yj+zk$
\end_inset

，我们就能得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
qvq^{*} & =L(q)R(q^{*})v\quad(\text{或者}R(q^{*})L(q)\text{，它们是等价的})\\
 & =\left[\begin{array}{cccc}
s & -x & -y & -z\\
x & s & -z & y\\
y & z & s & -x\\
z & -y & x & s
\end{array}\right]\left[\begin{array}{cccc}
s & x & y & z\\
-x & s & -z & y\\
-y & z & s & -x\\
-z & -y & x & s
\end{array}\right]v\quad(\text{注意}R(q^{*})=R(q)^{T})\\
 & =\left[\begin{array}{cccc}
s^{2}+x^{2}+y^{2}+z^{2} & sx-sx-yz+yz & sy+xz-sy-xz & sz-xy+xy-sz\\
sx-sx+yz-yz & x^{2}+s^{2}-z^{2}-y^{2} & xy-sz-sz+xy & xz+sy+xz+sy\\
sy-xz-sy+xz & xy+sz+sz+xy & y^{2}-z^{2}+s^{2}-x^{2} & yz+yz-sx-sx\\
sz+xy-xy-sz & xz-sy+xz-sy & yz+yz+sx+sx & z^{2}-y^{2}-x^{2}+s^{2}
\end{array}\right]v
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $s^{2}+x^{2}+y^{2}+z^{2}=1$
\end_inset

，这个式子能化简为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
qvq^{*}=\left[\begin{array}{cccc}
1 & 0 & 0 & 0\\
0 & 1-2y^{2}-2z^{2} & 2xy-2sz & 2sy+2xz\\
0 & 2xy+2sz & 1-2x^{2}-2z^{2} & 2yz-2sx\\
0 & 2xz-2sy & 2sx+2yz & 1-2x^{2}-2y^{2}
\end{array}\right]v\label{eq:4.28}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
这样我们就得到了3D旋转的矩阵形式。因为矩阵的最外圈不会对
\begin_inset Formula $\mathbf{v}$
\end_inset

进行任何变换，我们可以将它压缩成
\begin_inset Formula $3\times3$
\end_inset

矩阵(用作3D向量的变换)：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 11:
\end_layout

\begin_layout Plain Layout
3D旋转公式(矩阵型)
\end_layout

\begin_layout Plain Layout
任意向量
\begin_inset Formula $\mathbf{v}$
\end_inset

沿着以单位向量定义的旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的
\begin_inset Formula $v'$
\end_inset

可以使用矩阵乘法来获得。
\begin_inset Formula $s=\cos\left(\dfrac{1}{2}\theta\right)$
\end_inset

，
\begin_inset Formula $x=\sin\left(\dfrac{1}{2}\theta\right)u_{x}$
\end_inset

，
\begin_inset Formula $y=\sin\left(\dfrac{1}{2}\theta\right)u_{y}$
\end_inset

，
\begin_inset Formula $z=\sin\left(\dfrac{1}{2}\theta\right)u_{z}$
\end_inset

，那么：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
\mathbf{v}'=\left[\begin{array}{ccc}
1-2y^{2}-2z^{2} & 2xy-2sz & 2sy+2xz\\
2xy+2sz & 1-2x^{2}-2z^{2} & 2yz-2sx\\
2xz-2sy & 2sx+2yz & 1-2x^{2}-2y^{2}
\end{array}\right]\mathbf{v}\label{eq:4.29}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
虽然3D旋转的矩阵形式可能不如四元数形式简单，而且占用更多的空间，但是对于大批量的变换，使用预计算好的矩阵是比四元数乘法更有效率的。
\end_layout

\begin_layout Section
旋转的组合
\end_layout

\begin_layout Standard
在这一小节里，我们来证明一下使用四元数的旋转是可以复合的。旋转的复合其实在我们之前证明
\begin_inset Formula $q^{2}=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]*\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

的时候就已经涉及到一点了。但是这里我们考虑的是更一般的情况。
\end_layout

\begin_layout Standard
假设有两个表示围绕着不同旋转轴，旋转不同角度的四元数
\begin_inset Formula $q_{1},q_{2}$
\end_inset

，我们先对
\begin_inset Formula $v$
\end_inset

进行
\begin_inset Formula $q_{1}$
\end_inset

的变换，再进行
\begin_inset Formula $q_{2}$
\end_inset

的变换，变换的结果是什么呢？
\end_layout

\begin_layout Standard
我们不妨将这两次变换分步进行。首先，我们实施
\begin_inset Formula $q_{1}$
\end_inset

的变换，变换之后的
\begin_inset Formula $v'$
\end_inset

为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v'=q_{1}vq_{1}^{*}
\]

\end_inset


\end_layout

\begin_layout Standard
接下来，对
\begin_inset Formula $v'$
\end_inset

进行
\begin_inset Formula $q_{2}$
\end_inset

的变换,得到
\begin_inset Formula $v''$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v'' & =q_{1}v'q_{1}^{*}\\
 & =q_{2}q_{1}vq_{1}^{*}q_{2}^{*}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
我们需要对这两个变换进行复合，写为一个等价变换的形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v''=q_{net}vq_{net}^{*}
\]

\end_inset


\end_layout

\begin_layout Standard
为了写成上面这种形式，我们还需要一个引理
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Lemma 4:
\end_layout

\begin_layout Plain Layout
对任意四元数
\begin_inset Formula $q_{1}=\left[s,\mathbf{v}\right],q_{2}=\left[t,\mathbf{u}\right]$
\end_inset

：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
q_{1}^{*}q_{2}^{*}=\left(q_{2}q_{1}\right)^{*}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Paragraph
Proof.
\end_layout

\begin_layout Standard
证明这个引理仍然使用与之前类似的方法：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{rl}
LHS & =q_{1}^{*}q_{2}^{*}\\
 & =\left[s,-\mathbf{v}\right]\cdot\left[t,-\mathbf{u}\right]\\
 & =\left[st-\left(-\mathbf{v}\right)\cdot\left(-\mathbf{u}\right),s\left(-\mathbf{u}\right)+t\left(-\mathbf{v}\right)+\left(-\mathbf{v}\right)\times\left(-\mathbf{u}\right)\right]\\
 & =\left[st-\mathbf{v}\cdot\mathbf{u},-s\mathbf{u}-t\mathbf{v}+\mathbf{v}\times\mathbf{u}\right]\\
RHS & =\left(q_{2}q_{1}\right)^{*}\\
 & =\left(\left[s,\mathbf{v}\right]\cdot\left[t,\mathbf{u}\right]\right)^{*}\\
 & =\left[ts-\mathbf{u}\cdot\mathbf{v},t\mathbf{v}+s\mathbf{u}+\mathbf{u}\times\mathbf{v}\right]^{*}\\
 & =\left[st-\mathbf{v}\cdot\mathbf{u},-s\mathbf{u}-t\mathbf{v}-\mathbf{u}\times\mathbf{v}\right]\\
 & =\left[st-\mathbf{v}\cdot\mathbf{u},-s\mathbf{u}-t\mathbf{v}+\mathbf{v}\times\mathbf{u}\right]\\
 & =LHS
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
所以，我们能得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v'' & =q_{2}q_{1}vq_{1}^{*}q_{2}^{*}\\
 & =\left(q_{2}q_{1}\right)v\left(q_{2}q_{1}\right)^{*}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这也就是说，
\begin_inset Formula $q_{net}=q_{2}q_{1}$
\end_inset

。注意四元数乘法的顺序，我们先进行的是
\begin_inset Formula $q_{1}$
\end_inset

的变换，再进行
\begin_inset Formula $q_{2}$
\end_inset

的变换。这和矩阵与函数的复合非常相似，都是从右往左叠加。
\end_layout

\begin_layout Standard
要注意的是，
\begin_inset Formula $q_{1}$
\end_inset

与
\begin_inset Formula $q_{2}$
\end_inset

的等价旋转
\begin_inset Formula $q_{net}$
\end_inset

并不是分别围绕着
\begin_inset Formula $q_{1}$
\end_inset

和
\begin_inset Formula $q_{2}$
\end_inset

的两个旋转轴进行的两次旋转。它是围绕着一个全新的旋转轴进行的一次等价旋转，仅仅只有旋转的结果相同。
\end_layout

\begin_layout Standard
虽然我们讨论的是两个旋转的复合，但是它可以很容易推广到更多个旋转的复合。比如说我们还需要进行第三个旋转
\begin_inset Formula $q_{3}$
\end_inset

，那么：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v''' & =q_{3}\left(q_{2}q_{1}\right)v\left(q_{2}q_{1}\right)^{*}q_{3}^{*}\\
 & =\left(q_{3}q_{2}q_{1}\right)v\left(q_{3}q_{2}q_{1}\right)^{*}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
它的等价旋转就是
\begin_inset Formula $q_{net}=q_{3}q_{2}q_{1}$
\end_inset

。
\end_layout

\begin_layout Standard
此外，在旋转组合中，很容易发现一个算法：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{1}^{*}v'q_{1}=q_{1}^{*}q_{1}vq_{1}^{*}q_{1}=v
\]

\end_inset

也就是在
\begin_inset Formula $qvq^{*}$
\end_inset

乘法序列中，当
\begin_inset Formula $q$
\end_inset

与
\begin_inset Formula $q^{*}$
\end_inset

调换位置，就反方向旋转回
\begin_inset Formula $\theta$
\end_inset

度，取消了刚才的旋转。这在工程计算中会经常用到。
\end_layout

\begin_layout Section
双倍覆盖
\end_layout

\begin_layout Standard
四元数与3D旋转的关系并不是一对一的，同一个3D旋转可以使用两个不同的四元数来表示。对任意的单位四元数
\begin_inset Formula $q=\left[\cos\left(\dfrac{1}{2}\theta\right),\sin\left(\dfrac{1}{2}\theta\right)\mathbf{u}\right]$
\end_inset

，
\begin_inset Formula $q$
\end_inset

与
\begin_inset Formula $-q$
\end_inset

代表的是同一个旋转。如果
\begin_inset Formula $q$
\end_inset

表示的是沿着旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

度,那么
\begin_inset Formula $-q$
\end_inset

代表的是沿着相反的旋转轴
\begin_inset Formula $-\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $(2\pi-\theta)$
\end_inset

度：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
-q & =\left[-\cos\left(\dfrac{1}{2}\theta\right),-\sin\left(\dfrac{1}{2}\theta\right)\mathbf{u}\right]\\
 & =\left[\cos\left(\pi-\dfrac{1}{2}\theta\right),\sin\left(\pi-\dfrac{1}{2}\theta\right)\left(-\mathbf{u}\right)\right]\;\left(\cos\left(\pi-\theta\right)=-\cos\left(\theta\right),\sin\left(\pi-\theta\right)=\sin\left(\theta\right)\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以，这个四元数旋转的角度为
\begin_inset Formula $2\left(\pi-\dfrac{1}{2}\theta\right)=2\pi-\theta$
\end_inset

。从下面的图中我们可以看到，这两个旋转是完全等价的：
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure4.1.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
旋转双倍覆盖示意图
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
其实从四元数的旋转公式中也能推导出相同的结果：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left(-q\right)v\left(-q\right)^{*}=\left(-1\right)^{2}qvq^{*}=qvq^{*}
\]

\end_inset


\end_layout

\begin_layout Standard
所以，我们经常说单位四元数与3D旋转有一个「2对1满射同态」(2-1 Surjective Homomorphism)关系，或者说单位四元数双倍覆盖(Doubl
e Cover)了3D旋转。它的严格证明会用到一些李群的知识，但这里给出的解释已经足够直观了。 
\end_layout

\begin_layout Standard
因为这个映射是满射，我们可以说所有的单位四元数都对应着一个3D旋转。或者说，一个四维单位超球面(也叫做
\begin_inset Formula $\mathbb{S}^{3}$
\end_inset

)上任意一点所对应的四元数(
\begin_inset Formula $\left|q\right|=1$
\end_inset

)都对应着一个3D旋转。 
\end_layout

\begin_layout Standard
有一点需要注意的是，虽然
\begin_inset Formula $q$
\end_inset

与
\begin_inset Formula $-q$
\end_inset

是两个不同的四元数，但是由于旋转矩阵中的每一项都包含了四元数两个分量的乘积，它们的旋转矩阵是完全相同的。旋转矩阵并不会出现双倍覆盖的问题。
\end_layout

\begin_layout Section
指数形式
\end_layout

\begin_layout Standard
在讨论复数的时候，我们利用欧拉公式将2D的旋转写成了
\begin_inset Formula $v'=e^{\theta i}v$
\end_inset

这样的指数形式。实际上，我们也可以利用四元数将3D旋转写成类似的形式。
\end_layout

\begin_layout Standard
类似于复数的欧拉公式，四元数也有一个类似的公式。如果
\begin_inset Formula $\mathbf{u}$
\end_inset

是一个单位向量，那么对于单位四元数
\begin_inset Formula $u=[0,\mathbf{u}]$
\end_inset

，有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
e^{\theta u}=\cos(\theta)+\sin(\theta)u=\cos(\theta)+\sin(\theta)\mathbf{u}\label{eq:4.31}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
这也就是说，
\begin_inset Formula $q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

可以使用指数表示为
\begin_inset Formula $e^{\theta u}$
\end_inset

。这个公式的证明与欧拉公式的证明非常类似，直接使用级数展开就可以了。关于它的证明参见6.1节。
\end_layout

\begin_layout Standard
注意，因为
\begin_inset Formula $\mathbf{u}$
\end_inset

是一个单位向量，
\begin_inset Formula $u^{2}=[-\mathbf{u}\cdot\mathbf{u},0]=-\left|\mathbf{u}\right|^{2}=-1$
\end_inset

。这与欧拉公式中的
\begin_inset Formula $i$
\end_inset

是非常类似的。
\end_layout

\begin_layout Standard
有了指数型的表示方式，我们就能够将之前四元数的旋转公式改写为指数形式了：
\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Paragraph
Theorem 12:
\end_layout

\begin_layout Plain Layout
3D旋转公式(指数型)
\end_layout

\begin_layout Plain Layout
任意向量
\begin_inset Formula $\mathbf{v}$
\end_inset

沿着以单位向量定义的旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

旋转
\begin_inset Formula $\theta$
\end_inset

角度之后的
\begin_inset Formula $v'$
\end_inset

可以使用四元数的指数表示。令
\begin_inset Formula $v=[0,\mathbf{v}]$
\end_inset

，
\begin_inset Formula $u=[0,\mathbf{u}]$
\end_inset

，那么：
\end_layout

\begin_layout Plain Layout
\begin_inset Formula 
\begin{equation}
v'=e^{\frac{\theta}{2}u}ve^{-\frac{\theta}{2}u}
\end{equation}

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
有了四元数的指数定义，我们就能够定义四元数的更多运算了。首先是自然对数
\begin_inset Formula $\log$
\end_inset

，对任意单位四元数
\begin_inset Formula $q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\log\left(q\right)=\log\left(e^{\theta u}\right)=[0,\theta\mathbf{u}]\label{eq:4.33}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
接下来是单位四元数的幂运算：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q^{t}=\left(e^{\theta u}\right)^{t}=e^{(t\theta)u}=\left[\cos(t\theta),\sin(t\theta)\mathbf{u}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
可以看到，一个单位四元数的
\begin_inset Formula $t$
\end_inset

次幂等同于将它的旋转角度缩放至
\begin_inset Formula $t$
\end_inset

倍，并且不会改变它的旋转轴(
\begin_inset Formula $u$
\end_inset

必须是单位向量，所以一般不能与
\begin_inset Formula $t$
\end_inset

结合)。这些运算会在之后讨论四元数微分方程时非常有用。
\end_layout

\begin_layout Chapter
姿态表示与四元数
\end_layout

\begin_layout Standard
在3D空间中，对于一个质点，我们用位置来描述就够了，只需要3个自由度(DOF)，也就可以用通俗的三维坐标来表示。然而对一个刚体，3个自由度是不够的，因为有了体积
的存在，还需要有3个角参量来描述姿态，一共是6个自由度(DOF)，这时候坐标已经不能够满足了，所以姿态就是为了描述这件事情产生的。也就是3D空间中的刚体，需要用
位置(position)以及姿态(Attitude)表示，两个物理量各有3个自由度(DOF)。姿态的英文词汇有两个“attitude”或者“orientatio
n”。后者的意义更为明显，可以理解为“取向”或“指向”。
\end_layout

\begin_layout Standard
所谓姿态，就是刚体在3D空间中，固连在刚体上的机体坐标系(body frame)和参考坐标系(reference frame)之间的旋转关系。
\end_layout

\begin_layout Standard
姿态的核心就是旋转。一般旋转有4种表示方式：矩阵表示、欧拉角表示、轴角表示和四元数表示。矩阵表示适合变换向量，欧拉角最直观，轴角表示则适合几何推导，而在组合旋转
方面，四元数表示最佳。因为姿态解算需要频繁组合旋转和用旋转变换向量，所以采用四元数保存组合姿态、辅以矩阵来变换向量、人机交互端使用欧拉角的组合方案最常见。
\end_layout

\begin_layout Standard
在这些表示方法中，旋转矩阵对于坐标系的描述是最冗余的。旋转矩阵用了9个元素来描述姿态。而事实上，由正交性条件带来6个约束，这9个元素之间不是独立的，而是相关的。
这就意味着，只要3个参数就能描述一个刚体在空间中的姿态。但是，数学上已经证明了，姿态估计的基本约束条件是姿态矩阵
\begin_inset Formula $A$
\end_inset

是旋转群或特殊正交群
\begin_inset Formula $SO(3)$
\end_inset

的成员。这只是说
\begin_inset Formula $A$
\end_inset

必须是行列式
\begin_inset Formula $+1$
\end_inset

的正交矩阵的群理论方法。对于某些姿态，所有的
\begin_inset Formula $SO(3)$
\end_inset

的3个参数表示都是奇异的或不连续的。所以对3D旋转来说，最少需要4个参数的表示方法，也就是四元数表示法，才能无奇点的、连续的、采样均匀地表示3D旋转。这才是四元
数表示法的最大优势。
\end_layout

\begin_layout Standard
但是避开奇点以后，小角度情况下，三参数旋转表示法也因为直观和易于理解而在工程界里广泛使用。本章简单介绍几种3参数旋转表示法。因为后面的讨论会涉及到。
\end_layout

\begin_layout Section
欧拉角表示法
\end_layout

\begin_layout Standard
介绍欧拉角的资料有很多。这里只是略微介绍一点概念。详细资料可以查看
\begin_inset CommandInset href
LatexCommand href
name "这里"
target "https://en.wikipedia.org/wiki/Euler_angles"
literal "false"

\end_inset

。
\end_layout

\begin_layout Standard
欧拉角是最直观的一种姿态描述方式，其定义为：一个坐标系到另一个坐标系的变换，可以通过绕不同坐标轴的3次连续转动来实现。这三次的转动角度统一称之为欧拉角。
\end_layout

\begin_layout Standard
欧拉角由三次绕轴旋转组成，而这三次转动顺序任意，且转动轴可以是参考坐标系的，也可以是机体坐标系的，因此共有24种转动方式。因此应用欧拉角时需要定义旋转顺序。
\end_layout

\begin_layout Standard
而通常飞控上所使用的姿态角，指的是航空领域主要应用的航空次序欧拉角，也叫卡尔丹角(Tait-Bryan angles)，定义欧拉角的转动顺序为
\begin_inset Formula $Z-Y-X$
\end_inset

。其中绕
\begin_inset Formula $Z$
\end_inset

轴转动为偏航角(Yaw)，绕
\begin_inset Formula $Y$
\end_inset

轴转动为俯仰角(Pitch)，绕
\begin_inset Formula $X$
\end_inset

轴转动为横滚角(Roll)，其具体意义如下：
\end_layout

\begin_layout Itemize
偏航角(Yaw)：机体坐标系
\begin_inset Formula $x$
\end_inset

轴投影到水平面与参考系
\begin_inset Formula $x$
\end_inset

轴的夹角
\begin_inset Formula $\psi$
\end_inset

，顺时针旋转为正。
\end_layout

\begin_layout Itemize
俯仰角(Pitch)：机体坐标系
\begin_inset Formula $x$
\end_inset

轴与水平面的夹角
\begin_inset Formula $\theta$
\end_inset

，抬头为正。
\end_layout

\begin_layout Itemize
横滚角(Roll)：机体坐标系
\begin_inset Formula $z$
\end_inset

轴与通过机体系
\begin_inset Formula $x$
\end_inset

轴的铅垂面间的夹角
\begin_inset Formula $\phi$
\end_inset

，机体右旋为正。
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure5.1.png
	scale 40

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
欧拉角
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
注意：欧拉角意义上并不直接等于姿态角，它只是描述了3次绕轴转动。而我们使用的姿态角：偏航角、横滚角与俯仰角实际上是机体坐标系与参考坐标系之间关系的表述。
\end_layout

\begin_layout Subsection
欧拉角和四元数的转换
\end_layout

\begin_layout Standard
在姿态解算的应用中，经常需要在欧拉角和四元数之间的做转换。也就是，同一个姿态，根据不同的计算需要，采用欧拉角或四元数做表示。
\end_layout

\begin_layout Standard
本节的内容主要参考以下网址：
\end_layout

\begin_layout Standard
\begin_inset CommandInset href
LatexCommand href
name "四元数和欧拉角之间的转换"
target "https://en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles"
literal "false"

\end_inset


\end_layout

\begin_layout Itemize
定义欧拉角
\begin_inset Formula $\left[\begin{array}{ccc}
\psi & \theta & \phi\end{array}\right]$
\end_inset

分别为绕
\begin_inset Formula $Z$
\end_inset

轴、
\begin_inset Formula $Y$
\end_inset

轴、
\begin_inset Formula $X$
\end_inset

轴的旋转角度，如果用Tait-Bryan angle表示，分别为偏航角(Yaw)、俯仰角(Pitch)、横滚角(Roll)。 
\end_layout

\begin_layout Itemize
定义单位四元数
\begin_inset Formula $q=\left[\begin{array}{cccc}
s & x & y & z\end{array}\right],\left|q\right|=1$
\end_inset

。
\end_layout

\begin_layout Standard
根据前面的知识，通过由单位向量
\begin_inset Formula $\mathbf{u}$
\end_inset

表示的旋转轴，和绕该轴旋转的角度，可以构造一个四元数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
s & =\cos(\alpha/2)\\
x & =\sin(\alpha/2)\cos(\beta_{x})\\
y & =\sin(\alpha/2)\cos(\beta_{y})\\
z & =\sin(\alpha/2)\cos(\beta_{z})
\end{array}
\end{equation}

\end_inset

其中
\begin_inset Formula $\alpha$
\end_inset

是绕旋转轴旋转的角度，
\begin_inset Formula $\left[\begin{array}{ccc}
\beta_{x} & \beta_{y} & \beta_{z}\end{array}\right]$
\end_inset

为旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

在
\begin_inset Formula $x,y,z$
\end_inset

轴上方向余弦(由此确定了旋转轴)。 
\end_layout

\begin_layout Subsection
欧拉角到四元数的转换
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q=\left[\begin{array}{c}
s\\
x\\
y\\
z
\end{array}\right]=\left[\begin{array}{c}
\cos(\phi/2)\cos(\theta/2)\cos(\psi/2)+\sin(\phi/2)\sin(\theta/2)\sin(\psi/2)\\
\sin(\phi/2)\cos(\theta/2)\cos(\psi/2)-\cos(\phi/2)\sin(\theta/2)\sin(\psi/2)\\
\cos(\phi/2)\sin(\theta/2)\cos(\psi/2)+\sin(\phi/2)\cos(\theta/2)\sin(\psi/2)\\
\cos(\phi/2)\cos(\theta/2)\sin(\psi/2)-\sin(\phi/2)\sin(\theta/2)\cos(\psi/2)
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
四元数到欧拉角的转换
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\begin{array}{c}
\phi\\
\theta\\
\psi
\end{array}\right]=\left[\begin{array}{c}
\arctan\left(\dfrac{2\left(sx+yz\right)}{1-2\left(x^{2}+y^{2}\right)}\right)\\
\arcsin\left(2\left(sy-xz\right)\right)\\
\arctan\left(\dfrac{2\left(sz+xy\right)}{1-2\left(y^{2}+z^{2}\right)}\right)
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\arctan$
\end_inset

函数的结果为
\begin_inset Formula $\left[-\pi/2,\pi/2\right]$
\end_inset

，对于
\begin_inset Formula $\phi$
\end_inset

和
\begin_inset Formula $\psi$
\end_inset

来说，这并不能覆盖所有象限姿态，因此需要用
\begin_inset Formula $\mathrm{atan2}$
\end_inset

函数来代替
\begin_inset Formula $\arctan$
\end_inset

函数。
\begin_inset Formula $\arcsin$
\end_inset

函数的结果为
\begin_inset Formula $\left[-\pi/2,\pi/2\right]$
\end_inset

，对于
\begin_inset Formula $\theta$
\end_inset

来说，取值范围已经满足。所以在计算机程序的计算中采用如下公式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\begin{array}{c}
\phi\\
\theta\\
\psi
\end{array}\right]=\left[\begin{array}{c}
\mathrm{atan2}\left(2\left(sx+yz\right),1-2\left(x^{2}+y^{2}\right)\right)\\
\arcsin\left(2\left(sy-xz\right)\right)\\
\mathrm{atan2}\left(2\left(sz+xy\right),1-2\left(y^{2}+z^{2}\right)\right)
\end{array}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
小结
\end_layout

\begin_layout Standard
欧拉角和四元数表示法对比的特点如下：
\end_layout

\begin_layout Itemize
欧拉角最直观、最容易理解、存储空间少，但是欧拉角存在万向节死锁现象、插值速度不均匀等缺点，而且不可以在计算机中直接运算。
\end_layout

\begin_layout Itemize
四元素不存在万向节死锁问题、利用球面插值可以获得均匀的转速、存储空间也较少，但是不好理解、不直观。
\end_layout

\begin_layout Section
欧拉轴-角(Axis-angle)表示和旋转向量
\begin_inset Foot
status open

\begin_layout Plain Layout
本章内讲的”旋转向量“一词是名词，意指”代表旋转的向量“。其它章”旋转向量“一词是动词，意思是”去旋转一个向量“。有时候会混用。需要从上下文判别。
\end_layout

\end_inset


\end_layout

\begin_layout Standard
旋转的轴-角(Axis-angle)表示用两个值参数化了旋转：指定单位向量
\begin_inset Formula $\mathbf{u}$
\end_inset

为旋转轴，围绕这个轴的旋转角度
\begin_inset Formula $\theta$
\end_inset

。它也叫做旋转的指数坐标，参见旋转的自然对数
\begin_inset Formula $\log$
\end_inset

公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.33"
plural "false"
caps "false"
noprefix "false"

\end_inset

)。这也叫做旋转向量表示，因为这两个参数(轴和角)可用在这个轴上的其模长是旋转角的一个向量来表示[7]。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mathbf{a}_{\theta}=\theta\mathbf{u}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
所有旋转都可以映射到旋转向量空间中半径为
\begin_inset Formula $\pi$
\end_inset

的球的内部和表面上的点，直径的两端的点表示相同的姿态。在奇点
\begin_inset Formula $\pi$
\end_inset

附近，姿态可能平稳变化的，但旋转向量可能从直径的一端跳到另一端。将表示扩展到半径为
\begin_inset Formula $2\pi$
\end_inset

的球体可以推迟这些跳跃，但不能完全避免，因为旋转向量的运动方程对于
\begin_inset Formula $\theta=2\pi$
\end_inset

是奇异的。
\end_layout

\begin_layout Standard
小角度情况下，旋转向量可以从四元数中获取。设单位四元数为
\begin_inset Formula $q=\left[\cos(\dfrac{1}{2}\theta),\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]$
\end_inset

。下面就是工程上常见的获取旋转向量的两种方法[7]。
\end_layout

\begin_layout Section
吉布斯向量(Gibbs Vector)或罗德里格斯参数(Rodrigues Parameters)
\end_layout

\begin_layout Standard
吉布斯向量的3个参数是
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mathbf{g}=\dfrac{\sin(\dfrac{1}{2}\theta)\mathbf{u}}{\cos(\dfrac{1}{2}\theta)}=\mathbf{u}\tan(\dfrac{1}{2}\theta)=\dfrac{\mathbf{a}_{g}}{2}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
最后一项中的
\begin_inset Formula $\dfrac{1}{2}$
\end_inset

因子确保小旋转时
\begin_inset Formula $\mathbf{a}_{g}$
\end_inset

的量级近似等于
\begin_inset Formula $\theta$
\end_inset

。这种参数是罗德里格斯早先介绍的。吉布斯向量可以看作是
\begin_inset Formula $S^{3}$
\end_inset

四元数空间在三维欧几里德
\begin_inset Formula $\mathbf{g}$
\end_inset

空间上的一个几何投影，如图所示。这是
\begin_inset Formula $S^{3}$
\end_inset

的
\begin_inset Formula $2:1$
\end_inset

映射，
\begin_inset Formula $q$
\end_inset

和
\begin_inset Formula $-q$
\end_inset

映射到同一点。由于
\begin_inset Formula $q$
\end_inset

和
\begin_inset Formula $-q$
\end_inset

代表相同的旋转，吉布斯向量参数化是
\begin_inset Formula $E^{3}$
\end_inset

上旋转的
\begin_inset Formula $1:1$
\end_inset

表示。吉布斯向量对于
\begin_inset Formula $\pi$
\end_inset

角度的旋转是无限的(
\begin_inset Formula $S^{3}$
\end_inset

的
\begin_inset Formula $\cos(\dfrac{1}{2}\theta)=0$
\end_inset

算子)，这对于旋转的全局表示是不可取的。
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure5.2.png

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Gibbs vector as a gnomonic projection.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
改进型罗德里格斯参数(Modified Rodrigues Parameters)
\end_layout

\begin_layout Standard
改进型罗德里格斯参数(Modified Rodrigues Parameters, MRPs)的3个参数是
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mathbf{p}=\dfrac{\sin(\dfrac{1}{2}\theta)\mathbf{u}}{1+\cos(\dfrac{1}{2}\theta)}=\mathbf{u}\tan(\dfrac{1}{4}\theta)=\dfrac{\mathbf{a}_{p}}{4}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
最后一项中的
\begin_inset Formula $\dfrac{1}{4}$
\end_inset

因子确保小旋转时
\begin_inset Formula $\mathbf{a}_{p}$
\end_inset

的量级近似等于
\begin_inset Formula $\theta$
\end_inset

。这些参数可以看作是
\begin_inset Formula $S^{3}$
\end_inset

四元数空间在
\begin_inset Formula $E^{3}$
\end_inset

上的立体平面投影，如图所示。
\begin_inset Formula $S^{3}$
\end_inset

的一个半球在三维
\begin_inset Formula $\mathbf{p}$
\end_inset

空间中投影到单位球体的内部，
\begin_inset Formula $S^{3}$
\end_inset

的另一个半球投影到单位
\begin_inset Formula $\mathbf{p}$
\end_inset

球体的外部。所有旋转都可以用单元球内部和表面的MRPs表示。如果我们将表示扩展到所有欧几里得空间，我们有一个
\begin_inset Formula $2:1$
\end_inset

的参数化，其中
\begin_inset Formula $\mathbf{p}$
\end_inset

和
\begin_inset Formula $-\mathbf{p}/p^{2}$
\end_inset

表示相同的旋转。这种参数化与旋转向量参数化有许多共同的特点，包括离散跳跃的需求，但又避免了超越函数。
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure5.3.png

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Modified Rodrigues parameters as a stereographic projection.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
旋转向量与四元数
\end_layout

\begin_layout Standard
在表示旋转方法中，四元数也可以算是轴-角(Axis-angle)表示法的一种，因为单位四元数的乘积形式既显示了旋转角度也显示了旋转轴。上述两种旋转向量可以直接放
入四元数的虚部。该四元数的实部用单位四元数的模长
\begin_inset Formula $\left|q\right|=1$
\end_inset

的规则计算出来。在姿态估计的算法中，一般使用旋转向量表示估计误差的误差。这个值一般都很小。为简化运算，实部写
\begin_inset Formula $1$
\end_inset

就可以快速构造一个近似单位四元数了。
\end_layout

\begin_layout Chapter
四元数的微分与积分
\end_layout

\begin_layout Section
四元数的指数映射
\end_layout

\begin_layout Standard
这里我们来证明之前提到的公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.31"
plural "false"
caps "false"
noprefix "false"

\end_inset

)：对任意单位向量
\begin_inset Formula $\mathbf{u}$
\end_inset

所对应的单位四元数
\begin_inset Formula $u=[0,\mathbf{u}]$
\end_inset

，有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
e^{\theta u}=\cos(\theta)+\sin(\theta)u
\]

\end_inset


\end_layout

\begin_layout Standard
和矩阵与复数一样，四元数的指数也是使用级数来定义的。
\end_layout

\begin_layout Paragraph
Proof.
 
\end_layout

\begin_layout Standard
和矩阵与复数一样，四元数的指数也是使用级数来定义的。
\end_layout

\begin_layout Standard
我们知道，
\begin_inset Formula $e^{x}$
\end_inset

，
\begin_inset Formula $\sin(x)$
\end_inset

，
\begin_inset Formula $\cos(x)$
\end_inset

分别能用泰勒级数展开为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
e^{x} & =\sum_{n=0}^{\infty}\dfrac{x^{n}}{n!}=1+x+\dfrac{x^{2}}{2!}+\dfrac{x^{3}}{3!}+\dfrac{x^{4}}{4!}+\ldots\\
\sin(x) & =\sum_{n=0}^{\infty}\dfrac{\left(-1\right)^{n}}{\left(2n+1\right)!}x^{2n+1}=x-\dfrac{x^{3}}{3!}+\dfrac{x^{5}}{5!}-\dfrac{x^{7}}{7!}+\ldots\\
\cos(x) & =\sum_{n=0}^{\infty}\dfrac{\left(-1\right)^{n}}{\left(2n\right)!}x^{2n}=1-\dfrac{x^{2}}{2!}+\dfrac{x^{4}}{4!}-\dfrac{x^{6}}{6!}+\ldots
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
我们可以将
\begin_inset Formula $x=\theta u$
\end_inset

代入
\begin_inset Formula $e^{x}$
\end_inset

，得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
LHS=e^{\theta u} & =\sum_{n=0}^{\infty}\dfrac{\left(\theta u\right)^{n}}{n!}\\
 & =1+\theta u+\dfrac{\left(\theta u\right)^{2}}{2!}+\dfrac{\left(\theta u\right)^{3}}{3!}+\dfrac{\left(\theta u\right)^{4}}{4!}+\dfrac{\left(\theta u\right)^{5}}{5!}+\ldots\\
 & =1+\theta u+\dfrac{\theta^{2}u^{2}}{2!}+\dfrac{\theta^{3}u^{3}}{3!}+\dfrac{\theta^{4}u^{4}}{4!}+\dfrac{\theta^{5}u^{5}}{5!}+\ldots
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\mathbf{u}^{2}=[-\mathbf{u}\cdot\mathbf{u},\mathbf{0}]=-\mathbf{\left|u\right|}^{2}=-1$
\end_inset

，我们可以对
\begin_inset Formula $e^{\theta u}$
\end_inset

进一步化简：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
LHS & =1+\theta u+\dfrac{\theta^{2}u^{2}}{2!}+\dfrac{\theta^{3}u^{3}}{3!}+\dfrac{\theta^{4}u^{4}}{4!}+\dfrac{\theta^{5}u^{5}}{5!}+\ldots\\
 & =1+\theta u-\dfrac{\theta^{2}}{2!}-\dfrac{\theta^{3}u}{3!}+\dfrac{\theta^{4}}{4!}+\dfrac{\theta^{5}u}{5!}-\ldots
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
同理,将
\begin_inset Formula $\theta$
\end_inset

代入
\begin_inset Formula $\cos(x)$
\end_inset

和
\begin_inset Formula $\sin(x)$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\sin(\theta) & =\sum_{n=0}^{\infty}\dfrac{\left(-1\right)^{n}}{\left(2n+1\right)!}\theta^{2n+1}\\
 & =\theta-\dfrac{\theta^{3}}{3!}+\dfrac{\theta^{5}}{5!}-\dfrac{\theta^{7}}{7!}+\ldots\\
\cos(\theta) & =\sum_{n=0}^{\infty}\dfrac{\left(-1\right)^{n}}{\left(2n\right)!}\theta^{2n}\\
 & =1-\dfrac{\theta^{2}}{2!}+\dfrac{\theta^{4}}{4!}-\dfrac{\theta^{6}}{6!}+\ldots
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
RHS & =\cos(\theta)+\sin(\theta)u\\
 & =\sum_{n=0}^{\infty}\dfrac{\left(-1\right)^{n}}{\left(2n\right)!}\theta^{2n}+u\sum_{n=0}^{\infty}\dfrac{\left(-1\right)^{n}}{\left(2n+1\right)!}\theta^{2n+1}\\
 & =1+\theta u-\dfrac{\theta^{2}}{2!}-\dfrac{\theta^{3}u}{3!}+\dfrac{\theta^{4}}{4!}+\dfrac{\theta^{5}u}{5!}-\ldots=LHS
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这在证明的其实是李代数
\begin_inset Formula $\mathfrak{su}(2)$
\end_inset

到李群
\begin_inset Formula $SU(2)$
\end_inset

的指数映射。我们之所以能够证明它是因为
\begin_inset Formula $u^{2}=-1$
\end_inset

，与复数的
\begin_inset Formula $i^{2}=-1$
\end_inset

非常类似。与复数不同的是
\begin_inset Formula $x^{2}=-1$
\end_inset

这个方程在四元数中是有无数个解的。比如说我们所用到的
\begin_inset Formula $u=[0,\mathbf{u}]$
\end_inset

，只要
\begin_inset Formula $\mathbf{u}$
\end_inset

是一个单位向量，
\begin_inset Formula $u$
\end_inset

就是这个方程的一个解。
\end_layout

\begin_layout Standard
四元数的极性形式实际上只是欧拉公式的四元数版本：任意单位复数 
\begin_inset Formula $z$
\end_inset

 都可以写成纯虚数的复指数
\begin_inset Formula $z=\exp(\theta i)=\cos(\theta)+\sin(\theta)i$
\end_inset

 ，同样任意单位四元数
\begin_inset Formula $q=\cos(\theta)+\sin(\theta)\mathbf{u}$
\end_inset

都可以写成纯虚四元数的指数
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $q=\exp(\theta\mathbf{u})$
\end_inset

。
\end_layout

\begin_layout Standard
如果以任意四元数
\begin_inset Formula $q=\left[s,\mathbf{v}\right]$
\end_inset

做指数，我们有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
e^{s+\mathbf{v}}=e^{s}e^{\left|\mathbf{v}\right|\frac{\mathbf{v}}{\left|\mathbf{v}\right|}}
\]

\end_inset


\end_layout

\begin_layout Standard
设单位向量
\begin_inset Formula $\mathbf{u}=\frac{\mathbf{v}}{\left|\mathbf{v}\right|}$
\end_inset

，
\begin_inset Formula $\left|\mathbf{v}\right|=\theta$
\end_inset

，所以有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
e^{\left|\mathbf{v}\right|\frac{\mathbf{v}}{\left|\mathbf{v}\right|}} & =e^{\theta u}\\
 & =\cos(\theta)+\sin(\theta)\mathbf{u}\\
 & =\cos(\left|\mathbf{v}\right|)+\sin(\left|\mathbf{v}\right|)\frac{\mathbf{v}}{\left|\mathbf{v}\right|}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
e^{s+\mathbf{v}}=e^{s}\left(\cos(\left|\mathbf{v}\right|)+\sin(\left|\mathbf{v}\right|)\frac{\mathbf{v}}{\left|\mathbf{v}\right|}\right)
\]

\end_inset


\end_layout

\begin_layout Section
微分方程推导思路
\begin_inset Foot
status open

\begin_layout Plain Layout
本节主要来自于文档[3]。
\end_layout

\end_inset


\end_layout

\begin_layout Standard
首先，需要指出似乎很重要的一点：实际上，四元数数值函数的积分或微分都没有什么特别之处。如果你有一个四元数数值函数的一个变量
\begin_inset Formula $q(t)$
\end_inset

，那么
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}(t)=q'(t)=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\lim_{\Delta t\to0}\dfrac{q(t+\Delta t)-q(t)}{\Delta t}
\]

\end_inset


\end_layout

\begin_layout Standard
这与任何实数或复数函数相同。
\end_layout

\begin_layout Standard
那么，关键问题是什么呢？简单的说：单位四元数通常用于表示旋转(或刚体的方向)，而刚体动力学需要计算方向和时间的积分。所以让我们从第一原则开始：两个单位四元数
\begin_inset Formula $q_{1}q_{0}$
\end_inset

相乘得到一个单位四元数，表示两个旋转的组合。现在假设我们要描述一个以恒定角速度旋转的刚体的方向
\begin_inset Formula $q(t)$
\end_inset

。然后我们可以写
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q(0) & =q_{0}\\
q(1) & =q_{\omega}q_{0}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
式中
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $q_{\omega}$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
表示刚体在一个时间段
\begin_inset Formula $\Delta t$
\end_inset

内的旋转。因为我们有恒定的角速度，我们将有
\begin_inset Formula $q(2)=q_{\omega}q_{\omega}q_{0}=q_{\omega}^{2}q_{0}$
\end_inset

，更普遍地说，通过归纳，对于所有的非负整数 
\begin_inset Formula $k$
\end_inset

，
\begin_inset Formula $q(k)=q_{\omega}^{k}q_{0}$
\end_inset

。所以对于更一般情况的来说，我们希望有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q(t)=q_{\omega}^{t}q_{0}
\]

\end_inset


\end_layout

\begin_layout Standard
现在，
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $q_{\omega}$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
是一个单位四元数，这意味着它可以写成极性形式。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{\omega}=\cos(\theta)+\sin(\theta)(u_{x}i+u_{y}j+u_{z}k)
\]

\end_inset


\end_layout

\begin_layout Standard
其中
\begin_inset Formula $\theta$
\end_inset

是某个旋转角度，
\begin_inset Formula $\mathbf{u}=\left[\begin{array}{ccc}
u_{x} & u_{y} & u_{z}\end{array}\right]$
\end_inset

是表示旋转轴的单位向量。这一部分通常在每个四元数教程中提到。三维向量有对应的纯虚数四元数，单位向量
\begin_inset Formula $\mathbf{u}$
\end_inset

对应的纯四元数为
\begin_inset Formula $u_{x}i+u_{y}j+u_{z}k$
\end_inset

，这在教程里通常也会提到。通常没有提到的是一个重要的信息，即四元数的极性形式实际上只是欧拉公式的四元数版本：任何单位复数
\begin_inset Formula $z$
\end_inset

都可以写成纯虚数的复指数
\begin_inset Formula $z=\exp(i\theta)=\cos(\theta)+i\sin(\theta)$
\end_inset

 ，同样任何单位长度的四元数(尤其是
\begin_inset Formula $q_{\omega}$
\end_inset

)都可以写成纯虚四元数的指数(
\begin_inset Formula $\dfrac{\theta}{2}$
\end_inset

是因为使用
\begin_inset Formula $q\overrightarrow{n}q^{*}$
\end_inset

公式的原因)
\end_layout

\begin_layout Standard

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
\begin_inset Formula 
\[
q_{\omega}=\exp(\dfrac{\theta}{2}\mathbf{u})
\]

\end_inset


\end_layout

\begin_layout Standard
这就给了我们一个自然的定义
\end_layout

\begin_layout Standard

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
\begin_inset Formula 
\[
q_{\omega}^{t}=\exp(t\dfrac{\theta}{2}\mathbf{u})
\]

\end_inset


\end_layout

\begin_layout Standard
现在，如果我们想写一个关于
\begin_inset Formula $q(t)$
\end_inset

随时间变化的微分方程的行为怎么办？只需计算
\begin_inset Formula $q(t)$
\end_inset

的导数，就像计算
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $t$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
的任何其他函数一样。使用一些列推导和乘积规则，我们得到：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}(t)=\dfrac{\mathrm{d}}{\mathrm{d}t}(q_{\omega}^{t}q_{0})=\dfrac{\theta}{2}\mathbf{u}\exp(t\dfrac{\theta}{2}\mathbf{u})q_{0}=\dfrac{\theta}{2}\mathbf{u}q(t)
\]

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\theta$
\end_inset

是在一个时间段
\begin_inset Formula $\Delta t$
\end_inset

内的旋转角度，所以这里它的单位是
\begin_inset Formula $[\mathrm{radian/s}]$
\end_inset

，所以矢量
\begin_inset Formula $\theta\mathbf{u}$
\end_inset

实际上就是三维角速度矢量
\begin_inset Formula $\overrightarrow{\omega}$
\end_inset

，它产生了经常被引用但很少推导出的方程：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\dfrac{1}{2}\overrightarrow{\omega}q
\]

\end_inset


\end_layout

\begin_layout Standard
这个公式在教程和论文里通常是完全没有上下文的引用。特别是，通常没有提到
\begin_inset Formula $q(t)$
\end_inset

描述的是在角速度恒定的情况下刚体的运动方向，这与指数函数相似，是至关重要的。
\end_layout

\begin_layout Section
四元数微分方程推导方法一
\begin_inset Foot
status open

\begin_layout Plain Layout
本节抄录自[4]。略有整理修改。
\end_layout

\end_inset


\end_layout

\begin_layout Standard
四元数微分公式是用角速度矢量
\begin_inset Formula $W(t)$
\end_inset

连接到四元数
\begin_inset Formula $q(t)$
\end_inset

矢量分量的时间导数。四元数
\begin_inset Formula $q(t)=(q_{0}(t),q_{1}(t),q_{2}(t),q_{3}(t))$
\end_inset

确定刚体以一个固定点移动时的姿态，角速度矢量
\begin_inset Formula $W_{X}(t),W_{Y}(t),W_{Z}(t)$
\end_inset

确定物体在时间点
\begin_inset Formula $t$
\end_inset

的角速度。
\end_layout

\begin_layout Standard
四元数
\begin_inset Formula $q(t)$
\end_inset

的范数为单位范数，有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q_{0}^{2}(t)+q_{1}^{2}(t)+q_{2}^{2}(t)+q_{3}^{2}(t)=1\label{eq:6.1}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
矢量
\begin_inset Formula $W(t)$
\end_inset

可以用标量部分为零的四元数表示。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
W(t)=(0,W_{X}(t),W_{Y}(t),W_{Z}(t))\label{eq:6.2}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
四元数微分公式可以表示为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}=\dfrac{1}{2}W(t)q(t)\label{eq:6.3}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
使用四元数乘法规则
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rcr}
\dfrac{\mathrm{d}q_{0}(t)}{\mathrm{d}t} & = & -\dfrac{1}{2}(W_{X}(t)q_{1}(t)+W_{Y}(t)q_{2}(t)+W_{Z}(t)q_{3}(t))\\
\dfrac{\mathrm{d}q_{1}(t)}{\mathrm{d}t} & = & \dfrac{1}{2}(W_{X}(t)q_{0}(t)+W_{Y}(t)q_{3}(t)-W_{Z}(t)q_{2}(t))\\
\dfrac{\mathrm{d}q_{2}(t)}{\mathrm{d}t} & = & \dfrac{1}{2}(W_{Y}(t)q_{0}(t)+W_{Z}(t)q_{1}(t)-W_{X}(t)q_{3}(t))\\
\dfrac{\mathrm{d}q_{3}(t)}{\mathrm{d}t} & = & \dfrac{1}{2}(W_{Z}(t)q_{0}(t)+W_{X}(t)q_{2}(t)-W_{Y}(t)q_{1}(t))
\end{array}\label{eq:6.4}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
下面是公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)简单而强健的推导。
\end_layout

\begin_layout Standard
设
\begin_inset Formula $R_{0}$
\end_inset

为初始时刻，时间点为
\begin_inset Formula $t_{0}$
\end_inset

，固定在刚体上的任意给定矢量(标量部分为零的四元数)，
\begin_inset Formula $R_{t}$
\end_inset

是在时间
\begin_inset Formula $t$
\end_inset

时刻同一个矢量(四元数)。那么，显然
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
R_{t}=q(t)R_{0}q^{-1}(t)\label{eq:6.5}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
如果我们对公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.5"
plural "false"
caps "false"
noprefix "false"

\end_inset

)进行微分
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\mathrm{d}R_{t}}{\mathrm{d}t}=\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}R_{0}q^{-1}(t)+q(t)R_{0}\dfrac{\mathrm{d}q^{-1}(t)}{\mathrm{d}t}\label{eq:6.6}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
从公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.5"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.6"
plural "false"
caps "false"
noprefix "false"

\end_inset

)我们有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\mathrm{d}R_{t}}{\mathrm{d}t}=\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)R_{t}+R_{t}q(t)\dfrac{\mathrm{d}q^{-1}(t)}{\mathrm{d}t}\label{eq:6.7}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $q(t)$
\end_inset

的范数为单位范数，所以
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q(t)q^{-1}(t)=1\label{eq:6.8}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
对上式做微分我们有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)+q(t)\dfrac{\mathrm{d}q^{-1}(t)}{\mathrm{d}t}=0\label{eq:6.9}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
从公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.7"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.9"
plural "false"
caps "false"
noprefix "false"

\end_inset

)我们有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\mathrm{d}R_{t}}{\mathrm{d}t}=\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)R_{t}-R_{t}\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)\label{eq:6.10}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
设
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(t)=\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)\label{eq:6.11}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
明显地
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q^{-1}(t)=S(q^{-1}(t))+V(q^{-1}(t))=q_{0}(t)-(q_{1}(t),q_{2}(t),q_{3}(t))\label{eq:6.12}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
这里
\begin_inset Formula $S()$
\end_inset

表示四元数的标量部分，
\begin_inset Formula $V()$
\end_inset

表示四元数的矢量部分。
\end_layout

\begin_layout Standard
公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)根据四元数乘法计算，四元数
\begin_inset Formula $p(t)$
\end_inset

的标量部分
\begin_inset Formula $S(p(t))$
\end_inset

等于
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
S(p(t))=\dfrac{\mathrm{d}q_{0}(t)}{\mathrm{d}t}q_{0}+\dfrac{\mathrm{d}q_{1}(t)}{\mathrm{d}t}q_{1}+\dfrac{\mathrm{d}q_{2}(t)}{\mathrm{d}t}q_{2}+\dfrac{\mathrm{d}q_{3}(t)}{\mathrm{d}t}q_{3}=0
\]

\end_inset


\end_layout

\begin_layout Standard
这是因为
\begin_inset Formula $q(t)$
\end_inset

的范数为单位范数，
\begin_inset Formula $\left|q(t)\right|^{2}=1$
\end_inset

，不随时间变化，对此求微分就得上述结果。
\end_layout

\begin_layout Standard
由此可知，
\begin_inset Formula $p(t)$
\end_inset

是一个矢量。因为
\begin_inset Formula $R_{t}$
\end_inset

同样也是矢量，所以从纯四元数乘法可得
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(t)R_{t}-R_{t}p(t)=2\left(p(t)\times R_{t}\right)\label{eq:6.13}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
这里
\begin_inset Formula $\left(a\times b\right)$
\end_inset

是矢量
\begin_inset Formula $a$
\end_inset

和矢量
\begin_inset Formula $b$
\end_inset

的叉乘。
\end_layout

\begin_layout Standard
另一方面，变量
\begin_inset Formula $\dfrac{\mathrm{d}R_{t}}{\mathrm{d}t}$
\end_inset

是刚体上的一个点相对于某个固定点的速度(
\begin_inset Formula $\overrightarrow{v}=\overrightarrow{\omega}\times\overrightarrow{r}$
\end_inset

)。由此
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dfrac{\mathrm{d}R_{t}}{\mathrm{d}t}=\left(W(t)\times R_{t}\right)\label{eq:6.14}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $R_{t}$
\end_inset

是任意矢量，从公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.10"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.13"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)由此可知，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
W(t)=2p(t)=2\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)\label{eq:6.15}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
从公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.15"
plural "false"
caps "false"
noprefix "false"

\end_inset

)最终可得公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}=\dfrac{1}{2}W(t)q(t)
\]

\end_inset


\end_layout

\begin_layout Standard
这里有必要提醒：在公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)中的角速度矢量
\begin_inset Formula $W(t)=W_{X}(t),W_{Y}(t),W_{Z}(t)$
\end_inset

是在固定世界坐标系轴上的投影表示。如果我们应用同一角速度矢量在运动世界坐标系轴上的投影，明显地有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
(0,W_{X}(t),W_{Y}(t),W_{Z}(t))=q(t)(0,W_{x}(t),W_{y}(t),W_{z}(t))q^{-1}(t)\label{eq:6.16}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
其中
\begin_inset Formula $W_{x}(t),W_{y}(t),W_{z}(t)$
\end_inset

是角速度矢量在运动世界坐标系轴上的投影。
\end_layout

\begin_layout Standard
从公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.16"
plural "false"
caps "false"
noprefix "false"

\end_inset

)由此可知
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\dfrac{\mathrm{d}q(t)}{\mathrm{d}t} & =\dfrac{1}{2}q(t)\overline{W}(t)\\
\overline{W}(t) & =(W_{x}(t),W_{y}(t),W_{z}(t))
\end{array}\label{eq:6.17}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
最后，考虑公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.17"
plural "false"
caps "false"
noprefix "false"

\end_inset

)的示例用于所谓的二次曲线移动。在这种情况下，四元数
\begin_inset Formula $q(t)$
\end_inset

等于：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
q(t) & =(\cos(\dfrac{\beta}{2}),\sin(\dfrac{\beta}{2})(\cos(\omega t),\sin(\omega t),0))\\
q^{-1}(t) & =(\cos(\dfrac{\beta}{2}),-\sin(\dfrac{\beta}{2})(\cos(\omega t),\sin(\omega t),0))\\
\dfrac{\mathrm{d}q(t)}{\mathrm{d}t} & =(0,\omega\sin(\dfrac{\beta}{2})(-\sin(\omega t),\cos(\omega t),0))
\end{array}\label{eq:6.18}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
相应地，公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.17"
plural "false"
caps "false"
noprefix "false"

\end_inset

)角速度矢量在固定世界坐标系和运动世界坐标系轴上的投影等于：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
(W_{X}(t),W_{Y}(t),W_{Z}(t)) & =2\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}q^{-1}(t)\\
 & =(-\omega\sin(\beta)\sin(\omega t),\omega\sin(\beta)\cos(\omega t),\omega(1-\ensuremath{\cos}(\beta)))\\
(W_{x}(t),W_{y}(t),W_{z}(t)) & =2q^{-1}(t)\dfrac{\mathrm{d}q(t)}{\mathrm{d}t}\\
 & =(-\omega\sin(\beta)\sin(\omega t),\omega\sin(\beta)\cos(\omega t),\omega(\cos(\beta)-1))
\end{align*}

\end_inset


\end_layout

\begin_layout Section
四元数微分方程推导方法二
\begin_inset Foot
status open

\begin_layout Plain Layout
本节抄录自文档[5]附录B。略有整理修改。
\end_layout

\end_inset


\end_layout

\begin_layout Standard
假设给出的四元数
\begin_inset Formula $q$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=q_{0}+\mathbf{q}=q_{0}+q_{1}i+q_{2}j+q_{3}k
\]

\end_inset


\end_layout

\begin_layout Standard
是时间
\begin_inset Formula $t$
\end_inset

的函数。则对
\begin_inset Formula $q(t)$
\end_inset

求导有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}=\dot{q_{0}}+\dot{\mathbf{q}}=\dot{q_{0}}+\dot{q_{1}}\hat{i}+\dot{q_{2}}\hat{j}+\dot{q_{3}}\hat{k}
\]

\end_inset


\end_layout

\begin_layout Standard
设另一个四元数 
\begin_inset Formula $p(t)$
\end_inset

也是时间
\begin_inset Formula $t$
\end_inset

的函数，则乘积为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
pq=\left[p_{0}q_{0}-\mathbf{p}\cdot\mathbf{q},p_{0}\mathbf{q}+q_{0}\mathbf{p}+\mathbf{p}\times\mathbf{q}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
乘积关于时间
\begin_inset Formula $t$
\end_inset

求导为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dfrac{\mathrm{d}}{\mathrm{d}t}(pq)=\dot{p}q+p\dot{q}
\]

\end_inset


\end_layout

\begin_layout Standard
从而可以对四元数的四个分量进行积分。
\end_layout

\begin_layout Standard
当
\begin_inset Formula $q(t)$
\end_inset

是一个单位四元数时，微分变得更加复杂，这将在本节后面部分进行讨论。在这种情况下，四元数函数
\begin_inset Formula $q(t)$
\end_inset

描述了由其机体坐标系表示的某个移动对象的方向如何相对于固定(世界)坐标系变化。设
\begin_inset Formula $\omega(t)$
\end_inset

为机体坐标系相对于世界坐标系的角速度。角速度可以由牛顿动力学方程确定。如何描述
\begin_inset Formula $q(t)$
\end_inset

的变化率，即其导数
\begin_inset Formula $\dot{q}(t)$
\end_inset

的特征？
\end_layout

\begin_layout Paragraph
定理：
\end_layout

\begin_layout Standard
令 
\begin_inset Formula $q(t)$
\end_inset

是一个单位四元数函数，
\begin_inset Formula $\text{\ensuremath{\omega(t)}}$
\end_inset

是由
\begin_inset Formula $q(t)$
\end_inset

确定的角速度。则
\begin_inset Formula $q(t)$
\end_inset

的导数为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dot{q}=\dfrac{1}{2}\omega q\label{eq:6.22}
\end{equation}

\end_inset


\end_layout

\begin_layout Paragraph
证明：
\end_layout

\begin_layout Standard
在
\begin_inset Formula $t+\Delta t$
\end_inset

 时刻，旋转可以描述为
\begin_inset Formula $q(t+\Delta t)$
\end_inset

。在
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\Delta t$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
过程中，机体坐标系在经过了
\begin_inset Formula $q(t)$
\end_inset

旋转的前提下，又经过了额外的微小旋转。这个额外的微小旋转的瞬时旋转轴为
\begin_inset Formula $\hat{\omega}=\omega/|\omega|$
\end_inset

 ，旋转角度为 
\begin_inset Formula $\Delta\theta=|\omega|\Delta t$
\end_inset

，可以用一个单位四元数描述：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align}
\Delta q & =\cos\dfrac{\Delta\theta}{2}+\hat{\omega}\sin\dfrac{\Delta\theta}{2}\nonumber \\
 & =\cos\dfrac{|\omega|\Delta t}{2}+\hat{\omega}\sin\dfrac{|\omega|\Delta t}{2}\label{eq:6.23}
\end{align}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $t+\Delta t$
\end_inset

 时刻的旋转可以描述成四元数序列
\begin_inset Formula $q(t),\Delta q$
\end_inset

，表明：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
q(t+\Delta t)=\Delta qq(t)\label{eq:6.24}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
接下来推导 
\begin_inset Formula $\dot{q}$
\end_inset

，首先从公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.23"
plural "false"
caps "false"
noprefix "false"

\end_inset

)(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.24"
plural "false"
caps "false"
noprefix "false"

\end_inset

)求差值：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q(t+\Delta t)-q(t) & =(\cos\dfrac{|\omega|\Delta t}{2}+\hat{\omega}\sin\dfrac{|\omega|\Delta t}{2})q(t)-q(t)\\
 & =-2\sin^{2}\dfrac{|\omega|\Delta t}{4}q(t)+\hat{\omega}\sin\dfrac{|\omega|\Delta t}{2}q(t)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
上面最后一个等式中的第一项的阶数高于
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\Delta t$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
，因此它与
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\Delta t$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
的比值在后面近于
\begin_inset Formula $0$
\end_inset

。因此
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align}
\dot{q}(t) & =\lim\limits _{\Delta t\to0}\dfrac{q(t+\Delta t)-q(t)}{\Delta t}\nonumber \\
 & =\hat{\omega}\lim\limits _{\Delta t\to0}\dfrac{\sin\left(\dfrac{|\omega|\Delta t}{2}\right)}{\Delta t}q(t)\nonumber \\
 & =\hat{\omega}\dfrac{\mathrm{d}}{\mathrm{d}t}\left.\sin\left(\dfrac{|\omega|t}{2}\right)\right|_{t=0}q(t)\label{eq:6.25}\\
 & =\hat{\omega}\dfrac{|\omega|}{2}q(t)\nonumber \\
 & =\dfrac{1}{2}\omega(t)q(t)\label{eq:6.26}
\end{align}

\end_inset


\end_layout

\begin_layout Standard
如果
\begin_inset Formula $\dot{q}$
\end_inset

是已知的，我们可以用它的导数公式两边右乘
\begin_inset Formula $q^{*}$
\end_inset

得到角速度：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\omega=2\dot{q}q^{*}\label{eq:6.27}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
四元数的二阶导数用它的导数公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.22"
plural "false"
caps "false"
noprefix "false"

\end_inset

)求得：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align}
\ddot{q} & =\dfrac{1}{2}\left(\dot{\omega}q+\omega\dot{q}\right)\label{eq:6.28}\\
 & =\dfrac{1}{2}\dot{\omega}q+\dfrac{1}{4}\omega\omega q\nonumber \\
 & =\left(-\dfrac{1}{4}\left|\omega\right|^{2}+\dfrac{1}{2}\dot{\omega}\right)q\nonumber 
\end{align}

\end_inset


\end_layout

\begin_layout Standard
如果
\begin_inset Formula $q$
\end_inset

的一阶和二阶导数都已知，我们也可以得到角加速度。这是通过将公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.28"
plural "false"
caps "false"
noprefix "false"

\end_inset

)右乘
\begin_inset Formula $q^{*}$
\end_inset

来实现的：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\dot{\omega} & =2\ddot{q}q^{*}-\omega\dot{q}q^{*}\\
 & =2\ddot{q}q^{*}-2\dot{q}q^{*}\dot{q}q^{*}\\
 & =2\left(\ddot{q}q^{*}-\left(\dot{q}q^{*}\right)^{2}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在力学中，一个刚体在任何时刻的角速度通常是相对于一个固定坐标系来描述的，这个固定坐标系与它的机体坐标系是瞬间重合的
\begin_inset Foot
status open

\begin_layout Plain Layout
因此，在不同的时间瞬间，由于机体坐标系的旋转，是在不同的随之旋转的固定坐标系中测量角速度。
\end_layout

\end_inset

。我们经常说的角速度是依据机体坐标系来说的。它被标记为
\begin_inset Formula $\tilde{\omega}$
\end_inset

̃，通过旋转世界坐标系，从
\begin_inset Formula $\omega$
\end_inset

中得到，使其与由
\begin_inset Formula $q$
\end_inset

确定的旋转坐标系重合。这建立了方程
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\tilde{\omega}=q^{*}\omega q
\]

\end_inset


\end_layout

\begin_layout Standard
结合上述，我们得到了四元数导数的另一个表达式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}=\dfrac{1}{2}q\tilde{\omega}
\]

\end_inset


\end_layout

\begin_layout Standard
上述微分方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:6.22"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可以用数值积分求解。令
\begin_inset Formula $h$
\end_inset

为时间步长，
\begin_inset Formula $q_{k}$
\end_inset

和
\begin_inset Formula $\omega_{k}$
\end_inset

是
\begin_inset Formula $kh$
\end_inset

时刻的四元数和角速度。则在下一时刻的四元数用欧拉方法近似为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{k+1}=q_{k}+\dfrac{1}{2}h\omega_{k}q_{k}
\]

\end_inset


\end_layout

\begin_layout Standard
由于增量计算，
\begin_inset Formula $q_{k+1}$
\end_inset

不一定是单位四元数，所以需要规范化为单位四元数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{k+1}\leftarrow\dfrac{q_{k+1}}{|q_{k+1}|}
\]

\end_inset


\end_layout

\begin_layout Standard
欧拉方法是一阶的，由于截断误差的存在，欧拉方法是不精确的，它会传播到后续的归一化过程中。要想更高的精度，可以采用Adams-Bashforth和Runge-Ku
tta等高阶标准积分方法。四元数的特殊积分方法也被开发出来，并被证明是更有效的。有些文献对这些方法的进行了调查和性能比较，参见文档[5]中的参考资料。
\end_layout

\begin_layout Section
工程应用
\end_layout

\begin_layout Standard
前面我们得到了四元数微分方程：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\dfrac{1}{2}\overrightarrow{\omega}q
\]

\end_inset


\end_layout

\begin_layout Standard
值得注意的是，角速度矢量
\begin_inset Formula $\overrightarrow{\omega}$
\end_inset

是在固定世界坐标系轴上的投影表示。如果我们应用同一角速度矢量在运动世界坐标系轴上的投影
\begin_inset Formula $\overrightarrow{\tilde{\omega}}$
\end_inset

，明显地有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\overrightarrow{\omega}=q\overrightarrow{\tilde{\omega}}q^{-1}
\]

\end_inset


\end_layout

\begin_layout Standard
所以有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dot{q}=\dfrac{\mathrm{d}q}{\mathrm{d}t}=\dfrac{1}{2}\overrightarrow{\omega}q=\dfrac{1}{2}q\overrightarrow{\tilde{\omega}}
\]

\end_inset


\end_layout

\begin_layout Standard
因为从 IMU 测量得到的角速度矢量是
\begin_inset Formula $\overrightarrow{\tilde{\omega}}$
\end_inset

，所以上述方程在工程中更常使用。
\end_layout

\begin_layout Standard
\begin_inset Formula $ $
\end_inset


\end_layout

\begin_layout Standard
假设我们已知刚体在时间
\begin_inset Formula $t$
\end_inset

时的姿态为单位四元数
\begin_inset Formula $q(t)=[q_{0},q_{1},q_{2},q_{3}]$
\end_inset

。经过时间
\begin_inset Formula $\Delta t$
\end_inset

，刚体的姿态发生了变化，用
\begin_inset Formula $q(t+\Delta t)=[q'_{0},q'_{1},q'_{2},q'_{3}]$
\end_inset

表示时间
\begin_inset Formula $t+\Delta t$
\end_inset

时的姿态。因为
\begin_inset Formula $\Delta t$
\end_inset

很小，我们假定这段时间里刚体的角速度恒定，根据微分方程得到的一阶近似方程：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\dfrac{q(t+\Delta t)-q(t)}{\Delta t}=\Delta q
\]

\end_inset


\end_layout

\begin_layout Standard
做积分：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q(t+\Delta t)-q(t)=\Delta q\Delta t
\]

\end_inset


\end_layout

\begin_layout Standard
所以有：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q(t+\Delta t)=\Delta q\Delta t+q(t)
\]

\end_inset


\end_layout

\begin_layout Standard
所以
\begin_inset Formula $t+\Delta t$
\end_inset

时刻的新姿态
\begin_inset Formula $q(t+\Delta t)$
\end_inset

近似为
\begin_inset Formula $t$
\end_inset

时刻的旧姿态
\begin_inset Formula $q(t)$
\end_inset

与姿态变化量
\begin_inset Formula $\Delta q\Delta t$
\end_inset

的叠加。
\end_layout

\begin_layout Standard
\begin_inset Formula $ $
\end_inset


\end_layout

\begin_layout Standard
根据前面得到的微分方程
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\Delta q=\dfrac{1}{2}q(t)\overrightarrow{\tilde{\omega}}
\]

\end_inset


\end_layout

\begin_layout Standard
我们把在
\begin_inset Formula $t+\Delta t$
\end_inset

时刻测量到的角速度矢量
\begin_inset Formula $\overrightarrow{\tilde{\omega}}$
\end_inset

，表示为一个纯四元数：
\begin_inset Formula $\overrightarrow{\tilde{\omega}}=(0,\omega_{x},\omega_{y},\omega_{z})$
\end_inset

。
\end_layout

\begin_layout Standard
根据四元数乘法定义
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q\omega & =(q_{0}+q_{1}i+q_{2}j+q_{3}k)(\omega_{0}+\omega_{x}i+\omega_{y}j+\omega_{z}k)\\
 & =\left[\begin{array}{c}
q_{0}\omega_{0}-q_{1}\omega_{x}-q_{2}\omega_{y}-q_{3}\omega_{z}\\
q_{0}\omega_{x}+q_{1}\omega_{0}+q_{2}\omega_{z}-q_{3}\omega_{y}\\
q_{0}\omega_{y}-q_{1}\omega_{z}+q_{2}\omega_{0}+q_{3}\omega_{x}\\
q_{0}\omega_{z}+q_{1}\omega_{y}-q_{2}\omega_{x}+q_{3}\omega_{0}
\end{array}\right]\\
 & =\left[\begin{array}{cccc}
\omega_{0} & -\omega_{x} & -\omega_{y} & -\omega_{z}\\
\omega_{x} & \omega_{0} & \omega_{z} & -\omega_{y}\\
\omega_{y} & -\omega_{z} & \omega_{0} & \omega_{x}\\
\omega_{z} & \omega_{y} & -\omega_{x} & \omega_{0}
\end{array}\right]\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
因为
\begin_inset Formula $\omega_{0}=0$
\end_inset

，所以
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\Delta q=\dfrac{1}{2}\left[\begin{array}{cccc}
0 & -\omega_{x} & -\omega_{y} & -\omega_{z}\\
\omega_{x} & 0 & \omega_{z} & -\omega_{y}\\
\omega_{y} & -\omega_{z} & 0 & \omega_{x}\\
\omega_{z} & \omega_{y} & -\omega_{x} & 0
\end{array}\right]\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
所以
\begin_inset Formula $q(t+\Delta t)$
\end_inset

的一阶近似值为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left[\begin{array}{c}
q'_{0}\\
q'_{1}\\
q'_{2}\\
q'_{3}
\end{array}\right]=\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]+\dfrac{1}{2}\Delta t\left[\begin{array}{cccc}
0 & -\omega_{x} & -\omega_{y} & -\omega_{z}\\
\omega_{x} & 0 & \omega_{z} & -\omega_{y}\\
\omega_{y} & -\omega_{z} & 0 & \omega_{x}\\
\omega_{z} & \omega_{y} & -\omega_{x} & 0
\end{array}\right]\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
其中：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
M=\left[\begin{array}{cccc}
0 & -\omega_{x} & -\omega_{y} & -\omega_{z}\\
\omega_{x} & 0 & \omega_{z} & -\omega_{y}\\
\omega_{y} & -\omega_{z} & 0 & \omega_{x}\\
\omega_{z} & \omega_{y} & -\omega_{x} & 0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
被称为旋转矩阵
\begin_inset Formula $M$
\end_inset

。
\end_layout

\begin_layout Standard
\begin_inset Formula $ $
\end_inset


\end_layout

\begin_layout Standard
由于是增量计算，
\begin_inset Formula $q(t+\Delta t)$
\end_inset

不一定是单位四元数，所以需要规范化为单位四元数以便下一个周期使用：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q(t+\Delta t)\leftarrow\dfrac{q(t+\Delta t)}{|q(t+\Delta t)|}
\]

\end_inset


\end_layout

\begin_layout Standard
周而复始，就可以估计刚体的下一个时刻的姿态了。
\end_layout

\begin_layout Chapter
四元数旋转的解释
\end_layout

\begin_layout Standard
使用四元数最大的问题可能是它们很难理解。所有的初学者在如何理解四元数与旋转的关系这个问题上，无一例外都会碰到大麻烦。许多教材和资料试图讲明白这个问题。结果是写的
人很费劲，看的人更迷糊。本文也试图在这方面添一把乱，说一说曾经遇到过的和现在还在迷惑的问题。
\end_layout

\begin_layout Standard
文档[1]是我见过的说得最清晰明了的教材，用最简单的数学概念，只用了复数和复平面(二维空间)、三维空间与向量、矩阵这几个概念就说清楚了四元数旋转三维向量的几何意
义。很值得给初学者推荐。本文的前2~4章，基本上就是抄录自文档[1][2]。但是这个教材所讨论的范围也是有局限性的。
\end_layout

\begin_layout Section
传统解释的冲突
\end_layout

\begin_layout Standard
用四元数表达旋转很难理解，不在于它的不直观(经过无数人的努力，用三角函数表示的单位四元数的乘积形式已经很直观了)，也不在于我们赋予它的意义有多难理解，而是在于这
些意义或概念要是一以惯之的话就会有很多冲突。这也反应了我们这些初学者对旋转的本质认识不足。
\end_layout

\begin_layout Standard
例如，对于
\begin_inset Formula $qpq^{*}$
\end_inset

公式，如果
\begin_inset Formula $q$
\end_inset

用轴-角(Axis-angle)方式解释，表达一个旋转角度和旋转轴。那么
\begin_inset Formula $p$
\end_inset

按照这种解释，也有一个旋转角度和旋转轴。两个旋转用乘法叠加，就成了另外一种旋转。这时，向量映射过来的四元数
\begin_inset Formula $p$
\end_inset

，一般实部为
\begin_inset Formula $0$
\end_inset

。按照轴-角方式解释，所谓的三维空间向量，因为
\begin_inset Formula $\cos(\theta)=0$
\end_inset

，都自带
\begin_inset Formula $90^{\circ}$
\end_inset

旋转角的属性。又例如，只有实部为
\begin_inset Formula $0$
\end_inset

才是可见的三维空间向量。那么
\begin_inset Formula $q$
\end_inset

做为表征旋转的单位四元数，大多数情况下
\begin_inset Formula $\cos(\theta)\neq0$
\end_inset

，那么
\begin_inset Formula $q$
\end_inset

就是不可见的。于是
\begin_inset Formula $qpq^{*}$
\end_inset

公式玄幻的解释就成了：要想让
\begin_inset Formula $p$
\end_inset

旋转，需要来自神秘空间的
\begin_inset Formula $q$
\end_inset

正反两面撞一下，
\begin_inset Formula $p$
\end_inset

就旋转到位了。撞一下还不行，只撞一下
\begin_inset Formula $p$
\end_inset

就转到另外一个神秘空间里去了。这个超出了我们日常的直觉。
\end_layout

\begin_layout Standard
又例如，在四元数中代表数量
\begin_inset Formula $1$
\end_inset

的写法是
\begin_inset Formula $\left[1,0,0,0\right]$
\end_inset

。如果按照轴-角方式解释，表示的是对任意旋转轴旋转
\begin_inset Formula $0^{\circ}$
\end_inset

，因此这被称为特征旋转(identity rotation)。在姿态表示中，用欧拉角翻译过来就是：飞机机身位于水平面，机翼没有翻转，机头对着正北方向，这是初始化
姿态。但是，姿态四元数用的是4个参数，而且变化姿态时，也可以不用
\begin_inset Formula $qpq^{*}$
\end_inset

公式。
\end_layout

\begin_layout Standard
在解释
\begin_inset Formula $qpq^{*}$
\end_inset

为什么会拆分成两个
\begin_inset Formula $\dfrac{1}{2}\theta$
\end_inset

时，解释就更费劲了。还有一种观点谈到四元数是在四维空间做旋转，所以需要将实部写为
\begin_inset Formula $0$
\end_inset

才能表示三维空间的旋转。这种说法是令人疑惑的。让人看不懂的数学专业解释是四元数所在的群为
\begin_inset Formula $S^{3}$
\end_inset

，而四元数所代表的三维旋转是
\begin_inset Formula $SO(3)$
\end_inset

，前者是后者的两倍覆盖。
\end_layout

\begin_layout Standard
另外，表示旋转的单位四元数不是向量，而是群，因为只有乘法是封闭的。因为对4维的四元数附加
\begin_inset Formula $s^{2}+x^{2}+y^{2}+z^{2}=1$
\end_inset

这个约束，使得4维的四元数可以表示3维旋转。但也是因为这个约束，单位四元数不是向量，因此也就不能直接被卡尔曼滤波器估计，所有直接用卡尔曼滤波器估计姿态四元数和旋
转矩阵的，在数学上都有问题。
\end_layout

\begin_layout Standard
如果说复数是“实数的复数”。相应的，四元数可以看做“复数的复数”。回顾四元数的一般形式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{cc}
q=s+xi+yj+zk & s,x,y,z\in\mathbb{R}\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
以及：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
i^{2}=j^{2}=k^{2}=ijk=-1
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\begin{array}{ccc}
ij=k & jk=i & ki=j\\
ji=-k & kj=-i & ik=-j
\end{array}
\]

\end_inset


\end_layout

\begin_layout Standard
我们做变形：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q & =s+xi+yj+zk\\
 & =s+xi+yj+z(ij)\\
 & =(s+xi)+(y+zi)j
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
令：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
a & =s+xi\\
b & =y+zi
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
则：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=a+bj
\]

\end_inset


\end_layout

\begin_layout Standard
这里就很有趣。两个正交的复数系统相撞是什么？
\begin_inset Formula $ij=?$
\end_inset


\begin_inset Formula $\:$
\end_inset

如果
\begin_inset Formula $ij=-1$
\end_inset

，则就成了三元数，然后在运算上就有各种问题[10]。Hamilton先生想这个问题想了十五年，终于在路过一条桥上时一下子想明白了，
\begin_inset Formula $ij=k$
\end_inset

，引入第三个正交的复数系统，用3个复数表示三维空间，而将实数排除在三维空间的坐标轴之外，这就是四元数。四元数是处理旋转的好工具，但是在如何形象理解实部和虚部的关
系，以及形象理解旋转这些问题上，让后来者吃尽了苦头。
\end_layout

\begin_layout Standard
四元数是二重向量(bivector)，而不是向量。和通常意义所说的4参数向量构成的4D空间还是有区别的。
\end_layout

\begin_layout Section
应用中概念的冲突
\end_layout

\begin_layout Standard
如果看姿态估计的资料和论文，这是应用四元数最多的地方之一。初学者在这里会发现很多和教材上的概念的冲突。在资料和论文里，那些牛人大佬们都惜墨如金，稍微透露几个概念
，挂一漏万的，然后就抛出几十个公式，带你闯世界，带你欢乐带你飞。
\end_layout

\begin_layout Standard
在这其中，有些会简略介绍四元数和旋转，三维向量要做成纯四元数，实部写
\begin_inset Formula $0$
\end_inset

，就可以用
\begin_inset Formula $qpq^{*}$
\end_inset

计算旋转了。然后后面就开始不声不响用4参数的姿态四元数，用微分方程推导出来的四元数加法算法计算旋转。说好的3参数纯四元数在哪里？说好的用
\begin_inset Formula $qpq^{*}$
\end_inset

计算旋转在哪里？
\end_layout

\begin_layout Standard
还有一些论文使用旋转向量(Gibbs Vector / Rodrigues Parameters)构造旋转四元数
\begin_inset Formula $q$
\end_inset

[7][8][9]。大佬们最后会很简单地在实部写
\begin_inset Formula $1$
\end_inset

，然后用
\begin_inset Formula $q^{*}pq$
\end_inset

计算旋转。不是说一定要用单位四元数才能计算旋转么？不是说只有单位四元数才能表达旋转么？
\end_layout

\begin_layout Standard
还有一个介绍四元数微分概念的小文章里[3]，开头最重要也最难懂的一句话就是：“我假设你知道，两个单位四元数
\begin_inset Formula $q_{1}q_{0}$
\end_inset

相乘得到一个单位四元数，表示两个旋转的组合。” 这个要当场晕倒。说好的要操作的向量在哪里呢？通篇文章里连向量都不出现了。
\end_layout

\begin_layout Standard
这就是本文第4章和第5~6章之间表面的冲突。实际上在这两种应用中处理的旋转对象不一样。前者是在一个三维空间中旋转一个三维向量；后者是在一个三维空间(参考坐标系/
固定坐标系)中旋转另外一个三维空间(机体坐标系)。实际上，四元数的加法和乘法都可以旋转，单次加法和乘法都在旋转，只是效果不一样。各路大神牛人，就是要找到对某种问
题的一个计算最简便的方法。
\end_layout

\begin_layout Section
\begin_inset Formula $qpq^{*}$
\end_inset

公式的计算特点
\end_layout

\begin_layout Standard
我们通常所说的旋转，指的是向量绕旋转轴旋转任意角度过后，向量的模长和夹角没有发生变化。计算旋转，并不只有
\begin_inset Formula $qpq^{*}$
\end_inset

这一种方式。
\begin_inset Formula $qpq^{*}$
\end_inset

这种方式，只是最简洁最直观的方式。这种连乘方式，是一种工具，类似于量子力学中的量子概念，是一个不可拆分的整体(遇事不决，量子力学)。拆分成两个
\begin_inset Formula $\dfrac{1}{2}\theta$
\end_inset

，是算法上的需要，不需要强行解释。因为我们一定可以找到一个四元数
\begin_inset Formula $q'$
\end_inset

，一次乘法就可以达到旋转
\begin_inset Formula $\theta$
\end_inset

角而向量模长和夹角不变的这种要求。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
p' & =qpq^{*}\\
p' & =q'p\\
q'p & =qpq^{*}\\
q'pp^{-1} & =qpq*p^{-1}\\
q' & =qpq*p^{-1}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
这时候不会再有两个
\begin_inset Formula $\dfrac{1}{2}\theta$
\end_inset

的拆分，不会再有四维空间天外飞仙的解释。如果用解释
\begin_inset Formula $qpq^{*}$
\end_inset

的方法解释这个
\begin_inset Formula $q'$
\end_inset

，就会很怪异。只是因为这个四元数
\begin_inset Formula $q'$
\end_inset

很难构造，构造出来也极为复杂难看，一般不会是单位四元数，既找不到旋转轴也找不到旋转角，所以没有任何研究价值
\begin_inset Foot
status open

\begin_layout Plain Layout
这个乘积形式很难构造出来，但是一次乘法的矩阵形式很容易构造出来，就是那个
\begin_inset Formula $4\times4$
\end_inset

的3D旋转矩阵。这个矩阵太复杂了，似乎就没有人从这里去解释旋转角为
\begin_inset Formula $\dfrac{1}{2}\theta$
\end_inset

的问题了。
\end_layout

\end_inset

。所以在旋转向量时，大家都用最简洁最直观的
\begin_inset Formula $qpq^{*}$
\end_inset

方式，但在解释拆分的两个
\begin_inset Formula $\dfrac{1}{2}\theta$
\end_inset

又犯了难。
\end_layout

\begin_layout Standard
非单位四元数用
\begin_inset Formula $qpq^{*}$
\end_inset

方式也可以旋转向量，只是模长发生了变化。用
\begin_inset Formula $qpq^{*}$
\end_inset

公式计算，
\begin_inset Formula $p$
\end_inset

的模长缩放了
\begin_inset Formula $\left|q\right|^{2}$
\end_inset

倍。因为表示误差的旋转向量(Gibbs Vector / Rodrigues Parameters)通常都很小，所以尽管构造出来的四元数实部写
\begin_inset Formula $1$
\end_inset

，造成的后果就是表示误差的误差，在误差范围以内。
\end_layout

\begin_layout Standard
这时候我们回头看
\begin_inset Formula $qpq^{*}$
\end_inset

方式的运算特点。根据3D旋转的矩阵形式：
\end_layout

\begin_layout Standard
设：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=s+xi+yj+zk,\left|q\right|=1
\]

\end_inset


\end_layout

\begin_layout Standard
则有公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.28"
plural "false"
caps "false"
noprefix "false"

\end_inset

)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
p'=qpq^{*}=\left[\begin{array}{cccc}
1 & 0 & 0 & 0\\
0 & 1-2y^{2}-2z^{2} & 2xy-2sz & 2sy+2xz\\
0 & 2xy+2sz & 1-2x^{2}-2z^{2} & 2yz-2sx\\
0 & 2xz-2sy & 2sx+2yz & 1-2x^{2}-2y^{2}
\end{array}\right]p
\]

\end_inset


\end_layout

\begin_layout Standard
可以确定最终结果
\begin_inset Formula $p'$
\end_inset

中：
\end_layout

\begin_layout Itemize
实部：完全由
\begin_inset Formula $p$
\end_inset

的实部贡献，也就是
\begin_inset Formula $p'$
\end_inset

的实部与
\begin_inset Formula $p$
\end_inset

的实部相等。整个
\begin_inset Formula $q$
\end_inset

的实部和虚部，
\begin_inset Formula $p$
\end_inset

的虚部对此都没有任何影响。
\end_layout

\begin_layout Itemize
虚部：
\begin_inset Formula $p$
\end_inset

的实部对此没有任何影响。完全由
\begin_inset Formula $q$
\end_inset

的实部和虚部，
\begin_inset Formula $p$
\end_inset

的虚部进行运算。
\end_layout

\begin_layout Standard
如果从
\begin_inset Formula $qpq^{*}$
\end_inset

计算结果的模长看(假设
\begin_inset Formula $r$
\end_inset

是第一步乘法的结果)：
\end_layout

\begin_layout Itemize
每步的结果都保证模长不变，
\begin_inset Formula $\left|p\right|=\left|r\right|=\left|p'\right|$
\end_inset

。这个符合单位四元数乘法的规则。
\end_layout

\begin_layout Itemize
第一步的时候，变化扩散到了整个四元数的实部和虚部。
\end_layout

\begin_layout Itemize
第二步的时候，限定了
\begin_inset Formula $p'$
\end_inset

的实部与
\begin_inset Formula $p$
\end_inset

的实部相等。这也意味着
\begin_inset Formula $p'$
\end_inset

的虚部(向量部分)模长与
\begin_inset Formula $p$
\end_inset

的相等。这意味着向量
\begin_inset Formula $p'$
\end_inset

和
\begin_inset Formula $p$
\end_inset

的所在的三维空间是一样的。
\end_layout

\begin_layout Standard
\begin_inset Formula $qpq^{*}$
\end_inset

公式的处理对象是四元数的虚部，能把运算结果限制在虚部里。也就是，我们把外部的三维向量映射进四元数的虚部，以及从四元数的虚部映射到外部的三维向量，就没有用到四元数
的实部。此时该四元数的实部无意义，可以填写任何数字而不只是
\begin_inset Formula $0$
\end_inset

。如果要类比，就是在计算过程中，实部该区域类似计算机里的临时缓冲区，可以存放中间结果。完成计算后该数字没有变化。如果该数字有变化，说明有信息溢出到实部里。如果这
时只取出虚部映射到外部的三维向量，则有信息遗漏，所以解析出来的向量就是错误的。
\end_layout

\begin_layout Section
对四元数旋转理解的困难
\begin_inset CommandInset label
LatexCommand label
name "sec:对四元数旋转理解的困难"

\end_inset


\end_layout

\begin_layout Standard
这里我们用几张图来感性地理解这个问题，并且来理解为什么理解这个问题这么困难。
\end_layout

\begin_layout Standard
如果说复数可以用复平面(complex plane)来表示，我们也借助类似的概念画出一个四元数平面。设有单位四元数
\begin_inset Formula $q=\left[s,\mathbf{r}\right],\mathbf{r}=\left[x,y,z\right]$
\end_inset

，两者的关系如图7.1。
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure7.1.eps

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Quaternions plane
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
可以看到，类似于复平面，随着实数
\begin_inset Formula $s$
\end_inset

的变化，
\begin_inset Formula $\mathbf{r}$
\end_inset

也在四元数平面上旋转。
\begin_inset Formula $\mathbf{r}$
\end_inset

是一个代表三维空间的圆球的半径。因为是用二维平面表示四元数，所以这个圆球以及里面所有的向量都被折叠成一条线段，只剩下模长这个数值量。这个圆球的半径
\begin_inset Formula $\mathbf{r}$
\end_inset

会随着
\begin_inset Formula $s$
\end_inset

的变化而进行缩放，就像一个气球膨胀或缩小一样。相应的，圆球里面的三维向量
\begin_inset Formula $\mathbf{v}$
\end_inset

的模长也会随之发生变化。
\end_layout

\begin_layout Standard
单位四元数又可以表示为
\begin_inset Formula $q=\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]$
\end_inset

。如果我们用这个单位四元数去逆时针旋转一个向量
\begin_inset Formula $v=[0,\mathbf{v}]$
\end_inset

，则为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v' & =qv\\
 & =\left[\cos(\theta),\sin(\theta)\mathbf{u}\right]\left[0,\mathbf{v}\right]\\
 & =\left[-\sin(\theta)\mathbf{u}\cdot\mathbf{v},\cos(\theta)\mathbf{v}+\sin(\theta)\mathbf{u}\times\mathbf{v}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
设向量
\begin_inset Formula $\mathbf{v}$
\end_inset

和旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

的夹角为
\begin_inset Formula $\phi$
\end_inset

，则新向量
\begin_inset Formula $\mathbf{v}'=\cos(\theta)\mathbf{v}+\sin(\theta)\mathbf{u}\times\mathbf{v}$
\end_inset

和旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

的夹角关系为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\mathbf{u}\cdot\mathbf{v}' & =\mathbf{u}\cdot\left(\cos(\theta)\mathbf{v}+\sin(\theta)\mathbf{u}\times\mathbf{v}\right)\\
 & =\mathbf{u}\cdot\mathbf{v}\cos(\theta)+\sin(\theta)\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right)\\
 & \{\because\mathbf{u},\mathbf{v}\perp\left(\mathbf{u}\times\mathbf{v}\right)\therefore\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0,\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0\}\\
 & =\mathbf{u}\cdot\mathbf{v}\cos(\theta)\\
 & \{\because\mathbf{u}\cdot\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\cos(\phi),\left|\mathbf{u}\right|=1\}\\
 & =\left|\mathbf{v}\right|\cos(\phi)\cos(\theta)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以新的夹角
\begin_inset Formula $\phi'$
\end_inset

发生了变化，和旋转角
\begin_inset Formula $\theta$
\end_inset

的三角函数相关。
\end_layout

\begin_layout Standard
向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

的范数变化为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left|\mathbf{v}'\right|^{2} & =\left(\cos(\theta)\mathbf{v}+\sin(\theta)\mathbf{u}\times\mathbf{v}\right)\left(\cos(\theta)\mathbf{v}+\sin(\theta)\mathbf{u}\times\mathbf{v}\right)\\
 & =\cos^{2}(\theta)\mathbf{v}^{2}+\cos(\theta)\mathbf{v}\sin(\theta)\mathbf{u}\times\mathbf{v}\\
 & +\sin(\theta)\mathbf{u}\times\mathbf{v}\cos(\theta)\mathbf{v}+\sin^{2}(\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2}\\
 & \{\because\mathbf{u},\mathbf{v}\perp\left(\mathbf{u}\times\mathbf{v}\right)\therefore\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0,\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0\}\\
 & =\cos^{2}(\theta)\mathbf{v}^{2}+\sin^{2}(\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2}\\
 & \{\because\mathbf{u}\times\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\sin(\phi)n_{0},\left|\mathbf{u}\right|=1,\left|n_{0}\right|=1\therefore\left(\mathbf{u}\times\mathbf{v}\right)^{2}=\sin^{2}(\phi)\mathbf{v}^{2}\}\\
 & =\cos^{2}(\theta)\mathbf{v}^{2}+\sin^{2}(\theta)\sin^{2}(\phi)\mathbf{v}^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

的模长也发生了变化，和旋转角
\begin_inset Formula $\theta$
\end_inset

的三角函数相关。
\end_layout

\begin_layout Standard
综合上述变化，这个旋转就不符合最简单的旋转的要求：旋转前后，模长不变，与旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

夹角
\begin_inset Formula $\phi$
\end_inset

不变。
\end_layout

\begin_layout Standard
这时候我们回头看第4章解释旋转含义的变形公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.21"
plural "false"
caps "false"
noprefix "false"

\end_inset

)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v'=qvq^{*}=qq^{*}v_{\parallel}+qqv_{\perp}=v_{\parallel}+q^{2}v_{\perp}
\]

\end_inset


\end_layout

\begin_layout Standard
这个变形巧妙的地方就在于先有分解四元数的公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.13"
plural "false"
caps "false"
noprefix "false"

\end_inset

)：
\begin_inset Formula $v=v_{\parallel}+v_{\perp}$
\end_inset

，然后是最关键的假设，公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.15"
plural "false"
caps "false"
noprefix "false"

\end_inset

)：
\begin_inset Formula $v_{\parallel}'=v_{\parallel}$
\end_inset

，最后是分别计算的公式(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4.16"
plural "false"
caps "false"
noprefix "false"

\end_inset

)：
\begin_inset Formula $v'=v_{\parallel}+q^{2}v_{\perp}$
\end_inset

。如果我们这么计算：
\begin_inset Formula $v'=q^{2}v_{\parallel}+q^{2}v_{\perp}$
\end_inset

，就会发现一个有趣的现象：只有
\begin_inset Formula $q^{2}v_{\perp}$
\end_inset

的运算使得向量旋转了
\begin_inset Formula $2\theta$
\end_inset

角度，并且
\begin_inset Formula $v_{\perp}$
\end_inset

的模长保持不变；而
\begin_inset Formula $q^{2}v_{\parallel}$
\end_inset

对旋转没有帮助，还改变了
\begin_inset Formula $v_{\parallel}$
\end_inset

的模长。也就是，上面
\begin_inset Formula $qv$
\end_inset

引起
\begin_inset Formula $v'$
\end_inset

的模长和夹角的变化，以及变成非纯四元数，都是由
\begin_inset Formula $qv_{\parallel}$
\end_inset

这个运算引起的。取消这个影响，再经过变形，就成了著名的
\begin_inset Formula $v'=qvq^{*}$
\end_inset

公式。
\end_layout

\begin_layout Standard
四元数乘法
\begin_inset Formula $\mathbf{v}'=qv$
\end_inset

造成的向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

的变化，模长和夹角都同时发生变化，变化规律和旋转角
\begin_inset Formula $\theta$
\end_inset

的三角函数相关，变化周期为
\begin_inset Formula $2\pi$
\end_inset

。如果把旋转中的向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

划过的轨迹画出来，其实是一个椭圆。以旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

为圆心，以
\begin_inset Formula $\left|\mathbf{v}_{\perp}\right|$
\end_inset

为半径形成一个圆柱体，以向量
\begin_inset Formula $\mathbf{v}$
\end_inset

和向量
\begin_inset Formula $\mathbf{w}=\mathbf{u}\times\mathbf{v}_{\perp}$
\end_inset

张成的平面与这个圆柱体相交形成的椭圆，半长轴为
\begin_inset Formula $\left|\mathbf{v}\right|$
\end_inset

，半短轴为
\begin_inset Formula $\left|\mathbf{v}_{\perp}\right|$
\end_inset

。
\end_layout

\begin_layout Standard
这时候我们回头看
\begin_inset Formula $p'=qpq^{*}$
\end_inset

公式造成的向量
\begin_inset Formula $\left|\mathbf{v}'\right|$
\end_inset

的变化轨迹，见图7.2。
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Quaternions_and_spatial_rotation_figure7.2.eps
	scale 80

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $p'=qpq^{*}$
\end_inset

公式造成的模长变化示意图
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
右边是从四元数平面看到的三维空间的变化，左边是一直随着
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

旋转的视角看
\begin_inset Formula $\mathbf{v}'$
\end_inset

的模长变化。
\end_layout

\begin_layout Standard
左乘
\begin_inset Formula $q$
\end_inset

的时候，四元数
\begin_inset Formula $p$
\end_inset

在四元数平面里，还有向量
\begin_inset Formula $\mathbf{v}$
\end_inset

在三维空间里都逆时针旋转了
\begin_inset Formula $\theta$
\end_inset

角度(右手法则)。但是因为向量
\begin_inset Formula $\mathbf{v}$
\end_inset

所在的三维空间产生了缩放，向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

的模长以及和旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

的夹角发生了变化。从左边可以看到
\begin_inset Formula $\mathbf{v}'$
\end_inset

的模长变了。
\end_layout

\begin_layout Standard
再次右乘
\begin_inset Formula $q^{*}$
\end_inset

，四元数
\begin_inset Formula $p$
\end_inset

又顺时针旋转过
\begin_inset Formula $\theta$
\end_inset

角度(左手法则)，回到了四元数平面原来的位置，
\begin_inset Formula $p$
\end_inset

和
\begin_inset Formula $p'$
\end_inset

实部相等。因为共轭四元数的特性，向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

在三维空间里继续沿逆时针旋转了
\begin_inset Formula $\theta$
\end_inset

角度。因为
\begin_inset Formula $p$
\end_inset

和
\begin_inset Formula $p'$
\end_inset

实部相等，所以向量
\begin_inset Formula $\mathbf{v}'$
\end_inset

所在的三维空间又和向量
\begin_inset Formula $\mathbf{v}$
\end_inset

的一样大了。这时
\begin_inset Formula $v_{\parallel}'=v_{\parallel}$
\end_inset

，垂直分量
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

和
\begin_inset Formula $\mathbf{v}_{\perp}$
\end_inset

又在同一个平面上了。相当于垂直分量
\begin_inset Formula $\mathbf{v}_{\perp}'$
\end_inset

在这个平面上逆时针旋转了
\begin_inset Formula $2\theta$
\end_inset

角度。因此符合最简单的旋转的要求：旋转前后，模长不变，与旋转轴
\begin_inset Formula $\mathbf{u}$
\end_inset

夹角不变。
\end_layout

\begin_layout Standard
我们还可以用玄幻的方法这样解释：在表示旋转时，四元数代表无数种三维空间，每个半径不一样，用实部来区分。乘法的旋转操作会从一种三维空间变化到另外一种三维空间，就像
气球一样膨胀或缩小了，标志是实部发生了变化。不同种类三维空间中的向量无法进行比较，因为还没有哪个聪明人来总结这些规律(定理不足，高维人族)。只有在同一种三维空间
里，也就是半径一样，实部相同，向量才可以进行比较，确定它旋转过后的位置。这时候
\begin_inset Formula $p'=qpq^{*}$
\end_inset

公式就是最简洁的选择。
\end_layout

\begin_layout Section
旋转姿态四元数的理解
\end_layout

\begin_layout Standard
姿态四元数就是旋转本身，所以姿态四元数使用4个参数。所以四元数加法、乘法、指数运算都可以直接拿过来用，以表示旋转的变化。这时候一定会存在机体坐标系(body
 frame)和参考坐标系(reference frame)，姿态，就是这两者之间的旋转关系。这时候计算的对象只有角度，而不关注模长了。但是计算后要保持机体坐标
系(body frame)还是一个单位四元数这个假设以便使用，所以需要在每次迭代后规范化四元数。
\end_layout

\begin_layout Standard
根据平行四边形法则，加法运算在旋转向量的同时，也会造成模长的变化，因此这种旋转也叫偏转(bias)。但是根据微分方程的无穷小假设，加法、乘法、指数运算此时的结果
都是差不多的，都在误差范围以内。然后假设无穷小的角度变化叠加，就从四元数的欧拉公式推导出了四元数的微分方程。因为在姿态估计算法中采用加法算法时，采样间隔小，数值
差异都很小，符合微分方程的假设，加法旋转造成的后果就是光滑的球面上有一个小毛刺，后面通过规范化计算就摸平了。
\end_layout

\begin_layout Standard
当然，要旋转姿态四元数，最佳的方法还是乘法。如果将当前姿态表示成一个单位四元数
\begin_inset Formula $p$
\end_inset

，过一段时间后姿态的变化表示为单位四元数
\begin_inset Formula $q$
\end_inset

，这时候只需要一次乘法
\begin_inset Formula $qp$
\end_inset

，就可以得到新时刻的姿态四元数。这个四元数同样也是单位四元数，又可以进入下一次迭代计算，理论上都不需要规范化。当然，因为有计算误差的存在，计算结束后都会偏离范数
\begin_inset Formula $1$
\end_inset

，所以每次迭代结束后都会做规范化。
\end_layout

\begin_layout Standard
要形象理解姿态四元数，还是将其转换为欧拉角更方便。这时候的映射，就使用了四元数全部的四个参数。
\end_layout

\begin_layout Section
人为赋予的意义
\end_layout

\begin_layout Standard
四元数能够很好地处理数学上的旋转。至于旋转中的意义，很多都是人为赋予的意义。脱离了具体的环境，很容易就成了没有意义的解释。这又回到如何理解四元数与旋转这个根本问
题上。目前的应用，四元数处理两类对象：一类是三维向量的旋转，一般用
\begin_inset Formula $qpq^{*}$
\end_inset

算法处理旋转；一类是系统本身(body frame)的旋转，如姿态四元数，一般用近似微分方程的加法算法或
\begin_inset Formula $qp$
\end_inset

乘法算法处理旋转。如果要把四元数和旋转引入到新的应用领域，则需要考虑，在新领域里，这个旋转代表什么含义，要处理的对象，是三维向量，还是处理旋转本身。
\end_layout

\begin_layout Standard
例如，观察四元数与旋转应用的新兴领域：彩色图像处理，就很有意思。数字图像的像素色彩，一般分为RGB三个通道。以前都是每个通道单独处理。于是有人认为RGB三个通道
应该是相互影响的，不能分开处理。于是就有聪明人引入了四元数，想应用旋转的概念对色彩做整体处理。这时候就有一个问题，RGB是三维向量还是一个要旋转的三维空间？都不
是。那些聪明人通过滤波器将RGB映射到四元数里，创造了能旋转的色彩空间的概念。你不得不佩服这些聪明人的想象力。
\end_layout

\begin_layout Standard
这其中有一项应用就是图像中的物体边缘检测。被映射进四元数所代表的三维空间，每一个像素点的色彩都有了方向和模长。通过比较相邻像素点的色彩的夹角和模长，设置差异的阈
值，就可以检测出物体的边缘。
\end_layout

\begin_layout Standard
类似这样应用，都在等待那些聪明人去赋予它意义。我们这些笨脑子，只需要理解这是聪明人的数学游戏就好。
\end_layout

\begin_layout Standard
尽管很难理解，但是因为四元数是用最少的参数(4个参数)，可以无奇点的、连续的、采样均匀地表示3D旋转，并且在组合旋转方面，表示最佳。所以四元数比其它旋转表示法表
示旋转有明显的优势，所以在专有领域是必不可少的，所以困惑痛苦是必不可少的。所以跟着感觉走，抓住大牛的手，迷糊并快乐着才是生活的常态。
\end_layout

\begin_layout Chapter
姿态四元数与卡尔曼滤波器之间的冲突
\end_layout

\begin_layout Standard
姿态估计可以采用很多种方法。卡尔曼滤波器也有很多应用领域。这两者并不需要绑定在一起才能工作。但自从阿波罗登月计划的成功以来，采用卡尔曼滤波器进行姿态估计，就是最
佳的工作模式。而姿态估计，计算的核心元素就是姿态四元数。
\end_layout

\begin_layout Standard
目前，做姿态估计的卡尔曼滤波器的主流类型是扩展卡尔曼滤波器(EKF)。本文不讨论EKF的工作细节，只简单探讨四元数应用到EKF中时的数学上的冲突，以及那些聪明人
的解决方案和发展现状。
\end_layout

\begin_layout Standard
首先明确，四元数不是一个向量，而是一个二重向量(bivector)。四元数的运动传播方程在四元数向量分量和角速度向量中是双线性的[7]。在文档[6]中谈到，处理
EKF中旋转的最大问题就是没有合理的方法来定义向量空间中的旋转。欧拉角、四元数和旋转矩阵不是向量，而是形式群。
\end_layout

\begin_layout Standard
这是EKF的一个问题，因为它假定所有的状态变量都是向量
\begin_inset Foot
status open

\begin_layout Plain Layout
其实就是状态变量之间两两正交。改变其中一个变量，对其它变量没有任何影响。而姿态的改变，对表示姿态的单位四元数或旋转矩阵，因为约束的存在，改变的不只是一个参数。也
就是单位四元数或旋转矩阵，是群而不是向量。
\end_layout

\end_inset

。例如，想想如何形成四元数的协方差矩阵。协方差矩阵定义为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
E\left[\left(x-\hat{x}\right)\left(x-\hat{x}\right)^{\mathrm{T}}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
但是，在四元数的情况下，
\begin_inset Formula $\left(q-\hat{q}\right)$
\end_inset

是什么意思？它不再是一个单位四元数。旋转矩阵也是这样。欧拉角更微妙一些，但类似的逻辑也适用(如果你减去两个欧拉角的“向量”，结果真正意味着什么？)。
\end_layout

\begin_layout Standard
此外，在姿态估计中，还有一个问题，虽然和四元数本身无关，但也是需要亟待解决的问题，那就是物理建模，或者说建立动力学模型。例如，汽车跑在公路上还是跑在沙漠上，动力
学模型是不一样的。但是，如果是火星车第一次跑在火星表面上该怎么办？之前谁也没有到过火星，不知道相应的动力学模型是什么。虽然可以提前猜测和模拟，但那不是实际的模型
。万一要是猜错了怎么办？或者说，环境变化了，动力学模型不适应了该怎么办？
\end_layout

\begin_layout Standard
为了解决这些问题，一些做航天器姿态估计的聪明人对此进行了研究。首先换了一个思路，虽然我们不知道火星表面的实际动力学模型，所以不确定估计出来的姿态有多大的误差，但
是我们可以确定和估计手头上的火星车的估计误差的偏差(也就是误差的误差)是多少。这个偏差和火星车本身有关，并且是长期稳定，变化缓慢的。误差的误差，有点拗口，所以这
种滤波器又称为Error-State Kalman Filter(ESKF)，或者Indirect Kalman Filter(IKF)。
\end_layout

\begin_layout Standard
既然是误差，第一直觉反应就是用传统的加减法。于是有人就发明了加法滤波器(Additive Filter，也有翻译为加性滤波器)。这时候又引入了一个数学上的冲突：
四元数的加减法对于旋转意味着什么？实数的误差意味着在数轴上距离的变化。姿态的本质就是旋转，姿态的误差其实是旋转之间的误差，那必须还是个旋转，那么直接相减还能表示
旋转吗？也就是说相减得到的角度转换成旋转矩阵还是个正交矩阵吗？根据平行四边形的法则，加减法虽然对四元数有偏转的效果，但是模长发生了变化。因此需要在每次计算迭代后
做四元数规范化。于是加法滤波器在数学概念上和在估计精度上不断受到质疑[9]。但是根据一些人的测试对比，在实际应用中，加法滤波器的估计精度并不差。真是神奇的卡尔曼
滤波器，四元数加法带来的偏差，也可以算是一个噪声源，最后被卡尔曼滤波器过滤掉了，数据也被校准过来了。
\end_layout

\begin_layout Standard
为解决上述两个问题，有另外一波聪明人提出了“乘法”EKF(Multiplicative EKF，也有翻译为乘性滤波器)。在MEKF中，可以考虑到协方差是根据关于
某个四元数参考状态的“误差向量”定义的。使用标准四元数动力学传播四元数，然后更新四元数，并使用参数化为吉布斯向量(gibbs vector)或罗德里格斯参数(r
odriguez parameters)的3参数向量定义协方差[7][8][9]。吉布斯向量(gibbs vector)实际上是一个向量，但它有一个奇点，所以它
只适用于小的旋转。因此，需要一个参考四元数，并用一个向量定义该参考四元数的小“误差”。“乘法”一词来源于这样一个事实，即你最终将这个误差向量“乘法”到参考四元数
中，而不是像所有其他状态那样用简单的向量加法添加它。
\end_layout

\begin_layout Standard
对MEKF更通俗和详细一点的描述就是：我们建立的动力学模型，虽然不一定符合外部的物理世界，由此计算出来的姿态四元数虽然不准确，但是和实际姿态的偏差是相对稳定的，
也就是误差的误差是相对稳定的。如果我们直接把姿态四元数放入EKF中估计，就会和EKF只能处理向量这个要求冲突。这时候我们只能用间接法(Indirect)，先定义
一个参考单位四元数表示参考姿态，用EKF估计该参考姿态的误差。这时候之所以能用EKF，是因为这时候是用旋转向量(gibbs vector / rodriguez
 parameters)表示误差，是一个EKF能处理的向量。并且该误差通常都很小，远离奇点，所以用旋转向量表示姿态误差没有问题。用EKF估计出误差，也就是3参数
的旋转向量，一般都很小，映射到四元数时可以简单地在实部写
\begin_inset Formula $1$
\end_inset

，就成了近似的单位四元数
\begin_inset Formula $q$
\end_inset

。最后用这个误差四元数乘以参考姿态四元数，就将误差纠正过来了。这时候只需要一次乘法，就得到了新的姿态四元数，也就是新的参考姿态。再经过一次规范化，又可以进入下一
次循环了。
\end_layout

\begin_layout Standard
卡尔曼滤波器的滤波器种类有很多，每年的论文层出不穷，每隔几年就会有新的种类冒出来，但是MEKF在实际项目里是主流。之所以MEKF会占优势，是因为它在数学概念上更
合理，并且在计算量相对较少的情况下估计精度较高。在这里，F.
 Landis Markley 这位白胡子老爷爷值得提一提，就是他从数学上证明了MEKF在数学概念上更合理，至少到二阶项都是符合
\begin_inset Formula $SO(3)$
\end_inset

和卡尔曼滤波的约束的[7][8][9]。于是MEKF就成了主流，从无人机飞控系统、Cardboard VR系统、相机防抖系统、SLAM系统等等，都有很好的应用。
\end_layout

\begin_layout Standard
近些年，事情又有了新的进展。这个世界上从不缺乏聪明人。有人用封装流形(Manifolds)的方法将群对象的四元数封装成向量，这样EKF就可以直接处理封装姿态四元
数过后的向量状态了，这样可以避免使用误差状态向量[6]。至于具体情形怎么样，需要学习过高深的流形(Manifolds)数学之后才知道了。苦海无边，回头是岸。
\end_layout

\begin_layout Chapter
四元数定义形式的影响
\end_layout

\begin_layout Standard
四元数并不只有一种定义，常见的 convention 有两种，Hamilton 和 JPL。Hamilton 和 JPL 两者的根本差别在于3个虚部的相互关系。
在 Hamilton convention 里，
\begin_inset Formula $ijk=-1$
\end_inset

；而 JPL 则取
\begin_inset Formula $ijk=1$
\end_inset

。这直接导致两者在四元数乘法、与其他旋转表示法相互转换时的公式都有所不同。两者的一些简单对比如表9.1。
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="8" columns="4">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="left" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Quaternion type
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Hamilton
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
JPL
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Componets order
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(q_{w},\mathbf{q}_{v}\right)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(\mathbf{q}_{v},q_{w}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Algebra
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $ij=k$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $ij=-k$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Handedness
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Right-handed
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Left-handed
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Function
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Passive
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Passive
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="3" alignment="center" valignment="middle" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Right-to-left products mean
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Local-to-Global
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Global-to-Local
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Default notation, 
\begin_inset Formula $\mathbf{q}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{q}\triangleq\mathbf{q}_{\mathcal{GL}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{q}\triangleq\mathbf{q}_{\mathcal{LG}}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="4" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Default operation
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{x}_{\mathcal{G}}=\mathbf{q}\otimes\mathbf{x}_{\mathcal{L}}\otimes\mathbf{q}^{*}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{x}_{\mathcal{L}}=\mathbf{q}\otimes\mathbf{x}_{\mathcal{G}}\otimes\mathbf{q}^{*}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Hamilton vs.
 JPL quaternion conventions with respect to the 4 binary choices
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
此外，还有一些常用的矩阵受到影响，见表9.2。
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Left quaternion product matrices
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Hamilton
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left[\mathbf{q}\right]_{L}=q_{w}\mathbf{I}+\left[\begin{array}{cc}
0 & -\mathbf{q}_{v}^{\mathrm{T}}\\
\mathbf{q}_{v} & \left[\mathbf{q}_{v}\right]\times
\end{array}\right]$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
JPL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
\begin_inset Formula $\left[\mathbf{q}\right]_{L}=\left[\begin{array}{cc}
q_{w}\mathbf{I}_{3\times3}+\left[\mathbf{q}_{v}\right]\times & \mathbf{q}_{v}\\
-\mathbf{q}_{v}^{\mathrm{T}} & q_{w}
\end{array}\right]$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Rotation matrix
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Hamilton
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{R}=\left[\begin{array}{cccc}
1 & 0 & 0 & 0\\
0 & 1-2q_{2}^{2}-2q_{3}^{2} & 2q_{1}q_{2}-2q_{0}q_{3} & 2q_{1}q_{3}+2q_{0}q_{2}\\
0 & 2q_{1}q_{2}+2q_{0}q_{3} & 1-2q_{1}^{2}-2q_{3}^{2} & 2q_{2}q_{3}-2q_{0}q_{1}\\
0 & 2q_{1}q_{3}-2q_{0}q_{2} & 2q_{2}q_{3}+2q_{0}q_{1} & 1-2q_{1}^{2}-2q_{2}^{2}
\end{array}\right]$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
JPL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{R}=\left[\begin{array}{cccc}
1-2q_{2}^{2}-2q_{3}^{2} & 2q_{1}q_{2}+2q_{0}q_{3} & 2q_{1}q_{3}-2q_{0}q_{2} & 0\\
2q_{1}q_{2}-2q_{0}q_{3} & 1-2q_{1}^{2}-2q_{3}^{2} & 2q_{2}q_{3}+2q_{0}q_{1} & 0\\
2q_{1}q_{3}+2q_{0}q_{2} & 2q_{2}q_{3}-2q_{0}q_{1} & 1-2q_{1}^{2}-2q_{2}^{2} & 0\\
0 & 0 & 0 & 1
\end{array}\right]$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
常用矩阵受到的影响
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
四元数是数学家 William Rowan Hamilton 引入的，那么 Hamilton convention 应该是他一开始使用的。那 JPL
 convention 又是从哪儿冒出来的呢？这个标准是由著名的 NASA Jet Propulsion Laboratory (JPL) 搞的。两种
 convention 的存在，确实给四元数的使用者造成了一些困惑或争论。基本上每个初学者在看资料和论文时，都在这里被弄糊涂了，经常发现两份文档中的公式不一致，
到底谁对谁错都没有了主意。
\end_layout

\begin_layout Standard
为什么会有JPL形式，现在也没有什么人讲得清楚了。有一点是可以确定的，在文档[7]中谈到过JPL的一个优点。JPL的四元数是这么表示的：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=\left[\begin{array}{c}
q_{v}\\
q_{4}
\end{array}\right]=\left[\begin{array}{c}
\mathbf{q}\\
q_{4}
\end{array}\right]=\left[\begin{array}{c}
\mathbf{e}\sin(\phi/2)\\
\cos(\phi/2)
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
单位四元数有
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
|q|^{2}\equiv|\mathbf{q}|^{2}+q_{4}^{2}=1
\]

\end_inset


\end_layout

\begin_layout Standard
姿态矩阵是单位四元数各分量的齐次二次函数；
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
A(q)=(q_{4}^{2}-|\mathbf{q}|^{2})\boldsymbol{I}_{3\times3}-2q_{4}[\mathbf{q}\times]+2\mathbf{q}\mathbf{q}^{T}
\]

\end_inset

其中
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
[\mathbf{q}\times]\equiv\left[\begin{array}{ccc}
0 & -q_{3} & q_{2}\\
q_{3} & 0 & -q_{1}\\
-q_{2} & q_{1} & 0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
四元数乘积为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
p\otimes q\equiv\left[\begin{array}{c}
p_{4}\mathbf{q}+q_{4}\mathbf{p}-\mathbf{p}\times\mathbf{q}\\
p_{4}q_{4}-\mathbf{p}\cdot\mathbf{q}
\end{array}\right]
\]

\end_inset

这与历史上的乘法惯例
\begin_inset Formula $qp$
\end_inset

表示不同。惯例用
\begin_inset Formula $qp$
\end_inset

表示乘法，不带中缀运算符，JPL形式乘法用向量部分的叉积符号
\begin_inset Formula $\otimes$
\end_inset

表示。这两种乘法通过
\begin_inset Formula $p\otimes q=qp$
\end_inset

关联。JPL形式具有以下有用的性质：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
A(p)A(q)=A(p\otimes q)
\]

\end_inset


\end_layout

\begin_layout Standard
与惯例
\begin_inset Formula $A(p)A(q)=A(qp)$
\end_inset

相比。
\begin_inset Formula $p\otimes q$
\end_inset

方程式表示旋转群和四元数群几乎是同构的[7]。
\end_layout

\begin_layout Standard
为区分JPL形式乘法符号，通常也用点积符号
\begin_inset Formula $\odot$
\end_inset

表示Hamilton乘法，因此
\begin_inset Formula 
\[
p\odot q\equiv\left[\begin{array}{c}
p_{1}\mathbf{q}+q_{1}\mathbf{p}+\mathbf{p}\times\mathbf{q}\\
p_{1}q_{1}-\mathbf{p}\cdot\mathbf{q}
\end{array}\right]
\]

\end_inset

因此两者的关系为
\begin_inset Formula 
\[
p\odot q\equiv q\otimes p
\]

\end_inset


\end_layout

\begin_layout Standard
在文档[14]有更深入的讨论。
\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
还有一个估计和“Right-to-left products mean”有关。Local和Global是相对的概念。以相机的视角举例，假设初始状态机体坐标系(相
机)和固定坐标系(大地)是重合的，经过一段时间的运动之后：
\end_layout

\begin_layout Itemize
Local-to-Global意味着是将相机在新的视角看到的空间某个固定点的坐标转成初始相机视角下的坐标。
\end_layout

\begin_layout Itemize
Global-to-Local意味着是将相机在初始视角看到的空间某个固定点坐标转成相机在新的视角下的坐标。
\end_layout

\begin_layout Standard
载人航天器自然要以宇航员优先。JPL形式就是宇航员视角看到的坐标，同时根据上面的方程式，姿态矩阵也容易构建一点。
\end_layout

\begin_layout Standard
另外，我估计JPL选择这种形式和计算机存储顺序有关。JPL形式的存储，向量部分都保存在数组的前面或矩阵的左上角，例如四元数的
\begin_inset Formula $1\times4$
\end_inset

数组，旋转矩阵的
\begin_inset Formula $4\times4$
\end_inset

矩阵，程序员可以在不改变指针首地址的情况下，直接将其变成向量或向量矩阵进行运算。这样少了复制操作，节省了时间和空间。在50年前的阿波罗登月计划时代，那时候的计算
机的速度很慢、存储很小，这是不可忽略的优势。
\end_layout

\begin_layout Standard
不管怎么样，如果要学习姿态估计，了解JPL形式是少不了的工作，因为NASA / JPL这群聪明人同样也是研究姿态估计的主力。于是JPL形式就像泥石流一样，肆虐着
四元数的应用领域。
\end_layout

\begin_layout Chapter
参考资料
\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "四元数与三维旋转"
target "https://krasjet.github.io/quaternion/quaternion.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Understanding Quaternions"
target "https://www.3dgep.com/understanding-quaternions/"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Quaternion differentiation"
target "https://fgiesen.wordpress.com/2012/08/24/quaternion-differentiation/"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Quaternion Differentiation"
target "https://www.euclideanspace.com/physics/kinematics/angularvelocity/QuaternionDifferentiation2.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Quaternions"
target "http://web.cs.iastate.edu/~cs577/handouts/quaternion.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "extended kalman filter equation for orientation quaternion"
target "https://math.stackexchange.com/questions/2621677/extended-kalman-filter-equation-for-orientation-quaternion"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Attitude Error Representations for Kalman Filtering"
target "https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20020060647.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Attitude estimation or quaternion estimation?"
target "https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20030093641.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Multiplicative vs. Additive Filtering for Spacecraft Attitude Determination"
target "https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20040037784.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "与向量的渊源极深的四元数"
target "https://spaces.ac.cn/archives/898"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "四元数的两种 notation：Hamilton 和 JPL"
target "https://zhuanlan.zhihu.com/p/31041805?from_voters_page=true"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "四元数运动学笔记（3）四元数和旋转相关的约定表述"
target "https://www.cnblogs.com/youzx/p/6387740.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "四元数的表示形式Hamilton & JPL定义及影响"
target "https://www.zybuluo.com/snuffles/note/1484888"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Why and How to Avoid the Flipped Quaternion Multiplication"
target "https://arxiv.org/abs/1801.07478"
literal "false"

\end_inset


\end_layout

\begin_layout Chapter
\start_of_appendix
验证旋转乘法公式
\begin_inset Formula $qpq^{*}$
\end_inset


\end_layout

\begin_layout Standard
设：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q & =\left[\cos(\dfrac{1}{2}\theta),\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]\\
q^{*} & =\left[\cos(\dfrac{1}{2}\theta),-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]\\
p & =\left[v,\mathbf{v}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
求：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
p'=qpq^{*}
\]

\end_inset


\end_layout

\begin_layout Standard
使用的公式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
[s_{a},\mathbf{a}][s_{b},\mathbf{b}]=[s_{a}s_{b}-\mathbf{a}\cdot\mathbf{b},s_{a}\mathbf{b}+s_{b}\mathbf{a}+\mathbf{a}\times\mathbf{b}]
\]

\end_inset


\end_layout

\begin_layout Standard
第一步：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
r & =qp\\
 & =\left[\cos(\dfrac{1}{2}\theta),\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]\left[v,\mathbf{v}\right]\\
 & =\left[\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v},\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
第二步：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
p' & =rq^{*}\\
 & =\left[\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v},\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right]\left[\cos(\dfrac{1}{2}\theta),-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right]\\
 & =\left(\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right)\left(\cos(\dfrac{1}{2}\theta)\right)-\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)\cdot\left(-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right),\\
 & \left(\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right)\left(-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right)+\left(\cos(\dfrac{1}{2}\theta)\right)\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)+\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)\times\left(-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
分别求实部和虚部的值。
\end_layout

\begin_layout Standard
实部：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left(\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right)\left(\cos(\dfrac{1}{2}\theta)\right)-\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)\cdot\left(-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right) & =\\
\left(\cos^{2}(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right)+\left(\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}^{2}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\mathbf{u}\right) & =\\
\{\because\mathbf{u},\mathbf{v}\perp\left(\mathbf{u}\times\mathbf{v}\right)\therefore\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0,\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0\}\\
\{\because\mathbf{u}^{2}=1\}\\
\cos^{2}(\dfrac{1}{2}\theta)v+\sin^{2}(\dfrac{1}{2}\theta)v & =v
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
求虚部使用到的公式：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\mathbf{a}\times\left(\mathbf{b}\times\mathbf{c}\right) & =\left(\mathbf{a}\cdot\mathbf{c}\right)\mathbf{b}-\left(\mathbf{a}\cdot\mathbf{b}\right)\mathbf{c}\\
\sin(\theta) & =2\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\\
\cos(\theta) & =1-2\sin^{2}(\dfrac{1}{2}\theta)\\
2\sin^{2}(\dfrac{1}{2}\theta) & =\left(1-\left(1-2\sin^{2}(\dfrac{1}{2}\theta)\right)\right)\\
 & =\left(1-\cos(\theta)\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
虚部：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left(\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right)\left(-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right)+\left(\cos(\dfrac{1}{2}\theta)\right)\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)+\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)\times\left(-\sin(\dfrac{1}{2}\theta)\mathbf{u}\right) & =\\
\left(-\cos(\dfrac{1}{2}\theta)v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}\right)+\left(\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}+\cos(\dfrac{1}{2}\theta)v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)\right)-\left(\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{v}\times\mathbf{u}+v\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{u}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)\times\mathbf{u}\right) & =\\
\{\because\mathbf{u}\times\mathbf{u}=0\}\\
\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}+\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)-\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{v}\times\mathbf{u}-\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)\times\mathbf{u} & =\\
\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}+2\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)+\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}\times\left(\mathbf{u}\times\mathbf{v}\right) & =\\
\{\because\mathbf{u}\times\left(\mathbf{u}\times\mathbf{v}\right)=\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}-\left(\mathbf{u}\cdot\mathbf{u}\right)\mathbf{v}=\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}-\mathbf{v}\}\\
\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}+2\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)+\sin^{2}(\dfrac{1}{2}\theta)\left(\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}-\mathbf{v}\right) & =\\
\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}-\sin^{2}(\dfrac{1}{2}\theta)\mathbf{v} & =\\
2\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}-\sin^{2}(\dfrac{1}{2}\theta)\mathbf{v}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right) & =\\
\cos(\theta)\mathbf{v}+2\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right) & =\\
\cos(\theta)\mathbf{v}+\left(1-\left(1-2\sin^{2}(\dfrac{1}{2}\theta)\right)\right)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right) & =\\
\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
p' & =qpq^{*}\\
 & =\left[v,\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
再次确认一些信息。根据3D旋转的矩阵形式：
\end_layout

\begin_layout Standard
设：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=s+xi+yj+zk,\left|q\right|=1
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
p'=qpq^{*}=\left[\begin{array}{cccc}
1 & 0 & 0 & 0\\
0 & 1-2y^{2}-2z^{2} & 2xy-2sz & 2sy+2xz\\
0 & 2xy+2sz & 1-2x^{2}-2z^{2} & 2yz-2sx\\
0 & 2xz-2sy & 2sx+2yz & 1-2x^{2}-2y^{2}
\end{array}\right]p
\]

\end_inset


\end_layout

\begin_layout Standard
可以确定最终结果
\begin_inset Formula $p'$
\end_inset

中：
\end_layout

\begin_layout Itemize
实部：完全由
\begin_inset Formula $p$
\end_inset

的实部贡献，也就是
\begin_inset Formula $p'$
\end_inset

的实部与
\begin_inset Formula $p$
\end_inset

的实部相等。整个
\begin_inset Formula $q$
\end_inset

的实部和虚部，
\begin_inset Formula $p$
\end_inset

的虚部对此都没有任何影响。
\end_layout

\begin_layout Itemize
虚部：
\begin_inset Formula $p$
\end_inset

的实部对此没有任何影响。完全由
\begin_inset Formula $q$
\end_inset

的实部和虚部，
\begin_inset Formula $p$
\end_inset

的虚部进行运算。
\end_layout

\begin_layout Chapter
验证结果
\begin_inset Formula $p'$
\end_inset

的模长
\end_layout

\begin_layout Standard
最终结果
\begin_inset Formula $p'$
\end_inset

为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
p'=\left[v,\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)\left(\mathbf{u}\cdot\mathbf{v}\right)\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\right]
\]

\end_inset


\end_layout

\begin_layout Standard
设向量
\begin_inset Formula $\mathbf{u}$
\end_inset

与
\begin_inset Formula $\mathbf{v}$
\end_inset

之间的夹角为
\begin_inset Formula $\phi$
\end_inset

。
\end_layout

\begin_layout Standard
虚部向量的范数为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left(\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\right)\left(\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\right) & =[0]\\
\cos(\theta)\mathbf{v}\cdot\cos(\theta)\mathbf{v}+\cos(\theta)\mathbf{v}\cdot\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\cos(\theta)\mathbf{v}\cdot\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right) & +\\
\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}\cdot\cos(\theta)\mathbf{v}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}\cdot\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}\cdot\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right) & +\\
\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\cos(\theta)\mathbf{v}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\sin(\theta)\left(\mathbf{u}\times\mathbf{v}\right) & =[1]\\
\cos^{2}(\theta)\mathbf{v}^{2}+\cos(\theta)\left(1-\cos(\theta)\right)\mathbf{v}\cdot(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\cos(\theta)\sin(\theta)\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right) & +\\
\left(1-\cos(\theta)\right)\cos(\theta)(\mathbf{u}\cdot\mathbf{v})^{2}+\left(1-\cos(\theta)\right)^{2}(\mathbf{u}\cdot\mathbf{v})^{2}\mathbf{u}^{2}+\left(1-\cos(\theta)\right)\sin(\theta)(\mathbf{u}\cdot\mathbf{v})\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right) & +\\
\sin(\theta)\cos(\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\mathbf{v}+\sin(\theta)\left(1-\cos(\theta)\right)\left(\mathbf{u}\times\mathbf{v}\right)\cdot(\mathbf{u}\cdot\mathbf{v})\mathbf{u}+\sin^{2}(\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2} & =[2]\\
\{\because\mathbf{u},\mathbf{v}\perp\left(\mathbf{u}\times\mathbf{v}\right)\therefore\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0,\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0\}\\
\cos^{2}(\theta)\mathbf{v}^{2}+\cos(\theta)\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\left(1-\cos(\theta)\right)\cos(\theta)(\mathbf{u}\cdot\mathbf{v})^{2}+\left(1-\cos(\theta)\right)^{2}(\mathbf{u}\cdot\mathbf{v})^{2}\mathbf{u}^{2} & +\\
\sin^{2}(\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2} & =[3]\\
\{\because\mathbf{u}^{2}=1\}\\
\cos^{2}(\theta)\mathbf{v}^{2}+\cos(\theta)\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\cos(\theta)\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2}+\left(1-\cos(\theta)\right)^{2}(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\sin^{2}(\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2} & =[4]\\
\{\because\mathbf{u}\times\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\sin(\phi)n_{0},\left|\mathbf{u}\right|=1,\left|n_{0}\right|=1\therefore\left(\mathbf{u}\times\mathbf{v}\right)^{2}=\sin^{2}(\phi)\mathbf{v}^{2}\}\\
\cos^{2}(\theta)\mathbf{v}^{2}+\cos(\theta)\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\cos(\theta)\left(1-\cos(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2}+\left(1-\cos(\theta)\right)^{2}(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\sin^{2}(\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[5]\\
\cos^{2}(\theta)\mathbf{v}^{2}+\left(\cos(\theta)-\cos^{2}(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\left(\cos(\theta)-\cos^{2}(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2}+\left(1-2\cos(\theta)+\cos^{2}(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\sin^{2}(\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[6]\\
\{\because1-2\cos(\theta)+\cos^{2}(\theta)=(1-\cos^{2}(\theta))-2(\cos(\theta)-\cos^{2}(\theta))=\sin^{2}(\theta)-2(\cos(\theta)-\cos^{2}(\theta))\}\\
\cos^{2}(\theta)\mathbf{v}^{2}+\left(\cos(\theta)-\cos^{2}(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\left(\cos(\theta)-\cos^{2}(\theta)\right)(\mathbf{u}\cdot\mathbf{v})^{2}+\left(\sin^{2}(\theta)-2(\cos(\theta)-\cos^{2}(\theta))\right)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\sin^{2}(\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[7]\\
\cos^{2}(\theta)\mathbf{v}^{2} & +\\
\sin^{2}(\theta)(\mathbf{u}\cdot\mathbf{v})^{2} & +\\
\sin^{2}(\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[8]\\
\{\because\mathbf{u}\cdot\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\cos(\phi),\left|\mathbf{u}\right|=1\therefore(\mathbf{u}\cdot\mathbf{v})^{2}=\cos^{2}(\phi)\mathbf{v}^{2}\}\\
\cos^{2}(\theta)\mathbf{v}^{2} & +\\
\sin^{2}(\theta)\cos^{2}(\phi)\mathbf{v}^{2} & +\\
\sin^{2}(\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[9]\\
\cos^{2}(\theta)\mathbf{v}^{2} & +\\
\sin^{2}(\theta)\mathbf{v}^{2}(\cos^{2}(\phi)+\sin^{2}(\phi)) & =[10]\\
(\cos^{2}(\theta)+\sin^{2}(\theta))\mathbf{v}^{2} & =\mathbf{v}^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
所以
\begin_inset Formula $p'$
\end_inset

的模长为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left|p'\right|=\sqrt{v^{2}+\mathbf{v}^{2}}=\left|p\right|
\]

\end_inset


\end_layout

\begin_layout Standard
乘法第一步的结果为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
qp=\left[\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v},\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right]
\]

\end_inset


\end_layout

\begin_layout Standard
求实部向量的范数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left(\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right)\left(\cos(\dfrac{1}{2}\theta)v-\sin(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}\right) & =\\
\cos^{2}(\dfrac{1}{2}\theta)v^{2}-2v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
求虚部向量的范数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right)\left(\cos(\dfrac{1}{2}\theta)\mathbf{v}+v\sin(\dfrac{1}{2}\theta)\mathbf{u}+\left(\sin(\dfrac{1}{2}\theta)\mathbf{u}\times\mathbf{v}\right)\right) & =[0]\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right) & +\\
v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v^{2}\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}^{2}+v\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right) & +\\
\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\mathbf{v}+v\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)\cdot\mathbf{u}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2} & =[1]\\
\{\because\mathbf{u},\mathbf{v}\perp\left(\mathbf{u}\times\mathbf{v}\right)\therefore\mathbf{u}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0,\mathbf{v}\cdot\left(\mathbf{u}\times\mathbf{v}\right)=0\}\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v} & +\\
v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v^{2}\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}^{2} & +\\
\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2} & =[2]\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+2v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v^{2}\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}^{2} & +\\
\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\times\mathbf{v}\right)^{2} & =[3]\\
\{\because\mathbf{u}\times\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\sin(\phi)n_{0},\left|\mathbf{u}\right|=1,\left|n_{0}\right|=1\therefore\left(\mathbf{u}\times\mathbf{v}\right)^{2}=\sin^{2}(\phi)\mathbf{v}^{2}\}\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+2v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v^{2}\sin^{2}(\dfrac{1}{2}\theta)\mathbf{u}^{2} & +\\
\sin^{2}(\dfrac{1}{2}\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[4]\\
\{\because\mathbf{u}^{2}=1\}\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+2v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v^{2}\sin^{2}(\dfrac{1}{2}\theta)+\sin^{2}(\dfrac{1}{2}\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[5]\\
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
实部加虚部的范数：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\cos^{2}(\dfrac{1}{2}\theta)v^{2}-2v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)^{2} & +\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+2v\sin(\dfrac{1}{2}\theta)\cos(\dfrac{1}{2}\theta)\mathbf{u}\cdot\mathbf{v}+v^{2}\sin^{2}(\dfrac{1}{2}\theta)+\sin^{2}(\dfrac{1}{2}\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[0]\\
v^{2}+\sin^{2}(\dfrac{1}{2}\theta)\left(\mathbf{u}\cdot\mathbf{v}\right)^{2} & +\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+\sin^{2}(\dfrac{1}{2}\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[1]\\
\{\because\mathbf{u}\cdot\mathbf{v}=\left|\mathbf{u}\right|\left|\mathbf{v}\right|\cos(\phi),\left|\mathbf{u}\right|=1\therefore(\mathbf{u}\cdot\mathbf{v})^{2}=\cos^{2}(\phi)\mathbf{v}^{2}\}\\
v^{2}+\sin^{2}(\dfrac{1}{2}\theta)\cos^{2}(\phi)\mathbf{v}^{2} & +\\
\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+\sin^{2}(\dfrac{1}{2}\theta)\sin^{2}(\phi)\mathbf{v}^{2} & =[2]\\
v^{2}+\sin^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2}+\cos^{2}(\dfrac{1}{2}\theta)\mathbf{v}^{2} & =[3]\\
v^{2}+\mathbf{v}^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
旋转乘法公式
\begin_inset Formula $qpq^{*}$
\end_inset

模长小节：
\end_layout

\begin_layout Itemize
每步的结果都保证模长不变，
\begin_inset Formula $\left|p\right|=\left|r\right|=\left|p'\right|$
\end_inset

。这个符合单位四元数乘法的规则。
\end_layout

\begin_layout Itemize
第一步的时候，变化扩散到了整个四元数的实部和虚部。
\end_layout

\begin_layout Itemize
第二步的时候，限定了
\begin_inset Formula $p'$
\end_inset

的实部与
\begin_inset Formula $p$
\end_inset

的实部相等。这也意味着
\begin_inset Formula $p'$
\end_inset

的虚部(向量部分)模长与
\begin_inset Formula $p$
\end_inset

的相等。这意味着向量
\begin_inset Formula $p'$
\end_inset

和
\begin_inset Formula $p$
\end_inset

的所在的三维空间是一样的。
\end_layout

\begin_layout Standard

\end_layout

\end_body
\end_document
