# 卡尔曼滤波器在姿态估计中的应用的简略总结
无数的人耗费了无数的墨水和口水。我也假装我懂了。-- 题记

* * *

# 前言
从数学到物理，从理论到工程，从物理世界的模型到测量噪声假设，从姿态估计的原理到卡尔曼滤波器的设计，从卡尔曼滤波器的原理到验证，迷魂阵一样，还缺一不可。耗时半年，就是为了看懂几百行代码，太难为人了。比起那些月产出万行代码的高手，实在是惭愧。

也许那些大神说得对，我们就是这样认识世界的：睁眼瞧瞧这个世界，再闭眼猜猜这个世界，然后按照自己的感觉调整调整 Q & R 矩阵，如此循环往复。只闭眼瞎猜的，那是傻子，只睁眼盯着的，那是呆子。能把 Q & R 矩阵调整得既能猜得准，又能灵敏反应变化的，那就是大神了。

从某种哲学意义上来说，这就是我们的现状：人类自以为聪明，掌握了一些这个世界的运行规律，称之为科学原理，又掌握了一些感知这个世界的能力(make sense)，称之为测量方法。其实两者都有问题，总结规律有谬误，测量数据有误差。于是大神找到了应付现状的最佳方法：
* 闭着眼睛用瞎凑的公式猜测这个世界从上一个状态运行到新的状态，这就是预测(Predict)，这是这段时间内世界的变化，所以又叫时间更新(Time Update)；
* 公式有问题，于是就睁开眼睛看看有多大的差异，这就是修正(Correct)，这是测量得到的世界的变化，所以又叫测量更新(Measurement Update)；
* 两者都有误差。于是假设误差按照正态分布，再按照最小二乘法进行优化，最佳估计值是公式值和测量值各乘上各自的信任系数后相加而来，这就是卡尔曼滤波器。

# 姿态估计的基本原理
姿态估计可以采用很多种方法。卡尔曼滤波器也有很多应用领域。这两者并不需要绑定在一起才能工作。但自从阿波罗登月计划的成功起，采用卡尔曼滤波器进行姿态估计，就是最佳的工作模式，同时也一再证明了卡尔曼滤波器的神奇。

## 重力法
重力分解
加速度计测量得到的是重力和线性加速度的叠加。无法区分。
只适用于静态物体。

## 磁力法
地磁测量得到的不是一个圆球，而是一个椭球。
地磁测量值也因此很难校准。都是保密算法，或者是有专利的算法。
地磁很弱，不容易测量。同时地磁容易受到环境的干扰，不可靠。

## 角速度法
前两个是绝对法，确定物体姿态和上一次测量无关，只和本次测量有关。
角速度法是相对法，确定物体姿态和上一次姿态有关，和本次测量有关。实际上就是确定初始状态后，到现在的所有测量结果的积分。
这是机体姿态估计中最根本的算法。大多数姿态估计的解题思路都从这个公式起步。
短期可信，长期不可信。
长期可信，短期不可信。基于统计学。

# 使用卡尔曼滤波器的姿态估计的解题思路

对于机体坐标系来说，姿态的变化量，可以从角速度推算而来。于是角速度对于 KF 系统，就是控制输入(Control Input)，或者说驱动输入(Drive Input)。绝大多数姿态估计的系统，都是由角速度进行驱动。重力数据和地磁数据用于校正。姿态估计，一个通用的离散算法流程大约是：
1. 从陀螺仪获得角速度，应用姿态变化的微分方程，积分得到当前姿态。这一步，在KF里就是时间传播，就是预估步骤。计算得到的就是姿态的估计值，短期有效，长时间有较大累积误差，所以需要校正。
2. 从加速计获得包含了重力的加速度，对姿态的估计值做校正。
3. 从磁力计获得地磁数据，可以对姿态的估计值做校正。
4. 从其它和姿态有关的传感器获得数据，对姿态的估计值做校正。
5. 回到步骤1，周而复始地估计物体的姿态。

用重力数据和地磁数据校正，最常用的方法就是固定矢量观测。从重力矢量，可以得到以重力矢量为法向量的当地水平面，从而校正了欧拉角中的 Roll & Pitch。结合已知的水平面，从地磁矢量分离出水平面上指向磁极的矢量，从而校正了欧拉角中的 Yaw。

把重力矢量做为一个固定矢量观测，原理是这样的：当地水平面的法向量是重力矢量。我们已经猜测机体坐标系已经旋转一个角度，我们反方向旋转回来，机体坐标系的 Z 轴应该与观测到的重力矢量重合。如果有差异，就要修正。

但是，从加速计获得的是叠加了重力矢量的加速度矢量。所以这里有一个重要假设，就是把外力当成是零均值高斯白噪声，各个方向各种大小随机分布，长期综合值为零。于是这种算法最怕机体长时间只受一个方向的力的情况，例如自由落体、或抛物线运动。

在微重力环境，例如在太空船中，使用的星光或太阳传感器做为参考固定矢量。这比观测重力矢量更准确。但是成本不知几何，不是民用设备能用得起的。

把地磁矢量做为一个固定矢量观测，原理和上面类似：地磁矢量分离出水平面上的矢量指向磁极。我们反方向旋转回来，机体坐标系的 Y 轴应该与观测到的地磁水平矢量重合。如果有差异，就要修正。这种方法使用的是地磁矢量在水平面上的分量。在高维度地区，地磁矢量差不多指向地心，在水平面上的分量很小。因此该算法在高维度地区会不可用。此外，地磁很弱，不容易测量，测量得到的不是一个圆球，而是一个椭球。同时地磁容易受到环境的干扰，不可靠。所以，如果有其它方法得到 Yaw 值，应该优先采用其它方法。参考地磁矢量是最后的方法。

# 用于姿态估计的卡尔曼滤波器的选择

应用于姿态估计的卡尔曼滤波器的滤波器种类有很多，每年的论文层出不穷，每隔几年就会有新的种类冒出来，各个都自称最优最精确。那该选哪一个进行学习呢？

其实有一个简单的办法可以选择，那就是：看航天人的。

自从卡尔曼滤波的第一个应用，也是第一个成功的应用---阿波罗登月计划---起，航天人一直都是卡尔曼滤波研究的领军人物。别人可以灌水论文提职称，而航天人需要对运行十余年，耗资十几亿美元的项目负责。灌水一时爽，秋后算账惨，航天人是不敢的。

在工业届里，非线性系统的估计最常使用的就是EKF与UKF。在姿态估计的方案里，也经常有这两种的选择。那么在实际项目里，EKF与UKF，该选择哪一个呢？搜索下来，主要还是选择了EKF。理由大概有这几个：
* 根据不少论文里的实测，EKF 与 UKF 得到的估计值的精度，也就是最小均方误差(MMSE)，基本上差不多。也许是姿态估计中的非线性方程中的线性性质较多，EKF 已经足够应付。也许是传感器的测量噪声太大，体现不出 UKF 的优点。总之，EKF 在估计精度上没有明显劣势。
* 根据复杂度分析，UKF 大概是 EKF 的两倍。这在嵌入式系统中是很敏感的指标。EKF 因为计算量较小，速度更快，能够适应于 MCU 系统。所以选择 EKF 的就比较多。

在 EKF 中，针对姿态估计的特点，大多又选择了 ESKF。之所以 ESKF 会占优势，是因为它在数学概念上更合理。在这里，F. Landis Markley 这位白胡子老爷爷值得提一提，就是他从数学上证明了 ESKF 在数学概念上更合理，至少到二阶项都是符合SO3和卡尔曼滤波的约束的。于是 ESKF 就成了主流。

所以，本地的大多数资料都是针对 ESKF 应用的分析。

## 最简单的方法
磁力法与卡尔曼滤波器。
地磁容易受到环境的干扰，不可靠。
## 误差状态卡尔曼滤波器
## 参考帧
从重力矢量，可以得到以重力矢量为法向量的当地水平面，从而校正了欧拉角中的 Roll & Pitch。结合已知的水平面，从地磁矢量分离出水平面上指向磁极的矢量，从而校正了欧拉角中的 Yaw。
重力参考帧的问题。卡尔曼滤波器的假设，零均值高斯白噪声。如果长久受到一个恒定的力，则估计不准确。只受一个力的的自由落体，抛物线运动。
地磁参考帧的问题。地磁矢量的方向，在水平面上的投影。在高维度地区的问题。

在太空船中，使用的星光或太阳传感器做为参考帧。

# 测量值的预处理
## 低通滤波
## 互补滤波
## 地磁测量值的校准

# 地磁测量噪声的隔离

# 特殊应用的特别设计
## NXP的零漂移模型
如何扩展状态列表
## cardboard的预测应用
卡尔曼滤波器的三种应用方向：
1. 平滑
2. 估计
3. 预测

分别代表着对过去、现在和将来时间的事件处理。
无人机对当前姿态的估计和控制，应用的是估计功能。
事后分析，应用的是平滑功能。
cardboard 应用的是预测功能。这是因为VR应用的特点。

异步采样，异步到达事件的处理。

# 测试与评价

# 参考资料


