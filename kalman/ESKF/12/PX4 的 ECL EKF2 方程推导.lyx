#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass ctex-article
\begin_preamble
% 如果没有这一句命令，XeTeX会出错，原因参见
% http://bbs.ctex.org/viewthread.php?tid=60547
\DeclareRobustCommand\nobreakspace{\leavevmode\nobreak\ }

%\XeTeXlinebreaklocale "zh"
%\XeTeXlinebreakskip = 0pt plus 1pt
%\usepackage{setspace}
%\onehalfspacing
%\XeTeXinterchartokenstate=1

%\usepackage[utf8]{inputenc}

%\usepackage{polyglossia}
%\setdefaultlanguage[variant=american]{english}
%\setotherlanguage{french}
\end_preamble
\options UTF8,fontset=founder
\use_default_options true
\begin_modules
subequations
\end_modules
\maintain_unincluded_children false
\language chinese-simplified
\language_package default
\inputencoding utf8-plain
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts true
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures false
\graphics default
\default_output_format pdf4
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref true
\pdf_title "PX4 的 ECL EKF2 方程推导"
\pdf_author "Shuyong Chen"
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks true
\pdf_pdfborder false
\pdf_colorlinks false
\pdf_backref false
\pdf_pdfusetitle true
\papersize a4paper
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 25.4mm
\topmargin 30mm
\rightmargin 25.4mm
\bottommargin 30mm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
PX4 的 ECL EKF2 方程推导
\end_layout

\begin_layout Author
Shuyong Chen
\end_layout

\begin_layout Section
简介
\end_layout

\begin_layout Standard
PX4 的 ECL (Estimation and Control Library，估计与控制库) 使用EKF对机体状态进行估计，是一个很成熟很优秀的状态估计模
块。因此在很多项目里面得到了广泛应用。但是，对于 ECL EKF 里面的算法，却很少有文档进行系统的总结，而是散落在各个角落。而总结 ECL EKF
 的算法，也相当困难。如果直接看 C++ 代码，则会被里面复杂庞大的计算式吓到。因为它的算法，以前采用 matlab 描述，后来采用 python
 描述，C++ 代码则是由符号推导系统优化后的展开式。但是，matlab / python 描述的只是算法的主要部分，有很多细节的处理，还需要回头看
 C++ 代码的部分。
\end_layout

\begin_layout Standard
本文试图对 ECL EKF 其中的主要算法做一个梳理。经验和学识不足，难免有错漏。欢迎读者讨论和指正。
\end_layout

\begin_layout Section
EKF简单回顾
\end_layout

\begin_layout Standard
对于一个在状态空间描述的线性或者准线性系统，状态
\begin_inset Formula $k$
\end_inset

从
\begin_inset Formula $k-1$
\end_inset

的状态演变而来，根据
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}_{k}=\boldsymbol{F}_{k}\boldsymbol{x}_{k-1}+\boldsymbol{G}_{k}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}
\]

\end_inset

在这里，
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

是状态转换矩阵。对于简单的问题，这个矩阵可以是一个常数，但是对于大多数实际应用程序，转换矩阵依赖于状态向量的值并每次迭代改变。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

是应用于控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

的控制输入模型。这可用于为系统的已知控制输入建模，例如应用于机器人电机的电流、汽车方向盘的位置等。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{w}_{k}$
\end_inset

是过程噪声，假定从零均值多元正态分布
\begin_inset Formula $\mathcal{N}$
\end_inset

中提取，利用协方差矩阵
\begin_inset Formula $\boldsymbol{Q}_{k}:\boldsymbol{w}_{k}\sim\mathcal{N}\left(0,\boldsymbol{Q}_{k}\right)$
\end_inset

。为这个矩阵确定一个合适的值是很棘手的，并且在卡尔曼滤波器的文献中经常被忽视。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在时间“
\begin_inset Formula $k$
\end_inset

”时刻，一个真实状态的观测(或测量)
\begin_inset Formula $\boldsymbol{z}_{k}$
\end_inset

根据
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{z}_{k}=\boldsymbol{H}_{k}\boldsymbol{x}_{k}+\boldsymbol{v}_{k}
\]

\end_inset

其中
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

是将状态空间映射到观测空间的观测模型。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{v}_{k}$
\end_inset

是假设为零均值高斯协方差的观测噪声
\begin_inset Formula $\boldsymbol{R}_{k}:\boldsymbol{v}_{k}\sim\mathcal{N}\left(0,\boldsymbol{R}_{k}\right)$
\end_inset


\end_layout

\begin_layout Standard
注意，
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

将状态向量映射到观测值，而不是相反。这是因为
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

通常是不可逆的，也就是说，它不提供对状态的直接可见性。
\end_layout

\begin_layout Standard
滤波器的状态由两个变量表示：
\end_layout

\begin_layout Itemize
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k}$
\end_inset

，时间k的后验状态估计，给出时间
\begin_inset Formula $k$
\end_inset

之前(包括该时间)的观测值；
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{P}_{k\mid k}$
\end_inset

，后验误差协方差矩阵(状态估计精度的度量)。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
滤波器分两步工作：
\end_layout

\begin_layout Itemize
一个时间更新(预测)步骤，其中状态和协方差矩阵根据我们对系统动力学和误差特征的了解进行更新，这些特征由
\begin_inset Formula $\boldsymbol{F}$
\end_inset

和
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

矩阵建模。预测步骤不包括观察结果的影响。
\end_layout

\begin_layout Itemize
一个测量更新(校正)步骤，其中包括观测的影响，以完善状态估计和协方差矩阵。这一步需要确定测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}$
\end_inset

矩阵。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
预测和校正步骤的相应方程式如下：
\end_layout

\begin_layout Standard
\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\lang english
预测
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测(先验)状态估计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k-1}=\boldsymbol{F}_{k}\hat{\boldsymbol{x}}_{k-1\mid k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测(先验)估计协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{Q}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\lang english
校正
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
新息或测量残差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-\boldsymbol{H}_{k}\hat{\boldsymbol{x}}_{k\mid k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
新息(或残差)协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最佳卡尔曼增益
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
更新(后验)的状态估计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k}=\hat{\boldsymbol{x}}_{k\mid k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
更新(后验)的协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
卡尔曼滤波实现的主要任务是利用系统动力学模型和测量模型，提出状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

和系统噪声特性，设计过程和测量噪声协方差矩阵。
\end_layout

\begin_layout Standard
对于EKF系统，上述方程则增加了本地线性化的处理，变化后的预测和校正步骤的相应方程式如下：
\end_layout

\begin_layout Itemize

\series bold
\lang english
预测
\end_layout

\begin_deeper
\begin_layout Itemize
预测(先验)状态估计
\begin_inset Formula 
\begin{equation}
\hat{\boldsymbol{x}}_{k\mid k-1}=f\left(\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k},\boldsymbol{w}_{k}\right)\label{eq:1}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
预测(先验)估计协方差
\begin_inset Formula 
\begin{equation}
\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{G}_{k}\boldsymbol{Q}_{k}\boldsymbol{G}_{k}^{\mathrm{T}}\label{eq:2}
\end{equation}

\end_inset

其中，状态转移矩阵
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

为雅克比矩阵
\begin_inset Formula 
\[
\boldsymbol{F}_{k}=\left.\dfrac{\partial f}{\partial\boldsymbol{x}}\right|_{\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k}}
\]

\end_inset

控制输入矩阵
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

为雅克比矩阵
\begin_inset Formula 
\[
\boldsymbol{G}_{k}=\left.\dfrac{\partial f}{\partial\boldsymbol{w}}\right|_{\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k}}
\]

\end_inset


\end_layout

\end_deeper
\begin_layout Itemize

\series bold
\lang english
校正
\end_layout

\begin_deeper
\begin_layout Itemize
新息或测量残差
\begin_inset Formula 
\[
\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)
\]

\end_inset


\end_layout

\begin_layout Itemize
新息(或残差)协方差
\begin_inset Formula 
\[
\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}
\]

\end_inset

其中，观测矩阵
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

为雅克比矩阵
\begin_inset Formula 
\[
\boldsymbol{H}_{k}=\left.\dfrac{\partial h}{\partial\boldsymbol{x}}\right|_{\hat{\boldsymbol{x}}_{k\mid k-1}}
\]

\end_inset


\end_layout

\begin_layout Itemize
最佳卡尔曼增益
\begin_inset Formula 
\begin{equation}
\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}\label{eq:3}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的状态估计
\begin_inset Formula 
\begin{equation}
\hat{\boldsymbol{x}}_{k\mid k}=\hat{\boldsymbol{x}}_{k\mid k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k}\label{eq:4}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的协方差
\begin_inset Formula 
\begin{equation}
\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}\label{eq:5}
\end{equation}

\end_inset


\end_layout

\end_deeper
\begin_layout Standard
对于EKF，新增的任务就是计算状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、控制输入矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

和测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

的雅克比矩阵。
\end_layout

\begin_layout Section
ECL EKF 所使用的传感器测量值
\end_layout

\begin_layout Standard
ECL EKF 具有不同的操作模式，以允许不同的传感器测量组合。 滤波器在启动时会检查传感器的最小可行组合，并且在完成初始倾斜，偏航和高度对准之后，进入提供旋转
，垂直速度，垂直位置，IMU 角度偏差和 IMU 速度偏差估计的模式。 
\end_layout

\begin_layout Standard
此模式需要 IMU 数据，偏航数据源(磁力计或外部视觉)和高度数据源。 该数据集是所有EKF运行模式的最低需求数据。 在此基础上可以使用其它传感器数据来估计额外
的状态变量。 
\end_layout

\begin_layout Subsection
IMU 
\end_layout

\begin_layout Standard
与机体固连的三轴惯性测量单元(IMU)，以最小100Hz的频率获取增量角度和增量速度数据 。EKF仅将IMU数据用于状态预测。 在EKF推导中，IMU数据不作为
观测值使用。
\end_layout

\begin_layout Subsection
磁力计 
\end_layout

\begin_layout Standard
需要以最小 5Hz 的速度的三轴机体固连磁力计数据(或外部视觉系统姿势数据)。 磁力计数据可以用于两种方式： 
\end_layout

\begin_layout Itemize
使用倾角估计和磁偏角将磁力计测量值转换为偏航角。 然后将该偏航角用作 EKF 的观察值。 该方法精度较低并且不允许学习机体坐标系场偏移，但是它对于磁场异常和大的
初置陀螺偏差更有鲁棒性。 它是启动期间和在地面时的默认方法。 
\end_layout

\begin_layout Itemize
XYZ 磁力计读数用作单独的观察值。 该方法更精确并且允许学习机体坐标系场偏移，但是它假设地球磁场环境只会缓慢变化，并且当存在显着的外部磁场异常时表现较差。
 
\end_layout

\begin_layout Subsection
高度 
\end_layout

\begin_layout Standard
高度数据源
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

来自 GPS，气压计，测距仪或外部视觉设备，需要最小频率为 5Hz。 
\end_layout

\begin_layout Standard
如果不存在这些测量值，EKF 将无法启动。 当检测到这些测量值时，EKF 将初始化状态并完成倾角和偏航对准。 当倾角和偏航对齐完成后，EKF 可以转换到其它操作
模式，从而可以使用其它传感器数据。 
\end_layout

\begin_layout Subsection
GPS 
\end_layout

\begin_layout Subsubsection
位置和速度测量 
\end_layout

\begin_layout Standard
GPS 提供位置和速度测量。
\end_layout

\begin_layout Subsubsection
偏航角测量 
\end_layout

\begin_layout Standard
有一些全球定位系统接收器可用来提供一个偏航角测量，以取代磁强计数据的使用。 在存在大型磁场异常的环境中工作时，或在高纬度地区，地球磁场具有很大的倾斜角时，这可能
是一个重要的优势。 
\end_layout

\begin_layout Subsubsection
从 GPS 速度数据获取偏航角 
\end_layout

\begin_layout Standard
EKF在内部运行一个附加的多假设滤波器，它使用多个
\begin_inset Formula $3$
\end_inset

参数状态
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北/东向(N/E)的速度和偏航角
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

的扩展卡尔曼滤波器(EKF)。 然后使用高斯加和滤波器(GSF)合并这些偏航角的估计值。 单个
\begin_inset Formula $3$
\end_inset

参数状态的EKF使用了IMU和GPS水平速度数据(加上可选的空速数据)，而不依赖于事先对偏航角或磁强计测量有任何了解。 这里提供了一个对于主滤波器的偏航角备份，
当起飞后导航丢失，表明磁力计的偏航估计值不好时，它被用于重置主 EKF 滤波器的
\begin_inset Formula $24$
\end_inset

参数状态的中的偏航数据。
\end_layout

\begin_layout Standard
这也使得 ECL 能够在没有任何磁力计、或没有双天线 GPS 接收器的情况下运行，并提供偏航数据，只要起飞后能够进行某种水平的移动，偏航数据就变得可观测。
 一旦机体完成了足够的水平移动，使偏航角可观测， 
\begin_inset Formula $24$
\end_inset

参数的主EKF将使其偏航角与GSF的估计值对齐，并开始使用 GPS。 
\end_layout

\begin_layout Subsubsection
双 GPS 接收器 
\end_layout

\begin_layout Standard
GPS接收器提供的数据可以用基于所报告数据的精确度的加权算法混合(如果两者都以相同的速度输出数据并使用相同的精确度，这样做效果最好)。 如果来自接收器的数据丢失
，该机制还提供了自动故障转移，(例如，它允许使用标准 GPS 作为更精确的 RTK 接收器的备份)。
\end_layout

\begin_layout Subsection
测距仪 
\end_layout

\begin_layout Standard
测距仪的对地距离被用于一个单状态滤波器以估计地形相对于高度基准的垂直位置。 
\end_layout

\begin_layout Standard
如果在可用作零高度基准面的平面上操作，则 EKF 也可以直接使用测距仪数据估算高度。
\end_layout

\begin_layout Subsection
空速 
\end_layout

\begin_layout Standard
当存在空速传感器并且飞机类型不是旋翼时，将使用空速数据。 
\end_layout

\begin_layout Subsection
合成侧滑 
\end_layout

\begin_layout Standard
固定翼平台可以利用假定的侧滑观测值为零来改进风速估计，也可以在没有空速传感器的情况下进行风速估计。 
\end_layout

\begin_layout Subsection
基于阻力比力的多旋翼风场估计
\end_layout

\begin_layout Standard
多旋翼平台可以利用沿 X 和 Y 机体轴的空速和阻力之间的关系来估计风速的北/东分量。 
\end_layout

\begin_layout Subsection
光流 
\end_layout

\begin_layout Standard
光流传感器依赖测距仪，提供
\begin_inset Formula $xy$
\end_inset

水平面的速度测量值。 
\end_layout

\begin_layout Subsection
外部视觉系统 
\end_layout

\begin_layout Standard
外部视觉系统提供位置、速度和姿态测量。
\end_layout

\begin_layout Subsection
测量值用途汇总
\end_layout

\begin_layout Standard
\noindent
\begin_inset Tabular
<lyxtabular version="3" rows="11" columns="6">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测量值
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
符号
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
单位
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
来源
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最小频率
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
用途
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
加速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s^{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
地球磁场
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{gauss}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
磁力计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
距地高度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{hagl}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/气压计/测距仪/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{V}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/(光流+测距仪)/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
偏航角测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\psi$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/磁力计/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
等效空速
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{airspeed}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
空速传感器
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
合成侧滑
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{beta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
虚拟
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
阻力比力
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{drag}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
虚拟
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
根据前面的描述可知：
\end_layout

\begin_layout Itemize
ECL EKF2 最小传感器集合为：IMU，偏航数据源和高度数据源。
\end_layout

\begin_layout Itemize
机体的姿态变化由角速度驱动，速度变化由加速度驱动，这两者由IMU提供。
\end_layout

\begin_layout Itemize
偏航测量值校正了在
\begin_inset Formula $xy$
\end_inset

水平面上姿态，高度测量值校正了
\begin_inset Formula $z$
\end_inset

轴上的位置。有了这两者才能执行最基本的自动导航功能。
\end_layout

\begin_layout Itemize
磁力计是最适合校正姿态的传感器，也是最容易受到外界影响的传感器。气压计是最常见的测量高度的设备，因为成本低廉。
\end_layout

\begin_layout Itemize
GPS是多面手，可以提供很多测量数据。所以如果不是成本受限，GPS应该是无人机的标配设备。注意，GPS的采样速率比较慢，在ECL系统中假设其最小频率为2Hz。
\end_layout

\begin_layout Itemize
光流设备和外部视觉设备是最时髦的设备。但是应用效果还有待观察。
\end_layout

\begin_layout Itemize
ECL EKF2 做了很多数据质量检测判断。因此外接传感器的种类越多，则容错率就越高。
\end_layout

\begin_layout Section
ECL EKF 时间更新方程
\end_layout

\begin_layout Subsection
状态向量
\end_layout

\begin_layout Standard
估计和控制库(ECL)使用扩展卡尔曼滤波算法(EKF)来处理传感器的测量信息，并提供如下状态向量的估计值： 
\end_layout

\begin_layout Itemize
四元数定义从北，东，地(NED)局部地球坐标系到 X，Y，Z 机体坐标系的旋转 
\end_layout

\begin_layout Itemize
IMU 的速度
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北，东，地(NED)(m/s) 
\end_layout

\begin_layout Itemize
IMU 的位置
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北，东，地(NED)(m) 
\end_layout

\begin_layout Itemize
IMU 增量角度偏差估计
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

X, Y, Z(rad) 
\end_layout

\begin_layout Itemize
IMU 增量速度偏差估计
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

X, Y, Z(m/s) 
\end_layout

\begin_layout Itemize
地球磁场分量
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北，东，地(NED)(gauss) 
\end_layout

\begin_layout Itemize
飞行器机体坐标系磁场偏差
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

X, Y, Z(gauss) 
\end_layout

\begin_layout Itemize
风速
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北, 东(NE)(m/s)
\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
24个状态的向量定义为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}=\left[\begin{array}{cccccccc}
q^{\mathrm{T}} & \boldsymbol{V}_{NED}^{\mathrm{T}} & \boldsymbol{P}_{NED}^{\mathrm{T}} & \boldsymbol{\Delta\theta}_{b}^{\mathrm{T}} & \boldsymbol{\Delta V}_{b}^{\mathrm{T}} & \boldsymbol{M}_{I}^{\mathrm{T}} & \boldsymbol{M}_{B}^{\mathrm{T}} & \boldsymbol{V}_{wind}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\]

\end_inset

其中，姿态四元数
\begin_inset Formula $q$
\end_inset

，用于定义 XYZ 机体坐标系相对于 NED 导航
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
坐标系
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
的角度位置，我们用
\begin_inset Formula $\boldsymbol{q}$
\end_inset

表示其向量部分，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]=\left[\begin{array}{c}
q_{0}\\
\boldsymbol{q}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

表示在 NED 坐标系的机体速度，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{V}_{NED}=\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

表示在 NED 坐标系的机体位置，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{P}_{NED}=\left[\begin{array}{c}
P_{N}\\
P_{E}\\
P_{D}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{\Delta\theta}_{b}$
\end_inset

表示在 XYZ 机体坐标系的增量角度偏差(bias)，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{\Delta\theta}_{b}=\left[\begin{array}{c}
\Delta\theta_{b_{X}}\\
\Delta\theta_{b_{Y}}\\
\Delta\theta_{b_{Z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{\Delta V}_{b}$
\end_inset

表示在 XYZ 机体坐标系的增量速度偏差(bias)，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{b}=\left[\begin{array}{c}
\Delta V_{b_{X}}\\
\Delta V_{b_{Y}}\\
\Delta V_{b_{Z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

表示在 NED 坐标系的地球磁场向量，简称地磁，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{M}_{I}=\left[\begin{array}{c}
M_{N}\\
M_{E}\\
M_{D}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{M}_{B}$
\end_inset

表示在 XYZ 机体坐标系的磁场偏差(bias)，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{M}_{B}=\left[\begin{array}{c}
M_{X}\\
M_{Y}\\
M_{Z}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

表示在 NED 坐标系的在北东 (NE) 方向上的风速，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{V}_{wind}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
应用软件常用的数据输出有：
\end_layout

\begin_layout Itemize
姿态输出。 
\end_layout

\begin_layout Itemize
速度输出。 
\end_layout

\begin_layout Itemize
位置输出。 
\end_layout

\begin_layout Itemize
风速输出。 
\end_layout

\begin_layout Standard
注意：输出的数据项和状态向量中的数据不完全相同，而是使用输出互补滤波器进行校正的数据，参见文档[12]中的算法。
\end_layout

\begin_layout Subsection
时间更新方程
\end_layout

\begin_layout Subsubsection
旋转矩阵
\end_layout

\begin_layout Standard
从机体坐标系到导航坐标系的旋转矩阵根据姿态四元数
\begin_inset Formula $q$
\end_inset

由以下方程给出：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left[T\right]_{B}^{N} & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\\
 & =\left[\begin{array}{ccc}
1-2q_{2}^{2}-2q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & 1-2q_{1}^{2}-2q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & 1-2q_{1}^{2}-2q_{2}^{2}
\end{array}\right]
\end{align*}

\end_inset

上面上下两个方程在数学上完全相等，但是第二个方程在符号推导系统中产生更简单且更数值稳定的计算式，因此 ECL EKF2 选择了第二个方程。
\end_layout

\begin_layout Standard
如果需要从导航坐标系到机体坐标系的旋转，将使用转置，并用
\begin_inset Formula $\left[T\right]_{N}^{B}$
\end_inset

表示：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left[T\right]_{N}^{B}=\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}=\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Subsubsection
时间更新
\end_layout

\begin_layout Standard
IMU传感器定时采样，采样间隔时间为
\begin_inset Formula $\Delta t$
\end_inset

，获得
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}$
\end_inset

数据。所以我们得到增量角度的测量值为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta\theta}_{meas}=\boldsymbol{\omega}\Delta t\label{eq:6}
\end{equation}

\end_inset

还有增量速度的测量值为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta V}_{meas}=\boldsymbol{a}\Delta t\label{eq:7}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
已知陀螺仪的测量方差为
\begin_inset Formula $\boldsymbol{\sigma}_{gyro}^{2}$
\end_inset

，加速计的测量方差为
\begin_inset Formula $\boldsymbol{\sigma}_{accel}^{2}$
\end_inset

。所以我们有增量角度的测量方差为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}=\boldsymbol{\sigma}_{gyro}^{2}\Delta t^{2}\label{eq:8}
\end{equation}

\end_inset

还有增量速度的测量方差为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}=\boldsymbol{\sigma}_{accel}^{2}\Delta t^{2}\label{eq:9}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测量值
\begin_inset Formula $\boldsymbol{\Delta\theta}_{meas}$
\end_inset

和增量角度偏差
\begin_inset Formula $\boldsymbol{\Delta\theta}_{b}$
\end_inset

计算出真增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{truth}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta\theta}_{truth}=\boldsymbol{\Delta\theta}_{meas}-\boldsymbol{\Delta\theta}_{b}\label{eq:10}
\end{equation}

\end_inset

增量四元数
\begin_inset Formula $\Delta q$
\end_inset

定义了从第
\begin_inset Formula $k$
\end_inset

时刻到第
\begin_inset Formula $k+1$
\end_inset

时刻四元数的旋转，使用小角度近似从真增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{truth}$
\end_inset

计算(惯性导航采用其它精确方法计算)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\Delta q=\left[\begin{array}{c}
1\\
\dfrac{\boldsymbol{\Delta\theta}_{truth}}{2}
\end{array}\right]\label{eq:11}
\end{equation}

\end_inset

从
\begin_inset Formula $k$
\end_inset

时刻到
\begin_inset Formula $k+1$
\end_inset

时刻，四元数乘积规则用于将姿态四元数的状态向前旋转增量四元数
\begin_inset Formula $\Delta q$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
q_{k+1} & =q_{k}\cdot\Delta q\\
\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]_{k+1} & =\left[\begin{array}{c}
q_{0}\Delta q_{0}-q_{1}\Delta q_{1}-q_{2}\Delta q_{2}-q_{3}\Delta q_{3}\\
q_{1}\Delta q_{0}+q_{0}\Delta q_{1}-q_{3}\Delta q_{2}+q_{2}\Delta q_{3}\\
q_{2}\Delta q_{0}+q_{3}\Delta q_{1}+q_{0}\Delta q_{2}-q_{1}\Delta q_{3}\\
q_{3}\Delta q_{0}-q_{2}\Delta q_{1}+q_{1}\Delta q_{2}+q_{0}\Delta q_{3}
\end{array}\right]
\end{array}\label{eq:12}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测量值
\begin_inset Formula $\boldsymbol{\Delta V}_{meas}$
\end_inset

和增量速度偏差
\begin_inset Formula $\boldsymbol{\Delta V}_{b}$
\end_inset

计算出真增量速度
\begin_inset Formula $\boldsymbol{\Delta V}_{truth}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta V}_{truth}=\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta V}_{b}\label{eq:13}
\end{equation}

\end_inset

从
\begin_inset Formula $k$
\end_inset

时刻到
\begin_inset Formula $k+1$
\end_inset

时刻，将真增量速度向量
\begin_inset Formula $\boldsymbol{\Delta V}_{truth}$
\end_inset

从机体坐标系旋转到地球坐标系，并减去重力，计算速度状态变化
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\left(\boldsymbol{V}_{NED}\right)_{k+1} & =\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\\
\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k+1} & =\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\left[\begin{array}{c}
0\\
0\\
g
\end{array}\right]\cdot\Delta t
\end{array}\label{eq:14}
\end{equation}

\end_inset

使用欧拉积分更新位置状态(惯性导航使用更精确的梯形积分方法)
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\left(\boldsymbol{P}_{NED}\right)_{k+1} & =\left(\boldsymbol{P}_{NED}\right)_{k}+\left(\boldsymbol{V}_{NED}\right)_{k}\cdot\Delta t\\
\left[\begin{array}{c}
P_{N}\\
P_{E}\\
P_{D}
\end{array}\right]_{k+1} & =\left[\begin{array}{c}
P_{N}\\
P_{E}\\
P_{D}
\end{array}\right]_{k}+\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k}\cdot\Delta t
\end{array}\label{eq:15}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
IMU传感器的偏差、磁场和风速状态均采用静态过程模型：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\begin{array}{c}
\boldsymbol{\Delta\theta}_{b}\\
\boldsymbol{\Delta V}_{b}\\
\boldsymbol{M}_{I}\\
\boldsymbol{M}_{B}\\
\boldsymbol{V}_{wind}
\end{array}\right]_{k+1}=\left[\begin{array}{c}
\boldsymbol{\Delta\theta}_{b}\\
\boldsymbol{\Delta V}_{b}\\
\boldsymbol{M}_{I}\\
\boldsymbol{M}_{B}\\
\boldsymbol{V}_{wind}
\end{array}\right]_{k}\label{eq:16}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
自此，已经完成预测(先验)状态估计的计算。接下来要进行预测(先验)估计协方差的计算。方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:1"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可表示为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}_{k+1}=\boldsymbol{F}\boldsymbol{x}_{k}+\boldsymbol{G}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}
\]

\end_inset

其中，控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

，也称干扰(disturbance)向量，为
\begin_inset Formula 
\[
\boldsymbol{u}=\left[\begin{array}{c}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}
\end{array}\right]
\]

\end_inset

它是由惯性测量单元(IMU)的增量角度和增量速度的测量方差，
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}$
\end_inset

和
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}$
\end_inset

所定义。在状态变量中消除偏差影响后，假设惯性解中的误差增长是由增量角度和增量速度中的“噪声”驱动的。这种方案是可行的，因为在状态方程中考虑了传感器偏差。方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

)中的矩阵
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

为测量方差元素构成的对角线矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{Q}_{6\times6} & =\mathrm{diag}\left(\left[\begin{array}{c}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}
\end{array}\right]\right)
\end{align*}

\end_inset

并且
\begin_inset Formula $\boldsymbol{G}\boldsymbol{Q}\boldsymbol{G}^{\mathrm{T}}$
\end_inset

被称为状态误差矩阵。
\end_layout

\begin_layout Standard
根据前面推导的第 
\begin_inset Formula $k+1$
\end_inset

 时刻的状态向量方程 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:15"
plural "false"
caps "false"
noprefix "false"

\end_inset

) 和 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:16"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，分别对第 
\begin_inset Formula $k$
\end_inset

 时刻的状态 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\boldsymbol{x}_{k}$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
 求 Jacobian 可得状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、控制(干扰)影响矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

。
\end_layout

\begin_layout Standard
状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

是一个
\begin_inset Formula $24\times24$
\end_inset

的稀疏矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{F} & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\boldsymbol{x}_{k}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{F}_{q_{k}}^{q_{k+1}} & 0_{4\times3} & 0_{4\times3} & \boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}} & 0_{4\times3} & 0_{4\times3} & 0_{4\times3} & 0_{4\times2}\\
\boldsymbol{F}_{q_{k}}^{V_{k+1}} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{F}_{\Delta V_{b}^{k}}^{V_{k+1}} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & \boldsymbol{F}_{V_{k}}^{P_{k+1}} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times2}\\
0_{2\times4} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & \boldsymbol{I}_{2\times2}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{q_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{V_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{V_{k}}^{P_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{\Delta V_{b}^{k}}^{V_{k+1}}$
\end_inset

这5个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{q_{k+1}}$
\end_inset

为关于四元数的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的旋转相对于
\begin_inset Formula $k$
\end_inset

时刻的 Jacobian ，大小为
\begin_inset Formula $4\times4$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{q_{k}}^{q_{k+1}} & =\dfrac{\partial q_{k+1}}{\partial q_{k}}\\
 & =\dfrac{\partial\left(q_{k}\cdot\Delta q\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(q_{k}+q_{k}\cdot\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{truth}}{2}
\end{array}\right]\right)}{\partial q_{k}}\\
 & =\boldsymbol{I}_{4\times4}+M\left(\dfrac{\boldsymbol{\Delta\theta}_{truth}}{2}\right)
\end{align*}

\end_inset

其中，
\begin_inset Formula $M\left(\boldsymbol{\theta}\right)$
\end_inset

为
\begin_inset Formula $4\times4$
\end_inset

斜对称矩阵
\begin_inset Formula 
\[
M\left(\boldsymbol{\theta}\right)=\left[\begin{array}{cccc}
0 & -\theta_{x} & -\theta_{y} & -\theta_{z}\\
\theta_{x} & 0 & \theta_{z} & -\theta_{y}\\
\theta_{y} & -\theta_{z} & 0 & \theta_{x}\\
\theta_{z} & \theta_{y} & -\theta_{x} & 0
\end{array}\right]
\]

\end_inset

该矩阵在四元数教材里又被称为
\begin_inset Formula $\boldsymbol{\Omega}$
\end_inset

矩阵，出现在向量和四元数的乘积中
\begin_inset Formula 
\[
\boldsymbol{\Omega}\left(\boldsymbol{\theta}\right)=\left[\begin{array}{cc}
0 & -\boldsymbol{\theta}^{\mathrm{T}}\\
\boldsymbol{\theta} & -\left[\boldsymbol{\theta}\times\right]
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{V_{k+1}}$
\end_inset

为速度关于四元数的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的速度相对于
\begin_inset Formula $k$
\end_inset

时刻的旋转的 Jacobian ，大小为
\begin_inset Formula $3\times4$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{q_{k}}^{V_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
\Delta V_{X}\\
\Delta V_{Y}\\
\Delta V_{Z}
\end{array}\right]\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\Delta V_{X}+2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right)\Delta V_{Y}+2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\Delta V_{Z}\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right)\Delta V_{X}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\Delta V_{Y}+2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\Delta V_{Z}\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right)\Delta V_{X}+2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right)\Delta V_{Y}+\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)\Delta V_{Z}
\end{array}\right]\right)}{\partial q_{k}}\\
 & \tiny=2\left[\begin{array}{cccc}
q_{0}\Delta V_{X}-q_{3}\Delta V_{Y}+q_{2}\Delta V_{Z} & q_{1}\Delta V_{X}+q_{2}\Delta V_{Y}+q_{3}\Delta V_{Z} & -q_{2}\Delta V_{X}+q_{1}\Delta V_{Y}+q_{0}\Delta V_{Z} & -q_{3}\Delta V_{X}-q_{0}\Delta V_{Y}+q_{1}\Delta V_{Z}\\
q_{3}\Delta V_{X}+q_{0}\Delta V_{Y}-q_{1}\Delta V_{Z} & q_{2}\Delta V_{X}-q_{1}\Delta V_{Y}-q_{0}\Delta V_{Z} & q_{1}\Delta V_{X}+q_{2}\Delta V_{Y}+q_{3}\Delta V_{Z} & q_{0}\Delta V_{X}-q_{3}\Delta V_{Y}+q_{2}\Delta V_{Z}\\
-q_{2}\Delta V_{X}+q_{1}\Delta V_{Y}+q_{0}\Delta V_{Z} & q_{3}\Delta V_{X}+q_{0}\Delta V_{Y}-q_{1}\Delta V_{Z} & -q_{0}\Delta V_{X}+q_{3}\Delta V_{Y}-q_{2}\Delta V_{Z} & q_{1}\Delta V_{X}+q_{2}\Delta V_{Y}+q_{3}\Delta V_{Z}
\end{array}\right]\\
 & =2\left[\begin{array}{c}
\left(\Phi_{1}\cdot\boldsymbol{\Delta V}_{truth}\right)^{\mathrm{T}}\\
\left(\Phi_{2}\cdot\boldsymbol{\Delta V}_{truth}\right)^{\mathrm{T}}\\
\left(\Phi_{3}\cdot\boldsymbol{\Delta V}_{truth}\right)^{\mathrm{T}}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula 
\[
\Phi_{1}=\left[\begin{array}{ccc}
q_{0} & -q_{3} & q_{2}\\
q_{1} & q_{2} & q_{3}\\
-q_{2} & q_{1} & q_{0}\\
-q_{3} & -q_{0} & q_{1}
\end{array}\right],\quad\Phi_{2}=\left[\begin{array}{ccc}
q_{3} & q_{0} & -q_{1}\\
q_{2} & -q_{1} & -q_{0}\\
q_{1} & q_{2} & q_{3}\\
q_{0} & -q_{3} & q_{2}
\end{array}\right],\quad\Phi_{3}=\left[\begin{array}{ccc}
-q_{2} & q_{1} & q_{0}\\
q_{3} & q_{0} & -q_{1}\\
-q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{V_{k}}^{P_{k+1}}$
\end_inset

为位置关于速度的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的位置相对于
\begin_inset Formula $k$
\end_inset

时刻的速度的 Jacobian，大小为
\begin_inset Formula $3\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:15"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{V_{k}}^{P_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{P}_{NED}\right)_{k}+\left(\boldsymbol{V}_{NED}\right)_{k}\cdot\Delta t\right)}{\partial\left(\boldsymbol{V}_{NED}\right)_{k}}\\
 & =\boldsymbol{I}_{3\times3}\cdot\Delta t
\end{align*}

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}}$
\end_inset

为四元数关于增量角度偏差的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的旋转相对于陀螺仪
\begin_inset Formula $k$
\end_inset

时刻增量角度偏差的 Jacobian ，大小为
\begin_inset Formula $4\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:10"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}} & =\dfrac{\partial\left(q_{k}\cdot\Delta q\right)}{\partial\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}\\
 & =\dfrac{\partial\left(q_{k}+q_{k}\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{meas}}{2}
\end{array}\right]+q_{k}\left[\begin{array}{c}
0\\
\dfrac{-\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}{2}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}\\
 & =\dfrac{\partial\left(-\dfrac{1}{2}\left[\begin{array}{c}
-q_{1}\Delta\theta_{b_{X}}-q_{2}\Delta\theta_{b_{Y}}-q_{3}\Delta\theta_{b_{Z}}\\
+q_{0}\Delta\theta_{b_{X}}-q_{3}\Delta\theta_{b_{Y}}+q_{2}\Delta\theta_{b_{Z}}\\
+q_{3}\Delta\theta_{b_{X}}+q_{0}\Delta\theta_{b_{Y}}-q_{1}\Delta\theta_{b_{Z}}\\
-q_{2}\Delta\theta_{b_{X}}+q_{1}\Delta\theta_{b_{Y}}+q_{0}\Delta\theta_{b_{Z}}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}\\
 & =-\dfrac{1}{2}\left[\begin{array}{ccc}
-q_{1} & -q_{2} & -q_{3}\\
+q_{0} & -q_{3} & +q_{2}\\
+q_{3} & +q_{0} & -q_{1}\\
-q_{2} & +q_{1} & +q_{0}
\end{array}\right]\\
 & =-\dfrac{1}{2}\boldsymbol{\Xi}\left(q\right)
\end{align*}

\end_inset

矩阵
\begin_inset Formula $\boldsymbol{\Xi}\left(q\right)$
\end_inset

出现在四元数与向量的乘法中
\begin_inset Formula 
\[
\boldsymbol{\Xi}\left(q\right)=\left[\begin{array}{c}
-\boldsymbol{q}^{\mathrm{T}}\\
q_{0}\boldsymbol{I}_{3\times3}+\left[\boldsymbol{q}\times\right]
\end{array}\right]
\]

\end_inset

矩阵
\begin_inset Formula $\boldsymbol{\Xi}$
\end_inset

和
\begin_inset Formula $\boldsymbol{\Omega}$
\end_inset

之间的关系为
\begin_inset Formula 
\[
\boldsymbol{\Omega}\left(\boldsymbol{\theta}\right)q=\boldsymbol{\Xi}\left(q\right)\boldsymbol{\theta}
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{\Delta V_{b}^{k}}^{V_{k+1}}$
\end_inset

为速度关于增量速度偏差的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的速度相对于加速度计
\begin_inset Formula $k$
\end_inset

时刻增量速度偏差的 Jacobian ，大小为
\begin_inset Formula $3\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:13"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\Delta V_{b}^{k}}^{V_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta V}_{b}\right)_{k}}\\
 & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\left(\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta V}_{b}\right)+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta V}_{b}\right)_{k}}\\
 & =-\left[T\right]_{B}^{N}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
控制(干扰)影响矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

需要对增量角度和增量速度的测量值求偏导，因为测量值中包含有噪声。它是一个
\begin_inset Formula $24\times6$
\end_inset

的稀疏矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{G} & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\boldsymbol{w}_{k}}\\
 & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\left(\boldsymbol{\Delta\theta}_{meas},\boldsymbol{\Delta V}_{meas}\right)_{k}}\\
 & =\left[\begin{array}{cc}
\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}} & 0_{4\times3}\\
0_{3\times3} & \boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{2\times3} & 0_{2\times3}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}}$
\end_inset

和
\begin_inset Formula $\boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}}$
\end_inset

这2个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}}$
\end_inset

为姿态四元数关于增量角度噪声的控制输入矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的旋转相对于陀螺仪
\begin_inset Formula $k$
\end_inset

时刻增量角度噪声的协方差矩阵，大小为
\begin_inset Formula $4\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:10"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}} & =\dfrac{\partial\left(q_{k}\cdot\Delta q\right)}{\partial\left(\boldsymbol{\Delta\theta}_{meas}\right)_{k}}\\
 & =\dfrac{\partial\left(q_{k}+q_{k}\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{meas}}{2}
\end{array}\right]+q_{k}\left[\begin{array}{c}
0\\
\dfrac{-\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}{2}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{meas}\right)_{k}}\\
 & =\dfrac{\partial\left(\dfrac{1}{2}\left[\begin{array}{c}
-q_{1}\Delta\theta_{meas_{X}}-q_{2}\Delta\theta_{meas_{Y}}-q_{3}\Delta\theta_{meas_{Z}}\\
+q_{0}\Delta\theta_{meas_{X}}-q_{3}\Delta\theta_{meas_{Y}}+q_{2}\Delta\theta_{meas_{Z}}\\
+q_{3}\Delta\theta_{meas_{X}}+q_{0}\Delta\theta_{meas_{Y}}-q_{1}\Delta\theta_{meas_{Z}}\\
-q_{2}\Delta\theta_{meas_{X}}+q_{1}\Delta\theta_{meas_{Y}}+q_{0}\Delta\theta_{meas_{Z}}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{meas}\right)_{k}}\\
 & =\dfrac{1}{2}\left[\begin{array}{ccc}
-q_{1} & -q_{2} & -q_{3}\\
+q_{0} & -q_{3} & +q_{2}\\
+q_{3} & +q_{0} & -q_{1}\\
-q_{2} & +q_{1} & +q_{0}
\end{array}\right]\\
 & =\dfrac{1}{2}\boldsymbol{\Xi}\left(q\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}}$
\end_inset

为速度关于增量速度噪声的控制输入矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的速度相对于加速度计
\begin_inset Formula $k$
\end_inset

时刻增量速度噪声的协方差矩阵，大小为
\begin_inset Formula $3\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:13"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta V}_{meas}\right)_{k}}\\
 & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\left(\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta V}_{b}\right)+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta V}_{meas}\right)_{k}}\\
 & =\left[T\right]_{B}^{N}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
最后，为方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

)中的协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

增加过程噪声
\begin_inset Formula $\boldsymbol{w}$
\end_inset

。那些运动学的状态(姿态
\begin_inset Formula $q$
\end_inset

、速度
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

和位置
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

)，它们的误差增长分别由IMU噪声方差控制，已经在前面的方程中加入。对于其它静态过程模型的状态，则用静态过程模型构造这些状态的过程噪声方差对角线，
\begin_inset Formula $24\times24$
\end_inset

的过程噪声矩阵为
\begin_inset Formula 
\[
\boldsymbol{w}=\mathrm{diag}\left(\left[\begin{array}{c}
0_{4\times1}\\
0_{3\times1}\\
0_{3\times1}\\
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{M}_{I}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{M}_{B}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{V}_{wind}}^{2}
\end{array}\right]\right)
\]

\end_inset

其中，增量角度偏差和增量速度偏差的过程噪声方差，同样采用增量角度的测量方差
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}$
\end_inset

和增量速度的测量方差
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta V}}^{2}$
\end_inset

。地球磁场
\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

，机体磁场偏差
\begin_inset Formula $\boldsymbol{M}_{B}$
\end_inset

和风速
\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

的过程噪声方差，
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{M}_{I}}^{2}$
\end_inset

、
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{M}_{B}}^{2}$
\end_inset

和
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{V}_{wind}}^{2}$
\end_inset

，可由用户自行设定。
\end_layout

\begin_layout Standard
至此，已经完成预测(先验)估计协方差的计算。
\end_layout

\begin_layout Section
ECL EKF 测量更新方程
\end_layout

\begin_layout Standard
ECL EKF 算法最大的特点就是使用传感器组合进行状态估计。这样的好处是系统具有很高的容错性，不管发生什么异常，总是有方法进行数据校正。但是带来的问题就是算法
复杂，代码分支繁多，很难把握，更难调试。
\end_layout

\begin_layout Standard
该算法的第二个特点是将
\begin_inset Formula $xy$
\end_inset

水平面和
\begin_inset Formula $z$
\end_inset

轴方向的高度分开估计。这个估计是因为GPS的高度数据误差太大，而高度数据源又很多，这么处理可以提升高度数据的精度。
\end_layout

\begin_layout Standard
该算法的第三个特点是对所有的观测向量都是拆分为一维一维的数据进行校正。这是一种优化算法，通过使用更多的运算步骤换取使用更少的栈空间。这对于MCU这种内存紧张的环
境有好处。
\end_layout

\begin_layout Subsection
磁力计融合
\end_layout

\begin_layout Standard
磁力计更新分为两种情况：
\end_layout

\begin_layout Enumerate
用三轴磁力计的数据作为三维观测。
\end_layout

\begin_layout Enumerate
直接将磁力计的数据转换为磁偏角作为一维观测。
\end_layout

\begin_layout Standard
第二种方法对于磁场异常和大的初置陀螺偏差更有鲁棒性。 它是启动期间和在地面时的默认方法。第一种方法有更好的精度，但是当存在显着的外部磁场异常时表现较差。
\end_layout

\begin_layout Standard
三轴磁场的更新根据是否有磁偏角的约束分为两个阶段。在初始化或差工况时，先进行无磁偏角约束的磁力计融合阶段，再进行有磁偏角约束的融合阶段；好工况时则相反。下面2个
小节分别进行这两个阶段的方程推导。第3小节进行一维观测的方程推导。
\end_layout

\begin_layout Subsubsection
磁力计测量融合方程
\end_layout

\begin_layout Standard
无磁偏角约束的三轴磁场的融合阶段，不考虑磁偏角
\begin_inset Formula $\psi_{DECLINATION}$
\end_inset

，也就是假设地球的地理南北极与地磁南北极重合。
\end_layout

\begin_layout Standard
由磁力计测量的机体磁场强度为
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset

。已知磁力计的测量方差为
\begin_inset Formula $\boldsymbol{R}_{MAG}$
\end_inset

。
\end_layout

\begin_layout Standard
预测的机体磁场强度为
\begin_inset Formula $\boldsymbol{M}_{pred}$
\end_inset

，由状态向量中的地球磁场
\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

旋转到机体轴得到：
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{pred} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\\
\left[\begin{array}{c}
M_{pred_{X}}\\
M_{pred_{Y}}\\
M_{pred_{Z}}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
M_{N}\\
M_{E}\\
M_{D}
\end{array}\right]+\left[\begin{array}{c}
M_{X}\\
M_{Y}\\
M_{Z}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
磁场观测矩阵
\begin_inset Formula $\boldsymbol{H}_{MAG}$
\end_inset

是一个
\begin_inset Formula $3\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{MAG} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{H}_{M_{I}} & \boldsymbol{H}_{M_{B}} & 0_{3\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}$
\end_inset

、
\begin_inset Formula $\boldsymbol{H}_{M_{I}}$
\end_inset

和
\begin_inset Formula $\boldsymbol{H}_{M_{B}}$
\end_inset

这3个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{q}$
\end_inset

为磁力计的观测相对于姿态四元数的观测矩阵，即磁场测量值相对于旋转的 Jacobian ，大小为
\begin_inset Formula $3\times4$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{q} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial q}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\right)}{\partial q}\\
 & =\dfrac{\partial\left(\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
M_{N}\\
M_{E}\\
M_{D}
\end{array}\right]\right)}{\partial q}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)M_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)M_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)M_{D}\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right)M_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)M_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)M_{D}\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right)M_{N}+2\left(q_{2}q_{3}-q_{0}q_{1}\right)M_{E}+\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)M_{D}
\end{array}\right]\right)}{\partial q}\\
 & \tiny=2\left[\begin{array}{cccc}
q_{0}M_{N}+q_{3}M_{E}-q_{2}M_{D} & q_{1}M_{N}+q_{2}M_{E}+q_{3}M_{D} & -q_{2}M_{N}+q_{1}M_{E}-q_{0}M_{D} & -q_{3}M_{N}+q_{0}M_{E}+q_{1}M_{D}\\
-q_{3}M_{N}+q_{0}M_{E}+q_{1}M_{D} & q_{2}M_{N}-q_{1}M_{E}+q_{0}M_{D} & q_{1}M_{N}+q_{2}M_{E}+q_{3}M_{D} & -q_{0}M_{N}-q_{3}M_{E}+q_{2}M_{D}\\
q_{2}M_{N}-q_{1}M_{E}+q_{0}M_{D} & q_{3}M_{N}-q_{0}M_{E}-q_{1}M_{D} & q_{0}M_{N}+q_{3}M_{E}-q_{2}M_{D} & q_{1}M_{N}+q_{2}M_{E}+q_{3}M_{D}
\end{array}\right]\\
 & =2\left[\begin{array}{c}
\left(\Phi_{4}\cdot\boldsymbol{M}_{I}\right)^{\mathrm{T}}\\
\left(\Phi_{5}\cdot\boldsymbol{M}_{I}\right)^{\mathrm{T}}\\
\left(\Phi_{6}\cdot\boldsymbol{M}_{I}\right)^{\mathrm{T}}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula 
\[
\Phi_{4}=\left[\begin{array}{ccc}
q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}\\
-q_{2} & q_{1} & -q_{0}\\
-q_{3} & q_{0} & q_{1}
\end{array}\right],\quad\Phi_{5}=\left[\begin{array}{ccc}
-q_{3} & q_{0} & q_{1}\\
q_{2} & -q_{1} & q_{0}\\
q_{1} & q_{2} & q_{3}\\
-q_{0} & -q_{3} & q_{2}
\end{array}\right],\quad\Phi_{6}=\left[\begin{array}{ccc}
q_{2} & -q_{1} & q_{0}\\
q_{3} & -q_{0} & -q_{1}\\
q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{M_{I}}$
\end_inset

为磁力计的观测相对于地球磁场向量的观测矩阵，即磁场测量值相对于地球磁场的 Jacobian ，大小
\begin_inset Formula $3\times3$
\end_inset

为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{M_{I}} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial\boldsymbol{M}_{I}}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\right)}{\partial\boldsymbol{M}_{I}}\\
 & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{M_{B}}$
\end_inset

为磁力计的观测相对于机体磁场偏差的观测矩阵，即磁场测量值相对于磁场偏差的 Jacobian ，大小
\begin_inset Formula $3\times3$
\end_inset

为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{M_{B}} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial\boldsymbol{M}_{B}}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\right)}{\partial\boldsymbol{M}_{B}}\\
 & =\boldsymbol{I}_{3\times3}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在实际的代码里，磁场观测矩阵
\begin_inset Formula $\boldsymbol{H}_{MAG}$
\end_inset

实际上是分为3个一维观测矩阵进行观测：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{MAG_{X}} & =\dfrac{\partial M_{pred_{X}}}{\partial\boldsymbol{x}}\\
\boldsymbol{H}_{MAG_{Y}} & =\dfrac{\partial M_{pred_{Y}}}{\partial\boldsymbol{x}}\\
\boldsymbol{H}_{MAG_{Z}} & =\dfrac{\partial M_{pred_{Z}}}{\partial\boldsymbol{x}}
\end{align*}

\end_inset

这是一种优化算法，使用更多的运算步骤换取使用更少的栈空间。这对于MCU这种内存紧张的环境有好处。
\end_layout

\begin_layout Subsubsection
综合偏差测量的融合方程
\end_layout

\begin_layout Standard
有磁偏角约束的融合阶段，考虑事实上，地球的地理南北极与地磁南北极并不重合，也就是真北和磁北有一定夹角，这个夹角称为磁偏角
\begin_inset Formula $\psi_{DECLINATION}$
\end_inset

。 因此如果增加了磁偏角的约束，则需要在融合完三轴磁力计测量值的基础上进行此部分的融合。这用于在没有绝对位置或速度测量的情况下保持正确的航向
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

例如使用光流时。这可以用来防止在航向观测不良期间地球磁场估计的不必要的偏航旋转。
\end_layout

\begin_layout Standard
磁偏角的测量值，有两个来源：一是由GPS提供，二是由用户设定本地的磁偏角数据。磁偏角的噪声为
\begin_inset Formula $R=\sigma_{decl}^{2}$
\end_inset

，其中标准差
\begin_inset Formula $\sigma_{decl}$
\end_inset

在代码中设定，好工况为
\begin_inset Formula $0.02$
\end_inset

，差工况为
\begin_inset Formula $0.5$
\end_inset

。
\end_layout

\begin_layout Standard
磁偏角
\begin_inset Formula $\psi_{DECLINATION}$
\end_inset

的预测值为
\begin_inset Formula 
\[
\psi_{DECLINATION}=\arctan\left(\dfrac{M_{E}}{M_{N}}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
磁偏角观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\psi_{DECLINATION}}$
\end_inset

是一个
\begin_inset Formula $1\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{\psi_{DECLINATION}} & =\dfrac{\partial\psi_{DECLINATION}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
0_{1\times4} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & \boldsymbol{H}_{M_{I}}^{\psi_{DECLINATION}} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{M_{I}}^{\psi_{DECLINATION}}$
\end_inset

是一个
\begin_inset Formula $1\times3$
\end_inset

的矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{M_{I}}^{\psi_{DECLINATION}} & =\dfrac{\partial\psi_{DECLINATION}}{\partial\boldsymbol{M}_{I}}\\
 & =\dfrac{\partial\left(\tan^{-1}\left(\dfrac{M_{E}}{M_{N}}\right)\right)}{\partial\left(M_{N},M_{E},M_{D}\right)}\\
 & =\left[\begin{array}{ccc}
\dfrac{\partial\left(\tan^{-1}\left(\dfrac{M_{E}}{M_{N}}\right)\right)}{\partial\left(M_{N}\right)} & \dfrac{\partial\left(\tan^{-1}\left(\dfrac{M_{E}}{M_{N}}\right)\right)}{\partial\left(M_{E}\right)} & 0\end{array}\right]\\
 & =\left[\begin{array}{ccc}
\dfrac{-M_{E}}{M_{N}^{2}+M_{E}^{2}} & \dfrac{M_{N}}{M_{N}^{2}+M_{E}^{2}} & 0\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在飞行期间磁力数据对齐之后，进行最优估计之后的磁偏角
\begin_inset Formula $\psi_{DECLINATION}$
\end_inset

成为磁偏角的第三个数据源，其它模块通过调用
\family typewriter
Ekf::getMagDeclination()
\family default
函数获得当前最适合的磁偏角数据。
\end_layout

\begin_layout Subsubsection
一维磁罗盘航向测量融合方程
\end_layout

\begin_layout Standard
航向角(heading)，也称偏航角(yaw)
\begin_inset Formula $\psi$
\end_inset

，其测量值可由磁力计测量值
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset

计算出来。
\end_layout

\begin_layout Standard
首先将机体磁场旋转到 NED 坐标系：
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{meas_{I}} & =\left[T\right]_{B}^{N}\left(\boldsymbol{M}_{meas}-\boldsymbol{M}_{B}\right)\\
\left[\begin{array}{c}
M_{meas_{N}}\\
M_{meas_{E}}\\
M_{meas_{D}}
\end{array}\right] & =\left[T\right]_{B}^{N}\left(\left[\begin{array}{c}
M_{meas_{X}}\\
M_{meas_{Y}}\\
M_{meas_{Z}}
\end{array}\right]-\left[\begin{array}{c}
M_{X}\\
M_{Y}\\
M_{Z}
\end{array}\right]\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
则航向角的测量值
\begin_inset Formula $\psi_{meas}$
\end_inset

为：
\begin_inset Formula 
\[
\psi_{meas}=-\arctan\left(\dfrac{M_{meas_{E}}}{M_{meas_{N}}}\right)+\psi_{DECLINATION}
\]

\end_inset

它的噪声
\begin_inset Formula $R_{yaw}$
\end_inset

由用户设定。
\end_layout

\begin_layout Standard
航向角的预测值
\begin_inset Formula $\psi_{pred}$
\end_inset

可由旋转矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

，也就是姿态四元数
\begin_inset Formula $q$
\end_inset

计算出来：
\begin_inset Formula 
\begin{align*}
\psi_{pred} & =\begin{cases}
\arctan\left(\dfrac{\left(\left[T\right]_{B}^{N}\right)_{\left(1,0\right)}}{\left(\left[T\right]_{B}^{N}\right)_{\left(0,0\right)}}\right) & \text{for yaw321}\\
\arctan\left(\dfrac{-\left(\left[T\right]_{B}^{N}\right)_{\left(0,1\right)}}{\left(\left[T\right]_{B}^{N}\right)_{\left(1,1\right)}}\right) & \text{for yaw312}
\end{cases}\\
 & =\begin{cases}
\arctan\left(\dfrac{2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right)}{q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}}\right) & \text{for yaw321}\\
\arctan\left(\dfrac{-2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right)}{q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}}\right) & \text{for yaw312}
\end{cases}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
磁偏角的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\psi}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{\psi} & =\dfrac{\partial\psi_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{\psi} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{\psi}$
\end_inset

为磁偏角的观测相对于姿态四元数
\begin_inset Formula $q$
\end_inset

的观测矩阵，为
\begin_inset Formula $1\times4$
\end_inset

矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{q}^{\psi}=\dfrac{\partial\psi_{pred}}{\partial q}
\]

\end_inset

这个偏导展开太复杂，很难手工推导。使用符号推导系统生成的计算式如下：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{H}_{q}^{\psi}=\begin{cases}
\left[\begin{array}{c}
\frac{2\left(-2q_{0}\left(q_{0}q_{3}+q_{1}q_{2}\right)+q_{3}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(-2q_{1}\left(q_{0}q_{3}+q_{1}q_{2}\right)+q_{2}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(q_{1}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)+2q_{2}\left(q_{0}q_{3}+q_{1}q_{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(q_{0}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)+2q_{3}\left(q_{0}q_{3}+q_{1}q_{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}
\end{array}\right]^{\mathrm{T}} & \text{for yaw321}\\
\\
\left[\begin{array}{c}
\frac{2\left(-2q_{0}\left(q_{0}q_{3}-q_{1}q_{2}\right)+q_{3}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(2q_{1}\left(q_{0}q_{3}-q_{1}q_{2}\right)-q_{2}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
-\frac{2q_{1}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)+4q_{2}\left(q_{0}q_{3}-q_{1}q_{2}\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(q_{0}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)+2q_{3}\left(q_{0}q_{3}-q_{1}q_{2}\right)\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}
\end{array}\right]^{\mathrm{T}} & \text{for yaw312}
\end{cases}
\]

\end_inset


\end_layout

\begin_layout Subsection
光流测量序列融合方程
\end_layout

\begin_layout Standard
光流传感器(optical flow)依赖于测距仪(range finder)，它可以提供
\begin_inset Formula $xy$
\end_inset

水平面的速度测量值。 光流传感器的观测量有：
\end_layout

\begin_layout Itemize
视轴(line of sight, LOS)角速度测量(相对于传感器坐标系)，从向下看的光流传感器测量，以
\begin_inset Formula $\mathrm{rad}/\sec$
\end_inset

为单位，围绕
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

传感器坐标系轴。这些速度是运动补偿的。
\end_layout

\begin_layout Itemize
正视轴
\begin_inset Formula $X$
\end_inset

速度是图像围绕
\begin_inset Formula $X$
\end_inset

传感器轴的相对旋转，在正的
\begin_inset Formula $Y$
\end_inset

轴方向上产生地面相对速度。
\end_layout

\begin_layout Itemize
正视轴
\begin_inset Formula $Y$
\end_inset

速度是图像围绕
\begin_inset Formula $Y$
\end_inset

传感器轴的相对旋转，在负的
\begin_inset Formula $X$
\end_inset

轴方向上产生地面相对速度。
\end_layout

\begin_layout Itemize
距离(range)的测量与机体
\begin_inset Formula $Z$
\end_inset

轴对齐(假设为平地模型)。
\end_layout

\begin_layout Standard
距离(range)为从摄像机焦点到传感器视场(field of view, fov)中心的距离，已知其测量噪声
\begin_inset Formula $\boldsymbol{R}_{LOS}$
\end_inset

，由地形高差(terrain height offset)估计算法计算，详见第6节的描述。
\end_layout

\begin_layout Standard
首先计算传感器坐标系中的相对速度
\begin_inset Formula $\boldsymbol{V}_{B}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{B} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{NED}\\
\left[\begin{array}{c}
V_{X}\\
V_{Y}\\
V_{Z}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
将速度除以距离(range)得到相对于
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的预测视轴角速度(注：这些是机体角速度运动补偿光流速度)。
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
V_{LOS_{X}} & =+V_{Y}/\mathrm{range}\\
V_{LOS_{Y}} & =-V_{X}/\mathrm{range}\\
\boldsymbol{V}_{LOS} & =\left[\begin{array}{c}
V_{LOS_{X}}\\
V_{LOS_{Y}}
\end{array}\right]\\
 & =\dfrac{1}{\mathrm{range}}\left[\begin{array}{c}
2\left(q_{1}q_{2}-q_{0}q_{3}\right)V_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)V_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}\\
-\left(\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)V_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)V_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}\right)
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
视轴角速度的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\text{\boldsymbol{H}_{LOS}}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $2\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{LOS} & =\dfrac{\partial\boldsymbol{V}_{LOS}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{V_{LOS}} & \boldsymbol{H}_{V}^{V_{LOS}} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{V_{LOS}}$
\end_inset

和
\begin_inset Formula $\boldsymbol{H}_{V}^{V_{LOS}}$
\end_inset

这2个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{q}^{V_{LOS}}$
\end_inset

为视轴角速度的观测相对于姿态四元数的观测矩阵，即视轴角速度相对于旋转的 Jacobian ，大小为
\begin_inset Formula $2\times4$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{q}^{V_{LOS}} & =\dfrac{\partial\boldsymbol{V}_{LOS}}{\partial q}\\
 & =\dfrac{\partial\left(\dfrac{1}{\mathrm{range}}\left[\begin{array}{c}
2\left(q_{1}q_{2}-q_{0}q_{3}\right)V_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)V_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}\\
-\left(\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)V_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)V_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}\right)
\end{array}\right]\right)}{\partial q}\\
 & \tiny=\dfrac{2}{\mathrm{range}}\left[\begin{array}{cccc}
-q_{3}V_{N}+q_{0}V_{E}+q_{1}V_{D} & q_{2}V_{N}-q_{1}V_{E}+q_{0}V_{D} & q_{1}V_{N}+q_{2}V_{E}+q_{3}V_{D} & -q_{0}V_{N}-q_{3}V_{E}+q_{2}V_{D}\\
-\left(q_{0}V_{N}+q_{3}V_{E}-q_{2}V_{D}\right) & -\left(q_{1}V_{N}+q_{2}V_{E}+q_{3}V_{D}\right) & -\left(-q_{2}V_{N}+q_{1}V_{E}-q_{0}V_{D}\right) & -\left(-q_{3}V_{N}+q_{0}V_{E}+q_{1}V_{D}\right)
\end{array}\right]\\
 & =\dfrac{2}{\mathrm{range}}\left[\begin{array}{c}
\left(\Phi_{5}\cdot\boldsymbol{V}_{NED}\right)^{\mathrm{T}}\\
\left(-\Phi_{4}\cdot\boldsymbol{V}_{NED}\right)^{\mathrm{T}}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula 
\[
\Phi_{4}=\left[\begin{array}{ccc}
q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}\\
-q_{2} & q_{1} & -q_{0}\\
-q_{3} & q_{0} & q_{1}
\end{array}\right],\quad\Phi_{5}=\left[\begin{array}{ccc}
-q_{3} & q_{0} & q_{1}\\
q_{2} & -q_{1} & q_{0}\\
q_{1} & q_{2} & q_{3}\\
-q_{0} & -q_{3} & q_{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{V}^{V_{LOS}}$
\end_inset

为视轴角速度的观测相对于 NED 坐标系下机体速度的观测矩阵，即视轴角速度相对于 NED 坐标系下机体速度的 Jacobian ，大小为
\begin_inset Formula $2\times3$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{V}^{V_{LOS}} & =\dfrac{\partial\boldsymbol{V}_{LOS}}{\partial\boldsymbol{V}_{NED}}\\
 & =\dfrac{\partial\left(\dfrac{1}{\mathrm{range}}\left[\begin{array}{c}
2\left(q_{1}q_{2}-q_{0}q_{3}\right)V_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)V_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}\\
-\left(\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)V_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)V_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}\right)
\end{array}\right]\right)}{\partial\boldsymbol{V}_{NED}}\\
 & =\dfrac{1}{\mathrm{range}}\left[\begin{array}{ccc}
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
-\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right) & -2\left(q_{1}q_{2}+q_{0}q_{3}\right) & -2\left(q_{1}q_{3}-q_{0}q_{2}\right)
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在实际的代码里，磁场观测矩阵
\begin_inset Formula $\boldsymbol{H}_{LOS}$
\end_inset

实际上是分为2个一维观测矩阵进行观测：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{LOS_{X}} & =\dfrac{\partial V_{LOS_{X}}}{\partial\boldsymbol{x}}\\
\boldsymbol{H}_{LOS_{Y}} & =\dfrac{\partial V_{LOS_{Y}}}{\partial\boldsymbol{x}}
\end{align*}

\end_inset

这是一种优化算法，使用更多的运算步骤换取使用更少的栈空间。这对于MCU这种内存紧张的环境有好处。
\end_layout

\begin_layout Subsection
GPS速度和位置测量序列融合方程
\end_layout

\begin_layout Standard
GPS的速度和位置都涉及状态的直接观测，因此观测模型比较简单。因为GPS在
\begin_inset Formula $z$
\end_inset

轴方向上的数据误差比较大，而高度数据源比较多，所以对于位置向量只使用NE方向的更新。
\end_layout

\begin_layout Standard
GPS 的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{GPS}$
\end_inset

，即对应的观测矩阵 Jacobian 比较简单，为
\begin_inset Formula $5\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{GPS}=\left[\begin{array}{cccccccc}
0_{3\times4} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{2\times4} & 0_{2\times3} & \left[\begin{array}{ccc}
1 & 0 & 0\\
0 & 1 & 0
\end{array}\right] & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
并且已知GPS的测量噪声
\begin_inset Formula $\boldsymbol{R}_{GPS}$
\end_inset

，由此可对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度和位置进行校正。
\end_layout

\begin_layout Subsection
空速融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:空速融合方程"

\end_inset


\end_layout

\begin_layout Standard
对于固定翼平台，空速观测方程假设传感器测量相对于风场的速度
\begin_inset Formula $\boldsymbol{V}_{EAS}$
\end_inset

为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{EAS} & =\boldsymbol{V}_{NED}-\boldsymbol{V}_{wind}\\
\left[\begin{array}{c}
V_{EAS_{N}}\\
V_{EAS_{E}}\\
V_{EAS_{D}}
\end{array}\right] & =\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]-\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
则真实风速的预测值
\begin_inset Formula $V_{TAS}$
\end_inset

为：
\begin_inset Formula 
\[
V_{TAS}=\sqrt{\left(V_{EAS_{N}}^{2}+V_{EAS_{E}}^{2}+V_{EAS_{D}}^{2}\right)}
\]

\end_inset


\end_layout

\begin_layout Standard
当只使用风速估计而不使用合成侧滑时，真实风速的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{TAS}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{TAS} & =\dfrac{\partial V_{TAS}}{\partial\boldsymbol{x}}\\
 & =\dfrac{\partial\left(\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}\right)^{\frac{1}{2}}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
0_{1\times4} & \boldsymbol{H}_{V_{NED}}^{V_{TAS}} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & \boldsymbol{H}_{V_{wind}}^{V_{TAS}}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{V_{NED}}^{V_{TAS}}$
\end_inset

为真实风速相对于速度的
\begin_inset Formula $1\times3$
\end_inset

观测矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{V_{NED}}^{V_{TAS}}=\left[\begin{array}{c}
\dfrac{V_{N}-V_{wind_{N}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}\\
\dfrac{V_{E}-V_{wind_{E}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}\\
\dfrac{V_{D}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}
\end{array}\right]^{\mathrm{T}}
\]

\end_inset


\begin_inset Formula $\boldsymbol{H}_{V_{wind}}^{V_{TAS}}$
\end_inset

为真实风速相对于风速的
\begin_inset Formula $1\times2$
\end_inset

观测矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{V_{wind}}^{V_{TAS}}=-\left[\begin{array}{c}
\dfrac{V_{N}-V_{wind_{N}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}\\
\dfrac{V_{E}-V_{wind_{E}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}
\end{array}\right]^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
并且已知风速传感器的测量噪声
\begin_inset Formula $\boldsymbol{R}_{TAS}$
\end_inset

，由此可对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度和风速进行校正。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:真实空速融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“真实空速融合”的内容。
\end_layout

\begin_layout Standard
注意，因为风速的误差相当大，为减小其对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度的影响，正常情况下都将
\begin_inset Formula $\boldsymbol{H}_{V_{NED}}^{V_{TAS}}=\boldsymbol{0}$
\end_inset

，直到ECL估计系统进入风场航位推算模式模式后，才用
\begin_inset Formula $\boldsymbol{H}_{V_{NED}}^{V_{TAS}}$
\end_inset

对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度进行校正。具体见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“惯性航位推算”的讨论。
\end_layout

\begin_layout Subsection
合成侧滑融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:合成侧滑融合方程"

\end_inset


\end_layout

\begin_layout Standard
非固定翼平台可以利用假定的侧滑观测值为零来改进风速估计，也可以在没有空速传感器的情况下进行风速估计。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“合成侧滑融合”的内容。
\end_layout

\begin_layout Standard
首先将等效风速
\begin_inset Formula $\boldsymbol{V}_{EAS}$
\end_inset

旋转到机体坐标系中得到机体的风速
\begin_inset Formula $\boldsymbol{V}_{wind_{B}}$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind_{B}} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{EAS}\\
 & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\boldsymbol{V}_{NED}-\boldsymbol{V}_{wind}\right)\\
\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]-\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]\right)\\
 & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
V_{N}-V_{wind_{N}}\\
V_{E}-V_{wind_{E}}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
用小角近似法计算预测侧滑角度，也是侧滑新息，因为假设观测值为零：
\begin_inset Formula 
\[
\mathrm{beta}=\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}
\]

\end_inset


\end_layout

\begin_layout Standard
合成侧滑的噪声
\begin_inset Formula $R_{beta}$
\end_inset

由用户设定。合成侧滑的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{beta}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{beta} & =\dfrac{\partial\left(\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}\right)}{\partial\boldsymbol{x}}\\
 & =\dfrac{\partial\left(\dfrac{2\left(q_{1}q_{2}-q_{0}q_{3}\right)\left(V_{N}-V_{wind_{N}}\right)+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\left(V_{E}-V_{wind_{E}}\right)+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}}{\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\left(V_{N}-V_{wind_{N}}\right)+2\left(q_{1}q_{2}+q_{0}q_{3}\right)\left(V_{E}-V_{wind_{E}}\right)+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}}\right)}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{beta} & \boldsymbol{H}_{V}^{beta} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & \boldsymbol{H}_{V_{wind}}^{beta}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{beta}$
\end_inset

为合成侧滑的观测相对于姿态四元数的观测矩阵，即合成侧滑相对于旋转的 Jacobian ，大小为
\begin_inset Formula $1\times4$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V}^{beta}$
\end_inset

为合成侧滑的观测相对于 NED 坐标系下机体速度的观测矩阵，即合成侧滑相对于 NED 坐标系下机体速度的 Jacobian ，大小为
\begin_inset Formula $1\times3$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V_{wind}}^{beta}$
\end_inset

为合成侧滑的观测相对于风速观测矩阵，大小为
\begin_inset Formula $1\times3$
\end_inset

。这3个偏导展开太复杂，就不在这里推导。具体可见代码中用符号推导系统生成的计算式。
\end_layout

\begin_layout Standard
注意，因为合成侧滑的误差相当大，为减小其对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的姿态和速度的影响，正常情况下都将
\begin_inset Formula $\boldsymbol{H}_{q}^{beta}=\boldsymbol{0},\boldsymbol{H}_{V}^{beta}=\boldsymbol{0}$
\end_inset

，直到ECL估计系统进入风场航位推算模式模式后，才用
\begin_inset Formula $\boldsymbol{H}_{q}^{beta}$
\end_inset

和
\begin_inset Formula $\boldsymbol{H}_{V}^{beta}$
\end_inset

对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的姿态和速度进行校正。具体见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“惯性航位推算”的讨论。
\end_layout

\begin_layout Subsection
阻力比力融合方程
\end_layout

\begin_layout Standard
与合成侧滑类似，首先将等效风速
\begin_inset Formula $\boldsymbol{V}_{EAS}$
\end_inset

旋转到机体坐标系中得到机体的风速
\begin_inset Formula $\boldsymbol{V}_{wind_{B}}$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind_{B}} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{EAS}\\
 & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\boldsymbol{V}_{NED}-\boldsymbol{V}_{wind}\right)\\
\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]-\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]\right)\\
 & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
V_{N}-V_{wind_{N}}\\
V_{E}-V_{wind_{E}}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测得的加速度
\begin_inset Formula $\boldsymbol{a}_{meas}$
\end_inset

计算阻力比力
\begin_inset Formula $\mathrm{drag}$
\end_inset

：
\begin_inset Formula 
\[
\mathrm{drag}=\boldsymbol{a}_{meas}-\boldsymbol{\Delta V}_{b}/\Delta t
\]

\end_inset


\end_layout

\begin_layout Standard
并用空气密度
\begin_inset Formula $\rho$
\end_inset

和弹道系数
\begin_inset Formula $\mathrm{coef}$
\end_inset

估算空速
\begin_inset Formula $\mathrm{airspeed}$
\end_inset

：
\begin_inset Formula 
\[
\mathrm{airspeed}=\sqrt{\left(2\left|\mathrm{drag}\right|\right)/\left(\mathrm{coef}\cdot\rho\right)}
\]

\end_inset


\end_layout

\begin_layout Standard
并计算比力系数
\begin_inset Formula $\boldsymbol{K}_{acc}$
\end_inset

：
\begin_inset Formula 
\[
\boldsymbol{K}_{acc}=\mathrm{coef}\cdot\mathrm{airspeed}
\]

\end_inset


\end_layout

\begin_layout Standard
预测的加速度
\begin_inset Formula $\boldsymbol{a}_{pred}$
\end_inset

为：
\begin_inset Formula 
\[
\boldsymbol{a}_{pred}=-\dfrac{1}{2}\mathrm{sign}\left(\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right]\right)\left(\mathrm{coef}\cdot\rho\right)\left[\begin{array}{c}
V_{wind_{X}}^{2}\\
V_{wind_{Y}}^{2}\\
V_{wind_{Z}}^{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
则阻力比力新息
\begin_inset Formula $\mathrm{drag\_innov}$
\end_inset

为：
\begin_inset Formula 
\[
\mathrm{drag\_innov}=\boldsymbol{a}_{pred}-\mathrm{drag}
\]

\end_inset


\end_layout

\begin_layout Standard
阻力比力的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{drag}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $3\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{drag} & =\dfrac{\partial\boldsymbol{a}_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{drag} & \boldsymbol{H}_{V}^{drag} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{H}_{V_{wind}}^{drag}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{drag}$
\end_inset

为阻力比力的观测相对于姿态四元数的观测矩阵，即阻力比力相对于旋转的 Jacobian ，大小为
\begin_inset Formula $3\times4$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V}^{drag}$
\end_inset

为阻力比力的观测相对于 NED 坐标系下机体速度的观测矩阵，即阻力比力相对于 NED 坐标系下机体速度的 Jacobian ，大小为
\begin_inset Formula $3\times3$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V_{wind}}^{drag}$
\end_inset

为阻力比力的观测相对于风速观测矩阵，大小为
\begin_inset Formula $3\times2$
\end_inset

。这3个偏导展开太复杂，就不在这里推导。具体可见代码中用符号推导系统生成的计算式。
\end_layout

\begin_layout Subsection
高度融合方程
\end_layout

\begin_layout Standard
高度涉及状态的直接观测，因此观测模型比较简单。
\end_layout

\begin_layout Standard
高度数据源比较多，有4个：
\end_layout

\begin_layout Itemize
气压计
\end_layout

\begin_layout Itemize
测距仪
\end_layout

\begin_layout Itemize
GPS
\end_layout

\begin_layout Itemize
外部视觉
\end_layout

\begin_layout Standard
软件内部会根据数据源的质量状况进行切换。
\end_layout

\begin_layout Standard
高度的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{hgt}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

稀疏矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{H}_{hgt}=\left[\begin{array}{cccccccc}
0_{1\times4} & 0_{1\times3} & \left[\begin{array}{ccc}
0 & 0 & 1\end{array}\right] & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
根据各自传感器Z轴的噪声
\begin_inset Formula $R_{hgt}$
\end_inset

，就可以对高度进行校正。
\end_layout

\begin_layout Subsection
外部视觉融合方程
\end_layout

\begin_layout Standard
外部视觉系统可以提供速度、位置和航向角的测量值。相对应的融合方程见前面章节的描述。
\end_layout

\begin_layout Section
地形高差估计的EKF方程
\end_layout

\begin_layout Standard
因为光流的算法依赖测距仪提供的高度数据，所以ECL模块在原先维护的
\begin_inset Formula $24$
\end_inset

参数状态EKF之外，还单独维护一个地形估计器，目的是融合测距仪的测量值以估计地形垂直位置。地形高差(terrain height offset)估计的EKF方程
在本节描述。
\end_layout

\begin_layout Subsection
距地高度的估计
\end_layout

\begin_layout Standard
在地形估计器内部用一个标准KF维护一个地形高度(terrain height)状态值，又称地形垂直位置(terrain vertical position,
 
\begin_inset Formula $\mathrm{terrain}_{vpos}$
\end_inset

)，也称在向下轴的地形位置(position of terrain in down axis, ptd)。相对应的，在 ECL/EKF2 中维护的垂直速度
\begin_inset Formula $V_{D}$
\end_inset

为高差，又称在向下轴飞行器的位置(position of vehicle in down axis, pd)。
\end_layout

\begin_layout Standard
距地高度(height above ground, 
\begin_inset Formula $\mathrm{hagl}_{meas}$
\end_inset

)的测量值由测距仪提供。距地高度预测值
\begin_inset Formula $\mathrm{hagl}_{pred}$
\end_inset

由以下方程计算：
\begin_inset Formula 
\[
\mathrm{hagl}_{pred}=\mathrm{terrain}_{vpos}-V_{D}
\]

\end_inset


\end_layout

\begin_layout Standard
距地高度新息：
\begin_inset Formula 
\[
\mathrm{hagl}_{innov}=\mathrm{hagl}_{pred}-\mathrm{hagl}_{meas}
\]

\end_inset


\end_layout

\begin_layout Standard
由此可以得出最优估计的地形高度
\begin_inset Formula $\mathrm{terrain}_{vpos}$
\end_inset

。
\end_layout

\begin_layout Subsection
光流速度的估计
\end_layout

\begin_layout Standard
已知从导航坐标系到机体坐标系的旋转矩阵
\begin_inset Formula $\left(\left[T\right]_{N}^{B}\right)^{\mathrm{T}}$
\end_inset

，以及光流观测方差
\begin_inset Formula $R_{LOS}$
\end_inset

。
\end_layout

\begin_layout Standard
距离(range)为从摄像机焦点到传感器视场(field of view, fov)中心的距离，由以下方程计算：
\begin_inset Formula 
\[
\mathrm{range}=\left(\mathrm{terrain}_{vpos}-V_{D}\right)/\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
计算传感器坐标系中的相对速度
\begin_inset Formula $\boldsymbol{V}_{B}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{B} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{NED}\\
\left[\begin{array}{c}
V_{X}\\
V_{Y}\\
V_{Z}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
将速度除以距离(range)得到相对于
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的预测视轴角速度(注：这些是机体角速度运动补偿光流速度)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
V_{LOS_{X}} & =+V_{Y}/\mathrm{range}\\
V_{LOS_{Y}} & =-V_{X}/\mathrm{range}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算观测雅可比矩阵：
\begin_inset Formula 
\begin{align*}
H_{flow} & =\dfrac{\partial\left(V_{LOS_{X}},V_{LOS_{Y}}\right)}{\partial\left(\mathrm{terrain}_{vpos}\right)}\\
 & =\dfrac{\partial\left(\dfrac{+V_{Y}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-V_{D}\right)},\dfrac{-V_{X}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-V_{D}\right)}\right)}{\partial\left(\mathrm{terrain}_{vpos}\right)}\\
 & =\left[\begin{array}{c}
\dfrac{+V_{Y}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-V_{D}\right)^{2}}\\
\dfrac{-V_{X}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-V_{D}\right)^{2}}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
由此可以对光流速度进行最优估计。
\end_layout

\begin_layout Section
使用 IMU 和 GPS 进行偏航对准
\end_layout

\begin_layout Subsection
EKF-GSF 偏航估计器描述
\end_layout

\begin_layout Standard
该算法能在没有磁强计或外部偏航传感器的情况下运行，其目的是自动校正偏航误差引起的起飞后导航损失。它可以从不良磁偏航引起的起飞后导航故障中快速自动恢复。
\end_layout

\begin_layout Standard
ECL项目自2018年起进行的初步算法工作，以确定是否有可能仅使用 IMU 和 GPS 速度数据快速确定偏航角(yaw)，而不依赖机体动力学的假设。最后确定使用
多个 EKF 状态的高斯和滤波器(Gaussian Sum Filter, GSF)算法，即EKF-GSF，因其为应用提供了最佳的性能/计算成本权衡。
\end_layout

\begin_layout Standard
EKF-GSF算法也是在
\begin_inset Formula $24$
\end_inset

参数状态EKF之外又一个EKF实现，包括以下内容：
\end_layout

\begin_layout Itemize
使用互补滤波器的
\begin_inset Formula $5$
\end_inset

组AHRS的解
\end_layout

\begin_deeper
\begin_layout Itemize
这些计算预测偏航角和向前、向右加速度。
\end_layout

\begin_layout Itemize
空速(测量或估计)用于固定翼飞机飞行期间的向心加速度校正。
\end_layout

\end_deeper
\begin_layout Itemize
\begin_inset Formula $5$
\end_inset

组
\begin_inset Formula $3$
\end_inset

参数状态扩展卡尔曼滤波器
\end_layout

\begin_deeper
\begin_layout Itemize
状态为向北(N)、向东(E)速度和偏航角。
\end_layout

\begin_layout Itemize
偏航角估算开始时的角度间隔相等，
\begin_inset Formula $\left[\begin{array}{ccccc}
-4/5\pi & -2/5\pi & 0 & 2/5\pi & 4/5\pi\end{array}\right]$
\end_inset

。
\end_layout

\begin_layout Itemize
GPS的向北(N)、向东(E)速度作为观测值。
\end_layout

\end_deeper
\begin_layout Itemize
高斯和滤波器(Gaussian Sum Filter)
\end_layout

\begin_deeper
\begin_layout Itemize
根据标准化GPS的向北(N)、向东(E)速度新息数值级别计算每个EKF的权重。总权重为
\begin_inset Formula $1$
\end_inset

。
\end_layout

\begin_layout Itemize
输出偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

估计值，这是单个EKF估计值的加权平均值。
\end_layout

\end_deeper
\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
GSF-EKF过程框图如下：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename EKF-GSF.png
	scale 35

\end_inset


\end_layout

\begin_layout Standard
该算法运行要求无人机在起飞和初始水平运动时必须处于不需要位置固定模式(Position Control Mode)，让无人机水平移动一段距离。根据实验，无人机大
约在
\begin_inset Formula $1\mathrm{s}$
\end_inset

左右移动
\begin_inset Formula $4\mathrm{m}$
\end_inset

左右的距离，EKF 将自动对准偏航并开始使用 GPS，从而启用位置固定模式。测试结果表明：
\end_layout

\begin_layout Itemize
GSF权重在单个EKF滤波器之前收敛。
\end_layout

\begin_layout Itemize
要求水平速度变化大于GPS速度不确定性。
\end_layout

\begin_layout Itemize
速度变化越大，收敛速度越快。
\end_layout

\begin_layout Itemize
由于失去导航，速度变化较大，导致在
\begin_inset Formula $1\mathrm{s}$
\end_inset

内收敛。
\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsection
偏航估计器的算法直觉
\end_layout

\begin_layout Standard
EKF-GSF算法是一个很新奇也很有创意的算法。不论是在KF方面还是在传感器方面，以及无人机的运动特性方面，设计者在技术方面和工程方面都已经炉火纯青、游刃有余。
虽然该算法在数学方面还有说不清的地方，但是KF同样擅长在相关性领域工作，建模不一定要因果关系。
\end_layout

\begin_layout Standard
首先该算法一个假设就是偏航角由
\begin_inset Formula $xy$
\end_inset

水平面的向北(N)、向东(E)的增量速度和绕
\begin_inset Formula $z$
\end_inset

轴旋转的增量角度所驱动，所以偏航角的测量误差也和这
\begin_inset Formula $3$
\end_inset

个值的测量噪声相关
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\psi_{error}\propto\left(\sigma_{\Delta V_{x}}^{2},\sigma_{\Delta V_{y}}^{2},\sigma_{\Delta\psi}^{2}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
这
\begin_inset Formula $3$
\end_inset

个值和
\begin_inset Formula $3$
\end_inset

个噪声由IMU提供。于是我们可以在
\begin_inset Formula $xy$
\end_inset

水平面上面预置
\begin_inset Formula $5$
\end_inset

个偏航角
\begin_inset Formula $\psi_{i},i\in1\sim5$
\end_inset

，每个偏航角由这
\begin_inset Formula $3$
\end_inset

个值和
\begin_inset Formula $3$
\end_inset

个噪声驱动演化，独立进行时间更新。在测量更新阶段，我们观测GPS提供的
\begin_inset Formula $xy$
\end_inset

水平面的向北(N)、向东(E)的速度，因为残差的存在，这
\begin_inset Formula $5$
\end_inset

个偏航角
\begin_inset Formula $\psi_{i}$
\end_inset

会向真实的偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

聚拢，但是真实的偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

不可见。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-01.png
	scale 60

\end_inset


\end_layout

\begin_layout Standard
不过我们可以通过高斯和的算法，计算这
\begin_inset Formula $5$
\end_inset

个偏航角
\begin_inset Formula $\psi_{i}$
\end_inset

的权重并相加，得到距离真实的偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

最近的复合偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-02.png

\end_inset


\end_layout

\begin_layout Standard
因此该算法就可以在没有磁强计的情况下估计偏航角，并且是水平速度变化越大，收敛越快。
\end_layout

\begin_layout Subsection
偏航估计器的初始化与对齐
\end_layout

\begin_layout Subsubsection
偏航估计器的初始化
\end_layout

\begin_layout Standard
初始化的关键在于在
\begin_inset Formula $xy$
\end_inset

平面上预制
\begin_inset Formula $5$
\end_inset

个偏航角，平均间隔，平均权重。其它初始化都是常规操作。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-00.png
	scale 85

\end_inset


\end_layout

\begin_layout Subsubsection
AHRS倾斜对齐
\end_layout

\begin_layout Standard
就是如何从增量速度计算旋转矩阵。旋转矩阵直接从加速度测量中构造，对于所有模型都是相同的，因此只需计算一次。其假设是：
\end_layout

\begin_layout Enumerate
偏航角为零
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

当速度融合开始时，每个模型的偏航角稍后对齐。
\end_layout

\begin_layout Enumerate
机体没有加速，因此所有测量的加速度都是由重力引起的。
\end_layout

\begin_layout Standard
用
\begin_inset Formula $\Delta t$
\end_inset

表示传感器事件间隔时间。从主模块得到的加速度
\begin_inset Formula $\boldsymbol{a}_{I}$
\end_inset

计算得到增量速度
\begin_inset Formula $\boldsymbol{\Delta V}_{I}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{I}=\boldsymbol{a}_{I}\cdot\Delta t
\]

\end_inset

这是地球坐标系中的数据，需要转换到机体坐标系中并归一得到重力方向的单位向量
\begin_inset Formula 
\[
\boldsymbol{D}_{B}=-\boldsymbol{\Delta V}_{I}/\left\Vert \boldsymbol{\Delta V}_{I}\right\Vert 
\]

\end_inset


\end_layout

\begin_layout Standard
计算地球坐标系向北轴的单位向量，旋转为机体坐标系，与
\begin_inset Formula $\boldsymbol{D}_{B}$
\end_inset

正交
\begin_inset Formula 
\begin{align*}
\boldsymbol{N}_{B} & =\left[\begin{array}{c}
1\\
0\\
0
\end{array}\right]-\boldsymbol{D}_{B}\cdot\left(\left[\begin{array}{ccc}
1 & 0 & 0\end{array}\right]\boldsymbol{D}_{B}\right)\\
\boldsymbol{N}_{B} & =\boldsymbol{N}_{B}/\left\Vert \boldsymbol{N}_{B}\right\Vert 
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算地球坐标系向东轴的单位向量，旋转为机体坐标系，与
\begin_inset Formula $\boldsymbol{D}_{B}$
\end_inset

和
\begin_inset Formula $\boldsymbol{N}_{B}$
\end_inset

正交
\begin_inset Formula 
\[
\boldsymbol{E}_{B}=\boldsymbol{D}_{B}\times\boldsymbol{N}_{B}
\]

\end_inset


\end_layout

\begin_layout Standard
从地球坐标系到机体坐标系的旋转矩阵中的每一列表示旋转到机体坐标系的相应地球坐标系单位向量的投影，例如
\begin_inset Formula $\boldsymbol{N}_{B}$
\end_inset

将是第一列。我们需要从机体坐标系到地球坐标系的旋转矩阵，因此旋转到机体坐标系的地球坐标系单位向量被复制到相应的行中
\begin_inset Formula 
\[
\left[T\right]_{B}^{N}=\left[\begin{array}{c}
\boldsymbol{N}_{B}^{\mathrm{T}}\\
\boldsymbol{E}_{B}^{\mathrm{T}}\\
\boldsymbol{D}_{B}^{\mathrm{T}}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
倾斜对齐完成后可对每一个模型进行时间更新。
\end_layout

\begin_layout Subsubsection
AHRS偏航角对齐
\end_layout

\begin_layout Standard
其算法是根据最新的偏航角
\begin_inset Formula $\psi$
\end_inset

更新欧拉角向量，进而生成新的姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

。在
\begin_inset Formula $24$
\end_inset

参数EKF算法之外，在EKF-GSF算法中为每一个模型用增益系数法维护一个独立的姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

，用于后面的算法中。
\end_layout

\begin_layout Standard
偏航角对齐完成后可对每一个模型进行测量更新。
\end_layout

\begin_layout Subsubsection
AHRS预测
\end_layout

\begin_layout Standard
在每次时间更新前先从IMU数据生成姿态基准，即每一个模型的姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

被IMU数据驱动往前旋转了一个角度。所用数据为IMU数据及真实空速(固定翼飞机)，并用加速度融合增益系数和陀螺仪偏差增益系数进行计算。最后计算得到一个校正后的增
量角度，将其应用到姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

就得到新的姿态矩阵。
\end_layout

\begin_layout Subsubsection
AHRS更新
\end_layout

\begin_layout Standard
同样的，在每次测量更新之后，需要对姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

进行更新。因为增量偏航角
\begin_inset Formula $\Delta\psi$
\end_inset

发生在
\begin_inset Formula $xy$
\end_inset

平面上，所以利用偏航旋转矩阵的稀疏性可以对姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

做优化更新。
\end_layout

\begin_layout Subsection
偏航估计器的预测方程
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\psi$
\end_inset

表示机体坐标系相对于地球坐标系的偏航角(yaw)。
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\boldsymbol{V}_{NE}$
\end_inset

表示机体在世界坐标系中的向北(N)和向东(E)的速度，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{V}_{NE}=\left[\begin{array}{c}
V_{N}\\
V_{E}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
令
\begin_inset Formula $\Delta\psi$
\end_inset

表示IMU的
\begin_inset Formula $z$
\end_inset

轴在机体轴上的增量角度测量值，即增量偏航角的测量值。
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\sigma_{\Delta\psi}^{2}$
\end_inset

表示IMU的
\begin_inset Formula $z$
\end_inset

轴增量角度测量方差值。
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\boldsymbol{\Delta V}_{xy}$
\end_inset

表示IMU的
\begin_inset Formula $x$
\end_inset

轴和
\begin_inset Formula $y$
\end_inset

轴在机体轴上的增量速度测量值
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{xy}=\left[\begin{array}{c}
\Delta V_{x}\\
\Delta V_{y}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
令
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta V}xy}^{2}$
\end_inset

表示IMU的
\begin_inset Formula $x$
\end_inset

轴和
\begin_inset Formula $y$
\end_inset

轴增量速度测量方差
\begin_inset Formula 
\[
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}xy}^{2}=\left[\begin{array}{c}
\sigma_{\Delta V_{x}}^{2}\\
\sigma_{\Delta V_{y}}^{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
推导机体到导航方向的变换矩阵(2D)
\begin_inset Formula 
\[
\left[T\right]_{B}^{N}=\left[\begin{array}{cc}
\cos\left(\psi\right) & -\sin\left(\psi\right)\\
\sin\left(\psi\right) & \cos\left(\psi\right)
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
姿态更新方程
\begin_inset Formula 
\[
\psi^{\prime}=\psi+\Delta\psi
\]

\end_inset


\end_layout

\begin_layout Standard
速度更新方程
\begin_inset Formula 
\[
\boldsymbol{V}_{NE}^{\prime}=\boldsymbol{V}_{NE}+\left[T\right]_{B}^{N}\boldsymbol{\Delta V}_{xy}
\]

\end_inset


\end_layout

\begin_layout Standard
定义状态向量
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k-1|k-1}=\left[\begin{array}{c}
\boldsymbol{V}_{NE}\\
\psi
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
定义过程方程的向量
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k|k-1}=\left[\begin{array}{c}
\boldsymbol{V}_{NE}^{\prime}\\
\psi^{\prime}
\end{array}\right]
\]

\end_inset

此即方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:1"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，预测 (先验) 状态估计。
\end_layout

\begin_layout Standard
计算状态转移矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{F} & =\dfrac{\partial\hat{\boldsymbol{x}}_{k|k-1}}{\partial\hat{\boldsymbol{x}}_{k-1|k-1}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
V_{N}+\cos\left(\psi\right)\Delta V_{x}-\sin\left(\psi\right)\Delta V_{y}\\
V_{E}+\sin\left(\psi\right)\Delta V_{x}+\cos\left(\psi\right)\Delta V_{y}\\
\psi+\Delta\psi
\end{array}\right]\right)}{\partial\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
\psi
\end{array}\right]\right)}\\
 & =\left[\begin{array}{ccc}
1 & 0 & -\sin\left(\psi\right)\Delta V_{x}-\cos\left(\psi\right)\Delta V_{y}\\
0 & 1 & \cos\left(\psi\right)\Delta V_{x}-\sin\left(\psi\right)\Delta V_{y}\\
0 & 0 & 1
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
定义控制(干扰)向量
\begin_inset Formula 
\[
\boldsymbol{u}=\left[\begin{array}{c}
\boldsymbol{\Delta V}_{xy}\\
\Delta\psi
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
推导协方差预测方程。在消除偏差效应后，假设惯性解中的误差增长由增量角度和增量速度中的“噪声”驱动。推导IMU噪声到状态噪声的
\begin_inset Formula $3\times3$
\end_inset

控制(干扰)影响矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{G} & =\dfrac{\partial\hat{\boldsymbol{x}}_{k|k-1}}{\partial\boldsymbol{u}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
V_{N}+\cos\left(\psi\right)\Delta V_{x}-\sin\left(\psi\right)\Delta V_{y}\\
V_{E}+\sin\left(\psi\right)\Delta V_{x}+\cos\left(\psi\right)\Delta V_{y}\\
\psi+\Delta\psi
\end{array}\right]\right)}{\partial\left(\left[\begin{array}{c}
\Delta V_{x}\\
\Delta V_{y}\\
\Delta\psi
\end{array}\right]\right)}\\
 & =\left[\begin{array}{ccc}
\cos\left(\psi\right) & -\sin\left(\psi\right) & 0\\
\sin\left(\psi\right) & \cos\left(\psi\right) & 0\\
0 & 0 & 1
\end{array}\right]
\end{align*}

\end_inset

这实际上是在
\begin_inset Formula $xy$
\end_inset

平面上的旋转矩阵。
\end_layout

\begin_layout Standard
定义干扰(disturbance)矩阵，即
\begin_inset Formula $3\times3$
\end_inset

过程噪声矩阵
\begin_inset Formula 
\[
\boldsymbol{D}=\mathrm{diag}\left(\left[\begin{array}{c}
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}xy}^{2}\\
\sigma_{\Delta\psi}^{2}
\end{array}\right]\right)
\]

\end_inset


\end_layout

\begin_layout Standard
推导状态误差矩阵，即过程噪声协方差矩阵
\begin_inset Formula 
\[
\boldsymbol{Q}=\boldsymbol{G}\boldsymbol{D}\boldsymbol{G}^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
传播协方差矩阵
\begin_inset Formula 
\[
\boldsymbol{P}_{k|k-1}=\boldsymbol{F}\boldsymbol{P}_{k-1|k-1}\boldsymbol{F}^{\mathrm{T}}+\boldsymbol{Q}
\]

\end_inset

此即方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，预测 (先验) 估计协方差。
\end_layout

\begin_layout Subsection
偏航估计器的观测方程
\end_layout

\begin_layout Standard
由GPS提供的向北(N)、向东(E)速度观测值为
\begin_inset Formula 
\[
\boldsymbol{V}_{GPS}=\left[\begin{array}{c}
V_{N_{GPS}}\\
V_{E_{GPS}}
\end{array}\right]
\]

\end_inset

其方差为
\begin_inset Formula $\sigma_{\Delta V_{GPS}}^{2}$
\end_inset

，由此构建
\begin_inset Formula $2\times2$
\end_inset

测量噪声矩阵
\begin_inset Formula 
\[
\boldsymbol{R}=\mathrm{diag}\left(\left[\begin{array}{c}
\sigma_{\Delta V_{GPS}}^{2}\\
\sigma_{\Delta V_{GPS}}^{2}
\end{array}\right]\right)
\]

\end_inset


\end_layout

\begin_layout Standard
因为是对速度的直接观测，所以测量矩阵比较简单
\begin_inset Formula 
\[
\boldsymbol{H}=\left[\begin{array}{ccc}
1 & 0 & 0\\
0 & 1 & 0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
推导向北(N)、向东(E)速度观测的协方差更新方程，即方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:5"
plural "false"
caps "false"
noprefix "false"

\end_inset

)
\begin_inset Formula 
\begin{align*}
\tilde{\boldsymbol{y}} & =\boldsymbol{H}\hat{\boldsymbol{x}}_{k|k-1}-\boldsymbol{V}_{GPS}\\
\boldsymbol{S} & =\boldsymbol{H}\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{\mathrm{T}}+\boldsymbol{R}\\
\boldsymbol{K} & =\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{\mathrm{T}}\boldsymbol{S}^{-1}\\
\hat{\boldsymbol{x}}_{k|k} & =\hat{\boldsymbol{x}}_{k|k-1}-\boldsymbol{K}\tilde{\boldsymbol{y}}\\
\boldsymbol{P}_{k|k} & =\boldsymbol{P}_{k|k-1}-\boldsymbol{K}\boldsymbol{S}\boldsymbol{K}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Subsection
偏航估计器的GSF方程
\end_layout

\begin_layout Standard
对每个模型的状态计算高斯密度。首先计算马式距离(
\begin_inset CommandInset href
LatexCommand href
name "Mahalanobis distance"
target "https://en.wikipedia.org/wiki/Mahalanobis_distance"
literal "false"

\end_inset

)
\begin_inset Formula 
\[
D_{M}^{2}=\tilde{\boldsymbol{y}}^{\mathrm{T}}\boldsymbol{S}^{-1}\tilde{\boldsymbol{y}}
\]

\end_inset

再计算2D正态分布(
\begin_inset CommandInset href
LatexCommand href
name "Multivariate Normal Distribution"
target "https://online.stat.psu.edu/stat505/book/export/html/636"
literal "false"

\end_inset

)的密度
\begin_inset Formula 
\[
\mathrm{Density}=\left(\dfrac{1}{2}\right)^{p/2}\sqrt{\det\left(\boldsymbol{S}^{-1}\right)}\exp\left(-\dfrac{D_{M}^{2}}{2}\right)
\]

\end_inset

其中我们观测的是
\begin_inset Formula $2\times1$
\end_inset

速度向量，所以
\begin_inset Formula $p=2$
\end_inset

。
\end_layout

\begin_layout Standard
计算
\begin_inset Formula $5$
\end_inset

组AHRS的解的权重并归一
\begin_inset Formula 
\begin{align*}
W_{i}^{\prime} & =\mathrm{Density}_{i}\cdot W_{i}\\
\boldsymbol{W} & =\boldsymbol{W}^{\prime}/\left\Vert \boldsymbol{W}^{\prime}\right\Vert 
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
用每个模型的偏航状态的加权平均值以计算复合偏航向量。为避免角度回绕问题，在求和之前，将偏航状态转换为长度等于权重值为
\begin_inset Formula $1$
\end_inset

的向量
\begin_inset Formula 
\begin{align*}
x & =\sum_{i=1}^{5}W_{i}\cdot\cos\left(\psi_{i}\right)\\
y & =\sum_{i=1}^{5}W_{i}\cdot\sin\left(\psi_{i}\right)\\
\psi_{GSF} & =\mathrm{atan2}\left(y,x\right)
\end{align*}

\end_inset

该算法原理在于将每一个偏航状态
\begin_inset Formula $\psi_{i}$
\end_inset

看成是一个从原点出发的向量，因而在
\begin_inset Formula $x/y$
\end_inset

轴上的投影通过权重缩放后相加，就得到单位圆上的一个向量，因而求出加权复合偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-03.png
	scale 60

\end_inset


\end_layout

\begin_layout Standard
根据每个模型方差的加权平均值计算偏航状态的复合方差。具有较大新息的模型的权重较小 
\begin_inset Formula 
\begin{align*}
\Delta\psi_{i} & =\psi_{i}-\psi_{GSF}\\
\mathrm{variance}_{\psi_{GSF}} & =\sum_{i=1}^{5}W_{i}\cdot\left(P_{i}\left(3,3\right)+\Delta\psi_{i}^{2}\right)
\end{align*}

\end_inset

其中
\begin_inset Formula $P_{i}\left(3,3\right)$
\end_inset

为第
\begin_inset Formula $i$
\end_inset

组的协方差矩阵
\begin_inset Formula $\boldsymbol{P}_{i}$
\end_inset

中偏航角
\begin_inset Formula $\psi_{i}$
\end_inset

的方差。
\end_layout

\begin_layout Section
风速估计
\end_layout

\begin_layout Standard
因为风速对评估飞行环境十分重要，并且为了容错，所以除了在主要的24-EKF估计器中估计风速之外，ECL还采用另外不同模型的3-EKF算法来估计风速。
\end_layout

\begin_layout Subsection
假设
\end_layout

\begin_layout Standard
假设飞行器为近水平面姿态。飞行器有
\begin_inset Formula $z$
\end_inset

轴方向上的运动，但是飞行器以近水平面姿态运动。
\end_layout

\begin_layout Standard
假设风速为近水平面风场，因此
\begin_inset Formula $z$
\end_inset

轴方向风速为
\begin_inset Formula $0$
\end_inset

。用
\begin_inset Formula $V_{wind_{N}}/V_{wind_{E}}$
\end_inset

表示在 NED 坐标系中在北/东 (N/E) 方向上的风速，则风速向量
\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

表示为
\begin_inset Formula 
\[
\boldsymbol{V}_{wind}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
真实空速(True Air Speed, TAS)，又称真空速，是表示飞行器飞行时相对于周围空气运动的速度。真实空速的方程与温度和空气密度相关。在这里做一个简化
，假设其为飞行器相对于地球固定坐标系的速度向量
\begin_inset Formula $\boldsymbol{V}_{I}$
\end_inset

和风速向量
\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

的差值，并乘上真实空速缩放因子
\begin_inset Formula $k_{tas}$
\end_inset

。
\end_layout

\begin_layout Standard
所以，最终的要估计的状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{x}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{tas}
\end{array}\right]
\]

\end_inset

并且假设风场在短时间内不会有大的变化，所以采用固定过程模型。
\end_layout

\begin_layout Standard
系统的输入。由GPS、光流、外部视觉等传感器提供飞行器的速度向量
\begin_inset Formula $\boldsymbol{V}_{I}=\left[\begin{array}{ccc}
V_{N} & V_{E} & V_{D}\end{array}\right]^{\mathrm{T}}$
\end_inset

，我们关注N/E方向的地面速度方差
\begin_inset Formula $\boldsymbol{\sigma}^{2}=\left[\begin{array}{cc}
\sigma_{V_{N}}^{2} & \sigma_{V_{E}}^{2}\end{array}\right]^{\mathrm{T}}$
\end_inset

。对于风速的过程噪声分量为
\begin_inset Formula $Q_{w}$
\end_inset

，对于真实空速过程噪声分量为
\begin_inset Formula $Q_{k_{tas}}$
\end_inset

。对于固定翼飞机，由空速传感器提供真实空速测量值
\begin_inset Formula $TAS_{meas}$
\end_inset

，其测量噪声为
\begin_inset Formula $R_{tas}$
\end_inset

；对于旋翼飞机，由合成侧滑
\begin_inset Formula $\mathrm{beta}$
\end_inset

计算真实空速测量值，其测量噪声为
\begin_inset Formula $R_{beta}$
\end_inset

。
\end_layout

\begin_layout Subsection
初始化
\end_layout

\begin_layout Standard
初始化阶段的主要目标是通过地面速度初始化风速协方差。这是一种快速算法，与时间更新阶段的方程不一样。
\end_layout

\begin_layout Standard
根据地面速度估计航向角
\begin_inset Formula $\psi$
\end_inset

为
\begin_inset Formula 
\[
\psi=\mathrm{atan2}\left(V_{N},V_{E}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
根据近水平面的假设，根据飞行器地面速度、航向和空速测量值计算风速估计值(状态向量)
\begin_inset Formula 
\[
\mathrm{wind}_{est}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{tas}
\end{array}\right]=\left[\begin{array}{c}
V_{N}\\
V_{E}\\
k_{tas}
\end{array}\right]-\left[\begin{array}{c}
\cos\left(\psi\right)\\
\sin\left(\psi\right)\\
0
\end{array}\right]\cdot TAS_{meas}
\]

\end_inset


\end_layout

\begin_layout Standard
设置状态协方差矩阵的估计初值为
\begin_inset Formula 
\[
\boldsymbol{P}_{0}=\mathrm{diag}\left(\left[\begin{array}{c}
\sigma_{V_{N}}^{2}\\
\sigma_{V_{E}}^{2}\\
k_{tas}
\end{array}\right]\right)
\]

\end_inset

其中，设置
\begin_inset Formula $k_{tas}$
\end_inset

初值为
\begin_inset Formula $0.0001$
\end_inset

。
\end_layout

\begin_layout Standard
计算风速的状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

，其为相对于北/东方向的速度的状态和真实空速测量值的状态的Jacobian矩阵，
\begin_inset Formula 
\begin{align*}
\boldsymbol{F} & =\dfrac{\partial\left(\mathrm{wind}_{est}\right)}{\partial\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
k_{tas}
\end{array}\right]\right)}\\
 & =\left[\begin{array}{ccc}
L_{4} & L_{0}\cdot L_{3}+L_{6} & 0\\
L_{1}\cdot L_{3}+L_{6} & L_{4} & 0\\
0 & 0 & 1
\end{array}\right]
\end{align*}

\end_inset

其中
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
L_{0} & =V_{N}^{2}\\
L_{1} & =V_{E}^{2}\\
L_{2} & =V_{N}^{2}+V_{E}^{2}\\
L_{3} & =\dfrac{TAS_{meas}}{\left(V_{N}^{2}+V_{E}^{2}\right)\sqrt{\left(V_{N}^{2}+V_{E}^{2}\right)}}\\
L_{4} & =\dfrac{TAS_{meas}\cdot V_{N}^{2}\cdot V_{E}^{2}}{\left(V_{N}^{2}+V_{E}^{2}\right)\sqrt{\left(V_{N}^{2}+V_{E}^{2}\right)}}+1\\
L_{5} & =\dfrac{1}{\sqrt{V_{N}^{2}+V_{E}^{2}}}\\
L_{6} & =-\dfrac{TAS_{meas}}{\sqrt{V_{N}^{2}+V_{E}^{2}}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
根据地面速度和实测空速值的估计方差，获得初始化时的状态协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的估计值
\begin_inset Formula 
\begin{align*}
\boldsymbol{P} & =\boldsymbol{F}\boldsymbol{P}_{0}\boldsymbol{F}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Subsection
时间更新
\end_layout

\begin_layout Standard
因为算法采用的是固定过程模型，所以状态转移矩阵
\begin_inset Formula $\boldsymbol{F}=\boldsymbol{I}$
\end_inset

。我们只需要提供协方差预测公式。
\end_layout

\begin_layout Standard
创建协方差预测的过程噪声矩阵
\begin_inset Formula 
\[
\boldsymbol{x}_{k+1}=\boldsymbol{x}_{k}+\left[\begin{array}{c}
Q_{w}\\
Q_{w}\\
Q_{k_{tas}}
\end{array}\right]\cdot\mathrm{d}t
\]

\end_inset


\end_layout

\begin_layout Standard
计算系统过程噪声矩阵
\begin_inset Formula $\boldsymbol{Q}_{3\times3}$
\end_inset


\begin_inset Formula 
\begin{align*}
\boldsymbol{Q}_{2\times2} & =\mathrm{diag}\left(\left[\begin{array}{c}
Q_{w}\\
Q_{k_{tas}}
\end{array}\right]\right)\\
\boldsymbol{G} & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\left(\left[\begin{array}{c}
Q_{w}\\
Q_{k_{tas}}
\end{array}\right]\right)}\\
 & =\left[\begin{array}{cc}
1 & 0\\
1 & 0\\
0 & 1
\end{array}\right]\cdot\mathrm{d}t\\
\boldsymbol{Q}_{3\times3} & =\boldsymbol{G}\boldsymbol{Q}_{2\times2}\boldsymbol{G}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的预测方程
\begin_inset Formula 
\[
\boldsymbol{P}_{k|k-1}=\boldsymbol{P}_{k-1|k-1}+\boldsymbol{Q}_{3\times3}
\]

\end_inset


\end_layout

\begin_layout Subsection
测量更新
\end_layout

\begin_layout Subsubsection
真实空速融合
\begin_inset CommandInset label
LatexCommand label
name "subsec:真实空速融合"

\end_inset


\end_layout

\begin_layout Standard
对于带有空速传感器的非旋翼无人机，采用这个分支。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:空速融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“空速融合方程”的内容。
\end_layout

\begin_layout Standard
计算真实空速预测值
\begin_inset Formula $TAS_{pred}$
\end_inset


\begin_inset Formula 
\begin{align*}
TAS_{pred} & =\left\Vert \boldsymbol{V}_{I}-\boldsymbol{V}_{wind}\right\Vert _{2}\cdot k_{tas}\\
 & =\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}\cdot k_{tas}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
真实空速的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{tas}$
\end_inset


\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{tas} & =\dfrac{\partial\left(TAS_{pred}\right)}{\partial\boldsymbol{x}_{k}}\\
 & =\dfrac{\partial\left(\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}\cdot k_{tas}\right)}{\partial\left(\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{tas}
\end{array}\right]\right)}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算新息(或残差)协方差
\begin_inset Formula $S$
\end_inset


\begin_inset Formula 
\[
S=\boldsymbol{H}\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{{\rm T}}+R_{tas}
\]

\end_inset


\end_layout

\begin_layout Standard
最佳卡尔曼增益
\begin_inset Formula $\boldsymbol{K}_{3\times1}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{K}=\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{{\rm T}}S^{-1}
\]

\end_inset


\end_layout

\begin_layout Standard
更新(后验)的协方差
\begin_inset Formula $\boldsymbol{P}_{3\times3}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{P}_{k|k}=\boldsymbol{P}_{k|k-1}-\boldsymbol{K}\boldsymbol{H}\boldsymbol{P}_{k|k-1}
\]

\end_inset


\end_layout

\begin_layout Standard
最后注意，风速融合频率不超过
\begin_inset Formula $10\ \mathrm{Hz}$
\end_inset

。
\end_layout

\begin_layout Subsubsection
合成侧滑融合
\begin_inset CommandInset label
LatexCommand label
name "subsec:合成侧滑融合"

\end_inset


\end_layout

\begin_layout Standard
对于提供虚拟合成侧滑数值的旋翼无人机，采用这个分支。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“合成侧滑融合方程”的内容。
\end_layout

\begin_layout Standard
计算在飞行器机体坐标系中的相对于地球坐标系的风速向量
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind}^{N} & =\boldsymbol{V}_{I}-\boldsymbol{V}_{wind}\\
 & =\left[\begin{array}{c}
V_{N}-V_{wind_{N}}\\
V_{E}-V_{wind_{E}}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
根据外部输入的姿态四元数
\begin_inset Formula $q$
\end_inset

得到从机体坐标系到导航坐标系的旋转矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset


\begin_inset Formula 
\[
\left[T\right]_{B}^{N}=\boldsymbol{R}\left(q\right)
\]

\end_inset


\end_layout

\begin_layout Standard
计算相对于机体坐标系的风速
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind}^{B} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\cdot\boldsymbol{V}_{wind}^{N}\\
 & =\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
合成侧滑模型的小角度近似方程为
\begin_inset Formula 
\[
\mathrm{beta}=\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}
\]

\end_inset

并且根据近水平面假设，
\begin_inset Formula $\mathrm{beta}$
\end_inset

即为残差。
\end_layout

\begin_layout Standard
计算合成侧滑的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{beta}$
\end_inset


\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{beta} & =\dfrac{\partial\left(\mathrm{beta}\right)}{\partial\boldsymbol{x}_{k}}\\
 & =\dfrac{\partial\left(\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}\right)}{\partial\left(\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{tas}
\end{array}\right]\right)}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
后面的计算如上一小节一样。
\end_layout

\begin_layout Section
GPS的应用
\end_layout

\begin_layout Standard
在ECL估计系统中，GPS有着非常重要且特殊的地位。在这里，GPS有三种应用：一是在主要的24-EKF中校正状态向量；二是计算纬度/经度点之间的距离、方位角(b
earing)；三是配合全球地磁观测网站提供纬度/经度点的磁偏角。第一种用途已经在前面详细讨论，后面简略讨论后两种的算法。
\end_layout

\begin_layout Subsection
计算纬度/经度点之间的距离与方位角
\end_layout

\begin_layout Standard
因为人体的高度和视野相对于巨大的地球而言十分渺小，于是我们就误以为我们所处的大地是一个平面，但其实地球是一个近似圆球的橢球体。在一般的短距离的应用中，我们把地球
近似为平均半径
\begin_inset Formula $r=6371\ km$
\end_inset

的理想圆球。在这个假设中，ECL选择方位等距投影(Azimuthal Equidistant Projection)方式计算纬度/经度点之间的距离与方位角。
\end_layout

\begin_layout Standard
方位投影(Azimuthal Projection)是一种地图投影，其上所有点的方位都相对于中心正确显示。与地球两极之一相切的平面是极方位投影的基础。对于方位投
影，“天顶(zenithal)”一词是一个更古老的术语。方位投影最显著的特征是在图上测量的从中心到任意一点的距离是真实的。因而，地图上以投影中心为圆心的圆在真实
地球上与投影中心是等距离的。同时，从中心出发的任意方向也是真实的。该投影常用于展示多个地理位置与指定点的距离图。
\end_layout

\begin_layout Standard
方位等距投影(
\begin_inset CommandInset href
LatexCommand href
name "Azimuthal Equidistant Projection"
target "http://mathworld.wolfram.com/AzimuthalEquidistantProjection.html"
literal "false"

\end_inset

)是一种面积既不相等(equal-area)也不共形(conformal)的方位投影。等距方位投影可以保留距中心点的距离和方向。等距方位投影是假想球面与平面相切
，有极方位投影、赤道投影和斜轴投影三种，分别是：切于极点为正轴，切于赤道为横轴，切于极点和赤道之间的任意点为斜轴。经纬线形式同一般方位投影，只是在中央经线上纬线
间隔相等。其特点是：由切点至任一方向的距离同实地相符；最大角度和面积变形均为以切点为圆心的同心圆。这种投影常用于半球图，交通图等。
\end_layout

\begin_layout Standard
ECL采用的是局部方位等距投影(Local Azimuthal Equidistant Projection)，也就是斜轴投影。其直觉与我们应用李群和李代数的关
系类似，在这里进行的是地理坐标系统(geographic coordinate system)和方位等距平面(azimuthal equidistant
 plane)之间的变换。我们以飞行器当前点为切点/原点建立局部水平面，亦称局部方位等距平面(local azimuthal equidistant
 plane)。在局部水平面中，从原点出发的射线都是等距，射线的方位角保真，我们在此向量空间中进行向量计算，计算出到达下一个航路点(waypoint)的距离与方
位角，然后收回到球面上，就得到下一个航路点的纬度/经度，或者是反过来计算，将下一航路点的纬度/经度展开到当前水平面中，由此计算飞行距离与方位角。到达下一个航路点
后，我们再在这个航路点上建立新的局部水平面，并做下一步的计算。
\end_layout

\begin_layout Standard
\begin_inset CommandInset href
LatexCommand href
name "计算纬度/经度点之间的距离与方位角"
target "http://www.movable-type.co.uk/scripts/latlong.html"
literal "false"

\end_inset

的算法很古老也很成熟，其中还涉及到
\begin_inset CommandInset href
LatexCommand href
name "基于向量的大地测量学"
target "http://www.movable-type.co.uk/scripts/latlong-vectors.html"
literal "false"

\end_inset

知识。感兴趣的读者可以查看相关的书籍和网站。
\end_layout

\begin_layout Subsection
提供纬度/经度点的磁偏角
\end_layout

\begin_layout Standard
这里的算法十分简单，就是从开发和分发地球磁场模型的
\begin_inset CommandInset href
LatexCommand href
name "网站"
target "https://www.ngdc.noaa.gov/geomag/"
literal "false"

\end_inset

获取地磁数据档案，建立查询表格。然后根据当前的纬度/经度，查询表格，获取当前点的磁偏角数据，提供给ECL估计系统进行方位校正。
\end_layout

\begin_layout Section
惯性航位推算
\begin_inset CommandInset label
LatexCommand label
name "sec:惯性航位推算"

\end_inset


\end_layout

\begin_layout Standard
航位推算(dead reckoning)指的是无天文观测辅助导航，或者是基于很少或没有信息的位置估计。在ECL的估计系统中，当GPS类的全局定位数据不可用的情况
下，24-EKF仅使用惯性数据进行航位推算，并且执行的是水平惯性航位推算(horizontal inertial dead reckoning)。这是因为存在磁
力计就可以校正姿态，存在气压计或测距仪就可以校正
\begin_inset Formula $z$
\end_inset

轴高度，但是只有GPS类的全局定位数据，才能校正飞行器水平面的位置。当全局定位数据丢失或误差过大，则ECL估计系统就进入航位推算模式。注意，如果存在光流则可以校
正北/东方向速度，从而间接校正了水平面的增量位移，因此ECL估计系统不会进入航位推算模式。
\end_layout

\begin_layout Standard
当没有GPS类的全局定位数据，并且没有光流数据的情况下，航位推算模式还分为两种级别。第一种是存在水平风场数据，则进入风场航位推算(wind dead
 reckoning)模式，此时可以用水平风场向量校正北/东方向速度，从而间接校正了水平面的增量位移，这是第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:空速融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“空速融合方程”和第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“合成侧滑融合方程”的内容。第二种是连水平风场向量都没有的情况下，则是完全的水平惯性航位推算。
\end_layout

\begin_layout Standard
基于惯性的航位推算，根据经验，水平面位置的估计值，大约最长有
\begin_inset Formula $5\sim10\ s$
\end_inset

的有效期。所以在ECL估计系统中，设置
\begin_inset Formula $5\ s$
\end_inset

的有效期阈值，并且超过
\begin_inset Formula $7\ s$
\end_inset

就将状态向量中的水平位置和速度重置。
\end_layout

\begin_layout Section
输出互补滤波器
\end_layout

\begin_layout Standard
该算法使用当前时间范围内的最新IMU数据实现惯性导航。该算法缓冲惯性导航状态，并计算延迟融合时间范围内与EKF状态的差异。根据差值计算增量角、增量速度和速度校正
，并在当前时间范围内应用它们，以便惯性导航状态在延迟融合时间范围内跟踪EKF状态。使用互补滤波器校正EKF中的时间延迟的灵感来源于参考文档[12]的工作。
\end_layout

\begin_layout Standard
从软件的角度看，因为现在的系统越来越复杂，原本在RTOS时代所做的假设越来越不能得到满足。现在传感器采样，滤波器计算位姿，用户获取位姿，都分别处于不同的线程中，
有不同的工作频率。众多传感器各自工作在不同的频率，异步采样，数据异步到达。滤波器有自己的工作频率，上层软件也有另外的工作频率。所有这些，都会有一个时间差，因此在
用户获取当前位姿信息的瞬间，滤波器需要对当前所维护的信息做一个补偿，这就是输出互补滤波器。它的工作原理就是维护一个历史窗口，从历史数据中计算互补参数，然后对输出
信息进行校正，具体的原理请看参考文档[12]。在这里没有什么复杂的计算公式，一行的互补公式较多且大多简单细碎，经验参数众多，要看懂还得依赖专业背景和工程经验。
\end_layout

\begin_layout Section
总结
\end_layout

\begin_layout Standard
ECL EKF 算法最大的特点就是使用传感器组合进行状态估计。这使得系统具有很高的容错性，即对传感器故障的容忍度，但也使得算法具有更大的复杂度。但是在代码里，更
多的代码是对数据和协方差矩阵质量判断，并对上下限进行钳制处理，发现异常后更换数据源的处理。这些方法和经验数据，是多年的经验积累，是在一个个项目中一点点地磨炼出来
的经验总结。这才是 ECL EKF 模块最有价值的地方，因为主要算法可以在短时间内掌握，而这些知识只有靠时间来积淀。
\end_layout

\begin_layout Standard
不过 ECL EKF 算法也有值得探讨的地方。数学上已经清楚，旋转(包括四元数和旋转矩阵)不可以直接用卡尔曼滤波器进行估计，因为旋转是群而不是向量，而卡尔曼滤波
器里面最核心的概念
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

协方差
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

只能处理向量。因此直接把四元数放入卡尔曼滤波器中计算，估计的是四元数而不是旋转。
\end_layout

\begin_layout Standard
此外，对比误差状态EKF算法，就会发现这里的 Jacobian 矩阵展开后十分复杂，只要涉及旋转(包括四元数和旋转矩阵)的方程的 Jacobian
 矩阵都很复杂，并且难以解释。而在误差状态EKF算法中，误差大多在零点附近抖动，因此有较好的近线性特性，因此 Jacobian 矩阵和标准的KF的矩阵很类似，因
此计算速度会快一些，理论上精度也会高一些，并且容易解释。
\end_layout

\begin_layout Standard
但是，ECL EKF 模块已经在广大的产品和项目里得到验证，不论是在模拟器里还是在实际环境中，它的计算速度和精度都经受了检验。对此只能说卡尔曼滤波器真是一个很神
奇的东西，在工程中实用为上。
\end_layout

\begin_layout Standard
\begin_inset Newpage newpage
\end_inset


\end_layout

\begin_layout Section
参考文献
\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4: Estimation & Control Library for Guidance, Navigation and Control Applications - EKF"
target "https://github.com/PX4/ecl/tree/master/EKF"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 - EKF - documentation"
target "https://github.com/PX4/ecl/tree/master/EKF/documentation"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 - EKF - python code"
target "https://github.com/PX4/PX4-ECL/tree/master/EKF/python"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 - EKF - matlab code"
target "https://github.com/PX4/PX4-ECL/tree/master/EKF/matlab"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Using the ECL EKF"
target "https://docs.px4.io/en/advanced_config/tuning_the_ecl_ekf.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "EKF2 Estimation System"
target "https://ardupilot.org/dev/docs/ekf2-estimation-system.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Extended Kalman Filter Navigation Overview and Tuning"
target "https://ardupilot.org/dev/docs/extended-kalman-filter.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Extended Kalman Filter (EKF)"
target "https://ardupilot.org/copter/docs/common-apm-navigation-extended-kalman-filter-overview.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "NavEKF Change Overview 2020"
target "http://manual.cuav.net/ardupilot2020/EKF%20update.pptx"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 State Estimation 2021 Update"
target "https://px4.io/wp-content/uploads/2020/07/Paul-Riseborough-PX4-state-estimation-update.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Extended Kalman Filter"
target "https://ahrs.readthedocs.io/en/latest/filters/ekf.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Recursive Attitude Estimation in the Presence of Multi-rate and Multi-delay Vector Measurements"
target "http://users.cecs.anu.edu.au/~trumpf/pubs/khosravian_trumpf_mahony_hamel_ACC2015.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 的 ECL EKF 公式推导及代码解析"
target "https://blog.csdn.net/u010307048/article/details/100553475"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 InertialNAV Filter 与 EKF2概论"
target "https://blog.csdn.net/westlovehehe/article/details/54754943"
literal "false"

\end_inset


\end_layout

\end_body
\end_document
